<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin Flux</title>
    
    <!-- Telegram & Ads SDKs (Required for TWA functionality and Ad Libraries) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://js.onclckvd.com/in-stream-ad-admanager/tma.js"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Orbitron & Rajdhani for Sci-Fi look -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->

    <style>
        
        /* =========================================
   1. CORE VARIABLES & RESET
   ========================================= */
:root {
    --bg-dark: #05060a;
    --bg-panel: rgba(20, 25, 45, 0.6);
    --neon-blue: #00f0ff;
    --neon-purple: #bc13fe;
    --neon-gold: #ffd700;
    --text-main: #ffffff;
    --text-muted: #8b9bb4;
    --glass-border: rgba(255, 255, 255, 0.1);
    --font-head: 'Orbitron', sans-serif;
    --font-body: 'Rajdhani', sans-serif;

    /* NEW NEON COLORS for Holographic Dropdown */
    --neon-aqua: #09F2FF;
    --neon-uv-purple: #C542FF;
    --neon-plasma-gold: #F8C85F;
}

body {
    margin: 0; padding: 0;
    font-family: var(--font-body);
    background-color: var(--bg-dark);
    color: var(--text-main);
    overflow-x: hidden;
    padding-bottom: 100px; /* Space for bottom nav */
    -webkit-tap-highlight-color: transparent;
}

/* =========================================
   2. NETWORK-BASED ORGANIC LOADER
   ========================================= */

/* Loader Wrapper - Full Screen */
#loader-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #05060a; z-index: 9999;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    overflow: hidden;
    transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

#loader-screen.loaded {
    opacity: 0;
    transform: scale(2);
    filter: blur(20px);
    pointer-events: none;
}

.loader-bg-aurora {
    position: absolute; width: 200%; height: 200%;
    background: radial-gradient(circle at 50% 50%, rgba(0, 240, 255, 0.1), transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 170, 0.08), transparent 50%);
    animation: auroraMove 15s infinite alternate linear;
    z-index: 1;
}
@keyframes auroraMove { 
    0% { transform: translate(-20%, -20%) rotate(0deg); } 
    100% { transform: translate(10%, 10%) rotate(10deg); } 
}

/* Orbit Loader Style */
.loader-orbit-box {
    position: relative; 
    width: 180px; height: 180px;
    display: flex; justify-content: center; align-items: center;
    z-index: 10;
    margin-bottom: 20px;
}

.loader-ring-outer {
    position: absolute; width: 100%; height: 100%;
    border-radius: 50%; 
    border: 3px dashed rgba(0, 240, 255, 0.5);
    box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
    animation: spin 10s linear infinite;
}

.loader-ring-inner {
    position: absolute; width: 80%; height: 80%;
    border-radius: 50%; 
    border: 2px solid transparent;
    border-top: 2px solid var(--neon-purple);
    border-bottom: 2px solid var(--neon-purple);
    animation: spinReverse 6s linear infinite;
    box-shadow: 0 0 10px rgba(188, 19, 254, 0.3);
}

.loader-core-logo {
    font-size: 4rem; 
    color: #fff;
    z-index: 2;
    text-shadow: 0 0 20px var(--neon-blue);
    animation: bounce 3s infinite ease-in-out;
    margin-top: 30px;
}

.loader-text-wrapper {
    position: relative; z-index: 10;
    text-align: center;
    display: flex; flex-direction: column;
}

#progressText {
    font-family: var(--font-head); 
    font-size: 2rem; 
    font-weight: bold;
    color: #fff; 
    text-shadow: 0 0 10px var(--neon-blue);
}

.loading-label {
    font-family: var(--font-body); 
    font-size: 0.8rem; 
    letter-spacing: 3px;
    color: var(--neon-purple); 
    text-transform: uppercase; 
    margin-top: 5px;
    animation: blink 1s infinite;
}

.flash-burst {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: white; opacity: 0; pointer-events: none; z-index: 10000;
}
.flash-active { animation: flashAnim 0.3s ease-out; }

@keyframes flashAnim { 0% { opacity: 0.8; } 100% { opacity: 0; } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes spinReverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(-360deg); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes blink { 50% { opacity: 0.5; } }


/* =========================================
   3. BACKGROUND & ATMOSPHERE
   ========================================= */
.bg-particles {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* Updated background gradient */
    background: linear-gradient(180deg, #03020A 0%, #0C0F33 100%);
    z-index: -2;
}
.bg-glow {
    position: fixed; top: -20%; left: -20%; width: 50%; height: 50%;
    background: radial-gradient(circle, rgba(0, 240, 255, 0.15), transparent 70%);
    filter: blur(80px); z-index: -1; animation: floatGlowBG 10s infinite alternate;
}
@keyframes floatGlowBG { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 20px); } }

/* =========================================
   4. HEADER & BALANCE ORB
   ========================================= */
.cyber-header {
    display: flex; justify-content: space-between; padding: 20px;
    position: relative; z-index: 10;
}
.cyber-badge {
    background: rgba(0, 240, 255, 0.1);
    border: 1px solid var(--neon-blue);
    padding: 5px 12px; border-radius: 4px;
    font-size: 0.8rem; font-weight: 700;
    color: var(--neon-blue);
    text-shadow: 0 0 5px var(--neon-blue);
    backdrop-filter: blur(5px);
}

.balance-orbit-container {
    position: relative; width: 160px; height: 160px;
    margin: 10px auto 30px; display: flex;
    justify-content: center; align-items: center;
}
.orbit-ring {
    position: absolute; width: 100%; height: 100%;
    border-radius: 50%; border: 2px dashed rgba(0, 240, 255, 0.3);
    animation: spin 10s linear infinite;
}
.orbit-ring-2 {
    position: absolute; width: 80%; height: 80%;
    border-radius: 50%; border: 1px solid rgba(188, 19, 254, 0.3);
    border-top-color: var(--neon-purple);
    animation: spinReverse 6s linear infinite;
}
.balance-core {
    text-align: center; z-index: 2;
    position: relative;
}

.coin-hologram {
    font-size: 2rem; 
    color: var(--neon-gold); 
    filter: drop-shadow(0 0 10px var(--neon-gold)); 
    margin-bottom: 1px; 
    animation: none; 
}

#balance {
    font-family: var(--font-head);
    font-size: 2rem;           
    font-weight: 900;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    line-height: 1;
    width: 100%;
    max-width: 120px;          
    margin: 0 auto;
    white-space: nowrap;       
    overflow: hidden;          
    text-overflow: clip;       
    transition: font-size 0.2s ease, transform 0.1s; 
}

/* NEW: USD Label Style */
.usd-label {
    font-size: 0.9rem;
    color: #2ecc71; /* Dollar Green */
    font-family: 'Rajdhani', monospace;
    font-weight: 700;
    margin-top: 0px;
    margin-bottom: 2px; /* Space above 'Coin Flux' */
    text-shadow: 0 0 8px rgba(46, 204, 113, 0.4);
    letter-spacing: 1px;
    opacity: 0.9;
}

.balance-label 
{ 
    font-size: 0.7rem; letter-spacing: 2px; color: var(--neon-blue); margin-top: 2px; opacity: 0.8; 
    
}

/* =========================================
   5. TABS & CARDS (GLASS PANELS)
   ========================================= */
.cyber-tabs {
    display: flex; gap: 10px; padding: 5px;
    background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 20px;
}
.cyber-tab {
    flex: 1; text-align: center; padding: 10px;
    font-family: var(--font-head); font-size: 0.75rem;
    color: var(--text-muted); cursor: pointer;
    border: 1px solid transparent; border-radius: 8px;
    transition: all 0.3s;
}
.cyber-tab.active {
    background: rgba(0, 240, 255, 0.15);
    border-color: var(--neon-blue);
    color: var(--neon-blue);
    box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
}

.glass-panel {
    background: var(--bg-panel);
    border: 1px solid var(--glass-border);
    border-radius: 16px; padding: 20px;
    backdrop-filter: blur(12px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    margin-bottom: 20px; position: relative; overflow: hidden;
    transition: transform 0.3s;
}
.glass-panel::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--neon-purple), transparent);
}

.panel-icon { text-align: center; color: var(--neon-purple); margin-bottom: 10px; filter: drop-shadow(0 0 5px var(--neon-purple)); }
h3 { margin: 5px 0; font-family: var(--font-head); font-weight: 700; color: white; text-align: center; letter-spacing: 1px; }
p { color: var(--text-muted); font-size: 0.9rem; text-align: center; margin-top: 0; }
.neon-text { color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }


/* =========================================
   6. UPDATED RANK & VAULT ICONS (CENTERED)
   ========================================= */

/* Common style for centering main icons in cards */
.trophy-holo, 
.vault-icon {
    display: flex;            
    justify-content: center;  
    align-items: center;      
    width: 100%;              
    margin: 0 auto 20px auto; 
    text-align: center;
}

/* Rank/Leaderboard Icon */
.trophy-holo { 
    color: var(--neon-blue);  
    filter: drop-shadow(0 0 15px rgba(0, 240, 255, 0.6)); 
}

/* Wallet/Vault Icon */
.vault-icon { 
    color: var(--neon-blue); 
    filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.5));
    transition: transform 0.3s ease;
}
.vault-icon:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.8));
}

@keyframes floatGlow {
    0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.4)); }
    50% { transform: translateY(-5px); filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.8)); }
}


/* =========================================
   7. PROGRESS BARS & BUTTONS
   ========================================= */
.cyber-progress-box { margin: 20px 0; }
.progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; font-family: var(--font-head); }
.neon-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
.neon-bar {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
    box-shadow: 0 0 10px var(--neon-blue);
    transition: width 0.5s ease;
}

/* Glitch Button */
.cyber-btn-glitch {
    background: transparent; border: 1px solid var(--neon-blue);
    color: var(--neon-blue); padding: 12px; width: 100%;
    font-family: var(--font-head); font-weight: 700; letter-spacing: 1px;
    cursor: pointer; position: relative; overflow: hidden;
    transition: 0.2s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
}
.cyber-btn-glitch:active { transform: scale(0.98); background: rgba(0, 240, 255, 0.1); }
.cyber-btn-glitch.disabled { border-color: #555; color: #555; pointer-events: none; }
.flare {
    position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: flareAnim 3s infinite;
}
@keyframes flareAnim { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

.holo-btn-mini {
    position: absolute; top: 10px; right: 10px;
    background: rgba(0,0,0,0.5); border: 1px solid var(--text-muted);
    color: var(--text-muted); padding: 4px 10px; font-size: 0.7rem;
    border-radius: 4px; font-family: var(--font-head); cursor: pointer;
    z-index: 100;
}

.cyber-btn-small {
    background: linear-gradient(135deg, var(--neon-purple), #8a00d4);
    color: white; 
    border: none; 
    padding: 10px 20px;
    font-family: var(--font-head); 
    font-size: 0.8rem;
    clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    cursor: pointer; 
    box-shadow: 0 0 15px rgba(188, 19, 254, 0.4);
    
    /* স্পিনারের সময় বাটন ছোট হওয়া রোধ করার জন্য পরিবর্তন */
    min-width: 90px;        
    display: inline-flex;   
    justify-content: center;
    align-items: center;
    text-align: center;
}
.btn-blue { background: linear-gradient(135deg, #0088cc, #005f8f); box-shadow: 0 0 15px rgba(0, 136, 204, 0.4); }

/* =========================================
   8. LISTS (MISSIONS & REFERRALS)
   ========================================= */
.mission-capsule {
    background: rgba(255, 255, 255, 0.03); border-left: 3px solid var(--neon-purple);
    padding: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;
    backdrop-filter: blur(5px);
}
.capsule-left { display: flex; align-items: center; gap: 15px; }
.capsule-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(188, 19, 254, 0.1); border-radius: 50%; color: var(--neon-purple); }
.capsule-info h4 { text-align: left; margin: 0; font-size: 0.9rem; color: white; }
.capsule-info p { text-align: left; font-size: 0.75rem; color: var(--text-muted); }

/* Leaderboard */
.leaderboard-grid { max-height: 400px; overflow-y: auto; }
.top-ref-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.active-user-highlight { border: 1px solid var(--neon-gold); background: rgba(255, 215, 0, 0.1); }
.ref-rank-badge { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }

/* Rank Colors */
.rank-1 { 
    color: var(--neon-gold); 
    border: 2px solid var(--neon-gold); 
    background: rgba(255, 215, 0, 0.1); 
    text-shadow: 0 0 10px var(--neon-gold);
    font-family: var(--font-head); 
    font-size: 1.1rem !important; 
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); 
}
.rank-2 { 
    color: #e0e0e0; 
    border: 2px solid #e0e0e0;
    background: rgba(224, 224, 224, 0.1);
    text-shadow: 0 0 5px #e0e0e0;
    font-family: var(--font-head);
    font-size: 1.1rem !important;
}
.rank-3 { 
    color: #cd7f32; 
    border: 2px solid #cd7f32;
    background: rgba(205, 127, 50, 0.1);
    text-shadow: 0 0 5px #cd7f32;
    font-family: var(--font-head);
    font-size: 1.1rem !important;
}

.ref-info {
    flex: 1; 
    margin-left: 2px; 
    margin-right: 12px; 
    text-align: left;
    overflow: hidden;
}

.ref-info h4 { 
    text-align: left; 
    font-size: 0.9rem; 
    margin: 0;
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis;
}

.ref-count-pill { 
    background: rgba(0, 240, 255, 0.1); 
    color: var(--neon-blue); 
    padding: 5px 10px; 
    border-radius: 4px; 
    font-family: var(--font-head); 
    text-align: center; 
    min-width: 60px;
    flex-shrink: 0;
    font-size: 0.8rem;
}

/* Referral Stats */
.split-stats { display: flex; gap: 10px; margin-bottom: 20px; }
.stat-block { flex: 1; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
.stat-block i { font-size: 1.5rem; color: var(--neon-blue); margin-bottom: 5px; }

.stat-block h3 {
    margin: 0; 
    font-size: 1.2rem; /* ডিফল্ট সাইজ */
    color: white; 
    
    /* নতুন যোগ করা অংশ */
    white-space: nowrap;       /* লেখা নিচে নামবে না */
    overflow: hidden;          /* বক্সের বাইরে যাবে না */
    text-overflow: clip;       
    display: flex;             /* মাঝখানে রাখার জন্য */
    justify-content: center;
    align-items: center;
    width: 100%;               /* পুরো জায়গা নিবে */
    transition: font-size 0.2s ease; /* ফন্ট ছোট হওয়ার এনিমেশন */
}
.link-vault { background: rgba(0,0,0,0.5); border: 1px dashed var(--text-muted); padding: 10px; border-radius: 4px; margin-bottom: 15px; position: relative; }
.vault-label { position: absolute; top: -10px; left: 10px; background: var(--bg-dark); padding: 0 5px; font-size: 0.6rem; color: var(--neon-blue); }
.vault-text { font-family: monospace; color: var(--text-muted); word-break: break-all; font-size: 0.8rem; }

/* =========================================
   9. INPUTS & NAVIGATION
   ========================================= */
.cyber-input-group { margin-bottom: 15px; text-align: left; position: relative; } /* Added position: relative for dropdown positioning */
.cyber-input-group label { display: block; font-size: 0.7rem; color: var(--neon-blue); margin-bottom: 5px; font-family: var(--font-head); }
.cyber-input {
    width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
    color: white; padding: 12px; border-radius: 4px; font-family: var(--font-body); font-size: 1rem;
    outline: none; box-sizing: border-box;
}
.cyber-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 240, 255, 0.1); }

/* Bottom Nav */
.cyber-nav {
    position: fixed; bottom: 20px; left: 5%; width: 90%;
    background: rgba(10, 15, 30, 0.9); border: 1px solid var(--glass-border);
    backdrop-filter: blur(15px); border-radius: 20px;
    display: flex; justify-content: space-around; padding: 10px 0;
    z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.nav-item { text-align: center; color: var(--text-muted); transition: 0.3s; width: 20%; cursor: pointer; }
.nav-icon { font-size: 1.2rem; margin-bottom: 2px; transition: 0.3s; }
.nav-item span { font-size: 0.6rem; font-family: var(--font-head); text-transform: uppercase; }
.nav-item.active { color: var(--neon-blue); text-shadow: 0 0 8px var(--neon-blue); }
.nav-item.active .nav-icon { transform: translateY(-3px); }

/* =========================================
   10. MODALS & UTILITIES (UPDATED)
   ========================================= */
.modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* Updated background for blur/dark overlay effect */
    background: rgba(0,0,0,0.9); 
    backdrop-filter: blur(8px); /* Blur effect on background */
    z-index: 3000;
    display: none; justify-content: center; align-items: center;
}
.cyber-modal {
    background: #0b1021; border: 1px solid var(--neon-blue);
    width: 85%; max-width: 350px; padding: 30px 20px;
    text-align: center; position: relative;
    box-shadow: 0 0 30px rgba(0, 240, 255, 0.1);
    clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
    
    /* Animation: Center Pop-up */
    animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes modalPop {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

.large-modal { max-width: 450px; height: 80vh; display: flex; flex-direction: column; }

/* NEW Style for the Network Modal */
.network-modal-style {
    max-width: 400px;
    height: auto; /* Let content define height */
    max-height: 90vh;
    padding: 20px;
}
.modal-scroll-area {
    overflow-y: auto; 
    padding: 10px 0; 
    flex-grow: 1;
}

.history-scroll-area { overflow-y: auto; flex-grow: 1; }
.close-modal, .close-modal-icon { position: absolute; top: 15px; right: 15px; color: #555; cursor: pointer; font-size: 1.2rem; }
.close-modal-icon:hover { color: #fff; transform: scale(1.1); } /* Hover effect for better UX */

/* Ad Loader (Small) */
.loader-ring { width: 50px; height: 50px; border: 4px solid rgba(0, 240, 255, 0.3); border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 20px; }
.ad-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #05060a; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--neon-blue); font-family: var(--font-head); }
.blink-text { animation: blink 1s infinite; }

/* Helpers */
.neon-title { font-family: var(--font-head); font-size: 1rem; color: var(--text-muted); margin: 30px 0 10px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px; }
.neon-title .line { height: 1px; background: rgba(255,255,255,0.1); flex-grow: 1; }
.container, .cyber-container { padding: 0 20px; position: relative; z-index: 5; }
.page-section { display: none; animation: fadeIn 0.4s; }
.page-section.active-section { display: block; }
.ad-card-container { display: none; }
.ad-card-container.active { display: block; animation: slideUp 0.4s; }
.success-msg { color: #2ecc71; font-family: var(--font-head); font-size: 0.8rem; margin-top: 10px; display: none; }

/* General Animations */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


.img1
{
    width: 140px;
}

/* =========================================
   11. ADVANCED SHINY BUTTON EFFECTS (FINAL)
   ========================================= */

@keyframes universalFlare {
    0% { left: -150%; }
    10% { left: 150%; }
    100% { left: 150%; }
}

/* GROUP A: SLOW SHINE */
.holo-btn-mini, 
.cyber-btn-small, 
.tournament-chip {
    position: relative !important;
    overflow: hidden !important;
    z-index: 1;
}

.holo-btn-mini::after, 
.cyber-btn-small::after, 
.tournament-chip::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 80%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transform: skewX(-25deg);
    pointer-events: none;
    animation: universalFlare 5s infinite linear; 
}

/* GROUP B: FAST SHINE */
.cyber-btn-glitch:not(#watchAdBtn):not(#watchAdsgramBtn):not(#watchOnclickaBtn) {
    position: relative !important;
    overflow: hidden !important;
}

.cyber-btn-glitch:not(#watchAdBtn):not(#watchAdsgramBtn):not(#watchOnclickaBtn)::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 50%; 
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transform: skewX(-25deg);
    pointer-events: none;
    animation: universalFlare 3s infinite linear;
}

/* GROUP C: EVENT BUTTON */
.tournament-chip {
    background: linear-gradient(135deg, #ff9d00, #ff5e00) !important;
    color: #000 !important; 
    font-weight: 800 !important;
    border: 1px solid #ffd700 !important;
    box-shadow: 0 0 10px rgba(255, 157, 0, 0.4) !important;
    text-shadow: none !important;
}
.tournament-chip i { color: #000 !important; }

/* DISABLED STATE */
button:disabled::after,
.cyber-btn-glitch.disabled::after,
.cyber-btn-small.disabled::after,
.holo-btn-mini:disabled::after {
    display: none !important;
}

/* FIX LOGS BUTTON */
.holo-btn-mini {
    position: absolute !important; 
    top: 10px !important;
    right: 10px !important;
    z-index: 100 !important;
}

.ref-rank-badge i {
    font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
    font-weight: 900 !important;
}

/* =========================================
   12. FLYING COINS WITH SMOKE & COUNTING BOUNCE
   ========================================= */

/* 1. The Main Flying Coin */
.flying-coin {
    position: fixed;
    width: 16px;
    height: 16px;
    background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00);
    border-radius: 50%;
    box-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00;
    z-index: 10000;
    pointer-events: none;
    will-change: transform, opacity;
}

/* 2. The Smoke/Trail Effect */
.neon-smoke {
    position: fixed;
    width: 10px;
    height: 10px;
    background: rgba(255, 215, 0, 0.6);
    border-radius: 50%;
    box-shadow: 0 0 10px #ff8c00;
    pointer-events: none;
    z-index: 9999;
    animation: fadeSmoke 0.6s linear forwards;
}
@keyframes fadeSmoke {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(2); opacity: 0; }
}

/* 3. Balance Ring Ripple (Impact Effect only) */
.balance-sparkle {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    margin: auto;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #ffd700;
    box-shadow: 0 0 30px #ffd700, inset 0 0 15px #ffd700;
    animation: impactRipple 0.5s ease-out forwards;
    pointer-events: none;
    z-index: 15;
}
@keyframes impactRipple {
    0% { transform: scale(0.8); opacity: 1; border-width: 5px; }
    100% { transform: scale(1.6); opacity: 0; border-width: 0px; }
}

/* 4. COUNTING BOUNCE & SPARKLE (Active during counting) */
.counting-sparkle {
    /* Infinite pulse while counting */
    animation: countingPulse 0.15s infinite alternate; 
    color: #fffacd !important; /* Lemon Chiffon Color */
    text-shadow: 
        0 0 15px #ffd700, 
        0 0 30px #ffffff,
        0 0 50px #ff8c00;
}

@keyframes countingPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.2); } /* সংখ্যা বাড়ার সময় বড় হবে */
}

/* --- Modal Text & Color Styles --- */

/* 1. মডালের আইকন স্টাইল */
.modal-main-icon {
    font-size: 3rem; /* আইকন বড় */
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: bounce 3s infinite ease-in-out; 
    filter: none; 
    text-shadow: none;
}

/* 2. কালার ক্লাসসমূহ */
.text-cyan { 
    color: #00f0ff !important; 
    text-shadow: none !important; 
}

.text-gold { 
    color: #ffd700 !important; 
    text-shadow: none !important; 
}

.text-red { 
    color: #ff4d4d !important; 
    text-shadow: none !important; 
}

/* 3. টাইটেল স্টাইল */
.reward-title {
    font-size: 1.5rem;
    font-weight: 900;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* 4. অ্যামাউন্ট টেক্সট স্টাইল */
.reward-amount-text {
    font-size: 2.2rem;
    font-weight: bold;
    margin: 5px 0 15px 0;
    font-family: var(--font-head);
}

/* Common Bounce Keyframe */
@keyframes bounce { 
    0%, 100% { transform: translateY(0); } 
    50% { transform: translateY(-10px); } 
}

/* --- Button State Overrides --- */

.cyber-btn-small {
    /* ... existing styles ... */
    min-width: 90px;        
    display: inline-flex;   
    justify-content: center;
    align-items: center;
    text-align: center;
}

.btn-claim {
    background: linear-gradient(135deg, #2ecc71, #27ae60) !important; /* সবুজ গ্র্যাডিয়েন্ট */
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.6) !important;
    color: #fff !important;
}

.cyber-btn-small.disabled {
    background: #333 !important;
    color: #777 !important;
    box-shadow: none !important;
    cursor: not-allowed;
    border: 1px solid #444;
}

/* =========================================
   13. CUSTOM HOLO DROPDOWN STYLES (MODAL)
   ========================================= */

/* Custom Dropdown Trigger (remains the same) */
.custom-select-trigger {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}
.custom-select-trigger:active {
    border-color: var(--neon-aqua);
    box-shadow: 0 0 10px rgba(9, 242, 255, 0.2);
}

/* Panel Header (reused for modal title) */
.panel-header {
    font-family: var(--font-head);
    font-size: 0.8rem;
    color: var(--neon-uv-purple);
    padding: 10px 15px;
    border-bottom: 1px solid rgba(197, 66, 255, 0.2);
    text-align: center;
    letter-spacing: 2px;
}

/* Container inside the modal */
.network-options-container {
    padding: 10px 0; 
    overflow-y: visible;
}

/* Holo Capsule Option */
.network-option-capsule {
    position: relative;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-head);
    color: var(--text-main);
    text-align: center;
    transition: all 0.2s ease-out;
    overflow: hidden;
    
    /* Initial state for staggered animation */
    opacity: 0;
    transform: translateY(10px);
}

/* Staggered animation keyframes */
@keyframes capsuleIn {
    to { opacity: 1; transform: translateY(0); }
}

/* Hover/Tap Effects */
.network-option-capsule:hover {
    background: rgba(9, 242, 255, 0.1);
    border-color: var(--neon-aqua);
    box-shadow: 0 0 15px rgba(9, 242, 255, 0.3);
    transform: translateY(-2px) scale(1.01);
}

/* Selected State */
.network-option-capsule.selected {
    background: rgba(197, 66, 255, 0.15);
    border-color: var(--neon-uv-purple);
    box-shadow: 0 0 20px rgba(197, 66, 255, 0.5);
    color: var(--neon-aqua);
    transform: none;
    animation: pulseBorder 1.5s infinite alternate;
}

/* Rotating Energy Ring on Selected */
.network-option-capsule.selected::after {
    content: '';
    position: absolute;
    top: -5px; bottom: -5px; left: -5px; right: -5px;
    border: 2px dashed var(--neon-aqua);
    border-radius: 12px;
    opacity: 0.5;
    animation: spin 6s linear infinite;
    z-index: 0;
}

/* Keyframes for Selected Pulse */
@keyframes pulseBorder {
    0% { box-shadow: 0 0 20px rgba(197, 66, 255, 0.5); }
    100% { box-shadow: 0 0 30px rgba(197, 66, 255, 0.8), 0 0 10px var(--neon-uv-purple); }
}

/* Icon style inside capsule */
.capsule-content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    z-index: 1;
}

.capsule-icon-holo {
    color: var(--neon-plasma-gold);
    text-shadow: 0 0 5px var(--neon-plasma-gold);
}

/* Down Arrow Animation when Open */
.fa-caret-down {
    transition: transform 0.3s ease;
}
.fa-rotate-180 {
    transform: rotate(180deg);
}
/* END OF CUSTOM HOLO DROPDOWN STYLES */


    </style>
    
</head>
<body>

    <!-- ========================================= -->
    <!-- 1. NEW ORGANIC LOADING SCREEN START       -->
    <!-- ========================================= -->
    <div id="loader-screen">
        <!-- Background Effects -->
        <div class="loader-bg-aurora"></div>
        
        <!-- New Orbit Style Loader (Like Balance Orb) -->
        <div class="loader-orbit-box">
            <!-- Outer Dashed Ring -->
            <div class="loader-ring-outer"></div>
            <!-- Inner Purple Ring -->
            <div class="loader-ring-inner"></div>
            
            <!-- Logo Inside -->
            <div class="loader-core-logo">
                <img class="img1" src="img1.png" alt="Logo" /> 
            </div>
        </div>

        <!-- Progress Text Below -->
        <div class="loader-text-wrapper">
            <span id="progressText">0%</span>
            <span class="loading-label">SYSTEM SYNC</span>
        </div>
    </div>
    <!-- ========================================= -->
    <!--    NEW ORGANIC LOADING SCREEN END         -->
    <!-- ========================================= -->


    <!-- Dynamic Background Elements (Main App) -->
    <div class="bg-particles"></div>
    <div class="bg-glow"></div>

    <!-- Top Bar (User Profile) -->
    <div class="cyber-header">
        <div class="cyber-badge user-badge">
            <i class="fas fa-fingerprint"></i> <span id="uidDisplay">...</span>
        </div>
        <div class="cyber-badge user-name">
            <i class="fas fa-user-astronaut"></i> <span id="username">Guest</span>
        </div>
    </div>

    <!-- Main Balance Orb (Center) -->
    <div class="balance-orbit-container">
        <div class="orbit-ring"></div>
        <div class="orbit-ring-2"></div>
        <div class="balance-core">
            <div class="coin-hologram"><i class="fas fa-coins" id="mainCoinIcon"></i></div>
            
            <span id="balance">0</span>
            
            <!-- NEW: USD Display Added Here -->
            <div id="usdBalance" class="usd-label">= $0.00000</div>
            
            <div class="balance-label">Coin Flux</div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="cyber-container">
        
        <!-- 1. HOME SECTION (Dashboard) -->
        <div id="home-section" class="page-section active-section">
            <div class="neon-title">Ad Networks <div class="line"></div></div>
            
            <!-- Futuristic Tabs -->
            <div class="cyber-tabs">
                <div class="cyber-tab active" id="tab-monetag" onclick="switchAdTab('monetag')">
                    <i class="fas fa-cube"></i> Zone 1
                </div>
                <div class="cyber-tab" id="tab-adsgram" onclick="switchAdTab('adsgram')">
                    <i class="fas fa-cube"></i> Zone 2
                </div>
                <div class="cyber-tab" id="tab-onclicka" onclick="switchAdTab('onclicka')">
                    <i class="fas fa-cube"></i> Zone 3
                </div>
            </div>

            <!-- Card 1: Monetag -->
            <div id="card-monetag" class="ad-card-container active">
                <div class="glass-panel" id="adCard">
                    <button class="holo-btn-mini" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> Log</button> 
                    <div class="panel-icon"><i class="fas fa-play-circle fa-3x"></i></div>
                    <h3 id="adCardTitle">Video Stream</h3> 
                    <p id="adCardDesc">Reward: <span class="neon-text" id="rewardAmountDisplay">...</span> Coins</p>

                    <div class="cyber-progress-box">
                        <div class="progress-info">
                            <span>Zone 1 Daily Progress</span>
                            <span><b id="adCount">0</b> / <span id="limitDisplay">...</span></span>
                        </div>
                        <div class="neon-track">
                            <div class="neon-bar" id="dailyProgressBar"></div>
                        </div>
                    </div>

                    <button class="cyber-btn-glitch" id="watchAdBtn" onclick="startAdFlow('monetag')">
                        INITIALIZE AD <span class="flare"></span>
                    </button>
                    <div id="completedMsg" class="success-msg"><i class="fas fa-check-circle"></i> Come back the next day.</div>
                </div>
            </div>

            <!-- Card 2: Adsgram -->
            <div id="card-adsgram" class="ad-card-container">
                <div class="glass-panel" id="adsgramCard">
                    <button class="holo-btn-mini" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> Log</button> 
                    <div class="panel-icon"><i class="fas fa-satellite-dish fa-3x"></i></div>
                    <h3 id="adsgramCardTitle">Adsgram Link</h3> 
                    <p id="adsgramCardDesc">Reward: <span class="neon-text" id="adsgramRewardDisplay">...</span> Coins</p>

                    <div class="cyber-progress-box">
                        <div class="progress-info">
                            <span>Zone 2 Daily Progress</span>
                            <span><b id="adsgramCount">0</b> / <span id="adsgramLimitDisplay">...</span></span>
                        </div>
                        <div class="neon-track">
                            <div class="neon-bar" id="adsgramProgressBar"></div>
                        </div>
                    </div>

                    <button class="cyber-btn-glitch" id="watchAdsgramBtn" onclick="startAdFlow('adsgram')">
                        ESTABLISH LINK <span class="flare"></span>
                    </button>
                    <div id="adsgramCompletedMsg" class="success-msg"><i class="fas fa-check-circle"></i> Come back the next day.</div>
                </div>
            </div>
            
            <!-- Card 3: Onclicka -->
            <div id="card-onclicka" class="ad-card-container">
                <div class="glass-panel" id="onclickaCard">
                    <button class="holo-btn-mini" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> Log</button> 
                    <div class="panel-icon"><i class="fas fa-network-wired fa-3x"></i></div>
                    <h3 id="onclickaCardTitle">Onclicka Net</h3> 
                    <p id="onclickaCardDesc">Reward: <span class="neon-text" id="onclickaRewardDisplay">...</span> Coins</p>

                    <div class="cyber-progress-box">
                        <div class="progress-info">
                            <span>Zone 3 Daily Progress</span>
                            <span><b id="onclickaCount">0</b> / <span id="onclickaLimitDisplay">...</span></span>
                        </div>
                        <div class="neon-track">
                            <div class="neon-bar" id="onclickaProgressBar"></div>
                        </div>
                    </div>

                    <button class="cyber-btn-glitch" id="watchOnclickaBtn" onclick="startAdFlow('onclicka')">
                        CONNECT NODE <span class="flare"></span>
                    </button>
                    <div id="onclickaCompletedMsg" class="success-msg"><i class="fas fa-check-circle"></i> Come back the next day.</div>
                </div>
            </div>
        </div>

        <!-- 2. MISSIONS SECTION -->
        <div id="tasks-section" class="page-section">
            <div class="mission-capsule daily-mission">
                <div class="capsule-left">
                    <div class="capsule-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="capsule-info">
                        <h4>Daily Protocol</h4>
                        <p id="dailyRewardAmountDisplay">+100 Credits</p>
                    </div>
                </div>
                <button id="dailyClaimBtn" class="cyber-btn-small" onclick="claimDailyReward()">CHECK-IN</button>
            </div>

            <div class="neon-title" id="missionsSectionTitle">Tactical Missions <div class="line"></div></div>
            <div id="taskListContainer">
                <div class="loading-holo">
                    <div class="scanner"></div>
                    <p>Scanning for missions...</p>
                </div>
            </div>

            <div class="neon-title" id="completedMissionsTitle" style="display:none; margin-top: 30px;">Completed Logs <div class="line"></div></div>
            <div id="completedListContainer"></div>
        </div>

        <!-- 3. LEADERBOARD SECTION -->
        <div id="topref-section" class="page-section">
            <div class="neon-title" id="toprefSectionTitle">Global Elite <div class="line"></div></div>

            <div class="glass-panel" id="leaderboardCard" style="padding-bottom: 60px;">
                
                <div id="tournament-ui-container" style="display: none; position: absolute; top: 15px; right: 15px; z-index: 10;">
                    <button class="tournament-chip" id="referralTournamentBtn" onclick="handleTournamentButtonClick()">
                        <i class="fas fa-trophy"></i> EVENT
                    </button>
                    <div id="tournamentCountdown" style="text-align: right; font-size: 0.7rem; color: #00f0ff; margin-top: 5px;">
                        <i class="fas fa-clock"></i> <span id="tournamentTimerDisplay">...</span>
                    </div>
                </div>

                <div class="trophy-holo"><i class="fas fa-chart-line fa-3x"></i></div>
                <h2 id="leaderboardTitle" style="text-align: center; color: #fff;">Top Agents</h2>
                
                <div id="topReferralListContainer" class="leaderboard-grid">
                    <div class="loading-holo"><div class="scanner"></div><p>Syncing Database...</p></div>
                </div>
            </div>
        </div>

        <!-- 4. INVITE SECTION -->
        <div id="invite-section" class="page-section">
            <div class="neon-title" id="inviteSectionTitle">Recruitment <div class="line"></div></div>
            
            <div class="glass-panel">
                
                <!-- UPDATED: Use vault-icon class for glowing effect -->
                <div class="vault-icon"><i class="fas fa-user-plus fa-3x"></i></div>
                
                <!-- NOTE: h3 and p tags inside the glass-panel will be dynamically updated by script.js's settings listener (ref_title, ref_desc) -->
                <h3>Refer & Earn</h3>
                <p>Share link & get bonus!</p>
                
                <div class="split-stats">
                    <div class="stat-block">
                        <i class="fas fa-users"></i>
                        <h3 id="ref-count">0</h3>
                        <p>Referrals</p>
                    </div>
                    <div class="stat-block">
                        <i class="fas fa-gem"></i>
                        <h3 id="ref-earned">0</h3>
                        <p>Earned</p>
                    </div>
                </div>

                <div class="link-vault">
                    <div class="vault-label">ENCRYPTED LINK</div>
                    <div class="vault-text" id="refLink">Loading...</div>
                </div>
                <button class="cyber-btn-glitch full-width" onclick="copyLink(this)">COPY Link <i class="fas fa-copy"></i></button>
            </div>

            <div class="neon-title" id="activeReferralsTitle" style="margin-top: 30px; display: none;">Active Agents <div class="line"></div></div>
            <div id="activeReferralListContainer"></div>
            <div id="activeReferralPagination" class="pagination" style="display: none;"></div>
            
            <div class="neon-title" id="completedReferralsTitle" style="margin-top: 30px; display:none;">Bonus Claimed <div class="line"></div></div>
            <div id="completedReferralListContainer"></div>
            <div id="completedReferralPagination" class="pagination" style="display: none;"></div>
        </div>
        
        <!-- 5. WALLET SECTION -->
        <div id="wallet-section" class="page-section">
            <div class="neon-title" id="walletSectionTitle">Vault Access <div class="line"></div></div>
            <div class="glass-panel vault-panel">
                <button class="holo-btn-mini" onclick="showHistoryModal('withdrawal')"><i class="fas fa-history"></i> Log</button>
                
                <div class="vault-icon"><i class="fas fa-wallet fa-3x"></i></div>
                <h3 id="withdrawTitle">Withdraw Assets</h3>
                <p class="vault-desc"><span id="withdrawDesc">Min: 100</span></p> 
                
                <div class="cyber-input-group">
                    <label>Amount</label>
                    <input type="number" id="withdrawAmount" class="cyber-input" placeholder="Enter Amount">
                </div>

                <!-- --- UPDATED: CUSTOM HOLO DROPDOWN START (In-place trigger only) --- -->
                <div class="cyber-input-group" id="networkSelectionGroup">
                    <label>Method</label>
                    
                    <!-- কাস্টম ড্রপডাউন ট্রিগার -->
                    <!-- onclick calls the new modal function -->
                    <div id="customWithdrawMethodTrigger" class="cyber-input custom-select-trigger" onclick="openNetworkSelectionModal()">
                        <span id="selectedNetworkText">Select Withdraw Method</span>
                        <i class="fas fa-caret-down" id="triggerIcon"></i>
                    </div>
                    
                    <!-- Hidden input to hold the actual selected value for withdrawal -->
                    <input type="hidden" id="withdrawMethodValue" value="" />
                </div>
                <!-- --- UPDATED: CUSTOM HOLO DROPDOWN END --- -->

                <!-- account number input -->
                <div class="cyber-input-group">
                    <input type="text" id="accountNumber" class="cyber-input" placeholder="Wallet Address / Number" style="display: none;">
                </div>
                
                <button class="cyber-btn-glitch full-width" id="requestWithdrawBtn" onclick="requestWithdraw()">
                    INITIATE TRANSFER
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Bottom Nav -->
    <div class="cyber-nav">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('tasks', this)">
            <div class="nav-icon"><i class="fas fa-tasks"></i></div>
            <span>Mission</span>
        </div>
        <div class="nav-item" onclick="switchTab('topref', this)">
            <div class="nav-icon"><i class="fas fa-chart-simple"></i></div>
            <span>Rank</span>
        </div>
        <div class="nav-item" onclick="switchTab('invite', this)">
            <div class="nav-icon"><i class="fas fa-user-plus"></i></div>
            <span>Team</span>
        </div>
        <div class="nav-item" onclick="switchTab('wallet', this)">
            <div class="nav-icon"><i class="fas fa-wallet"></i></div>
            <span>Wallet</span>
        </div>
    </div>

    <!-- Overlay / Loader (For Ads) -->
    <div id="adOverlay" class="ad-overlay">
        <div class="loader-ring"></div>
        <h3 class="blink-text">LOADING...</h3>
    </div>
    
    <!-- MODALS -->
    <!-- Initial Verification -->
    <div id="initialVerificationModal" class="modal-backdrop" style="display: none;">
        <div class="cyber-modal">
            <div class="holo-icon"><i class="fas fa-robot"></i></div>
            <h2 id="initialModalTitle">IDENTIFICATION</h2> 
            <p id="initialModalDesc">Bot Verification Required.</p> 
            <button class="cyber-btn-small" id="joinBotBtn" onclick="handleVerificationButtonClick()">VERIFY IDENTITY</button>
            <p id="verificationTip" class="tiny-text">(Join bot & click Exit)</p>
        </div>
    </div>

    <!-- Reward Modal -->
    <div id="rewardModal" class="modal-backdrop">
        <div class="cyber-modal">
            <div class="reward-burst"></div>
            <div id="modalIconContainer" class="modal-icon-glow"></div>
            <h2 class="reward-title neon-text-blue">SUCCESS</h2> 
            <div class="reward-amount-text glitch-text" id="popupAmount">+50</div>
            <p class="reward-desc">Transaction Verified</p> 
            <button class="cyber-btn-small" id="modalClaimBtn">ACKNOWLEDGE</button>
        </div>
    </div>
    
    <!-- Status Modal (Used for Ban/Unban/Withdraw Success) -->
    <div id="statusModal" class="modal-backdrop">
        <div class="cyber-modal">
            <div id="statusIconContainer"></div>
            <h2 id="statusTitle"></h2>
            <p id="statusDesc"></p>
            <button id="statusBtn" class="cyber-btn-small"></button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="modal-backdrop" onclick="if(event.target.id === 'historyModal') hideHistoryModal()">
        <div class="cyber-modal large-modal">
            <i class="fas fa-times close-modal" onclick="hideHistoryModal()"></i>
            <h2 class="reward-title">DATA LOGS</h2>
            <div class="history-scroll-area">
                <div id="historyListContainer"></div>
            </div>
        </div>
    </div>

    <!-- Tournament List Modal -->
    <div id="tournamentListModal" class="modal-backdrop" onclick="if(event.target.id === 'tournamentListModal') hideTournamentListModal()">
        <div class="cyber-modal large-modal">
            <i class="fas fa-times close-modal" onclick="hideTournamentListModal()"></i>
            <h2 class="reward-title neon-text-gold">TOURNAMENT</h2>
            <div id="tournListModalCountdown" style="color: #00f0ff; margin-bottom: 15px; font-family: 'Orbitron';"></div>
            
            <div id="currentUserTournamentSummary"></div>

            <button class="cyber-btn-small btn-blue" style="margin-bottom: 15px;" onclick="showRulesModal()">RULES OF ENGAGEMENT</button>
            <div class="history-scroll-area">
                <div id="tournamentLeaderboardList"></div>
            </div>
            <button class="cyber-btn-small" id="listModalJoinBtn" onclick="showJoinTournamentModal(true)" style="margin-top: 15px; display: none;">ENTER TOURNAMENT</button>
        </div>
    </div>

    <!-- Join Tournament Modal -->
    <div id="joinTournamentModal" class="modal-backdrop" onclick="if(event.target.id === 'joinTournamentModal') hideJoinTournamentModal()">
        <div class="cyber-modal">
            <i class="fas fa-times close-modal" onclick="hideJoinTournamentModal()"></i>
            <div class="holo-icon" style="color:gold;"><i class="fas fa-trophy"></i></div>
            <h2 class="reward-title">CHALLENGE MODE</h2> 
            <p class="reward-desc" id="joinModalDesc">Compete for the ultimate prize.</p> 
            <button class="cyber-btn-small btn-blue" style="margin-bottom:10px;" onclick="showRulesModal()">READ PROTOCOLS</button>
            <button class="cyber-btn-small" id="joinTournamentBtn" onclick="joinTournament()">ACCEPT CHALLENGE</button>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="modal-backdrop" onclick="if(event.target.id === 'rulesModal') hideRulesModal()">
        <div class="cyber-modal large-modal">
            <i class="fas fa-times close-modal" onclick="hideRulesModal()"></i>
            <h2 class="reward-title">PROTOCOLS</h2>
            <div class="history-scroll-area" style="text-align: left; color: #ccc; font-family: 'Rajdhani';">
                <div id="tournamentRulesContent">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Prize Collect Modal -->
    <div id="prizeCollectModal" class="modal-backdrop">
        <div class="cyber-modal">
            <div class="reward-burst" style="background: radial-gradient(circle, gold 0%, transparent 70%);"></div>
            <div class="holo-icon"><i class="fas fa-crown"></i></div>
            <h2 class="reward-title neon-text-gold" id="prizeModalTitle">VICTORY</h2> 
            <p class="reward-desc" id="prizeModalDesc"></p> 
            <div class="reward-amount-text" id="prizePopupAmount" style="color: gold;"></div>
            <button class="cyber-btn-small" id="prizeCollectBtn" onclick="claimTournamentPrize(window.tournamentPrizeAmount)">CLAIM BOUNTY</button>
        </div>
    </div>

    <!-- NEW: Network Selection Modal (Full Screen Centered) -->
    <!-- The outer div's onclick closes the modal if the user clicks the backdrop -->
    <div id="networkSelectionModal" class="modal-backdrop" onclick="if(event.target.id === 'networkSelectionModal' || event.target.className === 'close-modal-icon') closeNetworkSelectionModal()">
        <!-- Added network-modal-style for size/scroll override -->
        <div class="cyber-modal large-modal network-modal-style"> 
            <i class="fas fa-times close-modal-icon" onclick="closeNetworkSelectionModal()"></i>
            <h2 class="reward-title">SELECT Method</h2>
            
            <div id="networkOptionsContainer" class="network-options-container modal-scroll-area">
                <!-- Dynamic capsules will be generated here by script.js -->
            </div>
        </div>
    </div>

    <!-- Main Logic Script -->
    
    <script>
        
        /* --- START OF BACKEND-FOCUSED script.js --- */

// <--- বাংলায় কমেন্ট: ১. API BASE URL (আপনার Render.com অ্যাপের URL দিয়ে এটি পরিবর্তন করুন!)
const API_BASE_URL = "https://coin-flux-backend.onrender.com/api"; 
let AUTH_TOKEN = localStorage.getItem('auth_token') || null;

// <--- বাংলায় কমেন্ট: ২. প্রাথমিক তথ্য ও ডেটা স্টেট
const BOT_USERNAME = "testnewearningminiapp1_bot"; 
const tg = window.Telegram.WebApp;
tg.expand();

let uid, username, firstName, lastName; 
if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
    const user = tg.initDataUnsafe.user;
    uid = user.id.toString();
    firstName = user.first_name;
    lastName = user.last_name || ''; 
    username = user.username || firstName;
} else {
    // Fallback for browser testing (REMOVE FOR PRODUCTION)
    uid = localStorage.getItem('test_uid');
    if(!uid) { uid = 'U'+Math.floor(Math.random()*99999); localStorage.setItem('test_uid', uid); }
    firstName = "Test"; lastName = "User"; username = "TestUser";
}
const userFullName = (firstName + ' ' + lastName).trim();
const BOT_BASE_LINK = `https://t.me/${BOT_USERNAME}`; 

// Dynamic State Variables (Server-Driven)
let currentBalance = 0;
let adsWatchedToday = { monetag: 0, adsgram: 0, onclicka: 0 }; 
let cooldownEndTime = { monetag: 0, adsgram: 0, onclicka: 0 }; 
let totalAdsWatched = 0; 
let referralCount = 0; 
let referralEarnings = 0;
let completedTasks = [];
let activeTasks = [];
let lastDailyClaimDate = null;
let isBotVerified = false;
let isBanned = false;
let seenUnbanPopup = true;

// Tournament State
window.userTournamentRank = null;
window.hasJoinedTournament = false;
window.hasClaimedPrize = false;
window.tournamentReferees = 0;
let isTournamentActive = false;
let tournamentEndTime = 0;

// Local UI Timer Intervals
let cooldownIntervals = {}; 
let tournamentCountdownInterval = null; 
let activeTaskTimeout = null; 
let activeMissionId = null; 

// Settings object (Populated from API)
let settings = {}; 
const USD_PER_COIN = 0.20 / 5000; 
const pageSize = 20;
let activeReferralsData = [], completedReferralsData = [];
let activeRefPage = 1, completedRefPage = 1;


// --- API HELPER FUNCTION ---
async function secureApiCall(endpoint, method = 'GET', body = null) {
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
    };
    
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    
    const response = await fetch(`${API_BASE_URL}/${endpoint}`, config);
    const data = await response.json();
    
    if (response.status === 401 || response.status === 403) {
        // Token expired or invalid. Force re-auth.
        localStorage.removeItem('auth_token');
        AUTH_TOKEN = null;
        // Optionally show a session expired modal
    }
    
    if (!data.success) {
        throw new Error(data.message || "Unknown API error.");
    }

    return data;
}

// ----------------------------------------------------
// --- ৩. প্রমাণীকরণ এবং ডেটা লোড ---
// ----------------------------------------------------

async function initializeAuthentication() {
    if (!tg.initData) return;

    try {
        if (AUTH_TOKEN) {
             // Try to fetch data with existing token first
             await fetchInitialData();
             return;
        }

        // Perform server-side initData validation and get JWT
        const authData = await secureApiCall('user/auth', 'POST', { initData: tg.initData });
        
        AUTH_TOKEN = authData.token;
        localStorage.setItem('auth_token', AUTH_TOKEN);
        
        // Update user info from local variables
        document.getElementById('uidDisplay').innerText = uid;
        document.getElementById('username').innerText = userFullName || firstName;
        document.getElementById('refLink').innerText = `${BOT_BASE_LINK}?startapp=${uid}`;

        // If user is new and came via referral, show verification
        if (authData.requiresVerification) {
            showInitialVerificationModal('join');
        } else {
             // Fetch initial data now that we have a valid token
            await fetchInitialData();
        }

    } catch (e) {
        console.error("Authentication/Initialization Failed:", e.message);
        // Show generic error or force restart
    }
}

async function fetchInitialData() {
    try {
        const data = await secureApiCall('user/data');
        const userData = data.data.user;
        const settingsData = data.data.settings;
        
        // --- State Update ---
        Object.assign(settings, settingsData);
        currentBalance = userData.balance || 0;
        cooldownEndTime = {
            monetag: userData.ad_cooldown_end_time || 0,
            adsgram: userData.adsgram_cooldown_end_time || 0,
            onclicka: userData.onclicka_cooldown_end_time || 0,
        };
        adsWatchedToday = {
            monetag: userData.ads_watched || 0,
            adsgram: userData.adsgram_ads_watched || 0,
            onclicka: userData.onclicka_ads_watched || 0,
        };
        totalAdsWatched = userData.total_ads_watched || 0;
        referralCount = userData.referral_count || 0;
        referralEarnings = userData.referral_earnings || 0;
        completedTasks = userData.completed_tasks || [];
        lastDailyClaimDate = userData.last_daily_claim_date || null;
        isBotVerified = userData.is_verified_bot_joined || false;
        isBanned = userData.is_banned || false;
        seenUnbanPopup = userData.seen_unban_popup || false;

        // Tournament Update
        window.userTournamentRank = userData.tournament_data?.rank || null;
        window.hasClaimedPrize = userData.tournament_data?.claimed_prize || false;
        window.tournamentReferees = userData.tournament_referral_count || 0;
        isTournamentActive = settingsData.is_tournament_active || false;
        tournamentEndTime = settingsData.tournament_end_time || 0;
        
        // Active Tasks (Server already filtered)
        activeTasks = data.data.activeTasks || [];

        // <--- বাংলায় কমেন্ট: Ban/Unban/Prize Claim চেক
        if (isBanned) return showBanPopup();
        if (!seenUnbanPopup && !isBanned) return showUnbanPopup();
        
        const now = Date.now();
        if (!isTournamentActive && tournamentEndTime && now > tournamentEndTime && window.userTournamentRank !== null && !window.hasClaimedPrize) {
            checkAndShowPrizeModal();
        }

        // <--- বাংলায় কমেন্ট: UI Initializer
        initApp();
        
    } catch (e) {
        console.error("Data Fetch Failed:", e.message);
        showErrorModal('SYNC ERROR', 'Could not load data from server. Try refreshing.', 'cloud-meatball');
    }
}

// ----------------------------------------------------
// --- ৪. UI আপডেটার ফাংশন (সেটিংস লোড হওয়ার পর) ---
// ----------------------------------------------------

function applySettingsToUI() {
    // Monetag (Zone 1)
    document.getElementById('limitDisplay').innerText = settings.daily_limit;
    document.getElementById('adCardTitle').innerText = settings.ad_card_title;
    let adDescText = settings.ad_card_desc.replace('{{reward_per_ad}}', settings.reward_per_ad).replace('Credits', 'Coins'); 
    document.getElementById('adCardDesc').innerHTML = adDescText.replace(`${settings.reward_per_ad}`, `<span class="neon-text" id="rewardAmountDisplay">${settings.reward_per_ad}</span>`);
    document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <span class="flare"></span>`;

    // Adsgram (Zone 2)
    document.getElementById('adsgramLimitDisplay').innerText = settings.adsgram_daily_limit;
    let adsgramDescText = settings.adsgram_card_desc.replace('{{adsgram_reward}}', settings.adsgram_reward).replace('Credits', 'Coins'); 
    document.getElementById('adsgramCardDesc').innerHTML = adsgramDescText.replace(`${settings.adsgram_reward}`, `<span class="neon-text" id="adsgramRewardDisplay">${settings.adsgram_reward}</span>`);
    document.getElementById('adsgramCardTitle').innerText = settings.adsgram_card_title;
    document.getElementById('watchAdsgramBtn').innerHTML = `${settings.adsgram_btn_text} <span class="flare"></span>`;
    
    // Onclicka (Zone 3)
    document.getElementById('onclickaLimitDisplay').innerText = settings.onclicka_daily_limit;
    let onclickaDescText = settings.onclicka_card_desc.replace('{{onclicka_reward}}', settings.onclicka_reward).replace('Credits', 'Coins'); 
    document.getElementById('onclickaCardDesc').innerHTML = onclickaDescText.replace(`${settings.onclicka_reward}`, `<span class="neon-text" id="onclickaRewardDisplay">${settings.onclicka_reward}</span>`);
    document.getElementById('onclickaCardTitle').innerText = settings.onclicka_card_title;
    document.getElementById('watchOnclickaBtn').innerHTML = `${settings.onclicka_btn_text} <span class="flare"></span>`;

    // General
    document.getElementById('dailyRewardAmountDisplay').innerText = `+${settings.daily_reward_amount} Coins`; 
    document.getElementById('missionsSectionTitle').innerHTML = settings.missions_section_title + ' <div class="line"></div>';
    document.getElementById('inviteSectionTitle').innerHTML = settings.invite_section_title + ' <div class="line"></div>';
    document.getElementById('walletSectionTitle').innerHTML = settings.wallet_section_title + ' <div class="line"></div>';

    // Invite Section Texts
    document.querySelector('#invite-section .glass-panel h3').innerText = settings.ref_title || 'Recruit Agents';
    document.querySelector('#invite-section .glass-panel p').innerText = settings.ref_desc || 'Share encrypted link!';
    document.getElementById('ref-count').innerText = referralCount;
    document.getElementById('ref-earned').innerText = referralEarnings;
    adjustRefStatSize('ref-count');
    adjustRefStatSize('ref-earned');

    // Withdraw
    document.getElementById('withdrawTitle').innerText = settings.withdraw_title;
    document.getElementById('withdrawDesc').innerHTML = settings.withdraw_desc.replace('{{min_withdraw}}', settings.min_withdraw);
    document.getElementById('requestWithdrawBtn').innerText = settings.request_withdraw_btn_text; 
    document.getElementById('withdrawAmount').placeholder = settings.withdraw_amount_placeholder || 'Enter Amount'; 
    populateWithdrawMethods(settings.pay_methods); 
    
    // Tournament
    document.getElementById('toprefSectionTitle').innerHTML = settings.topref_section_title + ' <div class="line"></div>';
}

function initApp() {
    if (!isBotVerified && (tg.initDataUnsafe.start_param)) {
        // If server says not verified and we came via referral, stay on verification modal
        return showInitialVerificationModal('join');
    }
    document.getElementById('initialVerificationModal').style.display = 'none'; 
    applySettingsToUI();
    updateUI(); updateDailyRewardUI(); renderTasks(); 
    
    // Call render functions for active section
    const activeSectionId = document.querySelector('.page-section.active-section').id;
    if(activeSectionId === 'invite-section') fetchReferrals();
    if(activeSectionId === 'topref-section') fetchLeaderboard();
    if(activeSectionId === 'wallet-section') fetchWithdrawalHistory();
}

// ----------------------------------------------------
// --- ৫. Ad & Cooldown লজিক (Client-Side UI) ---
// ----------------------------------------------------

function startCooldownTimer(provider, endTime) {
    if (cooldownIntervals[provider]) clearInterval(cooldownIntervals[provider]); 
    
    const btnId = `watch${provider.charAt(0).toUpperCase() + provider.slice(1)}Btn`;
    const btn = document.getElementById(btnId);
    if (!btn) return;

    btn.classList.add('disabled'); 
    btn.onclick = 'void(0)';

    cooldownIntervals[provider] = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(cooldownIntervals[provider]); 
            delete cooldownIntervals[provider];
            btn.classList.remove('disabled'); 
            updateUI(); // Redraw button to normal state
            return;
        }
        const seconds = Math.floor(remaining / 1000); 
        btn.innerHTML = `COOLDOWN: ${seconds}s`;
    }, 1000);
}

function updateUI() {
    const now = Date.now();
    
    // Balance
    document.getElementById('balance').innerText = currentBalance;
    updateUsdDisplay(currentBalance);
    adjustBalanceFontSize();

    ['monetag', 'adsgram', 'onclicka'].forEach(provider => {
        const pUpper = provider.charAt(0).toUpperCase() + provider.slice(1);
        const btnId = `watch${pUpper}Btn`;
        const countId = `${provider}Count`;
        const limitId = `${provider}LimitDisplay`;
        const progressId = `${provider}ProgressBar`;
        const msgId = `${provider}CompletedMsg`;
        const limitKey = provider === 'monetag' ? 'daily_limit' : (provider === 'adsgram' ? 'adsgram_daily_limit' : 'onclicka_daily_limit');
        const btnTextKey = provider === 'monetag' ? 'ad_btn_text' : (provider === 'adsgram' ? 'adsgram_btn_text' : 'onclicka_btn_text');
        
        const limit = settings[limitKey] || 0;
        const count = adsWatchedToday[provider];
        const cooldown = cooldownEndTime[provider];
        const btn = document.getElementById(btnId);

        if (!btn || !document.getElementById(countId)) return;
        
        document.getElementById(countId).innerText = count;
        document.getElementById(progressId).style.width = ((count / limit) * 100) + '%';
        
        const isOnCooldown = now < cooldown;
        const isLimitReached = count >= limit;

        if (isOnCooldown) {
            startCooldownTimer(provider, cooldown);
        } else if (isLimitReached) {
            btn.classList.add('disabled'); 
            btn.innerText = 'LIMIT REACHED'; 
            document.getElementById(msgId).style.display = 'block';
            btn.onclick = 'void(0)';
        } else {
            btn.classList.remove('disabled'); 
            document.getElementById(msgId).style.display = 'none';
            // Onclicka special logic remains client-side for SDK state check
            if(provider === 'onclicka' && (!window.showOnclicka || typeof window.showOnclicka !== 'function')) {
                 btn.classList.add('disabled');
                 btn.innerText = 'INITIALIZING...'; // Will be set to RETRY by switchAdTab if needed
            } else {
                 btn.innerHTML = `${settings[btnTextKey]} <span class="flare"></span>`;
                 btn.onclick = () => startAdFlow(provider);
            }
        }
    });
}

function updateDailyRewardUI() {
    const btn = document.getElementById('dailyClaimBtn');
    if (!btn) return;
    const today = new Date().toDateString(); 

    if (lastDailyClaimDate === today) { 
        btn.classList.add('disabled'); 
        btn.innerText = 'LOGGED'; 
        btn.onclick = 'void(0)'; 
        btn.disabled = true;
    } else { 
        btn.classList.remove('disabled'); 
        btn.innerText = 'CHECK-IN'; 
        btn.onclick = claimDailyReward; 
        btn.disabled = false; 
        btn.classList.remove('btn-claim');
    }
}

// ----------------------------------------------------
// --- ৬. API Call Functions (Ad, Claims, Withdraw) ---
// ----------------------------------------------------

// <--- বাংলায় কমেন্ট: Ad Flow - Monetag/Adsgram/Onclicka
function startAdFlow(provider) { 
    if (!isBotVerified) return;
    const now = Date.now();
    if (now < cooldownEndTime[provider]) { updateUI(); return; } // Client-side quick-check

    const pUpper = provider.charAt(0).toUpperCase() + provider.slice(1);
    const btnId = `watch${pUpper}Btn`;
    const btn = document.getElementById(btnId);
    
    // 1. SDK-Specific Logic (Still client-side)
    const sdkFunc = provider === 'adsgram' ? startAdsgramFlow : (provider === 'onclicka' ? startOnclickaFlow : startMonetagFlow);

    // 2. Wrap SDK Call in a promise
    const sdkPromise = new Promise((resolve, reject) => {
         if (provider === 'adsgram' || provider === 'onclicka') {
             // For Adsgram/Onclicka, the function wrapper needs to handle success/fail
             sdkFunc(resolve, reject); 
         } else {
             // For Monetag, the function must resolve/reject directly or wrap it
             sdkFunc(resolve, reject); 
         }
    });

    // 3. Start UI Overlay
    document.getElementById('adOverlay').style.display = 'flex'; 
    btn.classList.add('disabled'); 
    btn.innerHTML = 'CONNECTING...'; 

    sdkPromise.then(() => { 
        // 4. On SDK Success (Ad Viewed) -> Call Backend to claim reward
        document.getElementById('adOverlay').style.display = 'none'; 
        const reward = settings[`${provider === 'monetag' ? 'reward_per_ad' : provider + '_reward'}`];
        showRewardModal('ad', reward, null, provider); // Will call executeAdRewardTransaction() on modal button click
    }).catch((e) => { 
        // 5. On SDK Failure
        document.getElementById('adOverlay').style.display = 'none'; 
        showErrorModal('FAILED', e.message || 'Connection lost.', 'times-circle'); 
        updateUI(); // Restore button
    });
}

// <--- বাংলায় কমেন্ট: SDK-Specific Wrappers (Must handle resolve/reject)
function startMonetagFlow(resolve, reject) {
    const adCode = settings.monetag_ad_code;
    const adFunc = window[adCode];
    if (!adFunc || typeof adFunc !== 'function') { return reject(new Error('System not ready.')); }
    
    // Simulate Monetag flow completion
    adFunc().then(resolve).catch(reject);
}

function startAdsgramFlow(resolve, reject) {
    const blockId = settings.adsgram_block_id || "int-18699"; 
    if (!window.Adsgram) { return reject(new Error('Module missing.')); }
    const AdController = window.Adsgram.init({ blockId: blockId });
    AdController.show().then(resolve).catch(() => reject(new Error('Link terminated.')));
}

function startOnclickaFlow(resolve, reject) {
    if (!window.showOnclicka || typeof window.showOnclicka !== 'function') { return reject(new Error('Node not found. Retry init.')); }
    window.showOnclicka().then(resolve).catch(() => reject(new Error('Node rejected.')));
}

// <--- বাংলায় কমেন্ট: ব্যাকএন্ডে রিওয়ার্ড ক্লেইমের চূড়ান্ত ফাংশন
function executeAdRewardTransaction(amount, provider) {
    const btnId = `watch${provider.charAt(0).toUpperCase() + provider.slice(1)}Btn`;
    const btn = document.getElementById(btnId);
    
    fetch(`${API_BASE_URL}/ad/watch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${AUTH_TOKEN}` },
        body: JSON.stringify({ provider: provider })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const result = data.data;
            animateBalance(currentBalance, result.newBalance);
            currentBalance = result.newBalance;
            adsWatchedToday[provider] = result.newAdsWatched;
            cooldownEndTime[provider] = result.cooldownEndTime;
            updateUI(); 
        } else {
            showErrorModal('CLAIM FAILED', data.message, 'times-circle');
            updateUI();
        }
    })
    .catch(err => {
        showErrorModal('NETWORK ERROR', 'Could not process reward.', 'exclamation-circle');
        updateUI();
    });
}

// <--- বাংলায় কমেন্ট: Daily Claim লজিক
function claimDailyReward() {
    document.getElementById('dailyClaimBtn').disabled = true;
    
    secureApiCall('ad/daily-claim', 'POST')
        .then(data => {
            const reward = settings.daily_reward_amount;
            showRewardModal('daily', reward, null, null, document.getElementById('dailyClaimBtn'), data.data.newBalance); // Pass newBalance
        })
        .catch(e => {
            showErrorModal('CLAIM ERROR', e.message, 'clock');
            updateDailyRewardUI(); // Re-enable button
        });
}

// <--- বাংলায় কমেন্ট: Task Claim লজিক
function startTask(id, link, reward, waitTime = 5) {
    if (activeTaskTimeout) { return showErrorModal('FIELD MISSION', 'Another mission is in progress.', 'clock'); }
    
    window.open(link, '_blank'); 
    const btn = document.getElementById(`btn-${id}`);
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
    btn.disabled = true; 

    const totalWaitTimeMs = (waitTime > 0 ? waitTime : 5) * 1000 + 1500;

    activeMissionId = id; 
    
    activeTaskTimeout = setTimeout(() => { 
        activeTaskTimeout = null; 
        activeMissionId = null; 
        
        // Final check (client side)
        if (completedTasks.includes(id)) { 
            btn.innerHTML = 'LOGGED'; 
            btn.className = 'cyber-btn-small disabled'; 
            return; 
        } 
        
        btn.innerHTML = 'CLAIM'; 
        btn.disabled = false; 
        btn.classList.add('btn-claim');
        
        btn.onclick = function() { 
            // Call reward modal which calls backend function
            showRewardModal('mission', reward, id, null, btn); 
        }; 
        
    }, totalWaitTimeMs); 
}

// <--- বাংলায় কমেন্ট: টাস্ক কমপ্লিট ট্রানজ্যাকশন
function executeTaskRewardTransaction(taskId, taskButtonEl) {
    secureApiCall('ad/task-complete', 'POST', { taskId: taskId })
        .then(data => {
            const result = data.data;
            animateBalance(currentBalance, result.newBalance);
            currentBalance = result.newBalance;
            completedTasks.push(taskId); // Update local state
            
            if (taskButtonEl) {
                taskButtonEl.innerHTML = 'LOGGED'; 
                taskButtonEl.className = 'cyber-btn-small disabled';
                taskButtonEl.disabled = true; 
            }
            
            // Re-render tasks to reflect new status
            renderTasks(); 
        })
        .catch(e => {
            showErrorModal('CLAIM FAILED', e.message, 'times-circle');
            if (taskButtonEl) { taskButtonEl.innerHTML = 'CLAIM'; taskButtonEl.classList.remove('disabled'); taskButtonEl.disabled = false; }
        });
}

// <--- বাংলায় কমেন্ট: Withdraw Request লজিক
function requestWithdraw() {
    const method = document.getElementById('withdrawMethodValue').value; 
    const accNum = document.getElementById('accountNumber').value.trim();
    const amount = document.getElementById('withdrawAmount').value;

    const withdrawBtn = document.getElementById('requestWithdrawBtn');
    withdrawBtn.disabled = true;
    withdrawBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

    secureApiCall('transaction/request', 'POST', { amount: amount, method: method, accNum: accNum })
        .then(data => {
            showCustomSuccessModal(settings.withdraw_success_title, settings.withdraw_success_desc, 'check-circle'); 
            
            // Clear UI elements
            document.getElementById('withdrawAmount').value = ''; 
            document.getElementById('accountNumber').value = ''; 
            document.getElementById('withdrawMethodValue').value = ''; 
            document.getElementById('selectedNetworkText').innerText = 'Select Withdraw Method'; 
            selectedMethodValue = ''; selectedWithdrawalMethod = null;
            toggleAccountInput('');
            
            // Note: currentBalance and other user stats will be updated on next full data fetch/reload
            
            withdrawBtn.disabled = false;
            withdrawBtn.innerHTML = settings.request_withdraw_btn_text;

        })
        .catch(e => { 
            showErrorModal("WITHDRAW ERROR", e.message, 'exclamation-triangle'); 
            withdrawBtn.disabled = false;
            withdrawBtn.innerHTML = settings.request_withdraw_btn_text;
        });
}

// <--- বাংলায় কমেন্ট: Referral Bonus Claim লজিক
function claimReferralBonus(referredUid, amount) {
    const btn = document.getElementById(`ref-btn-${referredUid}`); 
    btn.innerHTML = '...'; btn.disabled = true;

    secureApiCall('user/claim-referral', 'POST', { referredUid: referredUid })
        .then(data => {
            window.referredIdToClaim = referredUid; 
            window.rewardAmountToClaim = data.data.reward;
            showRewardModal('referral', data.data.reward, referredUid, null, btn, data.data.newBalance); 
        })
        .catch(e => {
            showErrorModal('CLAIM ERROR', e.message, 'hand-point-up'); 
            btn.innerHTML = 'PENDING'; btn.classList.add('disabled'); btn.disabled = true;
        });
}

// ----------------------------------------------------
// --- ৭. Modal & UI Helpers ---
// ----------------------------------------------------

function showRewardModal(type, amount, id, provider = null, taskButtonEl = null, newBalance = currentBalance + amount) {
    let title = 'SUCCESS'; let desc = 'Transaction Verified.';
    
    if (type === 'ad') { title = settings.ad_popup_title; desc = settings.ad_popup_desc; }
    else if (type === 'daily') { title = settings.daily_popup_title; desc = settings.daily_popup_desc; }
    else if (type === 'mission') { title = settings.mission_popup_title; desc = settings.mission_popup_desc; }
    else if (type === 'referral') { title = 'BONUS CLAIMED'; desc = 'Referral bounty processing.'; } 

    const modal = document.getElementById('rewardModal');
    document.getElementById('modalIconContainer').innerHTML = `<div class="modal-main-icon text-gold"><i class="fas fa-coins"></i></div>`;
    modal.querySelector('.reward-title').innerText = title;
    modal.querySelector('.reward-title').className = 'reward-title text-cyan';
    modal.querySelector('.reward-desc').innerText = desc; 
    document.getElementById('popupAmount').innerText = '+' + amount;
    document.getElementById('popupAmount').style.display = 'block';
    document.getElementById('popupAmount').className = 'reward-amount-text text-gold'; 
    modal.style.display = 'flex';

    const btn = document.getElementById('modalClaimBtn');
    btn.onclick = null; 
    btn.innerText = settings.modal_claim_btn_text; 
    
    btn.onclick = function(e) {
        modal.style.display = 'none';
        
        spawnFlyingCoins(e, () => {
             // 1. Start the visual balance animation after coins land
             animateBalance(currentBalance, newBalance);
             currentBalance = newBalance; // Set local state immediately for accuracy
             
             // 2. Execute the database transaction
             if (type === 'ad') { executeAdRewardTransaction(amount, provider); }
             else if (type === 'mission') { executeTaskRewardTransaction(id, taskButtonEl); }
             else if (type === 'daily') { 
                 lastDailyClaimDate = new Date().toDateString();
                 updateDailyRewardUI(); 
             } 
             else if (type === 'referral') { 
                // executeClaimReferralBonus(id); // Already claimed via API, just fetch new data
                fetchReferrals(); // Update referral list
             }
        });
    };
}


// ... other UI/Modal helper functions (showErrorModal, showCustomSuccessModal, etc.)

function showErrorModal(title, desc, iconName) {
    const modal = document.getElementById('rewardModal');
    document.getElementById('modalIconContainer').innerHTML = `<div class="modal-main-icon text-red"><i class="fas fa-${iconName}"></i></div>`;
    document.getElementById('popupAmount').style.display = 'none'; 
    const titleEl = modal.querySelector('.reward-title');
    titleEl.innerText = title; titleEl.className = 'reward-title text-red';
    modal.querySelector('.reward-desc').innerHTML = desc; 
    modal.style.display = 'flex';
    const btn = document.getElementById('modalClaimBtn');
    btn.innerText = settings.error_modal_btn_text; 
    btn.onclick = () => modal.style.display = 'none';
}

function showCustomSuccessModal(title, desc, iconName) {
    const modal = document.getElementById('statusModal'); 
    document.getElementById('statusIconContainer').innerHTML = `<div class="modal-main-icon" style="color:#2ecc71; text-shadow: 0 0 15px rgba(46, 204, 113, 0.6);"><i class="fas fa-${iconName}"></i></div>`;
    const titleEl = document.getElementById('statusTitle');
    titleEl.innerText = title; 
    titleEl.style.color = '#2ecc71'; 
    titleEl.className = 'reward-title text-cyan'; 
    document.getElementById('statusDesc').innerText = desc;
    const btn = document.getElementById('statusBtn'); 
    btn.innerText = settings.withdraw_success_btn_text; 
    btn.className = 'cyber-btn-small btn-claim'; 
    btn.onclick = function() { modal.style.display = 'none'; fetchInitialData(); }; // Full data refresh
    modal.style.display = 'flex';
}

function showBanPopup() {
    // Logic remains the same, but fetch settings before displaying
    if(!settings.ban_popup_title) return;
    const modal = document.getElementById('statusModal'); 
    document.getElementById('statusIconContainer').innerHTML = `<div class="holo-icon" style="color:red"><i class="fas fa-ban"></i></div>`;
    document.getElementById('statusTitle').innerText = settings.ban_popup_title; document.getElementById('statusTitle').style.color = 'red';
    document.getElementById('statusDesc').innerText = settings.ban_popup_desc;
    const btn = document.getElementById('statusBtn'); btn.innerText = settings.ban_btn_text; btn.className = 'cyber-btn-small'; btn.style.background = '#e74c3c';
    btn.onclick = function() { tg.openTelegramLink(settings.support_url); }; modal.style.display = 'flex';
}
function showUnbanPopup() {
    // Logic remains the same, but fetch settings before displaying
    if(!settings.unban_popup_title) return;
    const modal = document.getElementById('statusModal'); 
    document.getElementById('statusIconContainer').innerHTML = `<div class="holo-icon" style="color:green"><i class="fas fa-check-circle"></i></div>`;
    document.getElementById('statusTitle').innerText = settings.unban_popup_title; document.getElementById('statusTitle').style.color = '#00ffaa';
    document.getElementById('statusDesc').innerText = settings.unban_popup_desc;
    const btn = document.getElementById('statusBtn'); btn.innerText = settings.unban_btn_text; btn.className = 'cyber-btn-small'; btn.style.background = '#2ecc71';
    // <--- বাংলায় কমেন্ট: সার্ভারকে জানাতে হবে যে ইউজার Unban Popup দেখেছে
    btn.onclick = function() { 
        secureApiCall('user/update-status', 'POST', { seenUnbanPopup: true })
            .then(() => { modal.style.display = 'none'; seenUnbanPopup = true; initApp(); })
            .catch(e => console.error("Unban Update Failed:", e));
    };
    modal.style.display = 'flex';
}

function updateVerificationModalUI(isVerified, state) {
    const joinBtn = document.getElementById('joinBotBtn');
    joinBtn.classList.remove('disabled'); joinBtn.disabled = false; document.getElementById('verificationTip').style.display = 'block';
    if (state === 'join') {
        document.getElementById('initialModalTitle').innerText = settings.initial_popup_title; 
        document.getElementById('initialModalDesc').innerText = settings.initial_popup_desc;
        joinBtn.innerHTML = `${settings.initial_popup_btn_text}`;
        joinBtn.onclick = handleVerificationButtonClick; 
    }
}
function showInitialVerificationModal(state) {
    if (isBotVerified) { initApp(); return; }
    updateVerificationModalUI(isBotVerified, 'join');
    document.getElementById('initialVerificationModal').style.display = 'flex';
}
function handleVerificationButtonClick() {
    const joinBtn = document.getElementById('joinBotBtn');
    if (joinBtn.innerText === settings.initial_popup_btn_text) {
        const botLink = settings.initial_popup_bot_link.trim() || BOT_BASE_LINK; tg.openTelegramLink(botLink.replace(/\/$/, ''));
        joinBtn.innerHTML = `${settings.initial_exit_btn_text}`; joinBtn.style.background = '#e74c3c'; 
        document.getElementById('initialModalDesc').innerText = settings.initial_exit_desc; 
    } else { 
        tg.close(); 
    }
}

// ----------------------------------------------------
// --- ৮. Renders and Data Fetchers (API-Based) ---
// ----------------------------------------------------

// <--- বাংলায় কমেন্ট: Tasks রেন্ডার (Initial Fetch-এর ডেটা ব্যবহার করে)
function renderTasks() {
    const activeContainer = document.getElementById('taskListContainer'); 
    const missionsTitle = document.getElementById('missionsSectionTitle'); 
    const completedContainer = document.getElementById('completedListContainer'); 
    const completedTitle = document.getElementById('completedMissionsTitle');
    
    let activeHtml = '', completedHtml = '';
    
    activeTasks.forEach(task => { // Use activeTasks from fetchInitialData
        const isCompleted = completedTasks.includes(task.id);
        
        let iconClass = task.type === 'telegram' ? 'fab fa-telegram-plane' : (task.type === 'youtube' ? 'fab fa-youtube' : 'fas fa-globe');
        const taskWaitTime = task.waitTime || 5; 
        
        let btnClass = isCompleted ? 'cyber-btn-small disabled' : 'cyber-btn-small', 
            btnText = isCompleted ? 'LOGGED' : 'START', 
            btnAction = isCompleted ? 'void(0)' : `startTask('${task.id}', '${task.link}', ${task.reward}, ${taskWaitTime})`;
        
        const cardHtml = `
        <div class="mission-capsule">
            <div class="capsule-left">
                <div class="capsule-icon"><i class="${iconClass}"></i></div>
                <div class="capsule-info">
                    <h4>${task.title}</h4>
                    <p>Bounty: ${task.reward} Coins</p>
                </div>
            </div>
            <button id="btn-${task.id}" class="${btnClass}" onclick="${btnAction}">${btnText}</button>
        </div>`;
        
        if (isCompleted) completedHtml += cardHtml; else activeHtml += cardHtml;
    });

    if (activeHtml === '') { activeContainer.innerHTML = ''; missionsTitle.style.display = 'none'; } 
    else { activeContainer.innerHTML = activeHtml; missionsTitle.style.display = 'flex'; }
    completedContainer.innerHTML = completedHtml; 
    completedTitle.style.display = completedHtml ? 'flex' : 'none';
}

// <--- বাংলায় কমেন্ট: Referrals রেন্ডার (API-এর মাধ্যমে ডেটা আনা হবে)
async function fetchReferrals(page = 1) {
    try {
        const data = await secureApiCall('user/referrals');
        // Assume API returns two lists: activeReferrals and completedReferrals
        activeReferralsData = data.data.activeReferrals || []; 
        completedReferralsData = data.data.completedReferrals || []; 
        
        // Sorting is done client-side or assume server sends sorted data
        activeRefPage = page; completedRefPage = 1; 
        updateReferralList(activeReferralsData, activeRefPage, 'active'); 
        updateReferralList(completedReferralsData, completedRefPage, 'completed');
    } catch (e) {
        // Handle error
    }
}
function updateReferralList(data, page, type) { /* ... existing logic ... */ }
function changeRefPage(type, newPage) { /* ... existing logic ... */ }


// <--- বাংলায় কমেন্ট: Leaderboard রেন্ডার (API-এর মাধ্যমে ডেটা আনা হবে)
async function fetchLeaderboard() {
    const container = document.getElementById('topReferralListContainer');
    const titleEl = document.getElementById('leaderboardTitle');
    const tourneyUI = document.getElementById('tournament-ui-container');

    container.innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Syncing...</p></div>`;

    if (isTournamentActive && Date.now() < tournamentEndTime) {
        tourneyUI.style.display = 'block';
        startTournamentCountdown(tournamentEndTime, 'tournamentTimerDisplay');
    } else {
        tourneyUI.style.display = 'none';
    }
    
    titleEl.innerHTML = 'ELITE AGENTS (Lifetime) <div class="line"></div>';

    try {
        const data = await secureApiCall('user/leaderboard/lifetime'); // API call for Lifetime Ranks
        let html = '';
        const filteredUsers = data.data.users || [];

        // ... render logic using filteredUsers ...
        filteredUsers.forEach((data, index) => {
             const rank = index + 1;
             const fullName = data.full_name || data.username || 'Unknown Agent'; 
             const referralCount = data.referral_count || 0;
             // ... HTML generation ...
             html += `
                <div class="top-ref-item">
                    <div class="ref-rank-badge rank-${rank <= 3 ? rank : ''}">${rank}</div>
                    <div class="ref-info"><h4>${fullName}</h4></div>
                    <div class="ref-count-pill">${referralCount} Refs</div>
                </div>`;
        });
        container.innerHTML = html;

    } catch (e) {
        container.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--text-muted);"><i class="fas fa-exclamation-triangle fa-2x"></i><p>Failed to load leaderboard.</p></div>`;
    }
}

// <--- বাংলায় কমেন্ট: Tournament Renders (API-এর মাধ্যমে ডেটা আনা হবে)
function showTournamentListModal() {
    if (!isTournamentActive) return;
    document.getElementById('tournamentListModal').style.display = 'flex';
    // ... countdown logic ...
    fetchTournamentLeaderboard(document.getElementById('tournamentLeaderboardList'), true);
}
async function fetchTournamentLeaderboard(container, isModal = false) {
    container.innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Loading Event Data...</p></div>`;
    
    try {
         const data = await secureApiCall('user/leaderboard/tournament');
         const participatingUsers = data.data.users || [];
         // ... render tournament leaderboard UI ...
         
    } catch (e) {
        // Handle error
    }
}

// <--- বাংলায় কমেন্ট: Tournament Join
function joinTournament() {
    document.getElementById('joinTournamentBtn').disabled = true;
    secureApiCall('transaction/join-tournament', 'POST')
        .then(() => {
            window.hasJoinedTournament = true;
            hideJoinTournamentModal();
            fetchLeaderboard(); // Refresh ranks
        })
        .catch(e => {
            showErrorModal('JOIN FAILED', e.message, 'times-circle');
            document.getElementById('joinTournamentBtn').disabled = false;
        });
}

// <--- বাংলায় কমেন্ট: Prize Claim
function claimTournamentPrize(amount) {
    const btn = document.getElementById('prizeCollectBtn');
    btn.disabled = true;
    
    // Animate coins before calling backend
    const rect = btn.getBoundingClientRect();
    const fakeEvent = { clientX: rect.left + rect.width/2, clientY: rect.top + rect.height/2 };
    document.getElementById('prizeCollectModal').style.display = 'none';

    spawnFlyingCoins(fakeEvent, () => {
        // Now call backend for transaction
        secureApiCall('transaction/claim-tournament', 'POST')
            .then(data => {
                const result = data.data;
                animateBalance(currentBalance, result.newBalance);
                currentBalance = result.newBalance;
                window.hasClaimedPrize = true;
            })
            .catch(e => {
                 showErrorModal('PRIZE FAILED', e.message, 'times-circle');
            });
    });
}


// <--- বাংলায় কমেন্ট: History Fetching (Withdrawal & Ads)
function showAdsHistoryModal() {
    const modal = document.getElementById('historyModal'); document.getElementById('historyListContainer').innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Fetching Logs...</p></div>`; 
    modal.style.display = 'flex'; fetchAdsHistory();
}
function fetchAdsHistory() {
    secureApiCall('user/history/ads')
        .then(data => {
            const logs = data.data.logs;
            // ... render history list using logs ...
            let html = `<div class="glass-panel" style="margin-bottom:10px; padding:10px; text-align: center;"><h4>LIFETIME ADS Viewed: <span style="color:#00f0ff">${totalAdsWatched}</span></h4></div>`;
             if (logs.length === 0) html += `<div style="text-align:center; padding: 30px; color: var(--text-muted);"><i class="fas fa-box-open fa-2x"></i><p>No logs found.</p></div>`;
            // ... loop through logs and generate HTML ...
            document.getElementById('historyListContainer').innerHTML = html;
        })
        .catch(e => {
            // Handle error
        });
}
function fetchWithdrawalHistory() {
    secureApiCall('user/history/withdrawal')
        .then(data => {
            const logs = data.data.logs;
            // ... render history list using logs ...
            document.getElementById('historyListContainer').innerHTML = 'Withdrawal history loaded.';
        })
        .catch(e => {
             // Handle error
        });
}

// ----------------------------------------------------
// --- ৯. DOMContentLoaded & Initialization ---
// ----------------------------------------------------

document.addEventListener("DOMContentLoaded", () => {
    startNetworkBasedLoading();
    
    // <--- বাংলায় কমেন্ট: ১ সেকেন্ড পর প্রমাণীকরণ শুরু
    setTimeout(initializeAuthentication, 1000); 
    
    // Init Tab UI only
    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
    document.getElementById('home-section').classList.add('active-section');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const homeNavItem = document.querySelector(`.cyber-nav .nav-item[onclick*="'home'"]`);
    if (homeNavItem) homeNavItem.classList.add('active');
    
    // <--- বাংলায় কমেন্ট: Onclicka SDK Loader ইনিশিয়ালাইজেশন
    if (settings.onclicka_spot_id) loadOnclickaSdk(settings.onclicka_spot_id);
});

// ... (All existing helper functions like switchAdTab, toggleAccountInput, adjustBalanceFontSize, spawnFlyingCoins, etc. remain here)

// <--- বাংলায় কমেন্ট: Monetag SDK Loader
function loadMonetagSdk(adCode) {
    const head = document.getElementsByTagName('head')[0];
    let script = document.createElement('script');
    script.src = '//libtl.com/sdk.js'; script.setAttribute('data-zone', adCode.replace('show_', '')); script.setAttribute('data-sdk', adCode);
    head.appendChild(script);
}

// <--- বাংলায় কমেন্ট: Onclicka SDK Loader
function loadOnclickaSdk(spotId) {
    if (window.showOnclicka) return; 
    if(window.initCdTma) {
        window.initCdTma({ id: spotId }).then(show => {
            window.showOnclicka = show;
            updateUI();
        }).catch(e => { updateUI(); });
    } else { updateUI(); }
}


// ... (The rest of the helper functions from the original index.html script, ensuring no Firebase calls remain)

/* --- END OF BACKEND-FOCUSED script.js --- */
        
    </script>
    
</body>
</html>