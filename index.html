<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tap 2 Earn</title>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <!-- NEW: Onclicka/tma.js SDK -->
    <script src="https://js.onclckvd.com/in-stream-ad-admanager/tma.js"></script>
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    
    <style>
        
        /* --- STYLES (Original Premium Design) --- */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --shadow: 0 4px 15px rgba(0,0,0,0.08);
    --bg-color: #f4f6f8;
    --card-bg: #ffffff;
    --progress-bg: #e0e0e0;
    --progress-fill: linear-gradient(90deg, #667eea, #764ba2);
    --red: #e74c3c; 
    --green: #2ecc71; 
}

/* Modals Active: Blur main content */
body.modal-active > .header, 
body.modal-active > .container, 
body.modal-active > .bottom-nav {
    filter: blur(5px);
    pointer-events: none;
    user-select: none;
}

body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: #333; overflow-x: hidden; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }

/* Header */
.header { background: var(--primary-gradient); padding: 20px 20px 35px 20px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; transition: filter 0.3s ease; }
.user-top-row { display: flex; justify-content: space-between; align-items: center; }
.user-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; backdrop-filter: blur(5px); }
.balance-display { text-align: center; margin-top: 15px; }

.balance-amount { 
    font-size: 2.2rem; font-weight: 700; 
    display: flex; align-items: center; justify-content: center; gap: 10px; 
    min-height: 60px;
    /* Counting Sparkle for animation */
    transition: all 0.1s ease;
}
.balance-amount.counting-sparkle {
    color: #ffd700;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    animation: countingPulse 0.15s infinite alternate; 
}

@keyframes countingPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.05); } 
}


/* Spinner */
.spinner {
    width: 30px; height: 30px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
}
.spinner-dark { border-color: #ddd; border-top-color: #764ba2; }

/* Container */
.container { padding: 0 20px; margin-top: -30px; position: relative; z-index: 5; transition: filter 0.3s ease; }
.page-section { display: none; padding: 10px 0; animation: fadeIn 0.3s ease; }
.page-section.active-section { display: block; }
.section-title { font-size: 1.1rem; font-weight: 600; color: #555; margin: 40px 0 10px 5px; }

/* --- NEW: AD NAVIGATION TABS --- */
.ad-nav-tabs {
    display: flex;
    background: white;
    padding: 5px;
    border-radius: 15px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
}
.ad-nav-item {
    flex: 1;
    text-align: center;
    padding: 5px;
    font-size: 0.8rem;
    font-weight: 600;
    color: #888;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 0; /* Ensures tabs fit better on smaller screens */
}
.ad-nav-item.active {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 3px 10px rgba(118, 75, 162, 0.3);
}

.ad-card-container { display: none; animation: slideUp 0.4s ease; }
.ad-card-container.active { display: block; }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Cards */
.card { 
    background: var(--card-bg); 
    border-radius: 20px; 
    padding: 20px; 
    box-shadow: var(--shadow); 
    text-align: center; 
    margin-bottom: 15px; 
    position: relative; 
}

.history-btn {
    position: absolute; top: 10px; right: 15px;
    background: rgba(118, 75, 162, 0.1); color: #764ba2;
    border: none; padding: 5px 10px; border-radius: 15px;
    font-size: 0.75rem; font-weight: 600; cursor: pointer; z-index: 10;
}

/* NEW: Tournament Button Style (Replacing history-btn visually in leaderboard card) */
.tournament-btn {
    background: rgba(255, 215, 0, 0.1); /* Light gold/yellow background */
    color: #ffaa00; /* Gold text */
    border: none;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    z-index: 10;
    transition: background 0.2s;
}
.tournament-btn:hover {
    background: rgba(255, 215, 0, 0.2);
}
/* End NEW */


/* Task Card */
.task-card {
    background: white; border-radius: 18px; padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px;
    display: flex; align-items: center; justify-content: space-between;
    text-align: left;
}
.task-left { display: flex; align-items: center; gap: 12px; }
.task-icon { 
    width: 45px; height: 45px; background: #f4f6f8; 
    border-radius: 12px; display: flex; align-items: center; justify-content: center; 
    color: #764ba2; font-size: 1.2rem;
}
.task-info h4 { margin: 0; font-size: 0.9rem; color: #333; font-weight: 600; }
.task-info p { margin: 2px 0 0; font-size: 0.75rem; color: #777; }

.task-btn {
    padding: 8px 16px; border-radius: 20px; border: none;
    font-size: 0.8rem; font-weight: 600; cursor: pointer; min-width: 75px;
    transition: 0.2s;
}
.btn-start { background: var(--primary-gradient); color: white; }
.btn-claim-task { 
    background: #4caf50; color: white; 
    animation: pulse 1s infinite; 
    border: 2px solid #2e8b57; /* Mission timer claim highlight */
}
.btn-done { background: #f0f0f0; color: #aaa; pointer-events: none; }

/* Referral List */
.ref-list-card { padding: 15px; justify-content: space-between; }
.ref-list-card .task-left { flex-grow: 1; min-width: 0; align-items: flex-start; }
.ref-list-card .ref-user-info { line-height: 1.2; overflow: hidden; white-space: normal; }
.ref-list-card .ref-user-info h4 { font-size: 0.95rem; margin-bottom: 2px; font-weight: 700; color: #333; }
.ref-list-card .ref-user-info p { font-size: 0.7rem; color: #999; margin: 0; }
.ref-join-date { font-size: 0.7rem; color: #555 !important; margin-top: 2px !important; font-weight: 400; }
.ref-actions { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 8px; margin-left: 10px; }
.ref-summary-right { display: flex; flex-direction: column; align-items: flex-end; min-width: 80px; text-align: right; }
.ref-reward-amount { font-size: 0.95rem; font-weight: 700; color: #764ba2; line-height: 1.2; margin-bottom: 4px; }
.ref-progress-text { font-size: 0.7rem; font-weight: 600; line-height: 1.2; }
.ref-list-card .task-btn { min-width: 80px; padding: 8px 10px; font-size: 0.75rem; margin-top: 0; }

/* Pagination */
.pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 20px 0; }
.page-btn { background: white; color: #764ba2; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; }
.page-btn:disabled { background: #f0f0f0; color: #ccc; cursor: not-allowed; }
.page-btn.active { background: #764ba2; color: white; border-color: #764ba2; }

/* Progress Bar */
.progress-wrapper { margin: 20px 0; text-align: left; }
.progress-info { display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; margin-bottom: 6px; font-weight: 600; }
.progress-track { width: 100%; height: 10px; background: var(--progress-bg); border-radius: 10px; overflow: hidden; }
.progress-bar { height: 100%; width: 0%; background: var(--progress-fill); border-radius: 10px; transition: width 0.5s ease; }

/* Buttons & Inputs */
.watch-btn, .btn-copy { background: var(--primary-gradient); color: white; border: none; padding: 12px 0; width: 100%; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); transition: transform 0.2s, opacity 0.3s; }
.watch-btn:active, .btn-copy:active { transform: scale(0.98); }
.watch-btn.disabled { background: #ccc; cursor: not-allowed; box-shadow: none; pointer-events: none; opacity: 0.7; }
.card.disabled-card { opacity: 0.8; }
.btn-copy { background: #333; border-radius: 12px; transition: background 0.3s ease; }

/* MODIFIED: Custom arrow for Select Field */
.wallet-input, .select-field { 
    width: 100%; padding: 12px; margin-bottom: 10px; 
    border: 1px solid #ddd; border-radius: 12px; 
    font-size: 0.95rem; background: #fff; 
    font-family: inherit; outline: none; box-sizing: border-box; 
    appearance: none; 
    -webkit-appearance: none; 
    -moz-appearance: none; 
}
/* NEW: Separating the Arrow styles ONLY for the select-field */
.select-field {
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20320%20512%22%3E%3Cpath%20fill%3D%22%23764ba2%22%20d%3D%22M137.4%20374.6c12.5%2012.5%2032.8%2012.5%2045.3%200l128-128c9.2-9.2%2011.9-22.9%206.9-34.9s-16.6-19.8-29.8-19.8H48.2c-13.1%200-24.8%207.8-29.8%2019.8s-2.3%2025.7%206.9%2034.9l128%20128z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 10px;
    padding-right: 40px;
}
.wallet-input:focus, .select-field:focus { border-color: #764ba2; }

/* Referral Stats */
.ref-stats { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; }
.ref-stat-item h3 { margin: 0; color: #764ba2; font-size: 1.5rem; }
.ref-stat-item p { margin: 0; font-size: 0.8rem; color: #777; }
.ref-link-box { background: #f0f2f5; border: 1px dashed #bbb; padding: 10px; border-radius: 10px; margin: 20px 0; word-break: break-all; font-family: monospace; color: #555; font-size: 0.9rem; }

/* Bottom Nav (Restored to default look for all items) */
.bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; border-top-left-radius: 20px; border-top-right-radius: 20px; transition: filter 0.3s ease; }
.nav-item { text-align: center; color: #aaa; font-size: 0.75rem; cursor: pointer; width: 20%; transition: color 0.3s; position: relative; }
.nav-item i { font-size: 1.4rem; display: block; margin-bottom: 5px; transition: 0.2s; color: inherit; }
.nav-item.active { color: #764ba2; font-weight: 600; }
.nav-item.active i { transform: translateY(-3px); }

/* Modals */
.ad-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.8); 
    z-index: 2000; display: none; flex-direction: column; 
    justify-content: center; align-items: center; color: white; 
}

.modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }

.history-content {
    background: white; 
    width: 85%; max-width: 450px; max-height: 80vh; 
    border-radius: 25px; padding: 20px; text-align: center;
    position: relative; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: scaleUp 0.4s; display: flex; flex-direction: column;
}

.history-scroll-area { overflow-y: auto; flex-grow: 1; padding: 0 10px; }
.history-content .reward-title { margin: 0 0 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

.history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; text-align: left; }
.history-item:last-child { border-bottom: none; }
.item-details { flex-grow: 1; }
.item-details h4 { margin: 0; font-size: 0.9rem; color: #333; font-weight: 600; }
.item-details p { margin: 2px 0 0; font-size: 0.75rem; color: #777; }
.item-status { font-size: 0.75rem; font-weight: 600; padding: 4px 8px; border-radius: 15px; text-transform: capitalize; }
.status-paid { background: var(--green); color: white; }
.status-pending { background: orange; color: white; }
.status-rejected { background: var(--red); color: white; }

/* Ads History (Synchronized Styles) */
.ads-history-summary { 
    background: #f0f5ff; border-radius: 10px; padding: 15px; margin-bottom: 10px; 
    display: flex; justify-content: space-between; align-items: center; font-weight: 600; 
    border: 1px solid #cceeff; /* Light Blue Border */
}
.ads-status-ok { color: var(--green); }
.ads-status-pending { color: var(--red); }
.history-item-ad { /* Custom style for ads history item */
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}
.history-item-ad:last-child {
    border-bottom: none;
}
.ad-zone-pill {
    background: rgba(118, 75, 162, 0.1); 
    color: #764ba2; 
    padding: 2px 6px; 
    border-radius: 4px; 
    font-size: 0.7rem; 
    font-weight: 600;
}
/* END Ads History */

.reward-modal { 
    background: white; width: 80%; max-width: 320px; border-radius: 25px; 
    padding: 30px 20px; text-align: center; position: relative; overflow: hidden; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: scaleUp 0.4s; 
}

.sparkle-bg { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, rgba(255,255,255,0) 70%); z-index: 0; animation: spin 10s linear infinite; }

/* MODIFIED: Reward Icon - Use fa-money-bill-wave for BDT theme */
.reward-coin { /* This style block is mostly overridden by the JS injection */
    width: 80px; height: 80px; margin: 0 auto 15px; position: relative; z-index: 1; animation: bounce 2s infinite; 
    background-size: contain; background-repeat: no-repeat; background-position: center;
}
.reward-icon-success, .reward-icon-error { width: 80px; height: 80px; margin: 0 auto 15px; position: relative; z-index: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: bounce 2s infinite; }
.reward-icon-success { background: #4caf50; } .reward-icon-success i { color: white; font-size: 3rem; }
.reward-icon-error { background: #e74c3c; } .reward-icon-error i { color: white; font-size: 3rem; }

.ban-icon-anim { font-size: 4.5rem; color: var(--red); margin: 0 auto 15px; position: relative; z-index: 1; animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both infinite; display: block; }
.unban-icon-anim { font-size: 4.5rem; color: var(--green); margin: 0 auto 15px; position: relative; z-index: 1; animation: bounce 2s infinite; display: block; }

.btn-claim-modal { background: var(--primary-gradient); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: 600; width: 80%; cursor: pointer; margin-top: 15px; position: relative; z-index: 1; box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4); transition: all 0.2s ease; }
.reward-title { margin: 0 0 5px; color: #333; font-size: 1.4rem; font-weight: 700; position: relative; z-index: 1; }
.reward-desc { color: #777; font-size: 0.9rem; margin-bottom: 10px; position: relative; z-index: 1; }
.reward-amount-text { font-size: 2rem; font-weight: 800; color: #764ba2; margin: 10px 0; position: relative; z-index: 1; }
/* MODIFIED: Flying coin styling for ৳ symbol (as a div) */
.fly-coin { 
    position: fixed; width: 35px; height: 35px; z-index: 9999; pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); 
    display: flex; justify-content: center; align-items: center;
    font-size: 1.2rem; font-weight: 700; color: #333;
}

/* --- Leaderboard List Styles (UPDATED) --- */
.top-ref-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
    text-align: left;
}
.top-ref-item:last-child {
    border-bottom: none;
}
.active-user-highlight {
    border: 2px solid #ffaa00;
    border-radius: 10px;
    padding: 13px 0; /* Adjust padding due to border */
    background: #fffbef;
    margin: 5px 0;
}
.ref-rank-badge {
    min-width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    margin-right: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.rank-1 { background: gold; color: #333; font-size: 1.4rem !important; } /* Gold */
.rank-2 { background: silver; color: #333; font-size: 1.4rem !important; } /* Silver */
.rank-3 { background: #cd7f32; color: white; font-size: 1.4rem !important; } /* Bronze */
.rank-other { 
    background: #f0f2f5; 
    color: #777; 
    font-size: 0.9rem; 
    border-radius: 8px; 
    min-width: 40px; 
    height: 40px;
    box-shadow: none;
}

.ref-info { flex-grow: 1; }
.ref-info h4 { margin: 0; font-size: 1rem; color: #333; font-weight: 600; }
.ref-info p { margin: 2px 0 0; font-size: 0.75rem; color: #777; }

/* UPDATED ref-count-pill for stacked text */
.ref-count-pill {
    background: #764ba2;
    color: white;
    padding: 8px 10px; /* Adjusted padding */
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 55px;
    text-align: center;
    /* NEW STYLES for stacking text */
    display: flex; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    line-height: 1.1; 
}
.ref-count-pill span {
    font-size: 0.65rem; /* Smaller text for "Referral/Referrals" */
    font-weight: 400;
    opacity: 0.9;
}
.ref-count-pill b {
    font-size: 1rem; /* Bigger size for the count */
    font-weight: 700;
}
/* END UPDATED ref-count-pill */


@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } 
@keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } } 
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="user-top-row">
            <div class="user-badge"><i class="fas fa-user"></i> <span id="username">Guest</span></div>
            <div class="user-badge">ID: <span id="uidDisplay">...</span></div>
        </div>
        <div class="balance-display">
            <div style="font-size: 0.9rem; opacity: 0.8;">Total Balance</div>
            <div class="balance-amount">
                <!-- MODIFIED: Changed icon to generic currency -->
                <i class="fas fa-money-bill-wave" style="color: #2ecc71;" id="mainCoinIcon"></i> 
                <!-- Changed class to include 'balance-amount' for the counting sparkle effect -->
                <span id="balance"><div class="spinner"></div></span> 
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        
        <!-- 1. HOME SECTION (Position: 1, Default Active) -->
        <div id="home-section" class="page-section active-section">
            <div class="section-title" id="homeSectionTitle">Daily Task</div> 
            
            <!-- Ad Navigation Tabs -->
            <div class="ad-nav-tabs">
                <div class="ad-nav-item active" id="tab-monetag" onclick="switchAdTab('monetag')">Ad Card 1</div>
                <div class="ad-nav-item" id="tab-adsgram" onclick="switchAdTab('adsgram')">Ad Card 2</div>
                <!-- NEW: Onclicka Tab -->
                <div class="ad-nav-item" id="tab-onclicka" onclick="switchAdTab('onclicka')">Ad Card 3</div>
            </div>

            <!-- Card 1: Monetag -->
            <div id="card-monetag" class="ad-card-container active">
                <div class="card" id="adCard">
                    <button class="history-btn" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> History</button> 
                    <i class="fas fa-gift fa-3x" style="color: #764ba2; margin-bottom: 10px;"></i>
                    <h3 id="adCardTitle" style="margin: 5px 0;">Watch Video Ads</h3> 
                    <!-- Text will be updated by JS to include ৳ -->
                    <p id="adCardDesc" style="color: #777; font-size: 0.9rem; margin-top: 0;">Earn <span id="rewardAmountDisplay">...</span> ৳ per ad</p>

                    <div class="progress-wrapper">
                        <div class="progress-info">
                            <span>Daily Limit</span>
                            <span><b id="adCount">0</b>/<span id="limitDisplay">...</span></span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar" id="dailyProgressBar"></div>
                        </div>
                    </div>

                    <button class="watch-btn" id="watchAdBtn" onclick="startAdFlow()">
                        Watch Ad Now <i class="fas fa-play-circle"></i>
                    </button>
                    <div id="completedMsg" style="display: none; color: #4caf50; font-weight: bold; margin-top: 10px;">
                        <i class="fas fa-check-circle"></i> Daily Limit Completed!
                    </div>
                </div>
            </div>

            <!-- Card 2: Adsgram -->
            <div id="card-adsgram" class="ad-card-container">
                <div class="card" id="adsgramCard">
                    <button class="history-btn" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> History</button> 
                    <i class="fas fa-ad fa-3x" style="color: #764ba2; margin-bottom: 10px;"></i>
                    <h3 id="adsgramCardTitle" style="margin: 5px 0;">Adsgram Task</h3> 
                    <!-- Text will be updated by JS to include ৳ -->
                    <p id="adsgramCardDesc" style="color: #777; font-size: 0.9rem; margin-top: 0;">Earn <span id="adsgramRewardDisplay">...</span> ৳ per ad</p>

                    <div class="progress-wrapper">
                        <div class="progress-info">
                            <span>Daily Limit</span>
                            <span><b id="adsgramCount">0</b>/<span id="adsgramLimitDisplay">...</span></span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar" id="adsgramProgressBar"></div>
                        </div>
                    </div>

                    <button class="watch-btn" id="watchAdsgramBtn" onclick="startAdsgramFlow()">
                        Watch Ad Now <i class="fas fa-play-circle"></i>
                    </button>
                    <div id="adsgramCompletedMsg" style="display: none; color: #4caf50; font-weight: bold; margin-top: 10px;">
                        <i class="fas fa-check-circle"></i> Daily Limit Completed!
                    </div>
                </div>
            </div>
            
            <!-- NEW Card 3: Onclicka -->
            <div id="card-onclicka" class="ad-card-container">
                <div class="card" id="onclickaCard">
                    <button class="history-btn" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> History</button> 
                    <i class="fas fa-desktop fa-3x" style="color: #667eea; margin-bottom: 10px;"></i>
                    <h3 id="onclickaCardTitle" style="margin: 5px 0;">Onclicka Ad Task</h3> 
                    <!-- Text will be updated by JS to include ৳ -->
                    <p id="onclickaCardDesc" style="color: #777; font-size: 0.9rem; margin-top: 0;">Earn <span id="onclickaRewardDisplay">...</span> ৳ per ad</p>

                    <div class="progress-wrapper">
                        <div class="progress-info">
                            <span>Daily Limit</span>
                            <span><b id="onclickaCount">0</b>/<span id="onclickaLimitDisplay">...</span></span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar" id="onclickaProgressBar"></div>
                        </div>
                    </div>

                    <button class="watch-btn" id="watchOnclickaBtn" onclick="startOnclickaFlow()">
                        Watch Onclicka Ad <i class="fas fa-play-circle"></i>
                    </button>
                    <div id="onclickaCompletedMsg" style="display: none; color: #4caf50; font-weight: bold; margin-top: 10px;">
                        <i class="fas fa-check-circle"></i> Daily Limit Completed!
                    </div>
                </div>
            </div>


        </div>

        <!-- 2. MISSIONS SECTION (Position: 2) -->
        <div id="tasks-section" class="page-section">
            <div id="dailyRewardCard" class="task-card" style="margin-top: 40px;">
                <div class="task-left">
                    <div class="task-icon" style="background: #e6e6fa; color: #764ba2;">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="task-info">
                        <h4>Daily Check-in</h4>
                        <!-- Text will be updated by JS to include ৳ -->
                        <p id="dailyRewardAmountDisplay">Reward: ৳ +100</p>
                    </div>
                </div>
                <button id="dailyClaimBtn" class="task-btn btn-start" onclick="claimDailyReward()">Claim</button>
            </div>

            <div class="section-title" id="missionsSectionTitle">Active Missions</div>
            <div id="taskListContainer">
                <div style="text-align:center; padding: 40px; color: #999;">
                    <div class="spinner spinner-dark"></div>
                    <p style="margin-top:10px;">Loading Missions...</p>
                </div>
            </div>

            <div class="section-title" id="completedMissionsTitle" style="display:none; margin-top: 30px;">Completed Missions</div>
            <div id="completedListContainer"></div>
        </div>

        <!-- 3. LEADERBOARD SECTION (Position: 3) -->
        <div id="topref-section" class="page-section">
            <div class="section-title" id="toprefSectionTitle">Leaderboard</div>

            <div class="card" id="leaderboardCard" style="text-align: left; margin-top: 10px; padding: 20px;">
                
                <!-- MODIFIED: Tournament UI Container (Positioned absolutely like .history-btn) -->
                <div id="tournament-ui-container" style="display: none; position: absolute; top: 10px; right: 15px; z-index: 10; text-align: right; margin-top: 0px;">
                    <!-- Tournament Button (Text changed to 'Tournament') -->
                    <button class="tournament-btn" id="referralTournamentBtn" onclick="handleTournamentButtonClick()">
                        <i class="fas fa-trophy"></i> Tournament
                    </button>
                    <!-- Timer below the button, small -->
                    <div id="tournamentCountdown" style="font-size: 0.60rem; color: #764ba2; font-weight: 600; margin-top: 3px;">
                        <i class="fas fa-clock"></i> <span id="tournamentTimerDisplay">...</span>
                    </div>
                </div>
                <!-- END MODIFIED: Tournament UI Container -->

                <!-- Original Card Header, shifted down by the new absolute element -->
                <i class="fas fa-chart-line fa-3x" style="color: #764ba2; margin-bottom: 15px; display: block; text-align: center;"></i>
                <h2 id="leaderboardTitle" style="margin: 0 0 5px; text-align: center; color: #764ba2;">Top 100 Referrers (Lifetime)</h2>
                <p id="leaderboardDesc" style="color: #666; font-size: 0.9rem; margin-bottom: 15px; text-align: center;">The list of the top 100 users with the most *lifetime* referrals. The list updates in real-time.</p>
                <div id="topReferralListContainer">
                    <div style="text-align:center; padding: 40px; color: #999;">
                        <div class="spinner spinner-dark"></div>
                        <p style="margin-top:10px;">Loading Leaderboard...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. INVITE SECTION (Position: 4) -->
        <div id="invite-section" class="page-section">
            <div class="section-title" id="inviteSectionTitle">Invite Friends</div>
            
            <div class="card">
                <img src="https://cdn-icons-png.flaticon.com/512/1256/1256650.png" width="80" style="margin-bottom:15px;">
                <h2 id="refTitle" style="margin: 0 0 10px;">Refer & Earn</h2>
                <p id="refDesc" style="color: #666; font-size: 0.9rem;">Share link & get bonus!</p>
                
                <div class="ref-stats">
                    <div class="ref-stat-item"> <h3 id="ref-count">0</h3> <p>Referrals</p> </div>
                    <!-- MODIFIED: Update text in JS for ৳ -->
                    <div class="ref-stat-item"> <h3 id="ref-earned">0</h3> <p>৳ Earned</p> </div>
                </div>

                <div class="ref-link-box" id="refLink">Loading...</div>
                <button class="btn-copy" onclick="copyLink(this)">Copy Link</button>
            </div>

            <div class="section-title" id="activeReferralsTitle" style="margin-top: 30px; display: none;">Your Referrals (Ads Progress)</div>
            <div id="activeReferralListContainer">
                <div style="text-align:center; padding: 40px; color: #999; display: none;" id="activeRefLoading">
                    <div class="spinner spinner-dark"></div>
                    <p style="margin-top:10px;">Loading Referrals...</p>
                </div>
            </div>
            
            <div id="activeReferralPagination" class="pagination" style="display: none;"></div>
            <div class="section-title" id="completedReferralsTitle" style="margin-top: 30px; display:none;">Completed Referral Bonus (Claimed)</div>
            <div id="completedReferralListContainer"></div>
            <div id="completedReferralPagination" class="pagination" style="display: none;"></div>
        </div>
        
        <!-- 5. WALLET SECTION (Position: 5) -->
        <div id="wallet-section" class="page-section">
            <div class="section-title" id="walletSectionTitle">My Wallet</div>
            <div class="card">
                <button class="history-btn" onclick="showHistoryModal('withdrawal')"><i class="fas fa-history"></i> History</button>
                <i class="fas fa-wallet fa-3x" style="color: #764ba2; margin-bottom: 20px;"></i>
                <h3 id="withdrawTitle">Withdraw Funds</h3>
                <!-- Text will be updated by JS to include ৳ -->
                <p style="color:#777; font-size:0.9rem;"><span id="withdrawDesc">Minimum Withdraw ৳ <strong>100</strong></span></p> 
                
                <input type="number" id="withdrawAmount" class="wallet-input" placeholder="Enter Coin Amount">
                <!-- MODIFIED: Select field has custom arrow via CSS -->
                <select id="withdrawMethod" class="select-field" onchange="toggleAccountInput()">
                    <option value="" disabled selected>Select Payment Method</option>
                </select>
                <!-- NOTE: The placeholder for this input will be set dynamically -->
                <input type="text" id="accountNumber" class="wallet-input" placeholder="Wallet Address / Number" style="display: none;">
                
                <button class="watch-btn" id="requestWithdrawBtn" onclick="requestWithdraw()">Request Withdraw</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav (UPDATED WITH NEW ORDER) -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item" onclick="switchTab('tasks', this)"><i class="fas fa-list-check"></i> Missions</div>
        <div class="nav-item" onclick="switchTab('topref', this)"><i class="fas fa-chart-bar fa-3x"></i> Leaderboard</div>
        <div class="nav-item" onclick="switchTab('invite', this)"><i class="fas fa-user-plus"></i> Invite</div>
        <div class="nav-item" onclick="switchTab('wallet', this)"><i class="fas fa-wallet"></i> Wallet</div>
    </div>

    <!-- Ad Overlay - REVERTED TO SIMPLE SPINNER -->
    <div id="adOverlay" class="ad-overlay">
        <div style="text-align:center;">
            <!-- Simple Font Awesome Dotted Spinner -->
            <i class="fas fa-circle-notch fa-spin fa-3x" style="margin-bottom:20px; color: white;"></i>
            <h3>Loading Ad...</h3>
            <p>Please wait while the ad loads.</p>
        </div>
    </div>
    
    <!-- INITIAL VERIFICATION MODAL -->
    <div id="initialVerificationModal" class="modal-backdrop" style="z-index: 4000; display: none;">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <div id="initialModalIconContainer"><i class="fas fa-robot" style="font-size:3rem; color:#764ba2; margin-bottom:15px;"></i></div>
            <h2 class="reward-title" id="initialModalTitle">Welcome!</h2> 
            <p class="reward-desc" id="initialModalDesc">To access, join our Telegram bot & send /start.</p> 
            <button class="btn-claim-modal" id="joinBotBtn" onclick="handleVerificationButtonClick()" style="width: 80%;">Join Telegram Bot</button>
            <p id="verificationTip" style="font-size: 0.75rem; color: #999; margin-top: 10px;">(Please join the bot and click Exit)</p>
        </div>
    </div>

    <!-- REWARD MODAL (MODIFIED: Default Icon) -->
    <div id="rewardModal" class="modal-backdrop">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <!-- MODIFIED: Changed default icon to a Font Awesome money icon -->
            <div id="modalIconContainer"><i class="fas fa-money-bill-wave reward-icon-success" style="background: #2ecc71; color: white; margin-bottom: 15px; font-size: 3rem; animation: bounce 2s infinite;" id="defaultRewardIcon"></i></div> 
            <h2 class="reward-title">Congratulations!</h2> 
            <!-- Text will be updated by JS to include ৳ -->
            <div class="reward-amount-text" id="popupAmount">৳ +50</div>
            <p class="reward-desc">You have successfully earned your reward.</p> 
            <button class="btn-claim-modal" id="modalClaimBtn">OK, Great!</button>
        </div>
    </div>
    
    <!-- STATUS MODAL -->
    <div id="statusModal" class="modal-backdrop" style="z-index: 5000;">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <div id="statusIconContainer"></div>
            <h2 id="statusTitle" class="reward-title" style="color: #333;"></h2>
            <p id="statusDesc" class="reward-desc"></p>
            <button id="statusBtn" class="btn-claim-modal"></button>
        </div>
    </div>
    
    <!-- HISTORY MODAL -->
    <div id="historyModal" class="modal-backdrop" onclick="if(event.target.id === 'historyModal') hideHistoryModal()">
        <div class="history-content">
            <i class="fas fa-times" style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; color: #aaa; z-index: 10;" onclick="hideHistoryModal()"></i>
            <div id="historyModalIconContainer"><i class="fas fa-history fa-2x" style="color: #764ba2; margin-bottom: 15px;"></i></div>
            <h2 class="reward-title">History</h2>
            <div class="history-scroll-area"><div id="historyListContainer"></div></div>
        </div>
    </div>
    
    <!-- NEW: TOURNAMENT LIST MODAL (Slides up from bottom) -->
    <div id="tournamentListModal" class="modal-backdrop" style="z-index: 3500;" onclick="if(event.target.id === 'tournamentListModal') hideTournamentListModal()">
        <div class="history-content">
            <i class="fas fa-times" style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; color: #aaa; z-index: 10;" onclick="hideTournamentListModal()"></i>
            <div id="tournListModalIconContainer"><i class="fas fa-trophy fa-2x" style="color: #ffd700; margin-bottom: 15px;"></i></div>
            <h2 class="reward-title" id="tournListModalTitle">Referrals Tournament List</h2>
            <div id="tournListModalCountdown" style="font-size: 0.85rem; color: #764ba2; font-weight: 600; margin-bottom: 10px;">
                <i class="fas fa-clock"></i> <span id="tournListTimerDisplay">...</span>
            </div>
            
            <!-- NEW: Current User Summary Section (Injected by script.js) -->
            <div id="currentUserTournamentSummary" style="background: #f0f5ff; border: 1px solid #cceeff; border-radius: 12px; padding: 10px; margin-bottom: 15px; display: none;">
                <!-- Content injected by script.js -->
            </div>
            <!-- END NEW -->

            <button class="watch-btn" style="width: 100%; margin-bottom: 15px; background: #3498db;" onclick="showRulesModal()">Tournament Rules <i class="fas fa-scroll"></i></button>
            <div class="history-scroll-area">
                <div id="tournamentLeaderboardList">
                    <!-- Tournament List will be injected here -->
                </div>
            </div>
            <!-- Join Button for quick access when not joined -->
            <button class="btn-claim-modal" id="listModalJoinBtn" onclick="showJoinTournamentModal(true)" style="width: 100%; margin-top: 15px; display: none;">Join Tournament!</button>
        </div>
    </div>

    <!-- NEW: JOIN TOURNAMENT MODAL -->
    <div id="joinTournamentModal" class="modal-backdrop" onclick="if(event.target.id === 'joinTournamentModal') hideJoinTournamentModal()">
        <div class="reward-modal">
            <i class="fas fa-times" style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; color: #aaa; z-index: 10;" onclick="hideJoinTournamentModal()"></i>
            <div class="sparkle-bg"></div>
            <div id="joinModalIconContainer"><i class="fas fa-trophy" style="font-size:3rem; color:#ffd700; margin-bottom:15px; animation: bounce 2s infinite;"></i></div>
            <h2 class="reward-title" id="joinModalTitle">Referrals Tournament</h2> 
            <p class="reward-desc" id="joinModalDesc">Join the tournament to start counting your referrals for a chance to win a prize!</p> 
            <button class="btn-claim-modal" id="joinTournamentRulesBtn" style="width: 80%; background: #3498db; margin-bottom: 10px;" onclick="showRulesModal()">Tournament Rules <i class="fas fa-scroll"></i></button>
            <button class="btn-claim-modal" id="joinTournamentBtn" onclick="joinTournament()" style="width: 80%;">Join Tournament!</button>
        </div>
    </div>

    <!-- NEW: RULES MODAL -->
    <div id="rulesModal" class="modal-backdrop" style="z-index: 3500;" onclick="if(event.target.id === 'rulesModal') hideRulesModal()">
        <div class="history-content">
            <i class="fas fa-times" style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; color: #aaa; z-index: 10;" onclick="hideRulesModal()"></i>
            <div id="rulesModalIconContainer"><i class="fas fa-scroll fa-2x" style="color: #3498db; margin-bottom: 15px;"></i></div>
            <h2 class="reward-title">Tournament Rules</h2>
            <div class="history-scroll-area">
                <div id="tournamentRulesContent" style="text-align: left; font-size: 0.9rem; color: #555; line-height: 1.6;">
                    Loading rules...
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: PRIZE COLLECTION MODAL -->
    <div id="prizeCollectModal" class="modal-backdrop" style="z-index: 5000;">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <div id="prizeModalIconContainer"><i class="fas fa-trophy" style="font-size:3rem; color:#ffd700; margin-bottom:15px; animation: bounce 2s infinite;"></i></div>
            <h2 class="reward-title" id="prizeModalTitle">Congratulations!</h2> 
            <p class="reward-desc" id="prizeModalDesc">You finished in rank X and won Y ৳!</p> 
            <div class="reward-amount-text" id="prizePopupAmount">৳ +X</div>
            <button class="btn-claim-modal" id="prizeCollectBtn">Collect ৳!</button>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

   <script>
       
       const firebaseConfig = {
    apiKey: "AIzaSyAXBG5RZJ2b38kknNKzmygXrzOoCTugLIE",
    authDomain: "new-tg-test.firebaseapp.com",
    projectId: "new-tg-test",
    storageBucket: "new-tg-test.firebasestorage.app",
    messagingSenderId: "1077123386154",
    appId: "1:1077123386154:web:dbbc89d5874127f60c6c53"
};
const BOT_USERNAME = "tap2earnbeta_bot";

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const tg = window.Telegram.WebApp;
tg.expand();

let uid, username, firstName, lastName, referrerId = null; 
if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
    const user = tg.initDataUnsafe.user;
    uid = user.id.toString();
    firstName = user.first_name;
    lastName = user.last_name || ''; 
    username = user.username || firstName;
    if (tg.initDataUnsafe.start_param) referrerId = tg.initDataUnsafe.start_param;
} else {
    uid = localStorage.getItem('test_uid');
    if(!uid) { uid = 'U'+Math.floor(Math.random()*99999); localStorage.setItem('test_uid', uid); }
    firstName = "Guest";
    lastName = ""; 
    username = "GuestUser";
}

const userFullName = (firstName + ' ' + lastName).trim();

document.getElementById('uidDisplay').innerText = uid;
document.getElementById('username').innerText = userFullName || firstName; 

const BOT_BASE_LINK = `https://t.me/${BOT_USERNAME}`; 
document.getElementById('refLink').innerText = `${BOT_BASE_LINK}?startapp=${uid}`;

// DYNAMIC COOLDOWN VARIABLES (Synchronized from index.html)
let adCooldownEndTime = 0; // Monetag
let adsgramCooldownEndTime = 0; // Adsgram
let onclickaCooldownEndTime = 0; // Onclicka
    
let monetagCooldownInterval = null; 
let adsgramCooldownInterval = null;
let onclickaCooldownInterval = null; 
let tournamentCountdownInterval = null; 

// MISSION TIMER VARIABLES (Synchronized from index.html)
let activeTaskTimeout = null; // Tracks the main setTimeout for CLAIM button
let activeMissionId = null; // Tracks the ID of the running mission

// NEW: Adsgram minimum view duration (15 seconds in milliseconds)
const ADSGRAM_MIN_VIEW_DURATION_MS = 15000; 

// STATE VARIABLES
let currentBalance = 0;
let adsWatchedToday = 0; 
let adsgramWatchedToday = 0; 
let onclickaWatchedToday = 0; 
let totalAdsWatched = 0; 
let referralCount = 0; 
let completedTasks = [];
let isBotVerified = false, verificationStep = 'join', isJoinButtonClicked = false;
const isEntryViaReferral = !!referrerId;

let activeReferralsData = [], completedReferralsData = [];
let activeRefPage = 1, completedRefPage = 1;
const pageSize = 20;

// TOURNAMENT STATE VARIABLES
let isTournamentActive = false;
let hasJoinedTournament = false;
let tournamentEndTime = 0;
window.userTournamentRank = null;
window.hasClaimedPrize = false;
window.tournamentReferees = 0;

window.referredIdToClaim = null; 
window.rewardAmountToClaim = null; 
let showOnclicka = null; 


// Default Settings (UPDATED to use ৳ for display text)
let settings = { 
    daily_limit: 20, reward_per_ad: 50, monetag_ad_code: '', 
    // DYNAMIC COOLDOWN DEFAULTS (in ms)
    monetag_cooldown_duration: 60000, 
    adsgram_cooldown_duration: 60000, 
    onclicka_cooldown_duration: 60000,
    
    adsgram_daily_limit: 20, adsgram_reward: 50, adsgram_block_id: 'int-18699',
    onclicka_daily_limit: 20, onclicka_reward: 50, onclicka_spot_id: '6101285',
    onclicka_card_title: 'Onclicka Ad Task', onclicka_card_desc: 'Earn ৳ +{{onclicka_reward}} per ad', // MODIFIED
    onclicka_btn_text: 'Watch Onclicka Ad',
    min_withdraw: 100, ref_bonus: 100, daily_reward_amount: 100,
    min_ads_view_for_withdraw: 0, min_referrals_for_withdraw: 0, 
    home_section_title: 'Daily Task', missions_section_title: 'Active Missions', invite_section_title: 'Invite Friends', wallet_section_title: 'My Wallet',
    ad_card_title: 'Watch Video Ads', ad_card_desc: 'Earn ৳ +{{reward_per_ad}} per ad', ad_btn_text: 'Watch Ad Now', // MODIFIED
    adsgram_card_title: 'Adsgram Task', adsgram_card_desc: 'Earn ৳ +{{adsgram_reward}} per ad', adsgram_btn_text: 'Watch Ad Now', // MODIFIED
    ref_title: 'Refer & Earn', ref_desc: 'Share link & get bonus!',
    ref_ads_watch_requirement: 100, 
    initial_popup_title: 'Welcome!', initial_popup_desc: 'To access...', initial_popup_btn_text: 'Join', initial_popup_tip: '(Please join the bot and click Exit)', initial_popup_bot_link: BOT_BASE_LINK,
    initial_exit_desc: 'Exit Desc', initial_exit_btn_text: 'Exit', initial_popup_tip: '(Please join the bot and click Exit)', 
    ban_popup_title: 'Account Suspended', ban_popup_desc: 'You have been banned.', ban_btn_text: 'Contact Support', support_url: 'https://t.me/',
    unban_popup_title: 'Account Restored!', unban_popup_desc: 'You can use the app again.', unban_btn_text: 'Continue',
    ad_popup_title: 'Congratulations!', ad_popup_desc: 'Reward Earned.', daily_popup_title: 'Daily Bonus!', daily_popup_desc: 'Checked in.', mission_popup_title: 'Mission Complete!', mission_popup_desc: 'Reward Earned.',
    withdraw_title: 'Withdraw Funds', withdraw_desc: 'Minimum Withdraw ৳ <strong>{{min_withdraw}}</strong>', // MODIFIED
    // UPDATED: Pay Methods as Array of Objects
    pay_methods: [{name: 'bKash', placeholder: 'bKash Number'}, {name: 'Nagad', placeholder: 'Nagad Number'}, {name: 'USDT TRC20', placeholder: 'USDT TRC20 Address'}], 
    request_withdraw_btn_text: 'Request Withdraw', 
    modal_claim_btn_text: 'OK', error_modal_btn_text: 'Close', withdraw_success_title: 'Success!', withdraw_success_desc: 'Request Submitted.', withdraw_success_btn_text: 'Done',          
    min_amt_err_title: 'Min Error', min_amt_err_desc: 'Min is ৳ {{min_withdraw}}', bal_err_title: 'Balance Error', bal_err_desc: 'Low Balance.', // MODIFIED
    method_err_title: 'Method Error', method_err_desc: 'Select Method.', acc_num_err_title: 'Account Error', acc_num_err_desc: 'Enter Number.',
    min_ads_err_title: 'Ads Error', min_ads_err_desc: 'Watch more ads.', min_refs_err_title: 'Ref Error', min_refs_err_desc: 'Refer more users.', 
    // TOURNAMENT SETTINGS
    topref_section_title: 'Leaderboard',
    is_tournament_active: false,
    tournament_duration_days: 7,
    tournament_start_time: 0, 
    tournament_end_time: 0, 
    tournament_title: 'Referrals Tournament',
    tournament_desc: 'Join the tournament to start counting your referrals for a chance to win a prize!',
    tournament_btn_text: 'Tournament',
    tournament_rules: 'The top referrers will share a prize pool...',
    tournament_prizes: {
        '1': 1000, '2': 750, '3': 500, '4-10': 400, '11-20': 300, '21-50': 200, '51-100': 100,
        '101-500': 50, '501-1000': 25, '1000+': 10
    },
    prize_popup_title: 'Congratulations!', 
    prize_popup_desc: 'You finished in rank {{rank_range}} and won ৳ {{prize_amount}}!', // MODIFIED
    prize_popup_btn_text: 'Collect ৳!', // MODIFIED
}; 
let adFunctionName = null, lastDailyClaimDate = null; 

const userRef = db.collection('users').doc(uid);

function updateUserActivity() {
    if (uid) { userRef.update({ last_activity: Date.now() }).catch(err => {}); }
}
updateUserActivity();

// Monetag SDK Loader (No Change)
function loadMonetagSdk(adCode) {
    const head = document.getElementsByTagName('head')[0];
    let script = document.createElement('script');
    script.src = '//libtl.com/sdk.js'; script.setAttribute('data-zone', adCode.replace('show_', '')); script.setAttribute('data-sdk', adCode);
    head.appendChild(script);
}

// Onclicka SDK Loader (No Change)
function loadOnclickaSdk(spotId) {
    if (showOnclicka) return; 
    if(window.initCdTma) {
        window.initCdTma({ id: spotId }).then(show => {
            showOnclicka = show;
            console.log("Onclicka SDK loaded successfully.");
            updateUI();
        }).catch(e => console.error("Onclicka SDK load failed:", e));
    } else {
        console.log("Onclicka SDK not initialized on window.initCdTma.");
    }
}

// UPDATED: Withdrawal Method Population (Uses object array and data-placeholder)
function populateWithdrawMethods(methodsArray) {
    const selectEl = document.getElementById('withdrawMethod');
    selectEl.innerHTML = '<option value="" disabled selected>Select Payment Method</option>'; 
    methodsArray.forEach(method => {
        const option = document.createElement('option'); 
        option.value = method.name.replace(/\s/g, ''); 
        option.innerText = method.name; 
        option.setAttribute('data-placeholder', method.placeholder || 'Wallet Address / Number');
        selectEl.appendChild(option);
    });
    // Call toggleAccountInput to initialize the input field visibility
    toggleAccountInput(); 
}

function initApp() {
    document.getElementById('initialVerificationModal').style.display = 'none'; 
    if(document.getElementById('statusModal').style.display === 'none') {
        document.body.classList.remove('modal-active'); 
    }
    updateUI(); updateDailyRewardUI(); renderTasks(); 
    if(document.getElementById('invite-section').classList.contains('active-section')) renderReferrals();
    if(document.getElementById('topref-section').classList.contains('active-section')) renderLeaderboard(); 
}

// Tab Switch Logic (No Change)
function switchAdTab(tab) {
    document.querySelectorAll('.ad-nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.ad-card-container').forEach(el => el.classList.remove('active'));
    
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('card-' + tab).classList.add('active');
    
    if (tab === 'onclicka' && settings.onclicka_spot_id && !showOnclicka) {
        loadOnclickaSdk(settings.onclicka_spot_id);
    }
}

// --- SETTINGS LISTENER (MODIFIED: Update to use ৳ in dynamic text) ---
const setRef = db.collection('settings').doc('global');
setRef.onSnapshot(doc => {
    if (doc.exists) {
        const d = doc.data();
        
        // Synchronized: Dynamic Cooldowns
        settings.monetag_cooldown_duration = d.monetag_cooldown_duration || 60000;
        settings.adsgram_cooldown_duration = d.adsgram_cooldown_duration || 60000;
        settings.onclicka_cooldown_duration = d.onclicka_cooldown_duration || 60000;
        
        Object.assign(settings, d); 
        
        // Synchronized: Tournament Settings
        isTournamentActive = d.is_tournament_active || false;
        tournamentEndTime = d.tournament_end_time || 0;
        document.getElementById('toprefSectionTitle').innerText = settings.topref_section_title;


        // Update UI Elements based on settings (MODIFIED TO USE ৳)
        document.getElementById('limitDisplay').innerText = settings.daily_limit;
        document.getElementById('adCardTitle').innerText = settings.ad_card_title;
        let adDescText = settings.ad_card_desc.replace('{{reward_per_ad}}', settings.reward_per_ad);
        document.getElementById('adCardDesc').innerHTML = adDescText.replace(`${settings.reward_per_ad}`, `<span id="rewardAmountDisplay">${settings.reward_per_ad}</span>`);
        document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`;

        document.getElementById('adsgramLimitDisplay').innerText = settings.adsgram_daily_limit;
        let adsgramDescText = settings.adsgram_card_desc.replace('{{adsgram_reward}}', settings.adsgram_reward);
        document.getElementById('adsgramCardDesc').innerHTML = adsgramDescText.replace(`${settings.adsgram_reward}`, `<span id="adsgramRewardDisplay">${settings.adsgram_reward}</span>`);
        document.getElementById('adsgramCardTitle').innerText = settings.adsgram_card_title;
        document.getElementById('watchAdsgramBtn').innerHTML = `${settings.adsgram_btn_text} <i class="fas fa-play-circle"></i>`;
        
        document.getElementById('onclickaLimitDisplay').innerText = settings.onclicka_daily_limit;
        let onclickaDescText = settings.onclicka_card_desc.replace('{{onclicka_reward}}', settings.onclicka_reward);
        document.getElementById('onclickaCardDesc').innerHTML = onclickaDescText.replace(`${settings.onclicka_reward}`, `<span id="onclickaRewardDisplay">${settings.onclicka_reward}</span>`);
        document.getElementById('onclickaCardTitle').innerText = settings.onclicka_card_title;
        document.getElementById('watchOnclickaBtn').innerHTML = `${settings.onclicka_btn_text} <i class="fas fa-play-circle"></i>`;

        // MODIFIED: Use ৳
        document.getElementById('dailyRewardAmountDisplay').innerText = `Reward: ৳ +${settings.daily_reward_amount}`; 
        document.getElementById('homeSectionTitle').innerText = settings.home_section_title;
        document.getElementById('missionsSectionTitle').innerText = settings.missions_section_title;
        document.getElementById('inviteSectionTitle').innerText = settings.invite_section_title;
        document.getElementById('walletSectionTitle').innerText = settings.wallet_section_title;
        document.getElementById('refTitle').innerText = settings.ref_title;
        document.getElementById('refDesc').innerText = settings.ref_desc;
        document.getElementById('withdrawTitle').innerText = settings.withdraw_title;
        // MODIFIED: Use ৳
        document.getElementById('withdrawDesc').innerHTML = settings.withdraw_desc.replace('{{min_withdraw}}', `<strong>${settings.min_withdraw}</strong>`);
        document.getElementById('requestWithdrawBtn').innerText = settings.request_withdraw_btn_text; 
        
        // Synchronized: Populate Withdrawal Methods
        if(settings.pay_methods && Array.isArray(settings.pay_methods)) {
             populateWithdrawMethods(settings.pay_methods);
        }

        if (settings.monetag_ad_code && !adFunctionName) {
            adFunctionName = settings.monetag_ad_code;
            setTimeout(() => loadMonetagSdk(adFunctionName), 500); 
        }
        if (settings.onclicka_spot_id) {
            loadOnclickaSdk(settings.onclicka_spot_id);
        }
        if(document.getElementById('initialVerificationModal').style.display === 'flex') updateVerificationModalUI(isBotVerified, verificationStep);
        
        updateUI(); 
        if(document.getElementById('topref-section').classList.contains('active-section')) renderLeaderboard();
    }
});

// --- USER LISTENER (MODIFIED: Prepend ৳ to balance display) ---
userRef.onSnapshot(doc => {
    if (doc.exists) {
        const d = doc.data();
        currentBalance = d.balance || 0;
        completedTasks = d.completed_tasks || [];
        lastDailyClaimDate = d.last_daily_claim_date || null; 
        totalAdsWatched = d.total_ads_watched || 0; 
        referralCount = d.referral_count || 0; 
        isBotVerified = d.is_verified_bot_joined || false; 
        
        hasJoinedTournament = d.has_joined_tournament || false;
        window.tournamentReferees = d.tournament_referral_count || 0;
        const tournamentData = d.tournament_data || {};
        window.userTournamentRank = tournamentData.rank || null;
        window.hasClaimedPrize = tournamentData.claimed_prize || false;

        // Synchronized: Get independent cooldowns
        adCooldownEndTime = d.ad_cooldown_end_time || 0; 
        adsgramCooldownEndTime = d.adsgram_cooldown_end_time || 0;
        onclickaCooldownEndTime = d.onclicka_cooldown_end_time || 0; 

        const balEl = document.getElementById('balance');
        if (balEl.innerHTML.includes('spinner') || document.getElementById('rewardModal').style.display === 'none') {
            // MODIFIED: Prepend ৳
            balEl.innerText = '৳ ' + currentBalance;
        }
        
        document.getElementById('ref-count').innerText = d.referral_count || 0;
        // MODIFIED: Update referral earned display to use ৳
        document.getElementById('ref-earned').innerText = '৳ ' + (d.referral_earnings || 0);

        const today = new Date().toDateString();
        if (d.last_ad_date !== today) {
            adsWatchedToday = 0;
            adsgramWatchedToday = 0;
            onclickaWatchedToday = 0; 
            userRef.update({ ads_watched: 0, adsgram_ads_watched: 0, onclicka_ads_watched: 0, last_ad_date: today }); 
        } else {
            adsWatchedToday = d.ads_watched || 0;
            adsgramWatchedToday = d.adsgram_ads_watched || 0;
            onclickaWatchedToday = d.onclicka_ads_watched || 0; 
        }
        
        if (d.is_banned === true) showBanPopup();
        else if (d.is_banned === false && d.seen_unban_popup === false) showUnbanPopup();
        else {
            if(document.getElementById('statusModal').style.display !== 'none') {
                document.getElementById('statusModal').style.display = 'none';
                document.body.classList.remove('modal-active');
            }
            
            const now = Date.now();
            if (!isTournamentActive && tournamentEndTime && now > tournamentEndTime && window.userTournamentRank !== null && !window.hasClaimedPrize) {
                checkAndShowPrizeModal();
            } else if (isBotVerified) {
                 initApp();
            } else if (!isBotVerified && isEntryViaReferral) {
                showInitialVerificationModal(verificationStep); 
            } else if (!isBotVerified && !isEntryViaReferral) {
                userRef.set({ is_verified_bot_joined: true, last_activity: Date.now() }, { merge: true }).then(() => {
                    isBotVerified = true; initApp();
                }).catch(err => showInitialVerificationModal('join'));
            } else if (document.getElementById('initialVerificationModal').style.display !== 'flex') {
                initApp();
            }
        }
    } else {
        // Create New User (Synchronized fields)
        let newUser = {
            balance: 0, ads_watched: 0, adsgram_ads_watched: 0, onclicka_ads_watched: 0, total_ads_watched: 0, referral_count: 0, referral_earnings: 0, 
            completed_tasks: [], last_ad_date: new Date().toDateString(), 
            username: username, full_name: userFullName, 
            is_verified_bot_joined: !isEntryViaReferral, last_daily_claim_date: null, 
            is_banned: false, seen_unban_popup: true, 
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            last_activity: Date.now(), 
            ad_cooldown_end_time: 0, 
            adsgram_cooldown_end_time: 0,
            onclicka_cooldown_end_time: 0, 
            tournament_referral_count: 0, 
            has_joined_tournament: false, 
            tournament_data: { rank: null, claimed_prize: false }, 
        };
        if (referrerId && referrerId !== uid) {
            newUser.referred_by = referrerId;
            db.collection('users').doc(referrerId).update({ referral_count: firebase.firestore.FieldValue.increment(1) });
            
            db.collection('settings').doc('global').get().then(settingsDoc => {
                const s = settingsDoc.data();
                if (s.is_tournament_active) {
                    db.collection('users').doc(referrerId).get().then(referrerDoc => {
                        const r = referrerDoc.data();
                        if (r && r.has_joined_tournament) {
                             db.collection('users').doc(referrerId).update({ 
                                tournament_referral_count: firebase.firestore.FieldValue.increment(1)
                            });
                        }
                    });
                }
            }).catch(e => console.error("Could not check tournament status for new referral: ", e));

            db.collection('users').doc(referrerId).collection('referred_users').doc(uid).set({
                referred_uid: uid, referred_username: userFullName, referred_total_ads_watched: 0, 
                is_claimed: false, claimed_at: null, created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        userRef.set(newUser).then(() => { if (isEntryViaReferral) showInitialVerificationModal('join'); else initApp(); });
        // MODIFIED: Prepend ৳
        document.getElementById('balance').innerText = '৳ 0';
    }
});

// --- POPUPS & VERIFICATION (No Change) ---
function showBanPopup() {
    const modal = document.getElementById('statusModal'); document.body.classList.add('modal-active');
    document.getElementById('statusIconContainer').innerHTML = `<i class="fas fa-ban ban-icon-anim"></i>`;
    document.getElementById('statusTitle').innerText = settings.ban_popup_title; document.getElementById('statusTitle').style.color = '#e74c3c';
    document.getElementById('statusDesc').innerText = settings.ban_popup_desc;
    const btn = document.getElementById('statusBtn'); btn.innerText = settings.ban_btn_text; btn.style.background = '#e74c3c';
    btn.onclick = function() { tg.openTelegramLink(settings.support_url); }; modal.style.display = 'flex';
}
function showUnbanPopup() {
    const modal = document.getElementById('statusModal'); document.body.classList.add('modal-active');
    document.getElementById('statusIconContainer').innerHTML = `<i class="fas fa-check-circle unban-icon-anim"></i>`;
    document.getElementById('statusTitle').innerText = settings.unban_popup_title; document.getElementById('statusTitle').style.color = '#2ecc71';
    document.getElementById('statusDesc').innerText = settings.unban_popup_desc;
    const btn = document.getElementById('statusBtn'); btn.innerText = settings.unban_btn_text; btn.style.background = '#2ecc71';
    btn.onclick = function() { userRef.update({ seen_unban_popup: true, last_activity: Date.now() }).then(() => { modal.style.display = 'none'; document.body.classList.remove('modal-active'); }); };
    modal.style.display = 'flex';
}

function updateVerificationModalUI(isVerified, state) {
    const joinBtn = document.getElementById('joinBotBtn');
    joinBtn.classList.remove('disabled'); joinBtn.disabled = false; joinBtn.style.background = '#0088cc'; document.getElementById('verificationTip').style.display = 'block';
    if (state === 'join') {
        document.getElementById('initialModalTitle').innerText = settings.initial_popup_title; 
        document.getElementById('initialModalDesc').innerText = settings.initial_popup_desc;
        joinBtn.innerHTML = `${settings.initial_popup_btn_text} <i class="fab fa-telegram-plane"></i>`;
        document.getElementById('initialModalIconContainer').innerHTML = '<i class="fas fa-robot" style="font-size:3rem; color:#764ba2; margin-bottom:15px; animation:bounce 2s infinite;"></i>';
        joinBtn.onclick = handleVerificationButtonClick; verificationStep = 'join'; 
    }
}
function showInitialVerificationModal(state) {
    if (isBotVerified) { initApp(); return; }
    document.body.classList.add('modal-active'); updateVerificationModalUI(isBotVerified, 'join');
    document.getElementById('initialVerificationModal').style.display = 'flex';
}
function handleVerificationButtonClick() {
    const joinBtn = document.getElementById('joinBotBtn');
    if (!isJoinButtonClicked) {
        const botLink = settings.initial_popup_bot_link.trim() || BOT_BASE_LINK; tg.openTelegramLink(botLink.replace(/\/$/, ''));
        joinBtn.innerHTML = `${settings.initial_exit_btn_text} <i class="fas fa-times-circle"></i>`; joinBtn.style.background = '#e74c3c'; 
        document.getElementById('initialModalDesc').innerText = settings.initial_exit_desc; document.getElementById('verificationTip').innerText = settings.initial_exit_tip; 
        isJoinButtonClicked = true;
    } else { tg.close(); }
}

// --- DYNAMIC COOLDOWN TIMERS (Synchronized from index.html, using dynamic settings) ---

function startAdCooldownTimer(endTime) {
    if (monetagCooldownInterval) clearInterval(monetagCooldownInterval); 
    const btn = document.getElementById('watchAdBtn');
    btn.classList.add('disabled'); btn.onclick = 'void(0)'; document.getElementById('adCard').classList.add('disabled-card');

    monetagCooldownInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(monetagCooldownInterval); monetagCooldownInterval = null;
            btn.classList.remove('disabled'); btn.onclick = startAdFlow; btn.innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`; document.getElementById('adCard').classList.remove('disabled-card');
            userRef.update({ ad_cooldown_end_time: 0 }); updateUI(); return;
        }
        const seconds = Math.floor(remaining / 1000); const display = `${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}`;
        btn.innerHTML = `<i class="fas fa-hourglass-half"></i> Wait: ${display}`;
    }, 1000);
}

function startAdsgramCooldownTimer(endTime) {
    if (adsgramCooldownInterval) clearInterval(adsgramCooldownInterval); 
    const btn = document.getElementById('watchAdsgramBtn');
    btn.classList.add('disabled'); btn.onclick = 'void(0)'; document.getElementById('adsgramCard').classList.add('disabled-card');

    adsgramCooldownInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(adsgramCooldownInterval); adsgramCooldownInterval = null;
            btn.classList.remove('disabled'); btn.onclick = startAdsgramFlow; btn.innerHTML = `${settings.adsgram_btn_text} <i class="fas fa-play-circle"></i>`; document.getElementById('adsgramCard').classList.remove('disabled-card');
            userRef.update({ adsgram_cooldown_end_time: 0 }); updateUI(); return;
        }
        const seconds = Math.floor(remaining / 1000); const display = `${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}`;
        btn.innerHTML = `<i class="fas fa-hourglass-half"></i> Wait: ${display}`;
    }, 1000);
}

function startOnclickaCooldownTimer(endTime) {
    if (onclickaCooldownInterval) clearInterval(onclickaCooldownInterval); 
    const btn = document.getElementById('watchOnclickaBtn');
    btn.classList.add('disabled'); btn.onclick = 'void(0)'; document.getElementById('onclickaCard').classList.add('disabled-card');

    onclickaCooldownInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(onclickaCooldownInterval); onclickaCooldownInterval = null;
            btn.classList.remove('disabled'); btn.onclick = startOnclickaFlow; btn.innerHTML = `${settings.onclicka_btn_text} <i class="fas fa-play-circle"></i>`; document.getElementById('onclickaCard').classList.remove('disabled-card');
            userRef.update({ onclicka_cooldown_end_time: 0 }); updateUI(); return;
        }
        const seconds = Math.floor(remaining / 1000); const display = `${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}`;
        btn.innerHTML = `<i class="fas fa-hourglass-half"></i> Wait: ${display}`;
    }, 1000);
}
// --- END DYNAMIC COOLDOWN TIMERS ---


function updateUI() {
    if (!isBotVerified && isEntryViaReferral) return; 
    const now = Date.now();

    // Monetag Check
    const mBtn = document.getElementById('watchAdBtn'), mCard = document.getElementById('adCard');
    const isOnCooldown = now < adCooldownEndTime;
    document.getElementById('adCount').innerText = adsWatchedToday;
    document.getElementById('dailyProgressBar').style.width = ((adsWatchedToday / settings.daily_limit) * 100) + '%';
    if (isOnCooldown) {
        mBtn.classList.add('disabled'); mCard.classList.add('disabled-card');
        document.getElementById('completedMsg').style.display = 'none';
        startAdCooldownTimer(adCooldownEndTime);
    } else if (adsWatchedToday >= settings.daily_limit) {
        mBtn.classList.add('disabled'); mBtn.innerText = 'Limit Reached'; document.getElementById('completedMsg').style.display = 'block'; mCard.classList.add('disabled-card');
    } else {
        mBtn.classList.remove('disabled'); document.getElementById('completedMsg').style.display = 'none'; mCard.classList.remove('disabled-card');
        mBtn.onclick = startAdFlow; mBtn.innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`;
    }

    // Adsgram Check
    const aBtn = document.getElementById('watchAdsgramBtn'), aCard = document.getElementById('adsgramCard');
    const isAdsgramOnCooldown = now < adsgramCooldownEndTime;
    document.getElementById('adsgramCount').innerText = adsgramWatchedToday;
    document.getElementById('adsgramProgressBar').style.width = ((adsgramWatchedToday / settings.adsgram_daily_limit) * 100) + '%';
    if (isAdsgramOnCooldown) {
        aBtn.classList.add('disabled'); aCard.classList.add('disabled-card');
        document.getElementById('adsgramCompletedMsg').style.display = 'none';
        startAdsgramCooldownTimer(adsgramCooldownEndTime);
    } else if (adsgramWatchedToday >= settings.adsgram_daily_limit) {
        aBtn.classList.add('disabled'); aBtn.innerText = 'Limit Reached'; document.getElementById('adsgramCompletedMsg').style.display = 'block'; aCard.classList.add('disabled-card');
    } else {
        aBtn.classList.remove('disabled'); document.getElementById('adsgramCompletedMsg').style.display = 'none'; aCard.classList.remove('disabled-card');
        aBtn.onclick = startAdsgramFlow; aBtn.innerHTML = `${settings.adsgram_btn_text} <i class="fas fa-play-circle"></i>`;
    }

    // Onclicka Check
    const oBtn = document.getElementById('watchOnclickaBtn'), oCard = document.getElementById('onclickaCard');
    const isOnClickaOnCooldown = now < onclickaCooldownEndTime;
    
    document.getElementById('onclickaCount').innerText = onclickaWatchedToday;
    document.getElementById('onclickaProgressBar').style.width = ((onclickaWatchedToday / settings.onclicka_daily_limit) * 100) + '%';

    if (!showOnclicka && document.getElementById('tab-onclicka').classList.contains('active')) { // Check only if tab is active
        oBtn.classList.remove('disabled'); oBtn.innerText = 'Initialize Ad'; oCard.classList.remove('disabled-card');
        oBtn.onclick = function() { loadOnclickaSdk(settings.onclicka_spot_id); oBtn.classList.add('disabled'); oBtn.innerText = 'Initializing...'; };
    } else if (!showOnclicka) {
        oBtn.classList.add('disabled'); oBtn.innerText = 'Initializing Ad...'; oCard.classList.add('disabled-card');
    } else if (isOnClickaOnCooldown) {
        oBtn.classList.add('disabled'); oCard.classList.add('disabled-card');
        document.getElementById('onclickaCompletedMsg').style.display = 'none';
        startOnclickaCooldownTimer(onclickaCooldownEndTime);
    } else if (onclickaWatchedToday >= settings.onclicka_daily_limit) {
        oBtn.classList.add('disabled'); oBtn.innerText = 'Limit Reached'; document.getElementById('onclickaCompletedMsg').style.display = 'block'; oCard.classList.add('disabled-card');
    } else {
        oBtn.classList.remove('disabled'); document.getElementById('onclickaCompletedMsg').style.display = 'none'; oCard.classList.remove('disabled-card');
        oBtn.onclick = startOnclickaFlow; oBtn.innerHTML = `${settings.onclicka_btn_text} <i class="fas fa-play-circle"></i>`;
    }
}

function updateDailyRewardUI() {
    if (!isBotVerified && isEntryViaReferral) return;
    const btn = document.getElementById('dailyClaimBtn'); const today = new Date().toDateString(); if (!btn) return; 
    if (lastDailyClaimDate === today) { btn.classList.remove('btn-start', 'btn-claim-task'); btn.classList.add('btn-done'); btn.innerText = 'Claimed'; btn.onclick = 'void(0)'; } 
    else { btn.classList.remove('btn-done'); btn.classList.add('btn-start'); btn.innerText = 'Claim'; btn.onclick = claimDailyReward; btn.disabled = false; }
}
function claimDailyReward() {
    if (!isBotVerified && isEntryViaReferral) return;
    const today = new Date().toDateString();
    // MODIFIED: Use ৳ in error message
    if (lastDailyClaimDate === today) { showErrorModal('Already Claimed!', 'You have already claimed your daily ৳ reward today.', 'exclamation-triangle'); updateDailyRewardUI(); return; }
    document.getElementById('dailyClaimBtn').disabled = true; window.dailyClaimButtonRef = document.getElementById('dailyClaimBtn'); 
    showRewardModal('daily', settings.daily_reward_amount, null); 
}

// --- TASKS RENDER (MODIFIED: Use ৳ in dynamic text) ---
function renderTasks() {
    if (!isBotVerified && isEntryViaReferral) return;
    const activeContainer = document.getElementById('taskListContainer'); 
    const missionsTitle = document.getElementById('missionsSectionTitle'); 
    const completedContainer = document.getElementById('completedListContainer'); 
    const completedTitle = document.getElementById('completedMissionsTitle');
    
    db.collection('tasks').where('active', '==', true).onSnapshot(snapshot => {
        let tasks = []; snapshot.forEach(doc => tasks.push({id: doc.id, ...doc.data()})); tasks.sort((a,b) => b.created_at - a.created_at);
        let activeHtml = '', completedHtml = '';
        tasks.forEach(task => {
            const isCompleted = completedTasks.includes(task.id);
            let iconClass = task.type === 'telegram' ? 'fab fa-telegram-plane' : (task.type === 'youtube' ? 'fab fa-youtube' : 'fas fa-globe');
            
            // Get waitTime from settings, default to 5 seconds
            const taskWaitTime = task.waitTime || 5; 
            
            let btnClass = isCompleted ? 'btn-done' : 'btn-start', 
                btnText = isCompleted ? 'Completed' : 'Start', 
                btnAction = isCompleted ? 'void(0)' : `startTask('${task.id}', '${task.link}', ${task.reward}, ${taskWaitTime})`;
            
            // MODIFIED: Use ৳
            const cardHtml = `<div class="task-card"><div class="task-left"><div class="task-icon" style="background: #e6e6fa; color: #764ba2;"><i class="${iconClass}"></i></div><div class="task-info"><h4>${task.title}</h4><p>Reward: ৳ +${task.reward}</p></div></div><button id="btn-${task.id}" class="task-btn ${btnClass}" onclick="${btnAction}">${btnText}</button></div>`;
            if (isCompleted) completedHtml += cardHtml; else activeHtml += cardHtml;
        });

        if (activeHtml === '') {
            activeContainer.innerHTML = ''; 
            missionsTitle.style.display = 'none';
        } else {
            activeContainer.innerHTML = activeHtml;
            missionsTitle.style.display = 'block';
        }
        
        completedContainer.innerHTML = completedHtml; 
        completedTitle.style.display = completedHtml ? 'block' : 'none';
    });
}

// --- MISSION TIMER LOGIC (No Change) ---

function startTask(id, link, reward, waitTime = 5) {
    if (!isBotVerified && isEntryViaReferral) return;
    
    if (activeTaskTimeout) {
        return showErrorModal('Mission Active', 'Please complete the current mission first.', 'clock');
    }
    
    window.open(link, '_blank'); 
    
    const btn = document.getElementById(`btn-${id}`);
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
    btn.disabled = true; 
    btn.classList.add('btn-done');

    const actualWaitTime = waitTime > 0 ? waitTime : 5; 
    const totalWaitTimeMs = actualWaitTime * 1000 + 1500; 

    activeMissionId = id; 
    
    activeTaskTimeout = setTimeout(() => { 
        
        activeTaskTimeout = null; 
        activeMissionId = null; 
        
        if (completedTasks.includes(id)) { 
            btn.innerHTML = 'Completed'; 
            btn.className = 'task-btn btn-done'; 
            return; 
        } 
        
        btn.innerHTML = 'Claim'; 
        btn.disabled = false; 
        btn.classList.add('btn-claim-task');
        btn.classList.remove('btn-done');
        
        // Final click action after wait time
        btn.onclick = function() { 
            showRewardModal('mission', reward, id, null, btn); 
        }; 
        
    }, totalWaitTimeMs); 
}

function stopMissionTimer(showError = false) {
     if (activeTaskTimeout) { 
        
        clearTimeout(activeTaskTimeout);
        activeTaskTimeout = null;
        
        if (showError) { 
            const errorDesc = `You left the task page before the timer ended. Please restart.`;
            showErrorModal('Mission Interrupted', errorDesc, 'exclamation-triangle');
            
            const btn = document.getElementById(`btn-${activeMissionId}`);
            if(btn) {
                // Restore to original START state by re-rendering
                if (!completedTasks.includes(activeMissionId)) {
                    btn.innerHTML = 'Start';
                    btn.classList.remove('disabled', 'btn-claim-task', 'btn-done');
                    btn.classList.add('btn-start');
                    // The original onclick will be restored on next renderTasks/tab switch
                }
            }
        }
        
        activeMissionId = null;
    }
}
// --- END MISSION TIMER LOGIC ---


// --- ADS LOGIC (MODIFIED: Adsgram flow implementation) ---
function startAdFlow() { 
    const now = Date.now(); if (now < adCooldownEndTime) { updateUI(); showErrorModal('Hold On!', `Please wait ${Math.ceil((adCooldownEndTime - now) / 1000)} seconds.`, 'clock'); return; }
    if (!isBotVerified && isEntryViaReferral) return; if (adsWatchedToday >= settings.daily_limit) return;
    const adFunc = window[adFunctionName]; if (!adFunc || typeof adFunc !== 'function') { showErrorModal('Error', 'Ad function is not ready.', 'exclamation-circle'); return; }
    document.getElementById('adOverlay').style.display = 'flex'; 
    document.getElementById('watchAdBtn').classList.add('disabled'); 
    document.getElementById('watchAdBtn').innerHTML = 'Loading...'; 

    adFunc().then(() => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        openAdModal('monetag'); 
    }).catch((e) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        document.getElementById('watchAdBtn').classList.remove('disabled'); 
        document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`; 
        showErrorModal('Ad Failed', 'Ad not completed.', 'times-circle'); 
    });
}

function startAdsgramFlow() { 
    const now = Date.now(); 
    if (now < adsgramCooldownEndTime) { 
        updateUI(); 
        showErrorModal('Hold On!', `Please wait ${Math.ceil((adsgramCooldownEndTime - now) / 1000)} seconds.`, 'clock'); 
        return; 
    }
    if (!isBotVerified && isEntryViaReferral) return; 
    if (adsgramWatchedToday >= settings.adsgram_daily_limit) return;
    
    const blockId = settings.adsgram_block_id || "int-18699"; 
    if (!window.Adsgram) { 
        showErrorModal('Error', 'Adsgram SDK not loaded.', 'exclamation-circle'); 
        return; 
    }
    
    // 1. Prepare UI
    const aBtn = document.getElementById('watchAdsgramBtn');
    document.getElementById('adOverlay').style.display = 'flex'; 
    aBtn.classList.add('disabled'); 
    aBtn.innerHTML = 'Loading...'; 

    // 2. Start Cooldown (DB update first, then local timer UI) - This keeps the button disabled after ad is closed
    const newCooldownEndTime = now + settings.adsgram_cooldown_duration;
    adsgramCooldownEndTime = newCooldownEndTime; 
    startAdsgramCooldownTimer(newCooldownEndTime); 
    userRef.update({ adsgram_cooldown_end_time: newCooldownEndTime }); 

    const AdController = window.Adsgram.init({ blockId: blockId });
    const adStartTime = Date.now();

    AdController.show().then((result) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        const adDuration = Date.now() - adStartTime;
        
        if (adDuration < ADSGRAM_MIN_VIEW_DURATION_MS) {
            const remainingSeconds = Math.ceil((ADSGRAM_MIN_VIEW_DURATION_MS - adDuration) / 1000);
            showAdsgramTimerErrorModal(remainingSeconds);
            // Cooldown is already running and the button remains disabled due to the running interval.
        } else {
            openAdModal('adsgram'); 
        }
    }).catch((result) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        // Cooldown is already running. Just show a generic error modal.
        console.log("Adsgram Error/Skip:", result); 
        showErrorModal('Ad Failed', 'Ad not completed or skipped.', 'times-circle'); 
    });
}

// NEW FUNCTION: Dedicated error modal for Adsgram timer (Custom Bengali Message)
function showAdsgramTimerErrorModal(remainingSeconds) {
    const modal = document.getElementById('rewardModal');
    // Use a clock icon for the timer error
    document.getElementById('modalIconContainer').innerHTML = `<div class="reward-icon-error"><i class="fas fa-clock" style="color:white;font-size:3rem;"></i></div>`;
    document.getElementById('popupAmount').style.display = 'none';
    
    modal.querySelector('.reward-title').innerText = "সময় বাকি ছিল!"; // "Time was remaining!"
    
    // Bengali translations for the remaining time
    const remainingText = remainingSeconds === 1 ? '১ সেকেন্ড' : `${remainingSeconds} সেকেন্ড`;
    // Bengali Error Message: আপনার (এখানে বাকি সময় থাকবে) এখনো বাকি থাকতে ad টি close করে দিয়েছেন, অনুগ্রহ করে আবার চেষ্টা করুন!
    const desc = `আপনার (${remainingText}) এখনো বাকি থাকতে ad টি close করে দিয়েছেন, অনুগ্রহ করে আবার চেষ্টা করুন!`;

    modal.querySelector('.reward-desc').innerHTML = desc; 
    modal.style.display = 'flex';
    document.getElementById('modalClaimBtn').innerText = settings.error_modal_btn_text; // "Close"
    document.getElementById('modalClaimBtn').onclick = () => { 
        modal.style.display = 'none'; 
        document.body.classList.remove('modal-active'); 
        // Button is correctly kept disabled by the running adsgramCooldownInterval
    };
    document.body.classList.add('modal-active');
}

function startOnclickaFlow() {
    const now = Date.now(); if (now < onclickaCooldownEndTime) { updateUI(); showErrorModal('Hold On!', `Please wait ${Math.ceil((onclickaCooldownEndTime - now) / 1000)} seconds.`, 'clock'); return; }
    if (!isBotVerified && isEntryViaReferral) return; 
    if (onclickaWatchedToday >= settings.onclicka_daily_limit) return;
    
    if (!showOnclicka || typeof showOnclicka !== 'function') {
        showErrorModal('Error', 'Onclicka Ad function is not ready. Try again.', 'exclamation-circle'); 
        loadOnclickaSdk(settings.onclicka_spot_id); 
        return;
    }

    document.getElementById('adOverlay').style.display = 'flex'; 
    document.getElementById('watchOnclickaBtn').classList.add('disabled'); 
    document.getElementById('watchOnclickaBtn').innerHTML = 'Loading...'; 

    showOnclicka().then(() => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        openAdModal('onclicka'); 
    }).catch((e) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        document.getElementById('watchOnclickaBtn').classList.remove('disabled'); 
        document.getElementById('watchOnclickaBtn').innerHTML = `${settings.onclicka_btn_text} <i class="fas fa-play-circle"></i>`; 
        console.error("Onclicka Ad Failed:", e); 
        showErrorModal('Ad Failed', 'Ad not completed or skipped.', 'times-circle'); 
    });
}

function openAdModal(provider) {
    const btnId = (provider === 'adsgram') ? 'watchAdsgramBtn' : (provider === 'onclicka') ? 'watchOnclickaBtn' : 'watchAdBtn';
    const btn = document.getElementById(btnId);
    
    btn.classList.add('disabled'); 
    btn.innerHTML = 'Waiting...'; 

    const reward = (provider === 'adsgram') ? settings.adsgram_reward : (provider === 'onclicka') ? settings.onclicka_reward : settings.reward_per_ad;
    showRewardModal('ad', reward, null, provider); 
}

// Synchronized: executeAdRewardTransaction (Uses dynamic cooldowns, MODIFIED for Adsgram)
function executeAdRewardTransaction(amount, provider) {
    const now = new Date(); 
    const todayDateKey = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
    const ref = db.collection('users').doc(uid).collection('daily_ads_views').doc(todayDateKey);

    db.runTransaction(async t => { 
        const dailyDoc = await t.get(ref);
        const userDoc = await t.get(db.collection('users').doc(uid));
        if (!userDoc.exists) throw "User not found.";
        
        const newDailyCount = (dailyDoc.exists ? dailyDoc.data().count : 0) + 1;
        const dailyData = {
            count: newDailyCount, last_reward: amount, last_provider: provider, updated_at: Date.now(), 
            created_at: dailyDoc.exists ? dailyDoc.data().created_at : Date.now()
        };
        t.set(ref, dailyData, {merge: true}); 

        const currentTotalAds = (userDoc.data().total_ads_watched || 0) + 1;
        if (userDoc.data().referred_by) {
            const referrerUid = userDoc.data().referred_by;
            t.update(db.collection('users').doc(referrerUid).collection('referred_users').doc(uid), { referred_total_ads_watched: currentTotalAds });
        }
        
        let updateData = {
            balance: firebase.firestore.FieldValue.increment(amount), 
            total_ads_watched: firebase.firestore.FieldValue.increment(1), 
            last_activity: Date.now()
        };
        
        // Handle Independent Cooldowns & Counters
        if (provider === 'adsgram') {
            updateData.adsgram_ads_watched = firebase.firestore.FieldValue.increment(1);
            // NOTE: Cooldown time is set in startAdsgramFlow, so we don't overwrite it here.
        } else if (provider === 'onclicka') { 
            updateData.onclicka_ads_watched = firebase.firestore.FieldValue.increment(1);
            updateData.onclicka_cooldown_end_time = Date.now() + settings.onclicka_cooldown_duration;
        } else { // 'monetag' (default)
            updateData.ads_watched = firebase.firestore.FieldValue.increment(1);
            updateData.ad_cooldown_end_time = Date.now() + settings.monetag_cooldown_duration;
        }

        t.update(db.collection('users').doc(uid), updateData);
    }).then(() => {
        // Update local cooldown variable immediately for UI responsiveness
        if (provider === 'adsgram') {
             // adsgramCooldownEndTime is already set in startAdsgramFlow, just update UI
        }
        else if (provider === 'onclicka') onclickaCooldownEndTime = Date.now() + settings.onclicka_cooldown_duration; 
        else adCooldownEndTime = Date.now() + settings.monetag_cooldown_duration;
        updateUI();
    }).catch(err => console.error("Ad log failed: ", err));
}

// MODIFIED: Custom Success Modal (use ৳)
function showCustomSuccessModal(title, desc, iconName) {
    const modal = document.getElementById('rewardModal');
    document.getElementById('modalIconContainer').innerHTML = `<div class="reward-icon-success"><i class="fas fa-${iconName}" style="color:white;font-size:3rem;"></i></div>`;
    document.getElementById('popupAmount').style.display = 'none';
    modal.querySelector('.reward-title').innerText = title || settings.withdraw_success_title;
    // MODIFIED: Ensure ৳ is used in success desc if applicable
    modal.querySelector('.reward-desc').innerHTML = desc || settings.withdraw_success_desc; 
    modal.style.display = 'flex';
    document.getElementById('modalClaimBtn').innerText = settings.withdraw_success_btn_text; 
    document.getElementById('modalClaimBtn').onclick = () => { modal.style.display = 'none'; document.body.classList.remove('modal-active'); };
    document.body.classList.add('modal-active');
}

// MODIFIED: Error Modal (use ৳)
function showErrorModal(title, desc, iconName) {
    const modal = document.getElementById('rewardModal');
    document.getElementById('modalIconContainer').innerHTML = `<div class="reward-icon-error"><i class="fas fa-${iconName}" style="color:white;font-size:3rem;"></i></div>`;
    document.getElementById('popupAmount').style.display = 'none';
    modal.querySelector('.reward-title').innerText = title; 
    // MODIFIED: Ensure ৳ is used in error desc if applicable
    modal.querySelector('.reward-desc').innerHTML = desc.replace('Coins', '৳'); 
    modal.style.display = 'flex';
    document.getElementById('modalClaimBtn').innerText = settings.error_modal_btn_text; 
    document.getElementById('modalClaimBtn').onclick = () => { modal.style.display = 'none'; document.body.classList.remove('modal-active'); };
    document.body.classList.add('modal-active');
}

// UPDATED: showRewardModal (MODIFIED: Use ৳ in text and for flying icon)
function showRewardModal(type, amount, id, provider = null, taskButtonEl = null) {
    if (!isBotVerified && isEntryViaReferral) return;
    let title = 'Reward!', desc = 'Processed.';
    // MODIFIED: Use fa-money-bill-wave icon
    document.getElementById('modalIconContainer').innerHTML = '<i class="fas fa-money-bill-wave reward-icon-success" style="background: #2ecc71; color: white; margin-bottom: 15px; font-size: 3rem; animation: bounce 2s infinite;" id="defaultRewardIcon"></i>';
    document.getElementById('popupAmount').style.display = 'block';
    document.body.classList.add('modal-active');

    if (type === 'ad') { title = settings.ad_popup_title; desc = settings.ad_popup_desc; }
    else if (type === 'daily') { title = settings.daily_popup_title; desc = settings.daily_popup_desc; }
    else if (type === 'mission') { title = settings.mission_popup_title; desc = settings.mission_popup_desc; }
    // MODIFIED: Use ৳
    else if (type === 'referral') { title = 'Referral Bonus!'; desc = 'You are about to claim your ৳ referral bonus.'; } 

    // MODIFIED: Prepend ৳
    document.getElementById('popupAmount').innerText = '৳ +' + amount;
    const modal = document.getElementById('rewardModal');
    modal.querySelector('.reward-title').innerText = title; modal.querySelector('.reward-desc').innerText = desc; 
    modal.style.display = 'flex';
    const btn = document.getElementById('modalClaimBtn');
    btn.onclick = null; btn.innerText = settings.modal_claim_btn_text; 
    
    btn.onclick = function() {
        modal.style.display = 'none';
        document.body.classList.remove('modal-active');
        
        // Flying Animation 
        // MODIFIED: Use a DIV with ৳ symbol and color for the flying coin
        const coin = document.createElement('div'); 
        coin.innerHTML = '৳';
        coin.className = 'fly-coin';
        coin.style.backgroundColor = '#ffd700'; 
        coin.style.borderRadius = '50%';
        
        const c = { x: window.innerWidth/2, y: window.innerHeight/2 }; coin.style.left = `${c.x-17.5}px`; coin.style.top = `${c.y-17.5}px`; document.body.appendChild(coin);
        const t = document.getElementById('mainCoinIcon').getBoundingClientRect();
        
        // Start balance animation
        let newBalance = currentBalance + amount; 
        animateBalance(currentBalance, newBalance);
        
        setTimeout(() => { 
             coin.style.left = t.left+'px'; coin.style.top = t.top+'px'; coin.style.opacity = '0.5'; coin.style.transform = 'scale(0.5)'; 
             // DB Transaction after animation starts (close enough)
             if (type === 'ad') { executeAdRewardTransaction(amount, provider); }
             else if (type === 'mission') { 
                userRef.update({ 
                    balance: firebase.firestore.FieldValue.increment(amount), 
                    completed_tasks: firebase.firestore.FieldValue.arrayUnion(id), 
                    last_activity: Date.now() 
                }).then(() => {
                    if (taskButtonEl) {
                        taskButtonEl.innerHTML = 'Completed'; 
                        taskButtonEl.className = 'task-btn btn-done'; 
                        taskButtonEl.disabled = true; 
                    }
                }); 
             }
             else if (type === 'daily') {
                 const today = new Date().toDateString();
                 userRef.update({ balance: firebase.firestore.FieldValue.increment(amount), last_daily_claim_date: today, last_activity: Date.now() }).then(() => {
                     if(window.dailyClaimButtonRef) { 
                         window.dailyClaimButtonRef.innerHTML = 'Claimed'; 
                         window.dailyClaimButtonRef.className = 'task-btn btn-done'; 
                         window.dailyClaimButtonRef.disabled = true; 
                         lastDailyClaimDate = today; 
                         delete window.dailyClaimButtonRef; 
                     }
                 });
             } 
             else if (type === 'referral') { 
                 processReferralClaimTransaction(window.referredIdToClaim, window.rewardAmountToClaim);
             }
        }, 50);
        setTimeout(() => coin.remove(), 800);
    };
}


function formatDate(timestamp) {
    if (!timestamp) return 'N/A';
    const date = (typeof timestamp === 'number') ? new Date(timestamp) : timestamp.toDate();
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

async function processReferralClaimTransaction(referredUid, amount) {
     const btn = document.getElementById(`ref-btn-${referredUid}`);
    const refUserRef = db.collection('users').doc(uid).collection('referred_users').doc(referredUid);
    try {
        await db.runTransaction(async t => {
            const userDoc = await t.get(userRef); const refDoc = await t.get(refUserRef);
            if (!userDoc.exists || !refDoc.exists) throw "User or Referral record not found.";
            if (refDoc.data().is_claimed) throw "Bonus already claimed.";
            if ((refDoc.data().referred_total_ads_watched || 0) < settings.ref_ads_watch_requirement) throw "Req not met.";
            t.update(userRef, { balance: firebase.firestore.FieldValue.increment(amount), referral_earnings: firebase.firestore.FieldValue.increment(amount), last_activity: Date.now() });
            t.update(refUserRef, { is_claimed: true, claimed_at: Date.now() });
            return amount; 
        });
    } catch (error) {
        console.error("Referral Claim Failed: ", error);
        const errMsg = (typeof error === 'string') ? error : "An unexpected error occurred.";
        if (btn && errMsg !== "Bonus already claimed.") { btn.innerHTML = 'Claim'; btn.classList.remove('btn-done'); btn.classList.add('btn-claim-task'); btn.disabled = false; }
        showErrorModal('Claim Failed', errMsg, 'exclamation-triangle');
    }
    window.referredIdToClaim = null; window.rewardAmountToClaim = null; 
}

async function claimReferralBonus(referredUid, amount) {
    if (!isBotVerified && isEntryViaReferral) return;
    const btn = document.getElementById(`ref-btn-${referredUid}`); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
    const refDoc = await db.collection('users').doc(uid).collection('referred_users').doc(referredUid).get();
    if (!refDoc.exists || refDoc.data().is_claimed || (refDoc.data().referred_total_ads_watched || 0) < settings.ref_ads_watch_requirement) {
         btn.innerHTML = 'Pending'; btn.classList.remove('btn-claim-task'); btn.classList.add('btn-done'); btn.disabled = true;
         showErrorModal('Requirement Not Met', 'Your referral has not yet viewed enough ads.', 'hand-point-up'); return; 
    }
    window.referredIdToClaim = referredUid; window.rewardAmountToClaim = amount; showRewardModal('referral', amount, referredUid); 
}

// MODIFIED: Use ৳ in renderReferrals list
function updateReferralList(data, page, type) {
    const container = document.getElementById(`${type}ReferralListContainer`); const titleEl = document.getElementById(`${type}ReferralsTitle`); const paginationEl = document.getElementById(`${type}ReferralPagination`);
    const start = (page - 1) * pageSize; const end = start + pageSize; const paginatedData = data.slice(start, end); const totalPages = Math.ceil(data.length / pageSize); const refReq = settings.ref_ads_watch_requirement || 100;
    titleEl.style.display = data.length > 0 ? 'block' : 'none';
    if (data.length === 0) { container.innerHTML = ''; paginationEl.style.display = 'none'; return; }
    let html = '';
    paginatedData.forEach(r => {
        const adsWatched = r.referred_total_ads_watched || 0; const cappedAdsWatched = Math.min(adsWatched, refReq); const isReadyToClaim = adsWatched >= refReq; const progressText = `${cappedAdsWatched}/${refReq}`; const progressColor = isReadyToClaim ? '#4caf50' : '#ff9800';
        let btnClass = 'btn-done', btnText = 'Pending', btnAction = 'void(0)', btnDisabled = true, buttonStyle = 'opacity: 0.8;';
        if (r.is_claimed) { btnText = 'Claimed'; btnClass = 'btn-done'; btnDisabled = true; buttonStyle = 'opacity: 1;'; } 
        else if (isReadyToClaim) { btnText = 'Claim'; btnClass = 'btn-claim-task'; btnAction = `claimReferralBonus('${r.id}', ${settings.ref_bonus})`; btnDisabled = false; buttonStyle = 'animation: pulse 1s infinite;'; }
        const joinDate = formatDate(r.created_at); 
        // MODIFIED: Use ৳
        html += `<div class="task-card ref-list-card" id="ref-card-${r.id}"><div class="task-left"><div class="task-icon" style="width: 40px; height: 40px; border-radius: 10px; font-size: 1rem;"><i class="fas fa-user-check"></i></div><div class="ref-user-info"><h4>${r.referred_username}</h4><p>UID: ${r.referred_uid.substring(0, 4)}...${r.referred_uid.slice(-4)}</p><p class="ref-join-date">Joined: ${joinDate}</p></div></div><div class="ref-actions"><div class="ref-summary-right"><div class="ref-reward-amount">৳ +${settings.ref_bonus}</div><div class="ref-progress-text" style="color: ${progressColor};">${progressText} Ads</div></div><button id="ref-btn-${r.id}" class="task-btn ${btnClass}" onclick="${btnAction}" ${btnDisabled ? 'disabled' : ''} style="${buttonStyle}">${btnText}</button></div></div>`;
    });
    container.innerHTML = html;
    paginationEl.innerHTML = '';
    if (totalPages > 1) {
        const prevBtn = `<button class="page-btn" onclick="changeRefPage('${type}', ${page - 1})" ${page === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
        const nextBtn = `<button class="page-btn" onclick="changeRefPage('${type}', ${page + 1})" ${page === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
        let pageNumbers = ''; for (let i = 1; i <= totalPages; i++) { pageNumbers += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="changeRefPage('${type}', ${i})">${i}</button>`; }
        paginationEl.innerHTML = prevBtn + pageNumbers + nextBtn; paginationEl.style.display = 'flex';
    } else { paginationEl.style.display = 'none'; }
}
function changeRefPage(type, newPage) { if (type === 'active') { activeRefPage = newPage; updateReferralList(activeReferralsData, activeRefPage, 'active'); } else if (type === 'completed') { completedRefPage = newPage; updateReferralList(completedReferralsData, completedRefPage, 'completed'); } }

// UPDATED: toggleAccountInput (Withdrawal Method Placeholder System)
function toggleAccountInput() { 
    const selectEl = document.getElementById('withdrawMethod');
    const accInputEl = document.getElementById('accountNumber');
    const selectedOption = selectEl.options[selectEl.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const placeholderText = selectedOption.getAttribute('data-placeholder');
        accInputEl.placeholder = placeholderText || 'Wallet Address / Number';
        accInputEl.style.display = 'block';
    } else {
        accInputEl.style.display = 'none';
        accInputEl.placeholder = 'Wallet Address / Number';
    }
}

function requestWithdraw() {
    if (!isBotVerified && isEntryViaReferral) return;
    const method = document.getElementById('withdrawMethod').value, accNum = document.getElementById('accountNumber').value.trim();
    const amount = parseInt(document.getElementById('withdrawAmount').value), minWithdraw = settings.min_withdraw; 
    
    // MODIFIED: Update error messages to use ৳
    const minAmtErrDesc = settings.min_amt_err_desc.replace('{{min_withdraw}}', `৳ ${minWithdraw}`);
    const minAdsErrDesc = settings.min_ads_err_desc.replace('{{min_ads_view}}', settings.min_ads_view_for_withdraw);
    const minRefsErrDesc = settings.min_refs_err_desc.replace('{{min_referrals}}', settings.min_referrals_for_withdraw);

    if (totalAdsWatched < settings.min_ads_view_for_withdraw) return showErrorModal(settings.min_ads_err_title, minAdsErrDesc, 'video');
    if (referralCount < settings.min_referrals_for_withdraw) return showErrorModal(settings.min_refs_err_title, minRefsErrDesc, 'user-plus');
    if (isNaN(amount) || amount <= 0) return showErrorModal(settings.min_amt_err_title, minAmtErrDesc, 'ban');
    if (amount < minWithdraw) return showErrorModal(settings.min_amt_err_title, minAmtErrDesc, 'hand-point-up');
    if (amount > currentBalance) return showErrorModal(settings.bal_err_title, settings.bal_err_desc, 'wallet');
    if (!method) return showErrorModal(settings.method_err_title, settings.method_err_desc, 'credit-card');
    if (!accNum) return showErrorModal(settings.acc_num_err_title, settings.acc_num_err_desc, 'user-circle');
    
    document.getElementById('balance').innerHTML = '<div class="spinner"></div>';
    
    userRef.update({ balance: firebase.firestore.FieldValue.increment(-amount), last_activity: Date.now() }).then(() => {
        db.collection('withdrawals').add({ user_id: uid, username: username, method: method, account_number: accNum, amount: amount, status: 'pending', date: Date.now() })
        .then(() => { 
            showCustomSuccessModal(settings.withdraw_success_title, settings.withdraw_success_desc, 'check-circle'); 
            document.getElementById('withdrawAmount').value = ''; 
            document.getElementById('accountNumber').value = ''; 
            document.getElementById('withdrawMethod').value = ''; 
            toggleAccountInput(); // Reset/hide account input
        });
    }).catch(err => { 
        // MODIFIED: Prepend ৳
        showErrorModal("Transaction Error", "Error deducting balance.", 'exclamation-triangle'); 
        document.getElementById('balance').innerText = '৳ ' + currentBalance; 
    });
}

function hideHistoryModal() { document.getElementById('historyModal').style.display = 'none'; document.body.classList.remove('modal-active'); }
function showHistoryModal(type) {
     if (!uid) return; const modal = document.getElementById('historyModal'); const titleEl = document.querySelector('#historyModal .reward-title'), iconContainer = document.getElementById('historyModalIconContainer'); document.getElementById('historyListContainer').innerHTML = `<div style="text-align:center; padding: 30px; color: #999;"><div class="spinner spinner-dark"></div><p style="margin-top:10px;">Loading...</p></div>`;
    if (type === 'withdrawal') { titleEl.innerText = 'Withdraw History'; iconContainer.innerHTML = '<i class="fas fa-wallet fa-2x" style="color: #764ba2; margin-bottom: 15px;"></i>'; fetchWithdrawalHistory(); } 
    modal.style.display = 'flex'; document.body.classList.add('modal-active'); updateUserActivity(); 
}
function showAdsHistoryModal() {
    if (!uid) return; const modal = document.getElementById('historyModal'); document.getElementById('historyListContainer').innerHTML = `<div style="text-align:center; padding: 30px; color: #999;"><div class="spinner spinner-dark"></div><p style="margin-top:10px;">Loading...</p></div>`; document.querySelector('#historyModal .reward-title').innerText = 'Ads View History'; document.getElementById('historyModalIconContainer').innerHTML = '<i class="fas fa-video fa-2x" style="color: #764ba2; margin-bottom: 15px;"></i>'; modal.style.display = 'flex'; document.body.classList.add('modal-active'); fetchAdsHistory(); updateUserActivity(); 
}
// MODIFIED: Use ৳ in fetchWithdrawalHistory
function fetchWithdrawalHistory() {
    if (!uid) return; db.collection('withdrawals').where('user_id', '==', uid).orderBy('date', 'desc').onSnapshot(snapshot => {
        let html = ''; if (snapshot.empty) html = `<div style="text-align:center; padding: 30px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No withdrawal history found.</p></div>`;
        else snapshot.forEach(doc => { 
            const item = doc.data(); 
            const date = item.date ? new Date(item.date).toLocaleDateString() : 'N/A'; 
            
            // Synchronized Status Colors
            let statusClass = 'status-pending'; 
            if (item.status === 'paid' || item.status === 'completed') statusClass = 'status-paid';
            else if (item.status === 'rejected' || item.status === 'declined') statusClass = 'status-rejected';

            html += `
            <div class="history-item" style="align-items: flex-start;">
                <div class="item-details">
                    <h4 style="margin-bottom: 8px; font-size: 1rem; color: #764ba2;">৳ ${item.amount}</h4>
                    <div style="font-size: 0.85rem; color: #444; line-height: 1.6;">
                        <strong>Method:</strong> ${item.method}
                        <br><strong>Account:</strong> ${item.account_number || 'N/A'}
                        <br><span style="font-size: 0.75rem; color: #888;">Date: ${date}</span>
                    </div>
                </div>
                <span class="item-status ${statusClass}" style="margin-top: 5px;">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
            </div>`; 
        });
        document.getElementById('historyListContainer').innerHTML = html;
    });
}
// MODIFIED: fetchAdsHistory (REMOVED 'Ads view needed' lines)
function fetchAdsHistory() {
    if (!uid) return; db.collection('users').doc(uid).collection('daily_ads_views').orderBy('updated_at', 'desc').onSnapshot(snapshot => {
        let html = ''; const bgColor = '#764ba2'; // Use primary color for background
        
        // Custom Ad History Summary (MODIFIED: Removed conditional requirement check)
        html += `<div class="ads-history-summary" style="background: #f0f5ff; border: 1px solid #cceeff;">
                    <div class="item-details" style="text-align: left;">
                        <h4 style="color:#764ba2; margin:0;">Total Lifetime Ads:</h4>
                        <!-- Removed 'Ads view needed, requirement met' line -->
                    </div>
                    <span class="item-status" style="background:${bgColor}; font-size:1rem; padding: 6px 12px; color: white;">${totalAdsWatched}</span>
                </div>`;
        
        if (snapshot.empty) html += `<div style="text-align:center; padding: 30px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No ads view history found.</p></div>`; 
        else snapshot.forEach(doc => { 
            const item = doc.data(); 
            const dateKey = doc.id; 
            const parts = dateKey.split('-'); 
            const displayDate = new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            
            let providerName = 'Last Ad Viewed: Ad Card 1'; 
            if(item.last_provider === 'adsgram') providerName = 'Last Ad Viewed: Ad Card 2';
            else if(item.last_provider === 'onclicka') providerName = 'Last Ad Viewed: Ad Card 3';

            // Custom Ad History Item (MODIFIED: Use ৳)
            html += `
            <div class="history-item-ad" style="display: flex; justify-content: space-between; align-items: center;">
                <div class="item-details" style="text-align: left;">
                    <h4 style="font-size: 0.95rem;">Daily Ads Log</h4>
                    <p style="margin: 2px 0; color: #777;">Date: ${displayDate}</p>
                    <span class="ad-zone-pill">${providerName}</span>
                </div>
                <div style="text-align: right;">
                    <h4 style="margin: 0; font-size: 1rem; color: #333;">${item.count} Viewed</h4>
                    <p style="margin: 2px 0 0; font-size: 0.75rem; color: #777;">৳ +${item.last_reward * item.count}</p>
                </div>
            </div>`; 
        });
        document.getElementById('historyListContainer').innerHTML = html;
    });
}
// --- END MODIFIED: fetchAdsHistory ---


// --- NEW: LEADERBOARD & TOURNAMENT LOGIC (MODIFIED: Use ৳ in prize modal) ---

function handleTournamentButtonClick() {
    if (!isTournamentActive) {
        showErrorModal('Tournament Inactive', 'The Referrals Tournament is currently inactive. Please check back later.', 'trophy');
    } else if (!hasJoinedTournament) {
        showJoinTournamentModal();
    } else {
        showTournamentListModal();
    }
}

function showTournamentListModal() {
    if (!isTournamentActive) return;

    document.getElementById('tournListModalTitle').innerText = settings.tournament_title;
    document.getElementById('tournamentListModal').style.display = 'flex';
    document.body.classList.add('modal-active');
    
    const joinBtn = document.getElementById('listModalJoinBtn');
    joinBtn.style.display = hasJoinedTournament ? 'none' : 'block';
    
    document.getElementById('currentUserTournamentSummary').style.display = 'none';
    document.getElementById('currentUserTournamentSummary').innerHTML = '';

    startTournamentCountdown(tournamentEndTime, 'tournListTimerDisplay');

    fetchTournamentLeaderboard(document.getElementById('tournamentLeaderboardList'), true);
}

function hideTournamentListModal() {
    document.getElementById('tournamentListModal').style.display = 'none';
    document.body.classList.remove('modal-active');
}

function showJoinTournamentModal(fromList = false) {
    if (hasJoinedTournament) { 
        if(fromList) hideTournamentListModal();
        return; 
    }
    
    document.getElementById('joinModalTitle').innerText = settings.tournament_title;
    document.getElementById('joinModalDesc').innerText = settings.tournament_desc;
    
    document.getElementById('joinTournamentModal').style.display = 'flex';
    document.body.classList.add('modal-active');
    if(fromList) hideTournamentListModal(); 
}

function hideJoinTournamentModal() {
    document.getElementById('joinTournamentModal').style.display = 'none';
    document.body.classList.remove('modal-active');
}

function renderLeaderboard() {
    if (!isBotVerified && isEntryViaReferral) return;

    const container = document.getElementById('topReferralListContainer');
    const titleEl = document.getElementById('leaderboardTitle');
    const descEl = document.getElementById('leaderboardDesc');
    const tourneyUI = document.getElementById('tournament-ui-container'); 
    const now = Date.now();

    if (isTournamentActive && now < tournamentEndTime) {
        tourneyUI.style.display = 'block';
        document.getElementById('referralTournamentBtn').innerHTML = `<i class="fas fa-trophy"></i> ${settings.tournament_btn_text}`;
        startTournamentCountdown(tournamentEndTime, 'tournamentTimerDisplay');
    } else {
        tourneyUI.style.display = 'none';
        if (tournamentCountdownInterval) clearInterval(tournamentCountdownInterval);
    }
    
    titleEl.innerText = 'Top 100 Referrers';
    descEl.innerText = 'The list of the top 100 users with the most *lifetime* referrals. The list updates in real-time.';
    
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #999;"><div class="spinner spinner-dark"></div><p style="margin-top:10px;">Loading Lifetime Leaderboard...</p></div>`;
    
    db.collection('users').orderBy('referral_count', 'desc').limit(100).onSnapshot(snapshot => {
         let html = '';
         const filteredUsers = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(data => (data.referral_count || 0) > 0); 

        if (filteredUsers.length === 0) {
            html = `<div style="text-align:center; padding: 40px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No referrers yet.</p></div>`;
        } else {
             filteredUsers.forEach((data, index) => {
                  const rank = index + 1;
                  const fullName = data.full_name || data.username || 'Unknown User'; 
                  const referralCount = data.referral_count || 0;
                  const refText = referralCount === 1 ? 'Referral' : 'Referrals'; 
                  
                  let rankBadgeHtml = ''; let rankText = rank; let badgeClass = 'rank-other';
                  if (rank === 1) { rankBadgeHtml = `<i class="fas fa-crown"></i>`; badgeClass = 'rank-1'; rankText = ''; } 
                  else if (rank === 2) { rankBadgeHtml = `<i class="fas fa-star"></i>`; badgeClass = 'rank-2'; rankText = ''; } 
                  else if (rank === 3) { rankBadgeHtml = `<i class="fas fa-medal"></i>`; badgeClass = 'rank-3'; rankText = ''; }
                  
                  html += `
                    <div class="top-ref-item">
                        <div class="ref-rank-badge ${badgeClass}">${rankBadgeHtml || rankText}</div>
                        <div class="ref-info"><h4>${fullName}</h4></div>
                        <div class="ref-count-pill"><span>${refText}</span><b>${referralCount}</b></div>
                    </div>`;
             });
        }
        container.innerHTML = html;
    });
}


function fetchTournamentLeaderboard(container, isModal = false) {
    if (!isTournamentActive) return;

    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #999;"><div class="spinner spinner-dark"></div><p style="margin-top:10px;">Loading Tournament Leaderboard...</p></div>`;
    
    const currentUserSummaryEl = document.getElementById('currentUserTournamentSummary');
    if(isModal && currentUserSummaryEl) {
        currentUserSummaryEl.style.display = 'none';
        currentUserSummaryEl.innerHTML = '';
    }

    db.collection('users')
        .where('has_joined_tournament', '==', true)
        .orderBy('tournament_referral_count', 'desc')
        .limit(100) 
        .onSnapshot(snapshot => {
            let html = '';
            let currentUserData = null;
            const participatingUsers = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(data => (data.tournament_referral_count || 0) >= 0); 

            participatingUsers.forEach((data, index) => {
                if (data.id === uid) {
                    currentUserData = {...data, rank: index + 1};
                }
            });

            if (isModal && hasJoinedTournament && currentUserData) {
                const rankText = currentUserData.rank;
                const refCount = currentUserData.tournament_referral_count || 0;
                const refText = refCount === 1 ? 'Referral' : 'Referrals';

                currentUserSummaryEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center;">
                            <span class="ref-rank-badge rank-other" style="min-width: 30px; height: 30px; font-size: 0.9rem; background: #667eea; color: white; margin-right: 10px; border-radius: 8px; box-shadow:none;">${rankText}</span>
                            <span>${userFullName}</span>
                        </div>
                        <div class="ref-count-pill" style="background:#3498db; font-size: 0.9rem; min-width: 80px;"><span>${refText}</span><b>${refCount}</b></div>
                    </div>
                `;
                currentUserSummaryEl.style.display = 'block';
            }


            if (participatingUsers.length === 0) {
                html = `<div style="text-align:center; padding: 40px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No users have joined the tournament yet.</p></div>`;
            } else {
                 participatingUsers.forEach((data, index) => {
                      const rank = index + 1;
                      const fullName = data.full_name || data.username || 'Unknown User'; 
                      const referralCount = data.tournament_referral_count || 0; 
                      const refText = referralCount === 1 ? 'Referral' : 'Referrals';
                      
                      let rankBadgeHtml = ''; let rankText = rank; let badgeClass = 'rank-other';
                      if (rank === 1) { rankBadgeHtml = `<i class="fas fa-crown"></i>`; badgeClass = 'rank-1'; rankText = ''; } 
                      else if (rank === 2) { rankBadgeHtml = `<i class="fas fa-star"></i>`; badgeClass = 'rank-2'; rankText = ''; } 
                      else if (rank === 3) { rankBadgeHtml = `<i class="fas fa-medal"></i>`; badgeClass = 'rank-3'; rankText = ''; }
                      
                      const isCurrentUser = data.id === uid;
                      const itemClass = isCurrentUser && !isModal ? 'top-ref-item active-user-highlight' : 'top-ref-item'; 
                      
                      const rankContainerHtml = isModal && rank > 3 ? 
                            `<div class="ref-rank-badge rank-other" style="background:#f0f2f5; color:#777; font-size:1rem; box-shadow:none; border-radius: 8px; min-width: 40px; height: 40px;">${rank}</div>` : 
                            `<div class="ref-rank-badge ${badgeClass}">${rankBadgeHtml || rankText}</div>`;

                      html += `
                        <div class="${itemClass}">
                            ${rankContainerHtml}
                            <div class="ref-info"><h4>${fullName}</h4></div>
                            <div class="ref-count-pill" style="background:#3498db;"><span>${refText}</span><b>${referralCount}</b></div>
                        </div>`;
                 });
            }
            container.innerHTML = html;
        });
}


function startTournamentCountdown(endTime, displayId) {
    if (tournamentCountdownInterval) clearInterval(tournamentCountdownInterval); 
    const displayEl = document.getElementById(displayId);
    if(!displayEl) return; // FIX: Prevent error if element doesn't exist

    updateCountdownDisplay(endTime, displayEl);

    tournamentCountdownInterval = setInterval(() => {
        updateCountdownDisplay(endTime, displayEl);
    }, 1000); 
}

function updateCountdownDisplay(endTime, displayEl) {
    const now = Date.now();
    const remaining = endTime - now; 
    
    if (remaining <= 0) {
        clearInterval(tournamentCountdownInterval);
        isTournamentActive = false;
        document.getElementById('tournament-ui-container').style.display = 'none';
        const modalCountdown = document.getElementById('tournListModalCountdown');
        if(modalCountdown) modalCountdown.style.display = 'none';
        
        checkAndShowPrizeModal();
        renderLeaderboard(); 
        return;
    }

    const totalSeconds = Math.floor(remaining / 1000); 
    const days = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60; 

    const display = `${days}D ${String(hours).padStart(2, '0')}H ${String(minutes).padStart(2, '0')}M ${String(seconds).padStart(2, '0')}S`;
    displayEl.innerHTML = display;
}


function joinTournament() {
    if(hasJoinedTournament) return;
    document.getElementById('joinTournamentBtn').disabled = true;
    document.getElementById('joinTournamentBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Joining...';

    userRef.update({
        has_joined_tournament: true,
        tournament_referral_count: 0 
    }).then(() => {
        hasJoinedTournament = true;
        hideJoinTournamentModal();
        showCustomSuccessModal('Tournament Joined!', 'Good Luck in the competition!', 'trophy');
        renderLeaderboard();
    }).catch(err => {
        showErrorModal('Join Failed', 'Failed to join: ' + err.message, 'exclamation-triangle');
        document.getElementById('joinTournamentBtn').disabled = false;
        document.getElementById('joinTournamentBtn').innerHTML = 'Join Tournament!';
    });
}

function showRulesModal() {
    document.getElementById('tournamentRulesContent').innerHTML = settings.tournament_rules || 'No rules available yet.';
    document.getElementById('rulesModal').style.display = 'flex';
}
function hideRulesModal() {
    document.getElementById('rulesModal').style.display = 'none';
}

// --- PRIZE COLLECTION LOGIC (MODIFIED: Use ৳) ---
function getPrizeAmount(rank, prizeTiers) {
    if (rank === 1) return prizeTiers['1'] || 0;
    if (rank === 2) return prizeTiers['2'] || 0;
    if (rank === 3) return prizeTiers['3'] || 0;
    if (rank >= 4 && rank <= 10) return prizeTiers['4-10'] || 0;
    if (rank >= 11 && rank <= 20) return prizeTiers['11-20'] || 0;
    if (rank >= 21 && rank <= 50) return prizeTiers['21-50'] || 0;
    if (rank >= 51 && rank <= 100) return prizeTiers['51-100'] || 0;
    if (rank >= 101 && rank <= 500) return prizeTiers['101-500'] || 0;
    if (rank >= 501 && rank <= 1000) return prizeTiers['501-1000'] || 0;
    if (rank > 1000) return prizeTiers['1000+'] || 0;
    return 0;
}

function getRankRange(rank) {
    if (rank === 1) return '1';
    if (rank === 2) return '2';
    if (rank === 3) return '3';
    if (rank >= 4 && rank <= 10) return '4-10';
    if (rank >= 11 && rank <= 20) return '11-20';
    if (rank >= 21 && rank <= 50) return '21-50';
    if (rank >= 51 && rank <= 100) return '51-100';
    if (rank >= 101 && rank <= 500) return '101-500';
    if (rank >= 501 && rank <= 1000) return '501-1000';
    if (rank > 1000) return '1000+';
    return 'Unranked';
}

function checkAndShowPrizeModal() {
    if (window.userTournamentRank === null || window.hasClaimedPrize || isTournamentActive) return; 
    
    if(document.getElementById('statusModal').style.display !== 'none') {
        document.getElementById('statusModal').style.display = 'none';
    }
    document.body.classList.add('modal-active');
    
    const rank = window.userTournamentRank;
    const prizeAmount = getPrizeAmount(rank, settings.tournament_prizes);
    
    if (prizeAmount <= 0) {
        userRef.update({ 'tournament_data.claimed_prize': true });
        document.body.classList.remove('modal-active');
        return;
    }

    const rankRange = getRankRange(rank);
    
    document.getElementById('prizeModalTitle').innerText = settings.prize_popup_title;
    let desc = settings.prize_popup_desc.replace('{{rank_range}}', rankRange);
    // MODIFIED: Use ৳
    desc = desc.replace('{{prize_amount}}', `৳ ${prizeAmount}`);
    document.getElementById('prizeModalDesc').innerText = desc;
    // MODIFIED: Use ৳
    document.getElementById('prizePopupAmount').innerText = `৳ +${prizeAmount}`;
    document.getElementById('prizeCollectBtn').innerText = settings.prize_popup_btn_text;

    document.getElementById('prizeCollectBtn').onclick = () => claimTournamentPrize(prizeAmount);
    document.getElementById('prizeCollectModal').style.display = 'flex';
}

function claimTournamentPrize(amount) {
    document.getElementById('prizeCollectBtn').disabled = true;
    document.getElementById('prizeCollectBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Collecting...';
    
    let newBalance = currentBalance + amount; 
    animateBalance(currentBalance, newBalance);

    userRef.update({
        balance: firebase.firestore.FieldValue.increment(amount),
        'tournament_data.claimed_prize': true,
        last_activity: Date.now()
    }).then(() => {
        window.hasClaimedPrize = true;
        document.getElementById('prizeCollectModal').style.display = 'none';
        document.body.classList.remove('modal-active');
        // MODIFIED: Use ৳
        showCustomSuccessModal('Bounty Claimed!', `You collected ৳ ${amount}!`, 'check-circle');
    }).catch(err => {
        console.error("Prize claim failed:", err);
        showErrorModal('Claim Failed', 'Collection failed: ' + err.message, 'exclamation-triangle');
        document.getElementById('prizeCollectBtn').disabled = false;
        document.getElementById('prizeCollectBtn').innerHTML = settings.prize_popup_btn_text;
    });
}


function switchTab(id, el) {
    if (!isBotVerified && isEntryViaReferral) return; 
    
    // Synchronized: Mission Tab Exit Check
    const isLeavingTasks = document.getElementById('tasks-section').classList.contains('active-section') && id !== 'tasks';
    if (isLeavingTasks && activeTaskTimeout) {
        stopMissionTimer(true); 
    }

    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section')); 
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); 
    
    document.getElementById(id+'-section').classList.add('active-section'); 
    el.classList.add('active');
    
    window.scrollTo(0,0); 
    updateUserActivity(); 

    if (id === 'invite') { 
        activeRefPage = 1; completedRefPage = 1; renderReferrals(activeRefPage); 
    } else if (id === 'topref') { 
        renderLeaderboard(); 
    } else if (id === 'tasks') {
        renderTasks();
    }
}

// Initial tab setting: Set 'home' as active on load (No Change)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
    document.getElementById('home-section').classList.add('active-section');

    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const homeNavItem = document.querySelector(`.bottom-nav .nav-item[onclick*="'home'"]`);
    if (homeNavItem) {
        homeNavItem.classList.add('active');
    }
});


function copyLink(btn) { navigator.clipboard.writeText(document.getElementById('refLink').innerText).then(() => { let old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-check"></i> Copied!'; btn.style.background = '#4caf50'; setTimeout(() => { btn.innerHTML = old; btn.style.background = '#333'; }, 1000); }); }

// MODIFIED: animateBalance (Added the counting-sparkle class toggle and ৳ prepend)
function animateBalance(start, end) { 
    const balanceEl = document.getElementById('balance');
    let current = start, step = Math.ceil((end - start) / 10); 
    
    balanceEl.classList.add('counting-sparkle'); // Start sparkle
    
    const timer = setInterval(() => { 
        current += step; 
        if (current >= end) { 
            current = end; 
            clearInterval(timer); 
            balanceEl.classList.remove('counting-sparkle'); // Stop sparkle
        } 
        // MODIFIED: Prepend ৳
        balanceEl.innerText = '৳ ' + current; 
    }, 30); 
}

       
   </script>
</body>
</html>
