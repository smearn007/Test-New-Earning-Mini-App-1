<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Earning App</title>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- STYLES (Premium Design) --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%); /* For Adsgram */
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --progress-bg: #e0e0e0;
            --progress-fill: linear-gradient(90deg, #667eea, #764ba2);
            --red: #e74c3c; 
            --green: #2ecc71; 
        }

        /* Blur Effect for Modal */
        body.modal-active > .header, 
        body.modal-active > .container, 
        body.modal-active > .bottom-nav {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
        }

        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: #333; overflow-x: hidden; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }

        /* Header */
        .header { background: var(--primary-gradient); padding: 20px 20px 35px 20px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; transition: filter 0.3s ease; }
        .user-top-row { display: flex; justify-content: space-between; align-items: center; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; backdrop-filter: blur(5px); }
        .balance-display { text-align: center; margin-top: 15px; }
        
        .balance-amount { 
            font-size: 2.2rem; font-weight: 700; 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            min-height: 60px;
        }

        /* Spinner */
        .spinner {
            width: 30px; height: 30px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        .spinner-dark { border-color: #ddd; border-top-color: #764ba2; }

        /* Container */
        .container { padding: 0 20px; margin-top: -30px; position: relative; z-index: 5; transition: filter 0.3s ease; }
        .page-section { display: none; padding: 10px 0; animation: fadeIn 0.3s ease; }
        .page-section.active-section { display: block; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #555; margin: 40px 0 10px 5px; }

        /* --- NEW: AD TABS STYLES --- */
        .ad-tabs-container {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10;
        }
        .ad-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #777;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .ad-tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(118, 75, 162, 0.3);
        }
        .ad-card-wrapper {
            display: none;
            animation: slideIn 0.4s ease;
        }
        .ad-card-wrapper.active-card {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- END AD TABS STYLES --- */

        /* Cards */
        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: var(--shadow); 
            text-align: center; 
            margin-bottom: 15px; 
            position: relative; 
        }

        .history-btn {
            position: absolute; top: 10px; right: 15px;
            background: rgba(118, 75, 162, 0.1); color: #764ba2;
            border: none; padding: 5px 10px; border-radius: 15px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer; z-index: 10;
        }

        /* Task Card */
        .task-card {
            background: white; border-radius: 18px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            text-align: left;
        }
        .task-left { display: flex; align-items: center; gap: 12px; }
        .task-icon { 
            width: 45px; height: 45px; background: #f4f6f8; 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            color: #764ba2; font-size: 1.2rem;
        }
        .task-info h4 { margin: 0; font-size: 0.9rem; color: #333; font-weight: 600; }
        .task-info p { margin: 2px 0 0; font-size: 0.75rem; color: #777; }
        
        .task-btn {
            padding: 8px 16px; border-radius: 20px; border: none;
            font-size: 0.8rem; font-weight: 600; cursor: pointer; min-width: 75px;
            transition: 0.2s;
        }
        .btn-start { background: var(--primary-gradient); color: white; }
        .btn-claim-task { background: #4caf50; color: white; animation: pulse 1s infinite; }
        .btn-done { background: #f0f0f0; color: #aaa; pointer-events: none; }

        /* Referral List Styles */
        .ref-list-card { padding: 15px; justify-content: space-between; }
        .ref-list-card .task-left { flex-grow: 1; min-width: 0; align-items: flex-start; }
        .ref-list-card .ref-user-info { line-height: 1.2; overflow: hidden; white-space: normal; }
        .ref-list-card .ref-user-info h4 { font-size: 0.95rem; margin-bottom: 2px; font-weight: 700; color: #333; }
        .ref-list-card .ref-user-info p { font-size: 0.7rem; color: #999; margin: 0; }
        .ref-join-date { font-size: 0.7rem; color: #555 !important; margin-top: 2px !important; font-weight: 400; }
        .ref-actions { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 8px; margin-left: 10px; }
        .ref-summary-right { display: flex; flex-direction: column; align-items: flex-end; min-width: 80px; text-align: right; }
        .ref-reward-amount { font-size: 0.95rem; font-weight: 700; color: #764ba2; line-height: 1.2; margin-bottom: 4px; }
        .ref-progress-text { font-size: 0.7rem; font-weight: 600; line-height: 1.2; }
        .ref-list-card .task-btn { min-width: 80px; padding: 8px 10px; font-size: 0.75rem; margin-top: 0; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 20px 0; }
        .page-btn { background: white; color: #764ba2; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; }
        .page-btn:disabled { background: #f0f0f0; color: #ccc; cursor: not-allowed; }
        .page-btn.active { background: #764ba2; color: white; border-color: #764ba2; }

        /* Progress Bar */
        .progress-wrapper { margin: 20px 0; text-align: left; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; margin-bottom: 6px; font-weight: 600; }
        .progress-track { width: 100%; height: 10px; background: var(--progress-bg); border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--progress-fill); border-radius: 10px; transition: width 0.5s ease; }
        /* Adsgram Progress Color */
        .progress-bar.adsgram-bar { background: var(--secondary-gradient); }

        /* Buttons & Inputs */
        .watch-btn, .btn-copy { background: var(--primary-gradient); color: white; border: none; padding: 12px 0; width: 100%; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); transition: transform 0.2s, opacity 0.3s; }
        .watch-btn.adsgram-btn { background: var(--secondary-gradient); box-shadow: 0 4px 10px rgba(255, 94, 98, 0.3); }
        
        .watch-btn:active, .btn-copy:active { transform: scale(0.98); }
        .watch-btn.disabled { background: #ccc; cursor: not-allowed; box-shadow: none; pointer-events: none; opacity: 0.7; }
        .card.disabled-card { opacity: 0.8; }
        .btn-copy { background: #333; border-radius: 12px; transition: background 0.3s ease; }

        .wallet-input, .select-field { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 12px; font-size: 0.95rem; background: #fff; font-family: inherit; outline: none; box-sizing: border-box; }
        .wallet-input:focus { border-color: #764ba2; }

        /* Referral */
        .ref-stats { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; }
        .ref-stat-item h3 { margin: 0; color: #764ba2; font-size: 1.5rem; }
        .ref-stat-item p { margin: 0; font-size: 0.8rem; color: #777; }
        .ref-link-box { background: #f0f2f5; border: 1px dashed #bbb; padding: 10px; border-radius: 10px; margin: 20px 0; word-break: break-all; font-family: monospace; color: #555; font-size: 0.9rem; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; border-top-left-radius: 20px; border-top-right-radius: 20px; transition: filter 0.3s ease; }
        .nav-item { text-align: center; color: #aaa; font-size: 0.75rem; cursor: pointer; width: 25%; transition: color 0.3s; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 5px; transition: 0.2s; }
        .nav-item.active { color: #764ba2; font-weight: 600; }
        .nav-item.active i { transform: translateY(-3px); }

        /* Modals */
        .ad-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        
        .history-content {
            background: white; 
            width: 85%; max-width: 450px; max-height: 80vh; 
            border-radius: 25px; padding: 20px; text-align: center;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: scaleUp 0.4s; display: flex; flex-direction: column;
        }

        .history-scroll-area { overflow-y: auto; flex-grow: 1; padding: 0 10px; }
        .history-content .reward-title { margin: 0 0 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; text-align: left; }
        .history-item:last-child { border-bottom: none; }
        .item-details { flex-grow: 1; }
        .item-details h4 { margin: 0; font-size: 0.9rem; color: #333; font-weight: 600; }
        .item-details p { margin: 2px 0 0; font-size: 0.75rem; color: #777; }
        .item-status { font-size: 0.75rem; font-weight: 600; padding: 4px 8px; border-radius: 15px; text-transform: capitalize; }
        .status-paid { background: var(--green); color: white; }
        .status-pending { background: orange; color: white; }
        .status-rejected { background: var(--red); color: white; }
        
        /* Ads History */
        .ads-history-summary { background: #f8f8f8; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; border: 1px solid #eee; }
        .ads-status-ok { color: var(--green); }
        .ads-status-pending { color: var(--red); }

        .reward-modal { 
            background: white; width: 80%; max-width: 320px; border-radius: 25px; 
            padding: 30px 20px; text-align: center; position: relative; overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: scaleUp 0.4s; 
        }
        
        .sparkle-bg { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, rgba(255,255,255,0) 70%); z-index: 0; animation: spin 10s linear infinite; }
        
        .reward-coin { width: 80px; height: 80px; margin: 0 auto 15px; position: relative; z-index: 1; animation: bounce 2s infinite; background-image: url('https://cdn-icons-png.flaticon.com/512/1292/1292744.png'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .reward-icon-success, .reward-icon-error { width: 80px; height: 80px; margin: 0 auto 15px; position: relative; z-index: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: bounce 2s infinite; }
        .reward-icon-success { background: #4caf50; } .reward-icon-success i { color: white; font-size: 3rem; }
        .reward-icon-error { background: #e74c3c; } .reward-icon-error i { color: white; font-size: 3rem; }
        
        .ban-icon-anim { font-size: 4.5rem; color: var(--red); margin: 0 auto 15px; position: relative; z-index: 1; animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both infinite; display: block; }
        .unban-icon-anim { font-size: 4.5rem; color: var(--green); margin: 0 auto 15px; position: relative; z-index: 1; animation: bounce 2s infinite; display: block; }

        .btn-claim-modal { background: var(--primary-gradient); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: 600; width: 80%; cursor: pointer; margin-top: 15px; position: relative; z-index: 1; box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4); transition: all 0.2s ease; }
        .reward-title { margin: 0 0 5px; color: #333; font-size: 1.4rem; font-weight: 700; position: relative; z-index: 1; }
        .reward-desc { color: #777; font-size: 0.9rem; margin-bottom: 10px; position: relative; z-index: 1; }
        .reward-amount-text { font-size: 2rem; font-weight: 800; color: #764ba2; margin: 10px 0; position: relative; z-index: 1; }
        .fly-coin { position: fixed; width: 35px; height: 35px; z-index: 9999; pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } 
        @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } } 
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="user-top-row">
            <div class="user-badge"><i class="fas fa-user"></i> <span id="username">Guest</span></div>
            <div class="user-badge">ID: <span id="uidDisplay">...</span></div>
        </div>
        <div class="balance-display">
            <div style="font-size: 0.9rem; opacity: 0.8;">Total Balance</div>
            <div class="balance-amount">
                <i class="fas fa-coins" style="color: #ffd700;" id="mainCoinIcon"></i> 
                <span id="balance"><div class="spinner"></div></span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        
        <!-- 1. HOME SECTION -->
        <div id="home-section" class="page-section active-section">
            <div class="section-title" id="homeSectionTitle">Daily Task</div> 
            
            <!-- Ad Navigation Tabs -->
            <div class="ad-tabs-container">
                <div class="ad-tab active" id="tab1" onclick="switchAdTab(1)">Network 1</div>
                <div class="ad-tab" id="tab2" onclick="switchAdTab(2)">Network 2</div>
            </div>

            <!-- AD CARD 1 (Monetag) -->
            <div class="ad-card-wrapper active-card" id="adCard1">
                <div class="card" id="monetagCard">
                    <button class="history-btn" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> History</button> 
                    
                    <i class="fas fa-gift fa-3x" style="color: #764ba2; margin-bottom: 10px;"></i>
                    <h3 id="adCardTitle" style="margin: 5px 0;">Watch Video Ads</h3> 
                    <p id="adCardDesc" style="color: #777; font-size: 0.9rem; margin-top: 0;">Earn <span id="rewardAmountDisplay">...</span> Coins per ad</p>

                    <div class="progress-wrapper">
                        <div class="progress-info">
                            <span>Daily Limit</span>
                            <span><b id="adCount">0</b>/<span id="limitDisplay">...</span></span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar" id="dailyProgressBar"></div>
                        </div>
                    </div>

                    <button class="watch-btn" id="watchAdBtn" onclick="startAdFlow()">
                        Watch Ad Now <i class="fas fa-play-circle"></i>
                    </button>
                    <div id="completedMsg" style="display: none; color: #4caf50; font-weight: bold; margin-top: 10px;">
                        <i class="fas fa-check-circle"></i> Daily Limit Completed!
                    </div>
                </div>
            </div>

            <!-- AD CARD 2 (Adsgram) -->
            <div class="ad-card-wrapper" id="adCard2">
                <div class="card" id="adsgramCard">
                    <button class="history-btn" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> History</button> 
                    
                    <i class="fas fa-ad fa-3x" style="color: #FF5E62; margin-bottom: 10px;"></i>
                    <h3 style="margin: 5px 0;">Special Ads Task</h3> 
                    <p style="color: #777; font-size: 0.9rem; margin-top: 0;">Earn <span id="adsgramRewardDisplay">...</span> Coins per ad</p>

                    <div class="progress-wrapper">
                        <div class="progress-info">
                            <span>Daily Limit</span>
                            <span><b id="adsgramAdCount">0</b>/<span id="adsgramLimitDisplay">...</span></span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar adsgram-bar" id="adsgramProgressBar"></div>
                        </div>
                    </div>

                    <button class="watch-btn adsgram-btn" id="watchAdsgramBtn" onclick="startAdsgramFlow()">
                        Watch Ad Now <i class="fas fa-play-circle"></i>
                    </button>
                    <div id="adsgramCompletedMsg" style="display: none; color: #FF5E62; font-weight: bold; margin-top: 10px;">
                        <i class="fas fa-check-circle"></i> Daily Limit Completed!
                    </div>
                </div>
            </div>
            
        </div>

        <!-- 2. MISSIONS SECTION -->
        <div id="tasks-section" class="page-section">
            <div id="dailyRewardCard" class="task-card" style="margin-top: 40px;">
                <div class="task-left">
                    <div class="task-icon" style="background: #e6e6fa; color: #764ba2;">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="task-info">
                        <h4>Daily Check-in</h4>
                        <p id="dailyRewardAmountDisplay">Reward: +100 Coins</p>
                    </div>
                </div>
                <button id="dailyClaimBtn" class="task-btn btn-start" onclick="claimDailyReward()">Claim</button>
            </div>

            <!-- Active Missions -->
            <div class="section-title" id="missionsSectionTitle">Social Missions</div>
            <div id="taskListContainer">
                <div style="text-align:center; padding: 40px; color: #999;">
                    <div class="spinner spinner-dark"></div>
                    <p style="margin-top:10px;">Loading Missions...</p>
                </div>
            </div>

            <!-- Completed Missions -->
            <div class="section-title" id="completedMissionsTitle" style="display:none; margin-top: 30px;">Completed Missions</div>
            <div id="completedListContainer"></div>
        </div>

        <!-- 3. INVITE SECTION -->
        <div id="invite-section" class="page-section">
            <div class="section-title" id="inviteSectionTitle">Invite Friends</div>
            
            <div class="card">
                <img src="https://cdn-icons-png.flaticon.com/512/1256/1256650.png" width="80" style="margin-bottom:15px;">
                <h2 id="refTitle" style="margin: 0 0 10px;">Refer & Earn</h2>
                <p id="refDesc" style="color: #666; font-size: 0.9rem;">Share link & get bonus!</p>
                
                <div class="ref-stats">
                    <div class="ref-stat-item"> <h3 id="ref-count">0</h3> <p>Referrals</p> </div>
                    <div class="ref-stat-item"> <h3 id="ref-earned">0</h3> <p>Earned</p> </div>
                </div>

                <div class="ref-link-box" id="refLink">Loading...</div>
                <button class="btn-copy" onclick="copyLink(this)">Copy Link</button>
            </div>

            <!-- New Referral Lists -->
            <div class="section-title" id="activeReferralsTitle" style="margin-top: 30px; display: none;">Your Referrals (Ads Progress)</div>
            <div id="activeReferralListContainer">
                <div style="text-align:center; padding: 40px; color: #999; display: none;" id="activeRefLoading">
                    <div class="spinner spinner-dark"></div>
                    <p style="margin-top:10px;">Loading Referrals...</p>
                </div>
            </div>
            
            <div id="activeReferralPagination" class="pagination" style="display: none;"></div>

            <div class="section-title" id="completedReferralsTitle" style="margin-top: 30px; display:none;">Completed Referral Bonus (Claimed)</div>
            <div id="completedReferralListContainer"></div>
            <div id="completedReferralPagination" class="pagination" style="display: none;"></div>
        </div>

        <!-- 4. WALLET SECTION -->
        <div id="wallet-section" class="page-section">
            <div class="section-title" id="walletSectionTitle">My Wallet</div>
            <div class="card">
                <button class="history-btn" onclick="showHistoryModal('withdrawal')"><i class="fas fa-history"></i> History</button>
                <i class="fas fa-wallet fa-3x" style="color: #764ba2; margin-bottom: 20px;"></i>
                <h3 id="withdrawTitle">Withdraw Funds</h3>
                <p style="color:#777; font-size:0.9rem;"><span id="withdrawDesc">Minimum Withdraw <strong>100</strong> coins</span></p> 
                
                <input type="number" id="withdrawAmount" class="wallet-input" placeholder="Enter Coin Amount">
                <select id="withdrawMethod" class="select-field" onchange="toggleAccountInput()">
                    <option value="" disabled selected>Select Payment Method</option>
                </select>
                <input type="number" id="accountNumber" class="wallet-input" placeholder="Enter Account Number" style="display: none;">
                
                <button class="watch-btn" id="requestWithdrawBtn" onclick="requestWithdraw()">Request Withdraw</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item" onclick="switchTab('tasks', this)"><i class="fas fa-list-check"></i> Missions</div>
        <div class="nav-item" onclick="switchTab('invite', this)"><i class="fas fa-user-plus"></i> Invite</div>
        <div class="nav-item" onclick="switchTab('wallet', this)"><i class="fas fa-wallet"></i> Wallet</div>
    </div>

    <!-- Ad Overlay -->
    <div id="adOverlay" class="ad-overlay">
        <div style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin fa-3x" style="margin-bottom:20px;"></i>
            <h3>Loading Ad...</h3>
            <p>Please wait while the ad loads.</p>
        </div>
    </div>
    
    <!-- INITIAL VERIFICATION MODAL -->
    <div id="initialVerificationModal" class="modal-backdrop" style="z-index: 4000; display: none;">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <div id="initialModalIconContainer"><i class="fas fa-robot" style="font-size:3rem; color:#764ba2; margin-bottom:15px;"></i></div>
            <h2 class="reward-title" id="initialModalTitle">Welcome!</h2> 
            <p class="reward-desc" id="initialModalDesc">To access, join our Telegram bot & send /start.</p> 
            <button class="btn-claim-modal" id="joinBotBtn" onclick="handleVerificationButtonClick()" style="width: 80%;">Join Telegram Bot</button>
            <p id="verificationTip" style="font-size: 0.75rem; color: #999; margin-top: 10px;">(বটে জয়েন করে নিচে Exit বাটনে ক্লিক করুন)</p>
        </div>
    </div>

    <!-- REWARD MODAL -->
    <div id="rewardModal" class="modal-backdrop">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <div id="modalIconContainer"><img src="https://cdn-icons-png.flaticon.com/512/1292/1292744.png" class="reward-coin" id="defaultRewardIcon"></div>
            <h2 class="reward-title">Congratulations!</h2> 
            <div class="reward-amount-text" id="popupAmount">+50 Coins</div>
            <p class="reward-desc">You have successfully earned your reward.</p> 
            <button class="btn-claim-modal" id="modalClaimBtn">OK, Great!</button>
        </div>
    </div>
    
    <!-- STATUS MODAL -->
    <div id="statusModal" class="modal-backdrop" style="z-index: 5000;">
        <div class="reward-modal">
            <div class="sparkle-bg"></div>
            <div id="statusIconContainer"></div>
            <h2 id="statusTitle" class="reward-title" style="color: #333;"></h2>
            <p id="statusDesc" class="reward-desc"></p>
            <button id="statusBtn" class="btn-claim-modal"></button>
        </div>
    </div>
    
    <!-- HISTORY MODAL -->
    <div id="historyModal" class="modal-backdrop" onclick="if(event.target.id === 'historyModal') hideHistoryModal()">
        <div class="history-content">
            <i class="fas fa-times" style="position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; color: #aaa; z-index: 10;" onclick="hideHistoryModal()"></i>
            <div id="historyModalIconContainer"><i class="fas fa-history fa-2x" style="color: #764ba2; margin-bottom: 15px;"></i></div>
            <h2 class="reward-title">History</h2>
            <div class="history-scroll-area"><div id="historyListContainer"></div></div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAXBG5RZJ2b38kknNKzmygXrzOoCTugLIE",
            authDomain: "new-tg-test.firebaseapp.com",
            projectId: "new-tg-test",
            storageBucket: "new-tg-test.firebasestorage.app",
            messagingSenderId: "1077123386154",
            appId: "1:1077123386154:web:dbbc89d5874127f60c6c53"
        };
        const BOT_USERNAME = "testnewearningminiapp1_bot"; 

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();

        let uid, username, firstName, lastName, referrerId = null; 
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            uid = user.id.toString();
            firstName = user.first_name;
            lastName = user.last_name || ''; 
            username = user.username || firstName;
            if (tg.initDataUnsafe.start_param) referrerId = tg.initDataUnsafe.start_param;
        } else {
            uid = localStorage.getItem('test_uid');
            if(!uid) { uid = 'U'+Math.floor(Math.random()*99999); localStorage.setItem('test_uid', uid); }
            firstName = "Guest";
            lastName = ""; 
            username = "GuestUser";
        }
        
        const userFullName = (firstName + ' ' + lastName).trim();

        document.getElementById('uidDisplay').innerText = uid;
        document.getElementById('username').innerText = userFullName || firstName; 

        const BOT_BASE_LINK = `https://t.me/${BOT_USERNAME}`; 
        document.getElementById('refLink').innerText = `${BOT_BASE_LINK}?startapp=${uid}`;

        const COOLDOWN_DURATION = 60000; 
        let adCooldownEndTime = 0; 
        let cooldownInterval = null; 
        
        // --- AD STATE VARIABLES ---
        let currentBalance = 0;
        let adsWatchedToday = 0; // Monetag
        let adsgramWatchedToday = 0; // Adsgram
        let totalAdsWatched = 0;
        let referralCount = 0; 
        let completedTasks = [];
        let isBotVerified = false, verificationStep = 'join', isJoinButtonClicked = false;
        const isEntryViaReferral = !!referrerId;
        
        let activeReferralsData = [], completedReferralsData = [];
        let activeRefPage = 1, completedRefPage = 1;
        const pageSize = 20;
        
        window.referredIdToClaim = null; 
        window.rewardAmountToClaim = null; 

        // Default Settings (Includes new Adsgram settings)
        let settings = { 
            daily_limit: 20, reward_per_ad: 50, 
            adsgram_daily_limit: 10, adsgram_reward: 50, adsgram_block_id: 'int-18699', // NEW SETTINGS
            min_withdraw: 100, ref_bonus: 100, monetag_ad_code: '', daily_reward_amount: 100,
            min_ads_view_for_withdraw: 0, min_referrals_for_withdraw: 0, 
            home_section_title: 'Daily Task', missions_section_title: 'Social Missions', invite_section_title: 'Invite Friends', wallet_section_title: 'My Wallet',
            ad_card_title: 'Watch Video Ads', ad_card_desc: 'Earn +{{reward_per_ad}} Coins per ad', ad_btn_text: 'Watch Ad Now',
            ref_title: 'Refer & Earn', ref_desc: 'Share link & get bonus!',
            ref_ads_watch_requirement: 100, 
            initial_popup_title: 'Welcome!', initial_popup_desc: 'To access...', initial_popup_btn_text: 'Join', initial_popup_tip: 'Tip...', initial_popup_bot_link: BOT_BASE_LINK,
            initial_exit_desc: 'Exit Desc', initial_exit_btn_text: 'Exit', initial_popup_tip: 'Exit Tip',
            ban_popup_title: 'Account Suspended', ban_popup_desc: 'You have been banned.', ban_btn_text: 'Contact Support', support_url: 'https://t.me/',
            unban_popup_title: 'Account Restored!', unban_popup_desc: 'You can use the app again.', unban_btn_text: 'Continue',
            ad_popup_title: 'Congratulations!', ad_popup_desc: 'Reward Earned.', daily_popup_title: 'Daily Bonus!', daily_popup_desc: 'Checked in.', mission_popup_title: 'Mission Complete!', mission_popup_desc: 'Reward Earned.',
            withdraw_title: 'Withdraw Funds', withdraw_desc: 'Min Withdraw 100', pay_methods: ['bKash'], request_withdraw_btn_text: 'Request Withdraw', 
            modal_claim_btn_text: 'OK', error_modal_btn_text: 'Close', withdraw_success_title: 'Success!', withdraw_success_desc: 'Request Submitted.', withdraw_success_btn_text: 'Done',          
            min_amt_err_title: 'Min Error', min_amt_err_desc: 'Min is {{min_withdraw}}', bal_err_title: 'Balance Error', bal_err_desc: 'Low Balance.',
            method_err_title: 'Method Error', method_err_desc: 'Select Method.', acc_num_err_title: 'Account Error', acc_num_err_desc: 'Enter Number.',
            min_ads_err_title: 'Ads Error', min_ads_err_desc: 'Watch more ads.', min_refs_err_title: 'Ref Error', min_refs_err_desc: 'Refer more users.', 
        }; 
        let adFunctionName = null, lastDailyClaimDate = null; 

        const userRef = db.collection('users').doc(uid);

        function updateUserActivity() {
            if (uid) { userRef.update({ last_activity: Date.now() }).catch(err => {}); }
        }
        updateUserActivity();

        function loadMonetagSdk(adCode) {
            const head = document.getElementsByTagName('head')[0];
            let script = document.createElement('script');
            script.src = '//libtl.com/sdk.js'; script.setAttribute('data-zone', adCode.replace('show_', '')); script.setAttribute('data-sdk', adCode);
            head.appendChild(script);
        }

        function populateWithdrawMethods(methodsArray) {
            const selectEl = document.getElementById('withdrawMethod');
            selectEl.innerHTML = '<option value="" disabled selected>Select Payment Method</option>'; 
            methodsArray.forEach(method => {
                const option = document.createElement('option'); option.value = method.replace(/\s/g, ''); option.innerText = method; selectEl.appendChild(option);
            });
        }
        
        function initApp() {
            document.getElementById('initialVerificationModal').style.display = 'none'; 
            if(document.getElementById('statusModal').style.display === 'none') {
                document.body.classList.remove('modal-active'); 
            }
            updateUI(); updateDailyRewardUI(); renderTasks(); 
            if(document.getElementById('invite-section').classList.contains('active-section')) renderReferrals();
        }

        // --- TAB SWITCH LOGIC ---
        function switchAdTab(tabIndex) {
            document.querySelectorAll('.ad-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tabIndex).classList.add('active');

            document.querySelectorAll('.ad-card-wrapper').forEach(c => c.classList.remove('active-card'));
            document.getElementById('adCard' + tabIndex).classList.add('active-card');
        }

        // --- SETTINGS LISTENER ---
        const setRef = db.collection('settings').doc('global');
        setRef.onSnapshot(doc => {
            if (doc.exists) {
                const d = doc.data();
                Object.assign(settings, d); 

                // Monetag Settings Update
                document.getElementById('limitDisplay').innerText = settings.daily_limit;
                document.getElementById('adCardTitle').innerText = settings.ad_card_title;
                let adDescText = settings.ad_card_desc.replace('{{reward_per_ad}}', settings.reward_per_ad);
                document.getElementById('adCardDesc').innerHTML = adDescText.replace(`${settings.reward_per_ad}`, `<span id="rewardAmountDisplay">${settings.reward_per_ad}</span>`);
                document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`;

                // Adsgram Settings Update
                document.getElementById('adsgramLimitDisplay').innerText = settings.adsgram_daily_limit;
                document.getElementById('adsgramRewardDisplay').innerText = settings.adsgram_reward;

                // General
                document.getElementById('dailyRewardAmountDisplay').innerText = `Reward: +${settings.daily_reward_amount} Coins`; 
                document.getElementById('homeSectionTitle').innerText = settings.home_section_title;
                document.getElementById('missionsSectionTitle').innerText = settings.missions_section_title;
                document.getElementById('inviteSectionTitle').innerText = settings.invite_section_title;
                document.getElementById('walletSectionTitle').innerText = settings.wallet_section_title;
                document.getElementById('refTitle').innerText = settings.ref_title;
                document.getElementById('refDesc').innerText = settings.ref_desc;
                document.getElementById('withdrawTitle').innerText = settings.withdraw_title;
                document.getElementById('withdrawDesc').innerHTML = settings.withdraw_desc.replace('{{min_withdraw}}', settings.min_withdraw);
                document.getElementById('requestWithdrawBtn').innerText = settings.request_withdraw_btn_text; 
                populateWithdrawMethods(settings.pay_methods);

                if (settings.monetag_ad_code && !adFunctionName) {
                    adFunctionName = settings.monetag_ad_code;
                    setTimeout(() => loadMonetagSdk(adFunctionName), 500); 
                }
                if(document.getElementById('initialVerificationModal').style.display === 'flex') updateVerificationModalUI(isBotVerified, verificationStep);
                
                // Re-run UI update to apply limits
                updateUI();
            }
        });

        // --- USER LISTENER ---
        userRef.onSnapshot(doc => {
            if (doc.exists) {
                const d = doc.data();
                currentBalance = d.balance || 0;
                completedTasks = d.completed_tasks || [];
                lastDailyClaimDate = d.last_daily_claim_date || null; 
                totalAdsWatched = d.total_ads_watched || 0; 
                referralCount = d.referral_count || 0; 
                isBotVerified = d.is_verified_bot_joined || false; 
                adCooldownEndTime = d.ad_cooldown_end_time || 0; 

                const balEl = document.getElementById('balance');
                if (balEl.innerHTML.includes('spinner') || document.getElementById('rewardModal').style.display === 'none') {
                    balEl.innerText = currentBalance;
                }
                
                document.getElementById('ref-count').innerText = d.referral_count || 0;
                document.getElementById('ref-earned').innerText = d.referral_earnings || 0;

                const today = new Date().toDateString();
                if (d.last_ad_date !== today) {
                    adsWatchedToday = 0;
                    adsgramWatchedToday = 0;
                    userRef.update({ ads_watched: 0, adsgram_ads_watched: 0, last_ad_date: today });
                } else {
                    adsWatchedToday = d.ads_watched || 0;
                    adsgramWatchedToday = d.adsgram_ads_watched || 0;
                }
                
                // === BAN / UNBAN CHECK ===
                if (d.is_banned === true) {
                    showBanPopup();
                } else if (d.is_banned === false && d.seen_unban_popup === false) {
                    showUnbanPopup();
                } else {
                    if(document.getElementById('statusModal').style.display !== 'none'){
                        document.getElementById('statusModal').style.display = 'none';
                        document.body.classList.remove('modal-active');
                    }

                    if (isBotVerified) {
                        initApp();
                    } else if (!isBotVerified && isEntryViaReferral) {
                        showInitialVerificationModal(verificationStep); 
                    } else if (!isBotVerified && !isEntryViaReferral) {
                        userRef.set({ is_verified_bot_joined: true, last_activity: Date.now() }, { merge: true }).then(() => {
                            isBotVerified = true; initApp();
                        }).catch(err => showInitialVerificationModal('join'));
                    } else {
                        if (document.getElementById('initialVerificationModal').style.display !== 'flex') initApp();
                    }
                }
                
            } else {
                let newUser = {
                    balance: 0, ads_watched: 0, adsgram_ads_watched: 0, total_ads_watched: 0, referral_count: 0, referral_earnings: 0,
                    completed_tasks: [], last_ad_date: new Date().toDateString(), 
                    username: username, 
                    full_name: userFullName, 
                    is_verified_bot_joined: !isEntryViaReferral, last_daily_claim_date: null, 
                    is_banned: false, seen_unban_popup: true, 
                    created_at: firebase.firestore.FieldValue.serverTimestamp(),
                    last_activity: Date.now(),
                    ad_cooldown_end_time: 0 
                };
                if (referrerId && referrerId !== uid) {
                    newUser.referred_by = referrerId;
                    db.collection('users').doc(referrerId).update({
                        referral_count: firebase.firestore.FieldValue.increment(1)
                    });
                    db.collection('users').doc(referrerId).collection('referred_users').doc(uid).set({
                        referred_uid: uid,
                        referred_username: userFullName, 
                        referred_total_ads_watched: 0, 
                        is_claimed: false,
                        claimed_at: null,
                        created_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                userRef.set(newUser).then(() => {
                    if (isEntryViaReferral) showInitialVerificationModal('join'); else initApp();
                });
                document.getElementById('balance').innerText = 0;
            }
        });

        // --- BAN / UNBAN FUNCTIONS ---
        function showBanPopup() {
            const modal = document.getElementById('statusModal');
            document.body.classList.add('modal-active');
            
            document.getElementById('statusIconContainer').innerHTML = `<i class="fas fa-ban ban-icon-anim"></i>`;
            document.getElementById('statusTitle').innerText = settings.ban_popup_title;
            document.getElementById('statusTitle').style.color = '#e74c3c';
            document.getElementById('statusDesc').innerText = settings.ban_popup_desc;
            
            const btn = document.getElementById('statusBtn');
            btn.innerText = settings.ban_btn_text;
            btn.style.background = '#e74c3c';
            btn.onclick = function() { tg.openTelegramLink(settings.support_url); };
            
            modal.style.display = 'flex';
        }

        function showUnbanPopup() {
            const modal = document.getElementById('statusModal');
            document.body.classList.add('modal-active');
            
            document.getElementById('statusIconContainer').innerHTML = `<i class="fas fa-check-circle unban-icon-anim"></i>`;
            document.getElementById('statusTitle').innerText = settings.unban_popup_title;
            document.getElementById('statusTitle').style.color = '#2ecc71';
            document.getElementById('statusDesc').innerText = settings.unban_popup_desc;
            
            const btn = document.getElementById('statusBtn');
            btn.innerText = settings.unban_btn_text;
            btn.style.background = '#2ecc71';
            btn.onclick = function() {
                userRef.update({ seen_unban_popup: true, last_activity: Date.now() }).then(() => {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-active');
                });
            };
            modal.style.display = 'flex';
        }

        // --- VERIFICATION MODAL ---
        function updateVerificationModalUI(isVerified, state) {
            const titleEl = document.getElementById('initialModalTitle'), descEl = document.getElementById('initialModalDesc');
            const iconContainer = document.getElementById('initialModalIconContainer'), joinBtn = document.getElementById('joinBotBtn'), tipEl = document.getElementById('verificationTip');
            joinBtn.classList.remove('disabled'); joinBtn.disabled = false; joinBtn.style.background = '#0088cc'; tipEl.style.display = 'block';

            if (state === 'join') {
                titleEl.innerText = settings.initial_popup_title; descEl.innerText = settings.initial_popup_desc;
                joinBtn.innerHTML = `${settings.initial_popup_btn_text} <i class="fab fa-telegram-plane"></i>`;
                tipEl.innerText = settings.initial_popup_tip;
                iconContainer.innerHTML = '<i class="fas fa-robot" style="font-size:3rem; color:#764ba2; margin-bottom:15px; animation:bounce 2s infinite;"></i>';
                joinBtn.onclick = handleVerificationButtonClick; verificationStep = 'join'; 
            }
        }

        function showInitialVerificationModal(state) {
            if (isBotVerified) { initApp(); return; }
            const modal = document.getElementById('initialVerificationModal');
            document.body.classList.add('modal-active');
            updateVerificationModalUI(isBotVerified, 'join');
            modal.style.display = 'flex';
        }
        
        function handleVerificationButtonClick() {
            const joinBtn = document.getElementById('joinBotBtn'), descEl = document.getElementById('initialModalDesc'), tipEl = document.getElementById('verificationTip');
            if (!isJoinButtonClicked) {
                const botLink = settings.initial_popup_bot_link.trim() || BOT_BASE_LINK;
                tg.openTelegramLink(botLink.replace(/\/$/, ''));
                joinBtn.innerHTML = `${settings.initial_exit_btn_text} <i class="fas fa-times-circle"></i>`;
                joinBtn.style.background = '#e74c3c'; descEl.innerText = settings.initial_exit_desc; tipEl.innerText = settings.initial_exit_tip; 
                isJoinButtonClicked = true;
            } else { tg.close(); }
        }

        // --- AD COOLDOWN TIMER ---
        function startAdCooldownTimer(endTime) {
            if (cooldownInterval) clearInterval(cooldownInterval); 

            // Handle BOTH buttons (disable both during cooldown)
            const btns = [document.getElementById('watchAdBtn'), document.getElementById('watchAdsgramBtn')];
            
            btns.forEach(btn => {
                if(btn) {
                    btn.classList.add('disabled');
                    btn.onclick = 'void(0)';
                }
            });

            cooldownInterval = setInterval(() => {
                const now = Date.now();
                const remaining = endTime - now; 

                if (remaining <= 0) {
                    clearInterval(cooldownInterval);
                    cooldownInterval = null;
                    
                    // Reset Monetag Button
                    const mBtn = document.getElementById('watchAdBtn');
                    mBtn.classList.remove('disabled');
                    mBtn.onclick = startAdFlow; 
                    mBtn.innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`;
                    document.getElementById('monetagCard').classList.remove('disabled-card');

                    // Reset Adsgram Button
                    const aBtn = document.getElementById('watchAdsgramBtn');
                    aBtn.classList.remove('disabled');
                    aBtn.onclick = startAdsgramFlow;
                    aBtn.innerHTML = `Watch Ad Now <i class="fas fa-play-circle"></i>`;
                    document.getElementById('adsgramCard').classList.remove('disabled-card');
                    
                    userRef.update({ ad_cooldown_end_time: 0 });
                    updateUI(); // Re-check daily limits to ensure buttons are correct
                    return;
                }

                const seconds = Math.floor(remaining / 1000);
                const display = `${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}`;
                
                btns.forEach(btn => {
                    if(btn) btn.innerHTML = `<i class="fas fa-hourglass-half"></i> Wait: ${display}`;
                });
            }, 1000);
        }

        function updateUI() {
            if (!isBotVerified && isEntryViaReferral) return; 
            
            const now = Date.now();
            const isOnCooldown = now < adCooldownEndTime;
            
            // Monetag Elements
            const mBtn = document.getElementById('watchAdBtn');
            const mCard = document.getElementById('monetagCard');
            
            // Adsgram Elements
            const aBtn = document.getElementById('watchAdsgramBtn');
            const aCard = document.getElementById('adsgramCard');

            if (isOnCooldown) {
                mBtn.classList.add('disabled'); mCard.classList.add('disabled-card');
                aBtn.classList.add('disabled'); aCard.classList.add('disabled-card');
                document.getElementById('completedMsg').style.display = 'none';
                document.getElementById('adsgramCompletedMsg').style.display = 'none';
                startAdCooldownTimer(adCooldownEndTime); 
                return; 
            }

            // 1. Update Monetag UI
            document.getElementById('adCount').innerText = adsWatchedToday;
            const mPct = (adsWatchedToday / settings.daily_limit) * 100;
            document.getElementById('dailyProgressBar').style.width = mPct + '%';
            
            mBtn.innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`;

            if (adsWatchedToday >= settings.daily_limit) {
                mBtn.classList.add('disabled'); mBtn.innerText = 'Limit Reached'; document.getElementById('completedMsg').style.display = 'block'; mCard.classList.add('disabled-card');
            } else {
                mBtn.classList.remove('disabled'); document.getElementById('completedMsg').style.display = 'none'; mCard.classList.remove('disabled-card');
                mBtn.onclick = startAdFlow; 
            }

            // 2. Update Adsgram UI
            document.getElementById('adsgramAdCount').innerText = adsgramWatchedToday;
            const aPct = (adsgramWatchedToday / settings.adsgram_daily_limit) * 100;
            document.getElementById('adsgramProgressBar').style.width = aPct + '%';

            aBtn.innerHTML = `Watch Ad Now <i class="fas fa-play-circle"></i>`;
            
            if (adsgramWatchedToday >= settings.adsgram_daily_limit) {
                aBtn.classList.add('disabled'); aBtn.innerText = 'Limit Reached'; document.getElementById('adsgramCompletedMsg').style.display = 'block'; aCard.classList.add('disabled-card');
            } else {
                aBtn.classList.remove('disabled'); document.getElementById('adsgramCompletedMsg').style.display = 'none'; aCard.classList.remove('disabled-card');
                aBtn.onclick = startAdsgramFlow;
            }
        }

        function updateDailyRewardUI() {
            if (!isBotVerified && isEntryViaReferral) return;
            const btn = document.getElementById('dailyClaimBtn');
            const today = new Date().toDateString();
            if (!btn) return; 
            if (lastDailyClaimDate === today) {
                btn.classList.remove('btn-start', 'btn-claim-task'); btn.classList.add('btn-done'); btn.innerText = 'Claimed'; btn.onclick = 'void(0)';
            } else {
                btn.classList.remove('btn-done'); btn.classList.add('btn-start'); btn.innerText = 'Claim'; btn.onclick = claimDailyReward; btn.disabled = false; 
            }
        }

        function claimDailyReward() {
            if (!isBotVerified && isEntryViaReferral) return;
            const today = new Date().toDateString();
            if (lastDailyClaimDate === today) {
                showErrorModal('Already Claimed!', 'You have already claimed your daily reward today.', 'exclamation-triangle');
                updateDailyRewardUI(); return;
            }
            document.getElementById('dailyClaimBtn').disabled = true;
            window.dailyClaimButtonRef = document.getElementById('dailyClaimBtn'); 
            showRewardModal('daily', settings.daily_reward_amount, null); 
        }
        
        // --- TASKS RENDER ---
        function renderTasks() {
            if (!isBotVerified && isEntryViaReferral) return;
            
            const activeContainer = document.getElementById('taskListContainer');
            const completedContainer = document.getElementById('completedListContainer');
            const completedTitle = document.getElementById('completedMissionsTitle');

            db.collection('tasks').where('active', '==', true).onSnapshot(snapshot => {
                let tasks = [];
                snapshot.forEach(doc => tasks.push({id: doc.id, ...doc.data()}));
                
                tasks.sort((a,b) => b.created_at - a.created_at);

                let activeHtml = '';
                let completedHtml = '';

                tasks.forEach(task => {
                    const isCompleted = completedTasks.includes(task.id);
                    let iconClass = task.type === 'telegram' ? 'fab fa-telegram-plane' : (task.type === 'youtube' ? 'fab fa-youtube' : 'fas fa-globe');
                    let btnClass = isCompleted ? 'btn-done' : 'btn-start';
                    let btnText = isCompleted ? 'Completed' : 'Start';
                    let btnAction = isCompleted ? 'void(0)' : `startTask('${task.id}', '${task.link}', ${task.reward})`;
                    
                    const cardHtml = `
                        <div class="task-card">
                            <div class="task-left">
                                <div class="task-icon"><i class="${iconClass}"></i></div>
                                <div class="task-info">
                                    <h4>${task.title}</h4>
                                    <p>Reward: +${task.reward} Coins</p>
                                </div>
                            </div>
                            <button id="btn-${task.id}" class="task-btn ${btnClass}" onclick="${btnAction}">${btnText}</button>
                        </div>`;

                    if (isCompleted) {
                        completedHtml += cardHtml;
                    } else {
                        activeHtml += cardHtml;
                    }
                });

                activeContainer.innerHTML = activeHtml || '<div style="text-align:center; padding: 40px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No active missions.</p></div>';
                completedContainer.innerHTML = completedHtml;

                if (completedHtml) completedTitle.style.display = 'block';
                else completedTitle.style.display = 'none';
            });
        }

        function startTask(id, link, reward) {
            if (!isBotVerified && isEntryViaReferral) return;
            window.open(link, '_blank');
            const btn = document.getElementById(`btn-${id}`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; btn.classList.add('btn-done'); 
            setTimeout(() => {
                if (completedTasks.includes(id)) { btn.innerHTML = 'Completed'; return; }
                btn.innerHTML = 'Claim'; btn.className = 'task-btn btn-claim-task'; btn.disabled = false;
                btn.onclick = function() { showRewardModal('mission', reward, id); btn.innerHTML = 'Completed'; btn.className = 'task-btn btn-done'; btn.disabled = true; };
            }, 5000); 
        }

        // --- AD LOGIC (Monetag) ---
        function startAdFlow() {
            const now = Date.now();
            if (now < adCooldownEndTime) { updateUI(); showErrorModal('Hold On!', 'Please wait for the cooldown timer.', 'clock'); return; }

            if (!isBotVerified && isEntryViaReferral) return;
            if (adsWatchedToday >= settings.daily_limit) return;
            const adFunc = window[adFunctionName];
            if (!adFunc || typeof adFunc !== 'function') { showErrorModal('Error', 'Ad function is not ready.', 'exclamation-circle'); return; }
            document.getElementById('adOverlay').style.display = 'flex'; 
            document.getElementById('watchAdBtn').classList.add('disabled'); document.getElementById('watchAdBtn').innerHTML = 'Loading...';
            adFunc().then(() => {
                document.getElementById('adOverlay').style.display = 'none'; adFinishedCallback('monetag');
            }).catch((e) => {
                document.getElementById('adOverlay').style.display = 'none'; 
                document.getElementById('watchAdBtn').classList.remove('disabled'); document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`; 
                showErrorModal('Ad Failed', 'Ad not completed.', 'times-circle');
            });
        }

        // --- NEW: ADSGRAM FLOW ---
        function startAdsgramFlow() {
            const now = Date.now();
            if (now < adCooldownEndTime) { updateUI(); showErrorModal('Hold On!', 'Please wait for the cooldown timer.', 'clock'); return; }

            if (!isBotVerified && isEntryViaReferral) return;
            if (adsgramWatchedToday >= settings.adsgram_daily_limit) return;

            const blockId = settings.adsgram_block_id || "int-18699"; 
            if (!window.Adsgram) { showErrorModal('Error', 'Adsgram SDK not loaded.', 'exclamation-circle'); return; }

            const AdController = window.Adsgram.init({ blockId: blockId });
            
            document.getElementById('watchAdsgramBtn').classList.add('disabled');
            document.getElementById('watchAdsgramBtn').innerHTML = 'Loading...';

            AdController.show().then((result) => {
                adFinishedCallback('adsgram');
            }).catch((result) => {
                document.getElementById('watchAdsgramBtn').classList.remove('disabled');
                document.getElementById('watchAdsgramBtn').innerHTML = `Watch Ad Now <i class="fas fa-play-circle"></i>`;
                // Optional: handle specific error codes from Adsgram
                console.log("Adsgram Error:", result);
                showErrorModal('Ad Failed', 'Ad was not completed or skipped.', 'times-circle');
            });
        }
        
        // --- UNIFIED AD CALLBACK ---
        function adFinishedCallback(provider) {
            // Reset Buttons
            document.getElementById('watchAdBtn').classList.remove('disabled'); 
            document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <i class="fas fa-play-circle"></i>`; 
            document.getElementById('watchAdsgramBtn').classList.remove('disabled');
            document.getElementById('watchAdsgramBtn').innerHTML = `Watch Ad Now <i class="fas fa-play-circle"></i>`;
            
            let reward = (provider === 'adsgram') ? settings.adsgram_reward : settings.reward_per_ad;
            
            showRewardModal('ad', reward, null); 
            
            const now = new Date(); 
            const todayDateKey = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
            const ref = db.collection('users').doc(uid).collection('daily_ads_views').doc(todayDateKey);

            db.runTransaction(async t => { 
                const dailyDoc = await t.get(ref);
                const userDoc = await t.get(db.collection('users').doc(uid));

                if (!userDoc.exists) throw "User not found for ad update.";
                
                // Update Daily Log (Counting both types in the same daily doc, tracking total count)
                // You could add specific fields like 'monetag_count' and 'adsgram_count' inside the daily doc if you want detailed stats.
                const newDailyCount = (dailyDoc.exists ? dailyDoc.data().count : 0) + 1;
                const dailyData = {
                    count: newDailyCount, 
                    last_reward: reward,
                    last_provider: provider, // Track which provider gave the last ad
                    updated_at: Date.now(), 
                    created_at: dailyDoc.exists ? dailyDoc.data().created_at : Date.now()
                };
                t.set(ref, dailyData, {merge: true}); 

                const currentTotalAds = (userDoc.data().total_ads_watched || 0) + 1;
                
                if (userDoc.data().referred_by) {
                    const referrerUid = userDoc.data().referred_by;
                    t.update(db.collection('users').doc(referrerUid).collection('referred_users').doc(uid), {
                        referred_total_ads_watched: currentTotalAds,
                    });
                }
                
                // Update specific counters
                let updateData = {
                    balance: firebase.firestore.FieldValue.increment(reward), 
                    total_ads_watched: firebase.firestore.FieldValue.increment(1) 
                };

                if (provider === 'adsgram') {
                    updateData.adsgram_ads_watched = firebase.firestore.FieldValue.increment(1);
                } else {
                    updateData.ads_watched = firebase.firestore.FieldValue.increment(1);
                }

                t.update(db.collection('users').doc(uid), updateData);
            }).catch(err => {
                console.error("Ad log transaction failed: ", err);
            });
        }
        
        // --- MODAL HELPERS ---
        function showCustomSuccessModal(title, desc, iconName) {
            const modal = document.getElementById('rewardModal');
            document.getElementById('modalIconContainer').innerHTML = `<div class="reward-icon-success"><i class="fas fa-${iconName}" style="color:white;font-size:3rem;"></i></div>`;
            document.getElementById('popupAmount').style.display = 'none';
            modal.querySelector('.reward-title').innerText = title || settings.withdraw_success_title;
            modal.querySelector('.reward-desc').innerHTML = desc || settings.withdraw_success_desc; 
            modal.style.display = 'flex';
            document.getElementById('modalClaimBtn').innerText = settings.withdraw_success_btn_text; 
            document.getElementById('modalClaimBtn').onclick = () => modal.style.display = 'none';
        }

        function showErrorModal(title, desc, iconName) {
            const modal = document.getElementById('rewardModal');
            document.getElementById('modalIconContainer').innerHTML = `<div class="reward-icon-error"><i class="fas fa-${iconName}" style="color:white;font-size:3rem;"></i></div>`;
            document.getElementById('popupAmount').style.display = 'none';
            modal.querySelector('.reward-title').innerText = title; 
            modal.querySelector('.reward-desc').innerHTML = desc; 
            modal.style.display = 'flex';
            document.getElementById('modalClaimBtn').innerText = settings.error_modal_btn_text; 
            document.getElementById('modalClaimBtn').onclick = () => modal.style.display = 'none';
        }

        function showRewardModal(type, amount, id) {
            if (!isBotVerified && isEntryViaReferral) return;
            let title = 'Reward!', desc = 'Processed.';
            document.getElementById('modalIconContainer').innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/1292/1292744.png" class="reward-coin" id="defaultRewardIcon">';
            document.getElementById('popupAmount').style.display = 'block';

            if (type === 'ad') { title = settings.ad_popup_title; desc = settings.ad_popup_desc; }
            else if (type === 'daily') { title = settings.daily_popup_title; desc = settings.daily_popup_desc; }
            else if (type === 'mission') { title = settings.mission_popup_title; desc = settings.mission_popup_desc; }
            else if (type === 'referral') { title = 'Referral Bonus!'; desc = 'You are about to claim your referral bonus.'; } 

            document.getElementById('popupAmount').innerText = '+' + amount + ' Coins';
            const modal = document.getElementById('rewardModal');
            modal.querySelector('.reward-title').innerText = title; modal.querySelector('.reward-desc').innerText = desc; 
            modal.style.display = 'flex';
            const btn = document.getElementById('modalClaimBtn');
            btn.onclick = null; btn.innerText = settings.modal_claim_btn_text; 
            
            btn.onclick = function() {
                modal.style.display = 'none';
                
                if(['mission','ad','daily','referral'].includes(type)) { 
                    const coin = document.createElement('img'); coin.src = 'https://cdn-icons-png.flaticon.com/512/1292/1292744.png'; coin.className = 'fly-coin';
                    const c = { x: window.innerWidth/2, y: window.innerHeight/2 }; coin.style.left = `${c.x-17.5}px`; coin.style.top = `${c.y-17.5}px`; document.body.appendChild(coin);
                    const t = document.getElementById('mainCoinIcon').getBoundingClientRect();
                    setTimeout(() => { coin.style.left = t.left+'px'; coin.style.top+'px'; coin.style.opacity = '0.5'; coin.style.transform = 'scale(0.5)'; }, 50);
                    setTimeout(() => coin.remove(), 800);
                }
                
                let newBalance = currentBalance + amount; 
                animateBalance(currentBalance, newBalance);
                
                if (type === 'mission') { 
                    userRef.update({ balance: firebase.firestore.FieldValue.increment(amount), completed_tasks: firebase.firestore.FieldValue.arrayUnion(id), last_activity: Date.now() });
                }
                else if (type === 'daily') {
                    const today = new Date().toDateString();
                    userRef.update({ balance: firebase.firestore.FieldValue.increment(amount), last_daily_claim_date: today, last_activity: Date.now() }).then(() => {
                        if(window.dailyClaimButtonRef) { window.dailyClaimButtonRef.innerHTML = 'Claimed'; window.dailyClaimButtonRef.className = 'task-btn btn-done'; window.dailyClaimButtonRef.disabled = true; lastDailyClaimDate = today; delete window.dailyClaimButtonRef; }
                    });
                } 
                else if (type === 'referral') { 
                    processReferralClaimTransaction(window.referredIdToClaim, window.rewardAmountToClaim);
                }
                else if (type === 'ad') { 
                    const newCooldownEndTime = Date.now() + COOLDOWN_DURATION;
                    
                    userRef.update({ 
                        ad_cooldown_end_time: newCooldownEndTime,
                        last_activity: Date.now()
                    }, {merge: true}).then(() => {
                        adCooldownEndTime = newCooldownEndTime;
                        updateUI(); 
                    }).catch(err => { console.error("Failed to set ad cooldown: ", err); });
                }
                
                if(type !== 'ad') { updateUserActivity(); }
            };
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = (typeof timestamp === 'number') ? new Date(timestamp) : timestamp.toDate();
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        async function processReferralClaimTransaction(referredUid, amount) {
             const btn = document.getElementById(`ref-btn-${referredUid}`);
            const refUserRef = db.collection('users').doc(uid).collection('referred_users').doc(referredUid);

            try {
                await db.runTransaction(async t => {
                    const userDoc = await t.get(userRef);
                    const refDoc = await t.get(refUserRef);
                    if (!userDoc.exists || !refDoc.exists) throw "User or Referral record not found.";
                    if (refDoc.data().is_claimed) throw "Bonus already claimed.";
                    if ((refDoc.data().referred_total_ads_watched || 0) < settings.ref_ads_watch_requirement) throw "Req not met.";
                    
                    t.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(amount),
                        referral_earnings: firebase.firestore.FieldValue.increment(amount),
                        last_activity: Date.now()
                    });
                    t.update(refUserRef, { is_claimed: true, claimed_at: Date.now() });
                    return amount; 
                });
            } catch (error) {
                console.error("Referral Claim Transaction Failed: ", error);
                const errMsg = (typeof error === 'string') ? error : "An unexpected error occurred.";
                if (btn && errMsg !== "Bonus already claimed.") {
                    btn.innerHTML = 'Claim'; btn.classList.remove('btn-done'); btn.classList.add('btn-claim-task'); btn.disabled = false;
                }
                showErrorModal('Claim Failed', errMsg, 'exclamation-triangle');
            }
            window.referredIdToClaim = null; window.rewardAmountToClaim = null; 
        }

        async function claimReferralBonus(referredUid, amount) {
            if (!isBotVerified && isEntryViaReferral) return;
            const btn = document.getElementById(`ref-btn-${referredUid}`);
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            const refDoc = await db.collection('users').doc(uid).collection('referred_users').doc(referredUid).get();
            if (!refDoc.exists || refDoc.data().is_claimed || (refDoc.data().referred_total_ads_watched || 0) < settings.ref_ads_watch_requirement) {
                 btn.innerHTML = 'Pending'; btn.classList.remove('btn-claim-task'); btn.classList.add('btn-done'); btn.disabled = true;
                 showErrorModal('Requirement Not Met', 'Your referral has not yet viewed enough ads.', 'hand-point-up');
                 return; 
            }
            window.referredIdToClaim = referredUid; window.rewardAmountToClaim = amount; 
            showRewardModal('referral', amount, referredUid); 
        }
        
        function renderReferrals(page = 1) {
            if (!isBotVerified && isEntryViaReferral) return;
            const loading = document.getElementById('activeRefLoading');
            loading.style.display = 'block';

            db.collection('users').doc(uid).collection('referred_users').onSnapshot(async snapshot => {
                loading.style.display = 'none';
                const referrals = [];
                const reqs = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    reqs.push(db.collection('users').doc(d.referred_uid).get().then(refUserDoc => {
                        const userName = d.referred_username || (refUserDoc.exists ? (refUserDoc.data().full_name || 'User') : 'User'); 
                        const totalAds = refUserDoc.exists ? (refUserDoc.data().total_ads_watched || 0) : (d.referred_total_ads_watched || 0);
                        referrals.push({ ...d, id: doc.id, referred_username: userName, referred_total_ads_watched: totalAds });
                    }).catch(() => {
                        referrals.push({ ...d, id: doc.id, referred_total_ads_watched: d.referred_total_ads_watched || 0 });
                    }));
                });
                await Promise.all(reqs);

                activeReferralsData = referrals.filter(r => !r.is_claimed);
                completedReferralsData = referrals.filter(r => r.is_claimed);

                activeReferralsData.sort((a, b) => (b.referred_total_ads_watched || 0) - (a.referred_total_ads_watched || 0));
                completedReferralsData.sort((a, b) => (b.claimed_at || 0) - (a.claimed_at || 0));

                activeRefPage = page; completedRefPage = 1; 
                updateReferralList(activeReferralsData, activeRefPage, 'active');
                updateReferralList(completedReferralsData, completedRefPage, 'completed');
            });
        }
        
        function updateReferralList(data, page, type) {
            const container = document.getElementById(`${type}ReferralListContainer`);
            const titleEl = document.getElementById(`${type}ReferralsTitle`);
            const paginationEl = document.getElementById(`${type}ReferralPagination`);
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = data.slice(start, end);
            const totalPages = Math.ceil(data.length / pageSize);
            const refReq = settings.ref_ads_watch_requirement || 100;
            
            titleEl.style.display = data.length > 0 ? 'block' : 'none';

            if (data.length === 0) { container.innerHTML = ''; paginationEl.style.display = 'none'; return; }

            let html = '';
            paginatedData.forEach(r => {
                const adsWatched = r.referred_total_ads_watched || 0;
                const cappedAdsWatched = Math.min(adsWatched, refReq);
                const isReadyToClaim = adsWatched >= refReq;
                const progressText = `${cappedAdsWatched}/${refReq}`; 
                const progressColor = isReadyToClaim ? '#4caf50' : '#ff9800';

                let btnClass = 'btn-done', btnText = 'Pending', btnAction = 'void(0)', btnDisabled = true, buttonStyle = 'opacity: 0.8;';

                if (r.is_claimed) {
                    btnText = 'Claimed'; btnClass = 'btn-done'; btnDisabled = true; buttonStyle = 'opacity: 1;';
                } else if (isReadyToClaim) {
                    btnText = 'Claim'; btnClass = 'btn-claim-task'; btnAction = `claimReferralBonus('${r.id}', ${settings.ref_bonus})`; btnDisabled = false; buttonStyle = 'animation: pulse 1s infinite;';
                }
                
                const joinDate = formatDate(r.created_at); 

                html += `
                    <div class="task-card ref-list-card" id="ref-card-${r.id}">
                        <div class="task-left">
                            <div class="task-icon" style="width: 40px; height: 40px; border-radius: 10px; font-size: 1rem;"><i class="fas fa-user-check"></i></div>
                            <div class="ref-user-info">
                                <h4>${r.referred_username}</h4>
                                <p>UID: ${r.referred_uid.substring(0, 4)}...${r.referred_uid.slice(-4)}</p>
                                <p class="ref-join-date">Joined: ${joinDate}</p>
                            </div>
                        </div>
                        <div class="ref-actions">
                            <div class="ref-summary-right">
                                <div class="ref-reward-amount">+${settings.ref_bonus} Coins</div>
                                <div class="ref-progress-text" style="color: ${progressColor};">${progressText} Ads</div>
                            </div>
                            <button id="ref-btn-${r.id}" class="task-btn ${btnClass}" onclick="${btnAction}" ${btnDisabled ? 'disabled' : ''} style="${buttonStyle}">${btnText}</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            
            paginationEl.innerHTML = '';
            if (totalPages > 1) {
                const prevBtn = `<button class="page-btn" onclick="changeRefPage('${type}', ${page - 1})" ${page === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
                const nextBtn = `<button class="page-btn" onclick="changeRefPage('${type}', ${page + 1})" ${page === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
                let pageNumbers = '';
                for (let i = 1; i <= totalPages; i++) {
                    pageNumbers += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="changeRefPage('${type}', ${i})">${i}</button>`;
                }
                paginationEl.innerHTML = prevBtn + pageNumbers + nextBtn;
                paginationEl.style.display = 'flex';
            } else { paginationEl.style.display = 'none'; }
        }
        
        function changeRefPage(type, newPage) {
            if (type === 'active') { activeRefPage = newPage; updateReferralList(activeReferralsData, activeRefPage, 'active'); }
            else if (type === 'completed') { completedRefPage = newPage; updateReferralList(completedReferralsData, completedRefPage, 'completed'); }
        }
        
        function toggleAccountInput() {
            const method = document.getElementById('withdrawMethod').value;
            document.getElementById('accountNumber').style.display = (method && method !== "") ? 'block' : 'none';
        }

        function requestWithdraw() {
            if (!isBotVerified && isEntryViaReferral) return;
            const method = document.getElementById('withdrawMethod').value, accNum = document.getElementById('accountNumber').value.trim();
            const amount = parseInt(document.getElementById('withdrawAmount').value), minWithdraw = settings.min_withdraw; 

            if (totalAdsWatched < settings.min_ads_view_for_withdraw) return showErrorModal(settings.min_ads_err_title, settings.min_ads_err_desc.replace('{{min_ads_view}}', settings.min_ads_view_for_withdraw), 'video');
            if (referralCount < settings.min_referrals_for_withdraw) return showErrorModal(settings.min_refs_err_title, settings.min_refs_err_desc.replace('{{min_referrals}}', settings.min_referrals_for_withdraw), 'user-plus');
            if (isNaN(amount) || amount <= 0) return showErrorModal(settings.min_amt_err_title, settings.min_amt_err_desc.replace('{{min_withdraw}}', minWithdraw), 'ban');
            if (amount < minWithdraw) return showErrorModal(settings.min_amt_err_title, settings.min_amt_err_desc.replace('{{min_withdraw}}', minWithdraw), 'hand-point-up');
            if (amount > currentBalance) return showErrorModal(settings.bal_err_title, settings.bal_err_desc, 'wallet');
            if (!method) return showErrorModal(settings.method_err_title, settings.method_err_desc, 'credit-card');
            if (!accNum) return showErrorModal(settings.acc_num_err_title, settings.acc_num_err_desc, 'user-circle');

            document.getElementById('balance').innerHTML = '<div class="spinner"></div>';
            userRef.update({ balance: firebase.firestore.FieldValue.increment(-amount), last_activity: Date.now() }).then(() => {
                db.collection('withdrawals').add({ user_id: uid, username: username, method: method, account_number: accNum, amount: amount, status: 'pending', date: Date.now() })
                .then(() => {
                    showCustomSuccessModal(settings.withdraw_success_title, settings.withdraw_success_desc, 'check-circle');
                    document.getElementById('withdrawAmount').value = ''; document.getElementById('accountNumber').value = ''; document.getElementById('withdrawMethod').value = ''; document.getElementById('accountNumber').style.display = 'none'; 
                });
            }).catch(err => {
                showErrorModal("Transaction Error", "Error deducting balance.", 'exclamation-triangle');
                document.getElementById('balance').innerText = currentBalance;
            });
        }
        
        function hideHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }
        function showHistoryModal(type) {
             if (!uid) return; 
            const modal = document.getElementById('historyModal');
            const titleEl = document.querySelector('#historyModal .reward-title'), iconContainer = document.getElementById('historyModalIconContainer');
            document.getElementById('historyListContainer').innerHTML = `<div style="text-align:center; padding: 30px; color: #999;"><div class="spinner spinner-dark"></div><p style="margin-top:10px;">Loading...</p></div>`;
            if (type === 'withdrawal') { titleEl.innerText = 'Withdraw History'; iconContainer.innerHTML = '<i class="fas fa-wallet fa-2x" style="color: #764ba2; margin-bottom: 15px;"></i>'; fetchWithdrawalHistory(); } 
            modal.style.display = 'flex';
            updateUserActivity(); 
        }
        
        function showAdsHistoryModal() {
            if (!uid) return; 
            const modal = document.getElementById('historyModal');
            document.getElementById('historyListContainer').innerHTML = `<div style="text-align:center; padding: 30px; color: #999;"><div class="spinner spinner-dark"></div><p style="margin-top:10px;">Loading...</p></div>`;
            document.querySelector('#historyModal .reward-title').innerText = 'Ads View History';
            document.getElementById('historyModalIconContainer').innerHTML = '<i class="fas fa-video fa-2x" style="color: #764ba2; margin-bottom: 15px;"></i>';
            modal.style.display = 'flex'; fetchAdsHistory();
            updateUserActivity(); 
        }

        function fetchWithdrawalHistory() {
            if (!uid) return;
            db.collection('withdrawals').where('user_id', '==', uid).orderBy('date', 'desc').onSnapshot(snapshot => {
                let html = '';
                if (snapshot.empty) html = `<div style="text-align:center; padding: 30px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No withdrawal history found.</p></div>`;
                else snapshot.forEach(doc => {
                    const item = doc.data();
                    const date = item.date ? new Date(item.date).toLocaleDateString() : 'N/A';
                    const statusClass = `status-${item.status}`;
                    const statusText = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                    
                    html += `
                        <div class="history-item" style="align-items: flex-start;">
                            <div class="item-details">
                                <h4 style="margin-bottom: 8px; font-size: 1rem; color: #764ba2;">${item.amount} Coins</h4>
                                <div style="font-size: 0.85rem; color: #444; line-height: 1.6;">
                                    <strong>UID:</strong> ${item.user_id}<br>
                                    <strong>Method:</strong> ${item.method}<br>
                                    <strong>Account:</strong> ${item.account_number || 'N/A'}<br>
                                    <span style="font-size: 0.75rem; color: #888;">Date: ${date}</span>
                                </div>
                            </div>
                            <span class="item-status ${statusClass}" style="margin-top: 5px;">${statusText}</span>
                        </div>
                    `;
                });
                document.getElementById('historyListContainer').innerHTML = html;
            });
        }
        
        function fetchAdsHistory() {
            if (!uid) return;
            db.collection('users').doc(uid).collection('daily_ads_views').orderBy('updated_at', 'desc').onSnapshot(snapshot => {
                let html = '';
                const minRequired = settings.min_ads_view_for_withdraw || 0;
                const isMet = totalAdsWatched >= minRequired;
                const statusClass = isMet ? 'ads-status-ok' : 'ads-status-pending';
                const statusText = isMet ? 'Requirement Met!' : `Needed for Withdraw: ${minRequired} Ads`;
                const bgColor = isMet ? '#2ecc71' : '#e74c3c'; 

                html += `
                    <div class="ads-history-summary">
                        <div class="item-details" style="text-align: left;">
                            <h4 style="color:#764ba2; margin:0;">Total Lifetime Ads:</h4>
                            <p class="${statusClass}" style="margin:0; font-weight:600;">${statusText}</p>
                        </div>
                        <span class="item-status" style="background:${bgColor}; font-size:1rem; padding: 6px 12px; color: white;">${totalAdsWatched}</span>
                    </div>
                `;
                
                if (snapshot.empty) {
                    html += `<div style="text-align:center; padding: 30px; color: #999;"><i class="fas fa-box-open fa-2x"></i><p>No ads view history found.</p></div>`;
                } else {
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const dateKey = doc.id; 
                        const parts = dateKey.split('-');
                        const displayDate = new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString();
                        const providerName = item.last_provider === 'adsgram' ? 'Adsgram' : 'Network 1';
                        
                        html += `
                            <div class="history-item">
                                <div class="item-details">
                                    <h4 style="font-size: 0.95rem;">${item.count} Ads Viewed (Daily)</h4>
                                    <p style="color: #764ba2; font-weight: 600;">Last Network: ${providerName}</p>
                                    <p style="font-size:0.75rem; color: #888;">Date: ${displayDate}</p>
                                </div>
                                <span class="item-status status-paid">Viewed</span>
                            </div>
                        `;
                    });
                }
                document.getElementById('historyListContainer').innerHTML = html;
            });
        }
        
        function switchTab(id, el) {
            if (!isBotVerified && isEntryViaReferral) return;
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById(id+'-section').classList.add('active-section');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active'); window.scrollTo(0,0);
            updateUserActivity(); 
            if (id === 'invite') {
                activeRefPage = 1; completedRefPage = 1; 
                renderReferrals(activeRefPage);
            }
        }

        function copyLink(btn) {
            navigator.clipboard.writeText(document.getElementById('refLink').innerText).then(() => {
                let old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-check"></i> Copied!'; btn.style.background = '#4caf50';
                setTimeout(() => { btn.innerHTML = old; btn.style.background = '#333'; }, 1000);
            });
        }

        function animateBalance(start, end) {
            let current = start, step = Math.ceil((end - start) / 10); 
            const timer = setInterval(() => {
                current += step; if (current >= end) { current = end; clearInterval(timer); }
                document.getElementById('balance').innerText = current;
            }, 30);
        }
    </script>
</body>
</html>