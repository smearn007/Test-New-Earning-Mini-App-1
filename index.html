<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin Flux</title>
    
    <!-- Telegram & Ads SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://js.onclckvd.com/in-stream-ad-admanager/tma.js"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Orbitron & Rajdhani for Sci-Fi look -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->

    <style>
        
        /* =========================================
   1. CORE VARIABLES & RESET
   ========================================= */
:root {
    --bg-dark: #05060a;
    --bg-panel: rgba(20, 25, 45, 0.6);
    --neon-blue: #00f0ff;
    --neon-purple: #bc13fe;
    --neon-gold: #ffd700;
    --text-main: #ffffff;
    --text-muted: #8b9bb4;
    --glass-border: rgba(255, 255, 255, 0.1);
    --font-head: 'Orbitron', sans-serif;
    --font-body: 'Rajdhani', sans-serif;

    /* NEW NEON COLORS for Holographic Dropdown */
    --neon-aqua: #09F2FF;
    --neon-uv-purple: #C542FF;
    --neon-plasma-gold: #F8C85F;
}

body {
    margin: 0; padding: 0;
    font-family: var(--font-body);
    background-color: var(--bg-dark);
    color: var(--text-main);
    overflow-x: hidden;
    padding-bottom: 100px; /* Space for bottom nav */
    -webkit-tap-highlight-color: transparent;
}

/* =========================================
   2. NETWORK-BASED ORGANIC LOADER
   ========================================= */

/* Loader Wrapper - Full Screen */
#loader-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #05060a; z-index: 9999;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    overflow: hidden;
    transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

#loader-screen.loaded {
    opacity: 0;
    transform: scale(2);
    filter: blur(20px);
    pointer-events: none;
}

.loader-bg-aurora {
    position: absolute; width: 200%; height: 200%;
    background: radial-gradient(circle at 50% 50%, rgba(0, 240, 255, 0.1), transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 170, 0.08), transparent 50%);
    animation: auroraMove 15s infinite alternate linear;
    z-index: 1;
}
@keyframes auroraMove { 
    0% { transform: translate(-20%, -20%) rotate(0deg); } 
    100% { transform: translate(10%, 10%) rotate(10deg); } 
}

/* Orbit Loader Style */
.loader-orbit-box {
    position: relative; 
    width: 180px; height: 180px;
    display: flex; justify-content: center; align-items: center;
    z-index: 10;
    margin-bottom: 20px;
}

.loader-ring-outer {
    position: absolute; width: 100%; height: 100%;
    border-radius: 50%; 
    border: 3px dashed rgba(0, 240, 255, 0.5);
    box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
    animation: spin 10s linear infinite;
}

.loader-ring-inner {
    position: absolute; width: 80%; height: 80%;
    border-radius: 50%; 
    border: 2px solid transparent;
    border-top: 2px solid var(--neon-purple);
    border-bottom: 2px solid var(--neon-purple);
    animation: spinReverse 6s linear infinite;
    box-shadow: 0 0 10px rgba(188, 19, 254, 0.3);
}

.loader-core-logo {
    font-size: 4rem; 
    color: #fff;
    z-index: 2;
    text-shadow: 0 0 20px var(--neon-blue);
    animation: bounce 3s infinite ease-in-out;
    margin-top: 30px;
}

.loader-text-wrapper {
    position: relative; z-index: 10;
    text-align: center;
    display: flex; flex-direction: column;
}

#progressText {
    font-family: var(--font-head); 
    font-size: 2rem; 
    font-weight: bold;
    color: #fff; 
    text-shadow: 0 0 10px var(--neon-blue);
}

.loading-label {
    font-family: var(--font-body); 
    font-size: 0.8rem; 
    letter-spacing: 3px;
    color: var(--neon-purple); 
    text-transform: uppercase; 
    margin-top: 5px;
    animation: blink 1s infinite;
}

.flash-burst {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: white; opacity: 0; pointer-events: none; z-index: 10000;
}
.flash-active { animation: flashAnim 0.3s ease-out; }

@keyframes flashAnim { 0% { opacity: 0.8; } 100% { opacity: 0; } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes spinReverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(-360deg); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes blink { 50% { opacity: 0.5; } }


/* =========================================
   3. BACKGROUND & ATMOSPHERE
   ========================================= */
.bg-particles {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* Updated background gradient */
    background: linear-gradient(180deg, #03020A 0%, #0C0F33 100%);
    z-index: -2;
}
.bg-glow {
    position: fixed; top: -20%; left: -20%; width: 50%; height: 50%;
    background: radial-gradient(circle, rgba(0, 240, 255, 0.15), transparent 70%);
    filter: blur(80px); z-index: -1; animation: floatGlowBG 10s infinite alternate;
}
@keyframes floatGlowBG { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 20px); } }

/* =========================================
   4. HEADER & BALANCE ORB
   ========================================= */
.cyber-header {
    display: flex; justify-content: space-between; padding: 20px;
    position: relative; z-index: 10;
}
.cyber-badge {
    background: rgba(0, 240, 255, 0.1);
    border: 1px solid var(--neon-blue);
    padding: 5px 12px; border-radius: 4px;
    font-size: 0.8rem; font-weight: 700;
    color: var(--neon-blue);
    text-shadow: 0 0 5px var(--neon-blue);
    backdrop-filter: blur(5px);
}

.balance-orbit-container {
    position: relative; width: 160px; height: 160px;
    margin: 10px auto 30px; display: flex;
    justify-content: center; align-items: center;
}
.orbit-ring {
    position: absolute; width: 100%; height: 100%;
    border-radius: 50%; border: 2px dashed rgba(0, 240, 255, 0.3);
    animation: spin 10s linear infinite;
}
.orbit-ring-2 {
    position: absolute; width: 80%; height: 80%;
    border-radius: 50%; border: 1px solid rgba(188, 19, 254, 0.3);
    border-top-color: var(--neon-purple);
    animation: spinReverse 6s linear infinite;
}
.balance-core {
    text-align: center; z-index: 2;
    position: relative;
}

.coin-hologram {
    font-size: 2rem; 
    color: var(--neon-gold); 
    filter: drop-shadow(0 0 10px var(--neon-gold)); 
    margin-bottom: 1px; 
    animation: none; 
}

#balance {
    font-family: var(--font-head);
    font-size: 2rem;           
    font-weight: 900;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    line-height: 1;
    width: 100%;
    max-width: 120px;          
    margin: 0 auto;
    white-space: nowrap;       
    overflow: hidden;          
    text-overflow: clip;       
    transition: font-size 0.2s ease, transform 0.1s; 
}

/* NEW: USD Label Style */
.usd-label {
    font-size: 0.9rem;
    color: #2ecc71; /* Dollar Green */
    font-family: 'Rajdhani', monospace;
    font-weight: 700;
    margin-top: 0px;
    margin-bottom: 2px; /* Space above 'Coin Flux' */
    text-shadow: 0 0 8px rgba(46, 204, 113, 0.4);
    letter-spacing: 1px;
    opacity: 0.9;
}

.balance-label 
{ 
    font-size: 0.7rem; letter-spacing: 2px; color: var(--neon-blue); margin-top: 2px; opacity: 0.8; 
    
}

/* =========================================
   5. TABS & CARDS (GLASS PANELS)
   ========================================= */
.cyber-tabs {
    display: flex; gap: 10px; padding: 5px;
    background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 20px;
}
.cyber-tab {
    flex: 1; text-align: center; padding: 10px;
    font-family: var(--font-head); font-size: 0.75rem;
    color: var(--text-muted); cursor: pointer;
    border: 1px solid transparent; border-radius: 8px;
    transition: all 0.3s;
}
.cyber-tab.active {
    background: rgba(0, 240, 255, 0.15);
    border-color: var(--neon-blue);
    color: var(--neon-blue);
    box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
}

.glass-panel {
    background: var(--bg-panel);
    border: 1px solid var(--glass-border);
    border-radius: 16px; padding: 20px;
    backdrop-filter: blur(12px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    margin-bottom: 20px; position: relative; overflow: hidden;
    transition: transform 0.3s;
}
.glass-panel::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--neon-purple), transparent);
}

.panel-icon { text-align: center; color: var(--neon-purple); margin-bottom: 10px; filter: drop-shadow(0 0 5px var(--neon-purple)); }
h3 { margin: 5px 0; font-family: var(--font-head); font-weight: 700; color: white; text-align: center; letter-spacing: 1px; }
p { color: var(--text-muted); font-size: 0.9rem; text-align: center; margin-top: 0; }
.neon-text { color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }


/* =========================================
   6. UPDATED RANK & VAULT ICONS (CENTERED)
   ========================================= */

/* Common style for centering main icons in cards */
.trophy-holo, 
.vault-icon {
    display: flex;            
    justify-content: center;  
    align-items: center;      
    width: 100%;              
    margin: 0 auto 20px auto; 
    text-align: center;
}

/* Rank/Leaderboard Icon */
.trophy-holo { 
    color: var(--neon-blue);  
    filter: drop-shadow(0 0 15px rgba(0, 240, 255, 0.6)); 
}

/* Wallet/Vault Icon */
.vault-icon { 
    color: var(--neon-blue); 
    filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.5));
    transition: transform 0.3s ease;
}
.vault-icon:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.8));
}

@keyframes floatGlow {
    0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.4)); }
    50% { transform: translateY(-5px); filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.8)); }
}


/* =========================================
   7. PROGRESS BARS & BUTTONS
   ========================================= */
.cyber-progress-box { margin: 20px 0; }
.progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; font-family: var(--font-head); }
.neon-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
.neon-bar {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
    box-shadow: 0 0 10px var(--neon-blue);
    transition: width 0.5s ease;
}

/* Glitch Button */
.cyber-btn-glitch {
    background: transparent; border: 1px solid var(--neon-blue);
    color: var(--neon-blue); padding: 12px; width: 100%;
    font-family: var(--font-head); font-weight: 700; letter-spacing: 1px;
    cursor: pointer; position: relative; overflow: hidden;
    transition: 0.2s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
}
.cyber-btn-glitch:active { transform: scale(0.98); background: rgba(0, 240, 255, 0.1); }
.cyber-btn-glitch.disabled { border-color: #555; color: #555; pointer-events: none; }
.flare {
    position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: flareAnim 3s infinite;
}
@keyframes flareAnim { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

.holo-btn-mini {
    position: absolute; top: 10px; right: 10px;
    background: rgba(0,0,0,0.5); border: 1px solid var(--text-muted);
    color: var(--text-muted); padding: 4px 10px; font-size: 0.7rem;
    border-radius: 4px; font-family: var(--font-head); cursor: pointer;
    z-index: 100;
}

.cyber-btn-small {
    background: linear-gradient(135deg, var(--neon-purple), #8a00d4);
    color: white; 
    border: none; 
    padding: 10px 20px;
    font-family: var(--font-head); 
    font-size: 0.8rem;
    clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    cursor: pointer; 
    box-shadow: 0 0 15px rgba(188, 19, 254, 0.4);
    
    /* স্পিনারের সময় বাটন ছোট হওয়া রোধ করার জন্য পরিবর্তন */
    min-width: 90px;        
    display: inline-flex;   
    justify-content: center;
    align-items: center;
    text-align: center;
}
.btn-blue { background: linear-gradient(135deg, #0088cc, #005f8f); box-shadow: 0 0 15px rgba(0, 136, 204, 0.4); }

/* =========================================
   8. LISTS (MISSIONS & REFERRALS)
   ========================================= */
.mission-capsule {
    background: rgba(255, 255, 255, 0.03); border-left: 3px solid var(--neon-purple);
    padding: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;
    backdrop-filter: blur(5px);
}
.capsule-left { display: flex; align-items: center; gap: 15px; }
.capsule-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(188, 19, 254, 0.1); border-radius: 50%; color: var(--neon-purple); }
.capsule-info h4 { text-align: left; margin: 0; font-size: 0.9rem; color: white; }
.capsule-info p { text-align: left; font-size: 0.75rem; color: var(--text-muted); }

/* Leaderboard */
.leaderboard-grid { max-height: 400px; overflow-y: auto; }
.top-ref-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.active-user-highlight { border: 1px solid var(--neon-gold); background: rgba(255, 215, 0, 0.1); }
.ref-rank-badge { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }

/* Rank Colors */
.rank-1 { 
    color: var(--neon-gold); 
    border: 2px solid var(--neon-gold); 
    background: rgba(255, 215, 0, 0.1); 
    text-shadow: 0 0 10px var(--neon-gold);
    font-family: var(--font-head); 
    font-size: 1.1rem !important; 
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); 
}
.rank-2 { 
    color: #e0e0e0; 
    border: 2px solid #e0e0e0;
    background: rgba(224, 224, 224, 0.1);
    text-shadow: 0 0 5px #e0e0e0;
    font-family: var(--font-head);
    font-size: 1.1rem !important;
}
.rank-3 { 
    color: #cd7f32; 
    border: 2px solid #cd7f32;
    background: rgba(205, 127, 50, 0.1);
    text-shadow: 0 0 5px #cd7f32;
    font-family: var(--font-head);
    font-size: 1.1rem !important;
}

.ref-info {
    flex: 1; 
    margin-left: 2px; 
    margin-right: 12px; 
    text-align: left;
    overflow: hidden;
}

.ref-info h4 { 
    text-align: left; 
    font-size: 0.9rem; 
    margin: 0;
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis;
}

.ref-count-pill { 
    background: rgba(0, 240, 255, 0.1); 
    color: var(--neon-blue); 
    padding: 5px 10px; 
    border-radius: 4px; 
    font-family: var(--font-head); 
    text-align: center; 
    min-width: 60px;
    flex-shrink: 0;
    font-size: 0.8rem;
}

/* Referral Stats */
.split-stats { display: flex; gap: 10px; margin-bottom: 20px; }
.stat-block { flex: 1; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
.stat-block i { font-size: 1.5rem; color: var(--neon-blue); margin-bottom: 5px; }

.stat-block h3 {
    margin: 0; 
    font-size: 1.2rem; /* ডিফল্ট সাইজ */
    color: white; 
    
    /* নতুন যোগ করা অংশ */
    white-space: nowrap;       /* লেখা নিচে নামবে না */
    overflow: hidden;          /* বক্সের বাইরে যাবে না */
    text-overflow: clip;       
    display: flex;             /* মাঝখানে রাখার জন্য */
    justify-content: center;
    align-items: center;
    width: 100%;               /* পুরো জায়গা নিবে */
    transition: font-size 0.2s ease; /* ফন্ট ছোট হওয়ার এনিমেশন */
}
.link-vault { background: rgba(0,0,0,0.5); border: 1px dashed var(--text-muted); padding: 10px; border-radius: 4px; margin-bottom: 15px; position: relative; }
.vault-label { position: absolute; top: -10px; left: 10px; background: var(--bg-dark); padding: 0 5px; font-size: 0.6rem; color: var(--neon-blue); }
.vault-text { font-family: monospace; color: var(--text-muted); word-break: break-all; font-size: 0.8rem; }

/* =========================================
   9. INPUTS & NAVIGATION
   ========================================= */
.cyber-input-group { margin-bottom: 15px; text-align: left; position: relative; } /* Added position: relative for dropdown positioning */
.cyber-input-group label { display: block; font-size: 0.7rem; color: var(--neon-blue); margin-bottom: 5px; font-family: var(--font-head); }
.cyber-input {
    width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
    color: white; padding: 12px; border-radius: 4px; font-family: var(--font-body); font-size: 1rem;
    outline: none; box-sizing: border-box;
}
.cyber-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 240, 255, 0.1); }

/* Bottom Nav */
.cyber-nav {
    position: fixed; bottom: 20px; left: 5%; width: 90%;
    background: rgba(10, 15, 30, 0.9); border: 1px solid var(--glass-border);
    backdrop-filter: blur(15px); border-radius: 20px;
    display: flex; justify-content: space-around; padding: 10px 0;
    z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.nav-item { text-align: center; color: var(--text-muted); transition: 0.3s; width: 20%; cursor: pointer; }
.nav-icon { font-size: 1.2rem; margin-bottom: 2px; transition: 0.3s; }
.nav-item span { font-size: 0.6rem; font-family: var(--font-head); text-transform: uppercase; }
.nav-item.active { color: var(--neon-blue); text-shadow: 0 0 8px var(--neon-blue); }
.nav-item.active .nav-icon { transform: translateY(-3px); }

/* =========================================
   10. MODALS & UTILITIES (UPDATED)
   ========================================= */
.modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* Updated background for blur/dark overlay effect */
    background: rgba(0,0,0,0.9); 
    backdrop-filter: blur(8px); /* Blur effect on background */
    z-index: 3000;
    display: none; justify-content: center; align-items: center;
}
.cyber-modal {
    background: #0b1021; border: 1px solid var(--neon-blue);
    width: 85%; max-width: 350px; padding: 30px 20px;
    text-align: center; position: relative;
    box-shadow: 0 0 30px rgba(0, 240, 255, 0.1);
    clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
    
    /* Animation: Center Pop-up */
    animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes modalPop {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

.large-modal { max-width: 450px; height: 80vh; display: flex; flex-direction: column; }

/* NEW Style for the Network Modal */
.network-modal-style {
    max-width: 400px;
    height: auto; /* Let content define height */
    max-height: 90vh;
    padding: 20px;
}
.modal-scroll-area {
    overflow-y: auto; 
    padding: 10px 0; 
    flex-grow: 1;
}

.history-scroll-area { overflow-y: auto; flex-grow: 1; }
.close-modal, .close-modal-icon { position: absolute; top: 15px; right: 15px; color: #555; cursor: pointer; font-size: 1.2rem; }
.close-modal-icon:hover { color: #fff; transform: scale(1.1); } /* Hover effect for better UX */

/* Ad Loader (Small) */
.loader-ring { width: 50px; height: 50px; border: 4px solid rgba(0, 240, 255, 0.3); border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 20px; }
.ad-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #05060a; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--neon-blue); font-family: var(--font-head); }
.blink-text { animation: blink 1s infinite; }

/* Helpers */
.neon-title { font-family: var(--font-head); font-size: 1rem; color: var(--text-muted); margin: 30px 0 10px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px; }
.neon-title .line { height: 1px; background: rgba(255,255,255,0.1); flex-grow: 1; }
.container, .cyber-container { padding: 0 20px; position: relative; z-index: 5; }
.page-section { display: none; animation: fadeIn 0.4s; }
.page-section.active-section { display: block; }
.ad-card-container { display: none; }
.ad-card-container.active { display: block; animation: slideUp 0.4s; }
.success-msg { color: #2ecc71; font-family: var(--font-head); font-size: 0.8rem; margin-top: 10px; display: none; }

/* General Animations */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


.img1
{
    width: 140px;
}

/* =========================================
   11. ADVANCED SHINY BUTTON EFFECTS (FINAL)
   ========================================= */

@keyframes universalFlare {
    0% { left: -150%; }
    10% { left: 150%; }
    100% { left: 150%; }
}

/* GROUP A: SLOW SHINE */
.holo-btn-mini, 
.cyber-btn-small, 
.tournament-chip {
    position: relative !important;
    overflow: hidden !important;
    z-index: 1;
}

.holo-btn-mini::after, 
.cyber-btn-small::after, 
.tournament-chip::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 80%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transform: skewX(-25deg);
    pointer-events: none;
    animation: universalFlare 5s infinite linear; 
}

/* GROUP B: FAST SHINE */
.cyber-btn-glitch:not(#watchAdBtn):not(#watchAdsgramBtn):not(#watchOnclickaBtn) {
    position: relative !important;
    overflow: hidden !important;
}

.cyber-btn-glitch:not(#watchAdBtn):not(#watchAdsgramBtn):not(#watchOnclickaBtn)::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 50%; 
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transform: skewX(-25deg);
    pointer-events: none;
    animation: universalFlare 3s infinite linear;
}

/* GROUP C: EVENT BUTTON */
.tournament-chip {
    background: linear-gradient(135deg, #ff9d00, #ff5e00) !important;
    color: #000 !important; 
    font-weight: 800 !important;
    border: 1px solid #ffd700 !important;
    box-shadow: 0 0 10px rgba(255, 157, 0, 0.4) !important;
    text-shadow: none !important;
}
.tournament-chip i { color: #000 !important; }

/* DISABLED STATE */
button:disabled::after,
.cyber-btn-glitch.disabled::after,
.cyber-btn-small.disabled::after,
.holo-btn-mini:disabled::after {
    display: none !important;
}

/* FIX LOGS BUTTON */
.holo-btn-mini {
    position: absolute !important; 
    top: 10px !important;
    right: 10px !important;
    z-index: 100 !important;
}

.ref-rank-badge i {
    font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
    font-weight: 900 !important;
}

/* =========================================
   12. FLYING COINS WITH SMOKE & COUNTING BOUNCE
   ========================================= */

/* 1. The Main Flying Coin */
.flying-coin {
    position: fixed;
    width: 16px;
    height: 16px;
    background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00);
    border-radius: 50%;
    box-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00;
    z-index: 10000;
    pointer-events: none;
    will-change: transform, opacity;
}

/* 2. The Smoke/Trail Effect */
.neon-smoke {
    position: fixed;
    width: 10px;
    height: 10px;
    background: rgba(255, 215, 0, 0.6);
    border-radius: 50%;
    box-shadow: 0 0 10px #ff8c00;
    pointer-events: none;
    z-index: 9999;
    animation: fadeSmoke 0.6s linear forwards;
}
@keyframes fadeSmoke {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(2); opacity: 0; }
}

/* 3. Balance Ring Ripple (Impact Effect only) */
.balance-sparkle {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    margin: auto;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #ffd700;
    box-shadow: 0 0 30px #ffd700, inset 0 0 15px #ffd700;
    animation: impactRipple 0.5s ease-out forwards;
    pointer-events: none;
    z-index: 15;
}
@keyframes impactRipple {
    0% { transform: scale(0.8); opacity: 1; border-width: 5px; }
    100% { transform: scale(1.6); opacity: 0; border-width: 0px; }
}

/* 4. COUNTING BOUNCE & SPARKLE (Active during counting) */
.counting-sparkle {
    /* Infinite pulse while counting */
    animation: countingPulse 0.15s infinite alternate; 
    color: #fffacd !important; /* Lemon Chiffon Color */
    text-shadow: 
        0 0 15px #ffd700, 
        0 0 30px #ffffff,
        0 0 50px #ff8c00;
}

@keyframes countingPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.2); } /* সংখ্যা বাড়ার সময় বড় হবে */
}

/* --- Modal Text & Color Styles --- */

/* 1. মডালের আইকন স্টাইল */
.modal-main-icon {
    font-size: 3rem; /* আইকন বড় */
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: bounce 3s infinite ease-in-out; 
    filter: none; 
    text-shadow: none;
}

/* 2. কালার ক্লাসসমূহ */
.text-cyan { 
    color: #00f0ff !important; 
    text-shadow: none !important; 
}

.text-gold { 
    color: #ffd700 !important; 
    text-shadow: none !important; 
}

.text-red { 
    color: #ff4d4d !important; 
    text-shadow: none !important; 
}

/* 3. টাইটেল স্টাইল */
.reward-title {
    font-size: 1.5rem;
    font-weight: 900;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* 4. অ্যামাউন্ট টেক্সট স্টাইল */
.reward-amount-text {
    font-size: 2.2rem;
    font-weight: bold;
    margin: 5px 0 15px 0;
    font-family: var(--font-head);
}

/* Common Bounce Keyframe */
@keyframes bounce { 
    0%, 100% { transform: translateY(0); } 
    50% { transform: translateY(-10px); } 
}

/* --- Button State Overrides --- */

.cyber-btn-small {
    /* ... existing styles ... */
    min-width: 90px;        
    display: inline-flex;   
    justify-content: center;
    align-items: center;
    text-align: center;
}

.btn-claim {
    background: linear-gradient(135deg, #2ecc71, #27ae60) !important; /* সবুজ গ্র্যাডিয়েন্ট */
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.6) !important;
    color: #fff !important;
}

.cyber-btn-small.disabled {
    background: #333 !important;
    color: #777 !important;
    box-shadow: none !important;
    cursor: not-allowed;
    border: 1px solid #444;
}

/* =========================================
   13. CUSTOM HOLO DROPDOWN STYLES (MODAL)
   ========================================= */

/* Custom Dropdown Trigger (remains the same) */
.custom-select-trigger {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}
.custom-select-trigger:active {
    border-color: var(--neon-aqua);
    box-shadow: 0 0 10px rgba(9, 242, 255, 0.2);
}

/* Panel Header (reused for modal title) */
.panel-header {
    font-family: var(--font-head);
    font-size: 0.8rem;
    color: var(--neon-uv-purple);
    padding: 10px 15px;
    border-bottom: 1px solid rgba(197, 66, 255, 0.2);
    text-align: center;
    letter-spacing: 2px;
}

/* Container inside the modal */
.network-options-container {
    padding: 10px 0; 
    overflow-y: visible;
}

/* Holo Capsule Option */
.network-option-capsule {
    position: relative;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-head);
    color: var(--text-main);
    text-align: center;
    transition: all 0.2s ease-out;
    overflow: hidden;
    
    /* Initial state for staggered animation */
    opacity: 0;
    transform: translateY(10px);
}

/* Staggered animation keyframes */
@keyframes capsuleIn {
    to { opacity: 1; transform: translateY(0); }
}

/* Hover/Tap Effects */
.network-option-capsule:hover {
    background: rgba(9, 242, 255, 0.1);
    border-color: var(--neon-aqua);
    box-shadow: 0 0 15px rgba(9, 242, 255, 0.3);
    transform: translateY(-2px) scale(1.01);
}

/* Selected State */
.network-option-capsule.selected {
    background: rgba(197, 66, 255, 0.15);
    border-color: var(--neon-uv-purple);
    box-shadow: 0 0 20px rgba(197, 66, 255, 0.5);
    color: var(--neon-aqua);
    transform: none;
    animation: pulseBorder 1.5s infinite alternate;
}

/* Rotating Energy Ring on Selected */
.network-option-capsule.selected::after {
    content: '';
    position: absolute;
    top: -5px; bottom: -5px; left: -5px; right: -5px;
    border: 2px dashed var(--neon-aqua);
    border-radius: 12px;
    opacity: 0.5;
    animation: spin 6s linear infinite;
    z-index: 0;
}

/* Keyframes for Selected Pulse */
@keyframes pulseBorder {
    0% { box-shadow: 0 0 20px rgba(197, 66, 255, 0.5); }
    100% { box-shadow: 0 0 30px rgba(197, 66, 255, 0.8), 0 0 10px var(--neon-uv-purple); }
}

/* Icon style inside capsule */
.capsule-content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    z-index: 1;
}

.capsule-icon-holo {
    color: var(--neon-plasma-gold);
    text-shadow: 0 0 5px var(--neon-plasma-gold);
}

/* Down Arrow Animation when Open */
.fa-caret-down {
    transition: transform 0.3s ease;
}
.fa-rotate-180 {
    transform: rotate(180deg);
}
/* END OF CUSTOM HOLO DROPDOWN STYLES */


    </style>
    
</head>
<body>

    <!-- ========================================= -->
    <!-- 1. NEW ORGANIC LOADING SCREEN START       -->
    <!-- ========================================= -->
    <div id="loader-screen">
        <!-- Background Effects -->
        <div class="loader-bg-aurora"></div>
        
        <!-- New Orbit Style Loader (Like Balance Orb) -->
        <div class="loader-orbit-box">
            <!-- Outer Dashed Ring -->
            <div class="loader-ring-outer"></div>
            <!-- Inner Purple Ring -->
            <div class="loader-ring-inner"></div>
            
            <!-- Logo Inside -->
            <div class="loader-core-logo">
                <img class="img1" src="img1.png" alt="Logo" /> 
            </div>
        </div>

        <!-- Progress Text Below -->
        <div class="loader-text-wrapper">
            <span id="progressText">0%</span>
            <span class="loading-label">SYSTEM SYNC</span>
        </div>
    </div>
    <!-- ========================================= -->
    <!--    NEW ORGANIC LOADING SCREEN END         -->
    <!-- ========================================= -->


    <!-- Dynamic Background Elements (Main App) -->
    <div class="bg-particles"></div>
    <div class="bg-glow"></div>

    <!-- Top Bar (User Profile) -->
    <div class="cyber-header">
        <div class="cyber-badge user-badge">
            <i class="fas fa-fingerprint"></i> <span id="uidDisplay">...</span>
        </div>
        <div class="cyber-badge user-name">
            <i class="fas fa-user-astronaut"></i> <span id="username">Guest</span>
        </div>
    </div>

    <!-- Main Balance Orb (Center) -->
    <div class="balance-orbit-container">
        <div class="orbit-ring"></div>
        <div class="orbit-ring-2"></div>
        <div class="balance-core">
            <div class="coin-hologram"><i class="fas fa-coins" id="mainCoinIcon"></i></div>
            
            <span id="balance">0</span>
            
            <!-- NEW: USD Display Added Here -->
            <div id="usdBalance" class="usd-label">= $0.00000</div>
            
            <div class="balance-label">Coin Flux</div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="cyber-container">
        
        <!-- 1. HOME SECTION (Dashboard) -->
        <div id="home-section" class="page-section active-section">
            <div class="neon-title">Ad Networks <div class="line"></div></div>
            
            <!-- Futuristic Tabs -->
            <div class="cyber-tabs">
                <div class="cyber-tab active" id="tab-monetag" onclick="switchAdTab('monetag')">
                    <i class="fas fa-cube"></i> Zone 1
                </div>
                <div class="cyber-tab" id="tab-adsgram" onclick="switchAdTab('adsgram')">
                    <i class="fas fa-cube"></i> Zone 2
                </div>
                <div class="cyber-tab" id="tab-onclicka" onclick="switchAdTab('onclicka')">
                    <i class="fas fa-cube"></i> Zone 3
                </div>
            </div>

            <!-- Card 1: Monetag -->
            <div id="card-monetag" class="ad-card-container active">
                <div class="glass-panel" id="adCard">
                    <button class="holo-btn-mini" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> Log</button> 
                    <div class="panel-icon"><i class="fas fa-play-circle fa-3x"></i></div>
                    <h3 id="adCardTitle">Video Stream</h3> 
                    <p id="adCardDesc">Reward: <span class="neon-text" id="rewardAmountDisplay">...</span> Coins</p>

                    <div class="cyber-progress-box">
                        <div class="progress-info">
                            <span>Zone 1 Daily Progress</span>
                            <span><b id="adCount">0</b> / <span id="limitDisplay">...</span></span>
                        </div>
                        <div class="neon-track">
                            <div class="neon-bar" id="dailyProgressBar"></div>
                        </div>
                    </div>

                    <button class="cyber-btn-glitch" id="watchAdBtn" onclick="startAdFlow()">
                        INITIALIZE AD <span class="flare"></span>
                    </button>
                    <div id="completedMsg" class="success-msg"><i class="fas fa-check-circle"></i> Come back the next day.</div>
                </div>
            </div>

            <!-- Card 2: Adsgram -->
            <div id="card-adsgram" class="ad-card-container">
                <div class="glass-panel" id="adsgramCard">
                    <button class="holo-btn-mini" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> Log</button> 
                    <div class="panel-icon"><i class="fas fa-satellite-dish fa-3x"></i></div>
                    <h3 id="adsgramCardTitle">Adsgram Link</h3> 
                    <p id="adsgramCardDesc">Reward: <span class="neon-text" id="adsgramRewardDisplay">...</span> Coins</p>

                    <div class="cyber-progress-box">
                        <div class="progress-info">
                            <span>Zone 2 Daily Progress</span>
                            <span><b id="adsgramCount">0</b> / <span id="adsgramLimitDisplay">...</span></span>
                        </div>
                        <div class="neon-track">
                            <div class="neon-bar" id="adsgramProgressBar"></div>
                        </div>
                    </div>

                    <button class="cyber-btn-glitch" id="watchAdsgramBtn" onclick="startAdsgramFlow()">
                        ESTABLISH LINK <span class="flare"></span>
                    </button>
                    <div id="adsgramCompletedMsg" class="success-msg"><i class="fas fa-check-circle"></i> Come back the next day.</div>
                </div>
            </div>
            
            <!-- Card 3: Onclicka -->
            <div id="card-onclicka" class="ad-card-container">
                <div class="glass-panel" id="onclickaCard">
                    <button class="holo-btn-mini" onclick="showAdsHistoryModal()"><i class="fas fa-history"></i> Log</button> 
                    <div class="panel-icon"><i class="fas fa-network-wired fa-3x"></i></div>
                    <h3 id="onclickaCardTitle">Onclicka Net</h3> 
                    <p id="onclickaCardDesc">Reward: <span class="neon-text" id="onclickaRewardDisplay">...</span> Coins</p>

                    <div class="cyber-progress-box">
                        <div class="progress-info">
                            <span>Zone 3 Daily Progress</span>
                            <span><b id="onclickaCount">0</b> / <span id="onclickaLimitDisplay">...</span></span>
                        </div>
                        <div class="neon-track">
                            <div class="neon-bar" id="onclickaProgressBar"></div>
                        </div>
                    </div>

                    <button class="cyber-btn-glitch" id="watchOnclickaBtn" onclick="startOnclickaFlow()">
                        CONNECT NODE <span class="flare"></span>
                    </button>
                    <div id="onclickaCompletedMsg" class="success-msg"><i class="fas fa-check-circle"></i> Come back the next day.</div>
                </div>
            </div>
        </div>

        <!-- 2. MISSIONS SECTION -->
        <div id="tasks-section" class="page-section">
            <div class="mission-capsule daily-mission">
                <div class="capsule-left">
                    <div class="capsule-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="capsule-info">
                        <h4>Daily Protocol</h4>
                        <p id="dailyRewardAmountDisplay">+100 Credits</p>
                    </div>
                </div>
                <button id="dailyClaimBtn" class="cyber-btn-small" onclick="claimDailyReward()">CHECK-IN</button>
            </div>

            <div class="neon-title" id="missionsSectionTitle">Tactical Missions <div class="line"></div></div>
            <div id="taskListContainer">
                <div class="loading-holo">
                    <div class="scanner"></div>
                    <p>Scanning for missions...</p>
                </div>
            </div>

            <div class="neon-title" id="completedMissionsTitle" style="display:none; margin-top: 30px;">Completed Logs <div class="line"></div></div>
            <div id="completedListContainer"></div>
        </div>

        <!-- 3. LEADERBOARD SECTION -->
        <div id="topref-section" class="page-section">
            <div class="neon-title" id="toprefSectionTitle">Global Elite <div class="line"></div></div>

            <div class="glass-panel" id="leaderboardCard" style="padding-bottom: 60px;">
                
                <div id="tournament-ui-container" style="display: none; position: absolute; top: 15px; right: 15px; z-index: 10;">
                    <button class="tournament-chip" id="referralTournamentBtn" onclick="handleTournamentButtonClick()">
                        <i class="fas fa-trophy"></i> EVENT
                    </button>
                    <div id="tournamentCountdown" style="text-align: right; font-size: 0.7rem; color: #00f0ff; margin-top: 5px;">
                        <i class="fas fa-clock"></i> <span id="tournamentTimerDisplay">...</span>
                    </div>
                </div>

                <div class="trophy-holo"><i class="fas fa-chart-line fa-3x"></i></div>
                <h2 id="leaderboardTitle" style="text-align: center; color: #fff;">Top Agents</h2>
                
                <div id="topReferralListContainer" class="leaderboard-grid">
                    <div class="loading-holo"><div class="scanner"></div><p>Syncing Database...</p></div>
                </div>
            </div>
        </div>

        <!-- 4. INVITE SECTION -->
        <div id="invite-section" class="page-section">
            <div class="neon-title" id="inviteSectionTitle">Recruitment <div class="line"></div></div>
            
            <div class="glass-panel">
                
                <!-- UPDATED: Use vault-icon class for glowing effect -->
                <div class="vault-icon"><i class="fas fa-user-plus fa-3x"></i></div>
                
                <!-- NOTE: h3 and p tags inside the glass-panel will be dynamically updated by script.js's settings listener (ref_title, ref_desc) -->
                <h3>Refer & Earn</h3>
                <p>Share link & get bonus!</p>
                
                <div class="split-stats">
                    <div class="stat-block">
                        <i class="fas fa-users"></i>
                        <h3 id="ref-count">0</h3>
                        <p>Referrals</p>
                    </div>
                    <div class="stat-block">
                        <i class="fas fa-gem"></i>
                        <h3 id="ref-earned">0</h3>
                        <p>Earned</p>
                    </div>
                </div>

                <div class="link-vault">
                    <div class="vault-label">ENCRYPTED LINK</div>
                    <div class="vault-text" id="refLink">Loading...</div>
                </div>
                <button class="cyber-btn-glitch full-width" onclick="copyLink(this)">COPY Link <i class="fas fa-copy"></i></button>
            </div>

            <div class="neon-title" id="activeReferralsTitle" style="margin-top: 30px; display: none;">Active Agents <div class="line"></div></div>
            <div id="activeReferralListContainer"></div>
            <div id="activeReferralPagination" class="pagination" style="display: none;"></div>
            
            <div class="neon-title" id="completedReferralsTitle" style="margin-top: 30px; display:none;">Bonus Claimed <div class="line"></div></div>
            <div id="completedReferralListContainer"></div>
            <div id="completedReferralPagination" class="pagination" style="display: none;"></div>
        </div>
        
        <!-- 5. WALLET SECTION -->
        <div id="wallet-section" class="page-section">
            <div class="neon-title" id="walletSectionTitle">Vault Access <div class="line"></div></div>
            <div class="glass-panel vault-panel">
                <button class="holo-btn-mini" onclick="showHistoryModal('withdrawal')"><i class="fas fa-history"></i> Log</button>
                
                <div class="vault-icon"><i class="fas fa-wallet fa-3x"></i></div>
                <h3 id="withdrawTitle">Withdraw Assets</h3>
                <p class="vault-desc"><span id="withdrawDesc">Min: 100</span></p> 
                
                <div class="cyber-input-group">
                    <label>Amount</label>
                    <input type="number" id="withdrawAmount" class="cyber-input" placeholder="Enter Amount">
                </div>

                <!-- --- UPDATED: CUSTOM HOLO DROPDOWN START (In-place trigger only) --- -->
                <div class="cyber-input-group" id="networkSelectionGroup">
                    <label>Method</label>
                    
                    <!-- কাস্টম ড্রপডাউন ট্রিগার -->
                    <!-- onclick calls the new modal function -->
                    <div id="customWithdrawMethodTrigger" class="cyber-input custom-select-trigger" onclick="openNetworkSelectionModal()">
                        <span id="selectedNetworkText">Select Withdraw Method</span>
                        <i class="fas fa-caret-down" id="triggerIcon"></i>
                    </div>
                    
                    <!-- Hidden input to hold the actual selected value for withdrawal -->
                    <input type="hidden" id="withdrawMethodValue" value="" />
                </div>
                <!-- --- UPDATED: CUSTOM HOLO DROPDOWN END --- -->

                <!-- account number input -->
                <div class="cyber-input-group">
                    <input type="number" id="accountNumber" class="cyber-input" placeholder="Wallet Address / Number" style="display: none;">
                </div>
                
                <button class="cyber-btn-glitch full-width" id="requestWithdrawBtn" onclick="requestWithdraw()">
                    INITIATE TRANSFER
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Bottom Nav -->
    <div class="cyber-nav">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('tasks', this)">
            <div class="nav-icon"><i class="fas fa-tasks"></i></div>
            <span>Mission</span>
        </div>
        <div class="nav-item" onclick="switchTab('topref', this)">
            <div class="nav-icon"><i class="fas fa-chart-simple"></i></div>
            <span>Rank</span>
        </div>
        <div class="nav-item" onclick="switchTab('invite', this)">
            <div class="nav-icon"><i class="fas fa-user-plus"></i></div>
            <span>Team</span>
        </div>
        <div class="nav-item" onclick="switchTab('wallet', this)">
            <div class="nav-icon"><i class="fas fa-wallet"></i></div>
            <span>Wallet</span>
        </div>
    </div>

    <!-- Overlay / Loader (For Ads) -->
    <div id="adOverlay" class="ad-overlay">
        <div class="loader-ring"></div>
        <h3 class="blink-text">LOADING...</h3>
    </div>
    
    <!-- MODALS -->
    <!-- Initial Verification Modal REMOVED -->

    <!-- Reward Modal -->
    <div id="rewardModal" class="modal-backdrop">
        <div class="cyber-modal">
            <div class="reward-burst"></div>
            <div id="modalIconContainer" class="modal-icon-glow"></div>
            <h2 class="reward-title neon-text-blue">SUCCESS</h2> 
            <div class="reward-amount-text glitch-text" id="popupAmount">+50</div>
            <p class="reward-desc">Transaction Verified</p> 
            <button class="cyber-btn-small" id="modalClaimBtn">ACKNOWLEDGE</button>
        </div>
    </div>
    
    <!-- Status Modal -->
    <div id="statusModal" class="modal-backdrop">
        <div class="cyber-modal">
            <div id="statusIconContainer"></div>
            <h2 id="statusTitle"></h2>
            <p id="statusDesc"></p>
            <button id="statusBtn" class="cyber-btn-small"></button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="modal-backdrop" onclick="if(event.target.id === 'historyModal') hideHistoryModal()">
        <div class="cyber-modal large-modal">
            <i class="fas fa-times close-modal" onclick="hideHistoryModal()"></i>
            <h2 class="reward-title">DATA LOGS</h2>
            <div class="history-scroll-area">
                <div id="historyListContainer"></div>
            </div>
        </div>
    </div>

    <!-- Tournament List Modal -->
    <div id="tournamentListModal" class="modal-backdrop" onclick="if(event.target.id === 'tournamentListModal') hideTournamentListModal()">
        <div class="cyber-modal large-modal">
            <i class="fas fa-times close-modal" onclick="hideTournamentListModal()"></i>
            <h2 class="reward-title neon-text-gold">TOURNAMENT</h2>
            <div id="tournListModalCountdown" style="color: #00f0ff; margin-bottom: 15px; font-family: 'Orbitron';"></div>
            
            <div id="currentUserTournamentSummary"></div>

            <button class="cyber-btn-small btn-blue" style="margin-bottom: 15px;" onclick="showRulesModal()">RULES OF ENGAGEMENT</button>
            <div class="history-scroll-area">
                <div id="tournamentLeaderboardList"></div>
            </div>
            <button class="cyber-btn-small" id="listModalJoinBtn" onclick="showJoinTournamentModal(true)" style="margin-top: 15px; display: none;">ENTER TOURNAMENT</button>
        </div>
    </div>

    <!-- Join Tournament Modal -->
    <div id="joinTournamentModal" class="modal-backdrop" onclick="if(event.target.id === 'joinTournamentModal') hideJoinTournamentModal()">
        <div class="cyber-modal">
            <i class="fas fa-times close-modal" onclick="hideJoinTournamentModal()"></i>
            <div class="holo-icon" style="color:gold;"><i class="fas fa-trophy"></i></div>
            <h2 class="reward-title">CHALLENGE MODE</h2> 
            <p class="reward-desc" id="joinModalDesc">Compete for the ultimate prize.</p> 
            <button class="cyber-btn-small btn-blue" style="margin-bottom:10px;" onclick="showRulesModal()">READ PROTOCOLS</button>
            <button class="cyber-btn-small" id="joinTournamentBtn" onclick="joinTournament()">ACCEPT CHALLENGE</button>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="modal-backdrop" onclick="if(event.target.id === 'rulesModal') hideRulesModal()">
        <div class="cyber-modal large-modal">
            <i class="fas fa-times close-modal" onclick="hideRulesModal()"></i>
            <h2 class="reward-title">PROTOCOLS</h2>
            <div class="history-scroll-area" style="text-align: left; color: #ccc; font-family: 'Rajdhani';">
                <div id="tournamentRulesContent">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Prize Collect Modal -->
    <div id="prizeCollectModal" class="modal-backdrop">
        <div class="cyber-modal">
            <div class="reward-burst" style="background: radial-gradient(circle, gold 0%, transparent 70%);"></div>
            <div class="holo-icon"><i class="fas fa-crown"></i></div>
            <h2 class="reward-title neon-text-gold" id="prizeModalTitle">VICTORY</h2> 
            <p class="reward-desc" id="prizeModalDesc"></p> 
            <div class="reward-amount-text" id="prizePopupAmount" style="color: gold;"></div>
            <button class="cyber-btn-small" id="prizeCollectBtn">CLAIM BOUNTY</button>
        </div>
    </div>

    <!-- NEW: Network Selection Modal (Full Screen Centered) -->
    <!-- The outer div's onclick closes the modal if the user clicks the backdrop -->
    <div id="networkSelectionModal" class="modal-backdrop" onclick="if(event.target.id === 'networkSelectionModal' || event.target.className === 'close-modal-icon') closeNetworkSelectionModal()">
        <!-- Added network-modal-style for size/scroll override -->
        <div class="cyber-modal large-modal network-modal-style"> 
            <i class="fas fa-times close-modal-icon" onclick="closeNetworkSelectionModal()"></i>
            <h2 class="reward-title">SELECT Method</h2>
            
            <div id="networkOptionsContainer" class="network-options-container modal-scroll-area">
                <!-- Dynamic capsules will be generated here by script.js -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Main Logic Script -->
    
    <script>
        
        /* --- START OF FILE script.js (MODIFIED) --- */

// 1. FIREBASE CONFIGURATION
const firebaseConfig = {
    apiKey: "AIzaSyAXBG5RZJ2b38kknNKzmygXrzOoCTugLIE",
    authDomain: "new-tg-test.firebaseapp.com",
    projectId: "new-tg-test",
    storageBucket: "new-tg-test.firebasestorage.app",
    messagingSenderId: "1077123386154",
    appId: "1:1077123386154:web:dbbc89d5874127f60c6c53"
};

// 2. INITIALIZATION
const BOT_USERNAME = "coinfluxworld_bot/app"; 
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const tg = window.Telegram.WebApp;
tg.expand();

// 3. USER AUTHENTICATION & DATA
let uid, username, firstName, lastName, referrerId = null; 

if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
    const user = tg.initDataUnsafe.user;
    uid = user.id.toString();
    firstName = user.first_name;
    lastName = user.last_name || ''; 
    username = user.username || firstName;
    if (tg.initDataUnsafe.start_param) referrerId = tg.initDataUnsafe.start_param;
} else {
    // Fallback for browser testing
    uid = localStorage.getItem('test_uid');
    if(!uid) { uid = 'U'+Math.floor(Math.random()*99999); localStorage.setItem('test_uid', uid); }
    firstName = "Guest";
    lastName = ""; 
    username = "GuestUser";
}

const userFullName = (firstName + ' ' + lastName).trim();

// Update UI with User Info
document.getElementById('uidDisplay').innerText = uid;
document.getElementById('username').innerText = userFullName || firstName; 

const BOT_BASE_LINK = `https://t.me/${BOT_USERNAME}`; 
document.getElementById('refLink').innerText = `${BOT_BASE_LINK}?startapp=${uid}`;


// 4. GLOBAL VARIABLES
    
let adCooldownEndTime = 0; 
let adsgramCooldownEndTime = 0; 
let onclickaCooldownEndTime = 0; 
    
let monetagCooldownInterval = null; 
let adsgramCooldownInterval = null;
let onclickaCooldownInterval = null; 
let tournamentCountdownInterval = null; 

// NEW: Mission Timer Variables
let activeTaskTimeout = null; // Tracks the main setTimeout for CLAIM button

// State Variables
let currentBalance = 0;
let adsWatchedToday = 0; 
let adsgramWatchedToday = 0; 
let onclickaWatchedToday = 0; 
let totalAdsWatched = 0; 
let referralCount = 0; 
let completedTasks = [];
let isBotVerified = true; // *** MODIFIED: Set to true to bypass verification ***
const isEntryViaReferral = !!referrerId;

let activeReferralsData = [], completedReferralsData = [];
let activeRefPage = 1, completedRefPage = 1;
const pageSize = 20;

// Tournament State
let isTournamentActive = false;
let hasJoinedTournament = false;
let tournamentEndTime = 0;
window.userTournamentRank = null;
window.hasClaimedPrize = false;
window.tournamentReferees = 0;

window.referredIdToClaim = null; 
window.rewardAmountToClaim = null; 
let showOnclicka = null; 

// Animation State
let coinClickCycle = 0; // Tracks 1-2-3 path cycle

// NEW: Custom Dropdown Global Variables
let selectedWithdrawalMethod = null; // Holds the selected method object {name, placeholder}
let selectedMethodValue = ''; // Holds the option value (e.g., 'bKash')

// --- NEW: USD Conversion Logic ---
// 5000 Coins = $0.20 => 1 Coin = $0.00004
const USD_PER_COIN = 0.20 / 5000; 

function updateUsdDisplay(coins) {
    const usdEl = document.getElementById('usdBalance');
    if (usdEl) {
        // 5 decimal places as requested
        const usdValue = (coins * USD_PER_COIN).toFixed(5); 
        usdEl.innerText = `= $${usdValue}`;
    }
}

// Default Settings
let settings = { 
    daily_limit: 20, reward_per_ad: 50, monetag_ad_code: '', 
    // NEW COOLDOWN DEFAULTS (in ms)
    monetag_cooldown_duration: 60000, 
    adsgram_cooldown_duration: 60000, 
    onclicka_cooldown_duration: 60000,
    
    adsgram_daily_limit: 20, adsgram_reward: 50, adsgram_block_id: 'int-18699',
    onclicka_daily_limit: 20, onclicka_reward: 50, onclicka_spot_id: '6101285',
    onclicka_card_title: 'Onclicka Net', onclicka_card_desc: 'Reward: +{{onclicka_reward}} Coins', 
    onclicka_btn_text: 'CONNECT NODE',
    min_withdraw: 100, ref_bonus: 100, daily_reward_amount: 100,
    min_ads_view_for_withdraw: 0, min_referrals_for_withdraw: 0, 
    home_section_title: 'Ad Networks', missions_section_title: 'Tactical Missions', invite_section_title: 'Recruitment', wallet_section_title: 'Vault Access',
    ad_card_title: 'Video Stream', ad_card_desc: 'Reward: +{{reward_per_ad}} Coins', ad_btn_text: 'INITIALIZE AD',
    ref_title: 'Recruit Agents', 
    ref_desc: 'Share encrypted link!',
    ref_ads_watch_requirement: 100, 
    initial_popup_title: 'IDENTIFICATION', initial_popup_desc: 'Bot Verification Required.', initial_popup_btn_text: 'VERIFY', initial_popup_tip: '(Join bot & click Exit)', initial_popup_bot_link: BOT_BASE_LINK,
    initial_exit_desc: 'Exit Verification', initial_exit_btn_text: 'EXIT', 
    ban_popup_title: 'ACCESS DENIED', ban_popup_desc: 'Account suspended due to violation.', ban_btn_text: 'CONTACT ADMIN', support_url: 'https://t.me/',
    unban_popup_title: 'ACCESS RESTORED', unban_popup_desc: 'You are back online.', unban_btn_text: 'CONTINUE',
    ad_popup_title: 'DATA RECEIVED', ad_popup_desc: 'Reward Coins Added.', daily_popup_title: 'LOGGED', daily_popup_desc: 'Daily check-in complete.', mission_popup_title: 'MISSION COMPLETE', mission_popup_desc: 'Bounty Claimed.',
    withdraw_title: 'Withdraw Assets', withdraw_desc: 'Min: {{min_withdraw}}', pay_methods: [{name: 'bKash', placeholder: 'bKash Number'}, {name: 'Nagad', placeholder: 'Nagad Number'}], // Updated to object array
    request_withdraw_btn_text: 'INITIATE TRANSFER', 
    modal_claim_btn_text: 'ACKNOWLEDGE', error_modal_btn_text: 'CLOSE', withdraw_success_title: 'SUCCESS', withdraw_success_desc: 'Transfer Initiated.', withdraw_success_btn_text: 'DONE',          
    min_amt_err_title: 'Error', min_amt_err_desc: 'Min required: {{min_withdraw}}', bal_err_title: 'Error', bal_err_desc: 'Insufficient Funds.',
    method_err_title: 'Error', method_err_desc: 'Select Network.', acc_num_err_title: 'Error', acc_num_err_desc: 'Enter Address.',
    min_ads_err_title: 'Access Denied', min_ads_err_desc: 'Watch more ads.', min_refs_err_title: 'Access Denied', min_refs_err_desc: 'Recruit more agents.', 
    
    // NEW WITHDRAWAL SETTING
    withdraw_amount_placeholder: 'Enter Amount', 
    
    // TOURNAMENT SETTINGS
    topref_section_title: 'Global Elite',
    is_tournament_active: false,
    tournament_duration_days: 7,
    tournament_start_time: 0, 
    tournament_end_time: 0, 
    tournament_title: 'CHALLENGE MODE',
    tournament_desc: 'Compete for the ultimate prize pool.',
    tournament_btn_text: 'EVENT',
    tournament_rules: 'Top agents will share the bounty pool...',
    tournament_prizes: {
        '1': 1000, '2': 750, '3': 500, '4-10': 400, '11-20': 300, '21-50': 200, '51-100': 100,
        '101-500': 50, '501-1000': 25, '1000+': 10
    },
    prize_popup_title: 'VICTORY', 
    prize_popup_desc: 'Rank {{rank_range}} achieved. Bounty: {{prize_amount}}', 
    prize_popup_btn_text: 'CLAIM BOUNTY',

    // NEW SETTING
    hide_rank_section: false, // <-- ADDED RANK VISIBILITY SETTING
}; 
let adFunctionName = null, lastDailyClaimDate = null; 

const userRef = db.collection('users').doc(uid);

// =========================================
// 5. NETWORK-BASED LOADING SYSTEM (UPDATED)
// =========================================

document.addEventListener("DOMContentLoaded", () => {
    startNetworkBasedLoading();
    
    // Init Tab
    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
    document.getElementById('home-section').classList.add('active-section');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const homeNavItem = document.querySelector(`.cyber-nav .nav-item[onclick*="'home'"]`);
    if (homeNavItem) homeNavItem.classList.add('active');
});

function startNetworkBasedLoading() {
    const loaderScreen = document.getElementById('loader-screen');
    const progressText = document.getElementById('progressText');
    
    // Detect Network Speed (Estimate)
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    // downlink (Mbps) ব্যবহার করা হচ্ছে। যদি না পাওয়া যায়, তবে ডিফল্ট 1.5 Mbps ধরা হচ্ছে।
    const speedMbps = connection ? (connection.downlink || 1.5) : 1.5; 
    
    let currentProgress = 0;
    
    // --- UPDATED LOGIC START: Minimum 2 seconds, longer for slow network ---
    const MIN_DURATION = 2000; // 2.0 সেকেন্ড ন্যূনতম সময় (Fast Network)
    const MAX_DURATION = 5000; // 5.0 সেকেন্ড সর্বোচ্চ সময় (Very Slow Network)
    const GOOD_SPEED = 5.0;    // 5.0 Mbps স্পিডকে স্ট্যান্ডার্ড (Fast) ধরা হচ্ছে
    const INTERVAL = 30;       // প্রতি 30ms পর পর প্রোগ্রেস আপডেট হবে

    let targetDuration = MIN_DURATION; 

    // Calculate dynamic duration based on speed
    if (speedMbps < GOOD_SPEED) {
        // Slowdown factor হিসেব করা, 2.5x (5000/2000) এর বেশি যেন না হয়
        const slowdownFactor = Math.min(MAX_DURATION / MIN_DURATION, (GOOD_SPEED / speedMbps)); 
        targetDuration = MIN_DURATION * slowdownFactor;
    }
    
    // Ensure minimum 2 seconds
    targetDuration = Math.max(MIN_DURATION, targetDuration); 
    
    // Calculate required increment per 30ms step: (100 / total_steps)
    const totalSteps = targetDuration / INTERVAL;
    let increment = 100 / totalSteps;
    // Add small random factor for organic feel
    increment = increment + (Math.random() * 0.1); 
    // --- UPDATED LOGIC END ---

    const loadingInterval = setInterval(() => {
        let randomFactor = Math.random() * 0.1; // Reduced random factor for stability
        currentProgress += increment + randomFactor;

        if (currentProgress >= 100) {
            currentProgress = 100;
            clearInterval(loadingInterval);
            finishLoadingSequence();
        }

        if(progressText) {
            progressText.innerText = Math.floor(currentProgress) + '%';
        }

    }, INTERVAL); // Use the constant INTERVAL
    
    function finishLoadingSequence() {
        setTimeout(() => {
            const flash = document.createElement('div');
            flash.className = 'flash-burst flash-active';
            document.body.appendChild(flash);
            
            if(loaderScreen) loaderScreen.classList.add('loaded');
            
            setTimeout(() => {
                if(loaderScreen) loaderScreen.style.display = 'none';
                flash.remove();
            }, 800);
        }, 500); 
    }
}

// 6. APP LOGIC & FIREBASE LISTENERS

function updateUserActivity() {
    if (uid) { userRef.update({ last_activity: Date.now() }).catch(err => {}); }
}
updateUserActivity();

// Monetag SDK Loader
function loadMonetagSdk(adCode) {
    const head = document.getElementsByTagName('head')[0];
    let script = document.createElement('script');
    script.src = '//libtl.com/sdk.js'; script.setAttribute('data-zone', adCode.replace('show_', '')); script.setAttribute('data-sdk', adCode);
    head.appendChild(script);
}

// Onclicka SDK Loader - FIXED: Added updateUI() on failure to allow RETRY INIT button
function loadOnclickaSdk(spotId) {
    if (showOnclicka) return; 
    if(window.initCdTma) {
        window.initCdTma({ id: spotId }).then(show => {
            showOnclicka = show;
            console.log("Onclicka SDK loaded successfully.");
            updateUI();
        }).catch(e => {
            console.error("Onclicka SDK load failed:", e);
            // NEW: If loading fails, update UI to allow retry
            updateUI(); 
        });
    } else {
        console.log("Onclicka SDK not initialized on window.initCdTma.");
        // If initCdTma is not even available, update UI to allow retry
        updateUI();
    }
}

// --- UPDATED: populateWithdrawMethods ফাংশন (Custom Modal) ---
function populateWithdrawMethods(methodsArray) {
    const containerEl = document.getElementById('networkOptionsContainer');
    const selectedTextEl = document.getElementById('selectedNetworkText');
    
    containerEl.innerHTML = ''; 
    
    if (!Array.isArray(methodsArray) || methodsArray.length === 0) {
        containerEl.innerHTML = `<p style="color:var(--text-muted); text-align:center;">No withdrawal nodes available.</p>`;
        return;
    }

    methodsArray.forEach((method, index) => {
        const optionValue = method.name.replace(/\s/g, ''); 
        
        const capsule = document.createElement('div');
        capsule.className = 'network-option-capsule';
        capsule.setAttribute('data-value', optionValue);
        capsule.setAttribute('data-placeholder', method.placeholder || 'Wallet Address / Number');
        // Ensure name and placeholder are properly escaped for string arguments
        const name = method.name.replace(/'/g, "\\'");
        const placeholder = (method.placeholder || 'Wallet Address / Number').replace(/'/g, "\\'");
        capsule.setAttribute('onclick', `selectNetwork(this, '${name}', '${optionValue}', '${placeholder}')`);

        capsule.innerHTML = `
            <div class="capsule-content">
                <i class="fas fa-satellite-dish capsule-icon-holo"></i>
                <span>${method.name}</span>
            </div>
        `;
        
        // Staggered animation on load/re-render
        capsule.style.animation = `capsuleIn 0.3s ease-out ${index * 0.12}s forwards`;
        
        containerEl.appendChild(capsule);
    });
    
    // Check if a method was already selected and re-select it
    if (selectedMethodValue) {
        const preSelected = containerEl.querySelector(`[data-value="${selectedMethodValue}"]`);
        if(preSelected) {
            preSelected.classList.add('selected');
            // Update the trigger text if the modal is being rendered but no selection made yet for this session
            selectedTextEl.innerText = selectedWithdrawalMethod.name;
        }
    } else {
        selectedTextEl.innerText = 'Select Withdraw Method';
    }

    // Set visibility for the initial load of the Wallet tab
    if (selectedMethodValue && selectedWithdrawalMethod) {
        toggleAccountInput(selectedWithdrawalMethod.placeholder);
    } else {
         toggleAccountInput('');
    }
}

function initApp() {
    // document.getElementById('initialVerificationModal').style.display = 'none'; // REMOVED
    updateUI(); updateDailyRewardUI(); renderTasks(); 
    
    // NEW: Check visibility on initial load as well <-- ADDED
    checkRankSectionVisibility(); 
    
    if(document.getElementById('invite-section').classList.contains('active-section')) renderReferrals();
    if(document.getElementById('topref-section').classList.contains('active-section')) renderLeaderboard(); 
}

function switchAdTab(tab) {
    document.querySelectorAll('.cyber-tab').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.ad-card-container').forEach(el => el.classList.remove('active'));
    
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('card-' + tab).classList.add('active');
    
    // Call updateUI here to refresh button state in case SDK load was pending
    updateUI(); 
    if (tab === 'onclicka' && settings.onclicka_spot_id && !showOnclicka) {
        loadOnclickaSdk(settings.onclicka_spot_id);
    }
}

// --- SETTINGS LISTENER ---
const setRef = db.collection('settings').doc('global');
setRef.onSnapshot(doc => {
    if (doc.exists) {
        const d = doc.data();
        
        // NEW: Fetch Cooldowns (in milliseconds)
        settings.monetag_cooldown_duration = d.monetag_cooldown_duration || 60000;
        settings.adsgram_cooldown_duration = d.adsgram_cooldown_duration || 60000;
        settings.onclicka_cooldown_duration = d.onclicka_cooldown_duration || 60000;
        
        // NEW: Fetch Rank Section Hide Setting <-- ADDED
        settings.hide_rank_section = d.hide_rank_section || false; 
        
        Object.assign(settings, d); 
        
        isTournamentActive = d.is_tournament_active || false;
        tournamentEndTime = d.tournament_end_time || 0;
        
        document.getElementById('toprefSectionTitle').innerHTML = settings.topref_section_title + ' <div class="line"></div>';

        // Monetag Settings Update
        document.getElementById('limitDisplay').innerText = settings.daily_limit;
        document.getElementById('adCardTitle').innerText = settings.ad_card_title;
        let adDescText = settings.ad_card_desc.replace('{{reward_per_ad}}', settings.reward_per_ad).replace('Credits', 'Coins'); 
        document.getElementById('adCardDesc').innerHTML = adDescText.replace(`${settings.reward_per_ad}`, `<span class="neon-text" id="rewardAmountDisplay">${settings.reward_per_ad}</span>`);
        document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <span class="flare"></span>`;

        // Adsgram Settings Update
        document.getElementById('adsgramLimitDisplay').innerText = settings.adsgram_daily_limit;
        let adsgramDescText = settings.adsgram_card_desc.replace('{{adsgram_reward}}', settings.adsgram_reward).replace('Credits', 'Coins'); 
        document.getElementById('adsgramCardDesc').innerHTML = adsgramDescText.replace(`${settings.adsgram_reward}`, `<span class="neon-text" id="adsgramRewardDisplay">${settings.adsgram_reward}</span>`);
        document.getElementById('adsgramCardTitle').innerText = settings.adsgram_card_title;
        document.getElementById('watchAdsgramBtn').innerHTML = `${settings.adsgram_btn_text} <span class="flare"></span>`;
        
        // Onclicka Settings Update
        document.getElementById('onclickaLimitDisplay').innerText = settings.onclicka_daily_limit;
        let onclickaDescText = settings.onclicka_card_desc.replace('{{onclicka_reward}}', settings.onclicka_reward).replace('Credits', 'Coins'); 
        document.getElementById('onclickaCardDesc').innerHTML = onclickaDescText.replace(`${settings.onclicka_reward}`, `<span class="neon-text" id="onclickaRewardDisplay">${settings.onclicka_reward}</span>`);
        document.getElementById('onclickaCardTitle').innerText = settings.onclicka_card_title;
        document.getElementById('watchOnclickaBtn').innerHTML = `${settings.onclicka_btn_text} <span class="flare"></span>`;

        // General
        document.getElementById('dailyRewardAmountDisplay').innerText = `+${settings.daily_reward_amount} Coins`; 
        document.getElementById('missionsSectionTitle').innerHTML = settings.missions_section_title + ' <div class="line"></div>';
        document.getElementById('inviteSectionTitle').innerHTML = settings.invite_section_title + ' <div class="line"></div>';
        document.getElementById('walletSectionTitle').innerHTML = settings.wallet_section_title + ' <div class="line"></div>';

        // ** ADDED: Invite Section Texts **
        document.querySelector('#invite-section .glass-panel h3').innerText = settings.ref_title || 'Recruit Agents';
        document.querySelector('#invite-section .glass-panel p').innerText = settings.ref_desc || 'Share encrypted link!';

        document.getElementById('withdrawTitle').innerText = settings.withdraw_title;
        document.getElementById('withdrawDesc').innerHTML = settings.withdraw_desc.replace('{{min_withdraw}}', settings.min_withdraw);
        document.getElementById('requestWithdrawBtn').innerText = settings.request_withdraw_btn_text; 
        
        // --- UPDATED WITHDRAWAL PLACEHOLDER LOGIC ---
        document.getElementById('withdrawAmount').placeholder = settings.withdraw_amount_placeholder || 'Enter Amount'; 
        populateWithdrawMethods(settings.pay_methods); // Uses new custom dropdown logic
        // -------------------------------------------

        if (settings.monetag_ad_code && !adFunctionName) {
            adFunctionName = settings.monetag_ad_code;
            setTimeout(() => loadMonetagSdk(adFunctionName), 500); 
        }
        if (settings.onclicka_spot_id) {
            loadOnclickaSdk(settings.onclicka_spot_id);
        }
        // Verification modal UI update removed

        updateUI(); 
        
        // NEW: Call the function to check visibility here <-- ADDED
        checkRankSectionVisibility(); 
        
        if(document.getElementById('topref-section').classList.contains('active-section')) renderLeaderboard();
    }
});

// --- USER LISTENER (MODIFIED) ---
userRef.onSnapshot(doc => {
    if (doc.exists) {
        const d = doc.data();
        currentBalance = d.balance || 0;
        completedTasks = d.completed_tasks || [];
        lastDailyClaimDate = d.last_daily_claim_date || null; 
        totalAdsWatched = d.total_ads_watched || 0; 
        referralCount = d.referral_count || 0; 
        isBotVerified = d.is_verified_bot_joined || true; // Preserve true if not set
        
        hasJoinedTournament = d.has_joined_tournament || false;
        window.tournamentReferees = d.tournament_referral_count || 0;
        const tournamentData = d.tournament_data || {};
        window.userTournamentRank = tournamentData.rank || null;
        window.hasClaimedPrize = tournamentData.claimed_prize || false;

        adCooldownEndTime = d.ad_cooldown_end_time || 0; 
        adsgramCooldownEndTime = d.adsgram_cooldown_end_time || 0;
        onclickaCooldownEndTime = d.onclicka_cooldown_end_time || 0; 

        const balEl = document.getElementById('balance');
        balEl.innerText = currentBalance;
        
        // UPDATE USD
        updateUsdDisplay(currentBalance);
        
        // --- পরিবর্তন শুরু ---
        document.getElementById('ref-count').innerText = d.referral_count || 0;
        document.getElementById('ref-earned').innerText = d.referral_earnings || 0;

        // নতুন ফাংশন কল করা হচ্ছে যা সাইজ ঠিক করবে
        adjustRefStatSize('ref-count');
        adjustRefStatSize('ref-earned');
        // --- পরিবর্তন শেষ ---

        const today = new Date().toDateString();
        if (d.last_ad_date !== today) {
            adsWatchedToday = 0; adsgramWatchedToday = 0; onclickaWatchedToday = 0;
            userRef.update({ ads_watched: 0, adsgram_ads_watched: 0, onclicka_ads_watched: 0, last_ad_date: today }); 
        } else {
            adsWatchedToday = d.ads_watched || 0;
            adsgramWatchedToday = d.adsgram_ads_watched || 0;
            onclickaWatchedToday = d.onclicka_ads_watched || 0; 
        }
        
        if (d.is_banned === true) showBanPopup();
        else if (d.is_banned === false && d.seen_unban_popup === false) showUnbanPopup();
        else {
            if(document.getElementById('statusModal').style.display !== 'none') {
                document.getElementById('statusModal').style.display = 'none';
            }
            
            const now = Date.now();
            if (!isTournamentActive && tournamentEndTime && now > tournamentEndTime && window.userTournamentRank !== null && !window.hasClaimedPrize) {
                checkAndShowPrizeModal();
            }
            // MODIFIED: Always call initApp now
            initApp(); 
        }
    } else {
        // Create New User (MODIFIED)
        let newUser = {
            balance: 0, ads_watched: 0, adsgram_ads_watched: 0, onclicka_ads_watched: 0, total_ads_watched: 0, referral_count: 0, referral_earnings: 0, 
            completed_tasks: [], last_ad_date: new Date().toDateString(), 
            username: username, full_name: userFullName, 
            is_verified_bot_joined: true, // *** MODIFIED: Set to true always ***
            last_daily_claim_date: null, 
            is_banned: false, seen_unban_popup: true, 
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            last_activity: Date.now(), 
            ad_cooldown_end_time: 0, 
            adsgram_cooldown_end_time: 0,
            onclicka_cooldown_end_time: 0, 
            tournament_referral_count: 0, 
            has_joined_tournament: false, 
            tournament_data: { rank: null, claimed_prize: false }, 
        };
        if (referrerId && referrerId !== uid) {
            newUser.referred_by = referrerId;
            db.collection('users').doc(referrerId).update({ referral_count: firebase.firestore.FieldValue.increment(1) });
            
            db.collection('settings').doc('global').get().then(settingsDoc => {
                const s = settingsDoc.data();
                if (s.is_tournament_active) {
                    db.collection('users').doc(referrerId).get().then(referrerDoc => {
                        const r = referrerDoc.data();
                        if (r && r.has_joined_tournament) {
                             db.collection('users').doc(referrerId).update({ 
                                tournament_referral_count: firebase.firestore.FieldValue.increment(1)
                            });
                        }
                    });
                }
            }).catch(e => console.error("Tournament ref check error: ", e));

            db.collection('users').doc(referrerId).collection('referred_users').doc(uid).set({
                referred_uid: uid, referred_username: userFullName, referred_total_ads_watched: 0, 
                is_claimed: false, claimed_at: null, created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        // MODIFIED: Always call initApp directly
        userRef.set(newUser).then(() => { initApp(); }); 
        document.getElementById('balance').innerText = 0;
    }
});


// --- POPUPS & VERIFICATION ---
function showBanPopup() {
    const modal = document.getElementById('statusModal'); 
    document.getElementById('statusIconContainer').innerHTML = `<div class="holo-icon" style="color:red"><i class="fas fa-ban"></i></div>`;
    document.getElementById('statusTitle').innerText = settings.ban_popup_title; document.getElementById('statusTitle').style.color = 'red';
    document.getElementById('statusDesc').innerText = settings.ban_popup_desc;
    const btn = document.getElementById('statusBtn'); btn.innerText = settings.ban_btn_text; btn.className = 'cyber-btn-small'; btn.style.background = '#e74c3c';
    btn.onclick = function() { tg.openTelegramLink(settings.support_url); }; modal.style.display = 'flex';
}
function showUnbanPopup() {
    const modal = document.getElementById('statusModal'); 
    document.getElementById('statusIconContainer').innerHTML = `<div class="holo-icon" style="color:green"><i class="fas fa-check-circle"></i></div>`;
    document.getElementById('statusTitle').innerText = settings.unban_popup_title; document.getElementById('statusTitle').style.color = '#00ffaa';
    document.getElementById('statusDesc').innerText = settings.unban_popup_desc;
    const btn = document.getElementById('statusBtn'); btn.innerText = settings.unban_btn_text; btn.className = 'cyber-btn-small'; btn.style.background = '#2ecc71';
    btn.onclick = function() { userRef.update({ seen_unban_popup: true, last_activity: Date.now() }).then(() => { modal.style.display = 'none'; }); };
    modal.style.display = 'flex';
}

// REMOVED: updateVerificationModalUI
// REMOVED: showInitialVerificationModal
// REMOVED: handleVerificationButtonClick

// --- COOLDOWN TIMERS ---
function startAdCooldownTimer(endTime) {
    if (monetagCooldownInterval) clearInterval(monetagCooldownInterval); 
    const btn = document.getElementById('watchAdBtn');
    btn.classList.add('disabled'); btn.onclick = 'void(0)';

    monetagCooldownInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(monetagCooldownInterval); monetagCooldownInterval = null;
            btn.classList.remove('disabled'); btn.onclick = startAdFlow; btn.innerHTML = `${settings.ad_btn_text} <span class="flare"></span>`; 
            userRef.update({ ad_cooldown_end_time: 0 }); updateUI(); return;
        }
        const seconds = Math.floor(remaining / 1000); 
        btn.innerHTML = `COOLDOWN: ${seconds}s`;
    }, 1000);
}

function startAdsgramCooldownTimer(endTime) {
    if (adsgramCooldownInterval) clearInterval(adsgramCooldownInterval); 
    const btn = document.getElementById('watchAdsgramBtn');
    btn.classList.add('disabled'); btn.onclick = 'void(0)';

    adsgramCooldownInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(adsgramCooldownInterval); adsgramCooldownInterval = null;
            btn.classList.remove('disabled'); btn.onclick = startAdsgramFlow; btn.innerHTML = `${settings.adsgram_btn_text} <span class="flare"></span>`; 
            userRef.update({ adsgram_cooldown_end_time: 0 }); updateUI(); return;
        }
        const seconds = Math.floor(remaining / 1000); 
        btn.innerHTML = `COOLDOWN: ${seconds}s`;
    }, 1000);
}

function startOnclickaCooldownTimer(endTime) {
    if (onclickaCooldownInterval) clearInterval(onclickaCooldownInterval); 
    const btn = document.getElementById('watchOnclickaBtn');
    btn.classList.add('disabled'); btn.onclick = 'void(0)';

    onclickaCooldownInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now; 
        if (remaining <= 0) {
            clearInterval(onclickaCooldownInterval); onclickaCooldownInterval = null;
            btn.classList.remove('disabled'); btn.onclick = startOnclickaFlow; btn.innerHTML = `${settings.onclicka_btn_text} <span class="flare"></span>`; 
            userRef.update({ onclicka_cooldown_end_time: 0 }); updateUI(); return;
        }
        const seconds = Math.floor(remaining / 1000); 
        btn.innerHTML = `COOLDOWN: ${seconds}s`;
    }, 1000);
}

function updateUI() {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED

    const now = Date.now();

    // Monetag
    const mBtn = document.getElementById('watchAdBtn');
    const isOnCooldown = now < adCooldownEndTime;
    document.getElementById('adCount').innerText = adsWatchedToday;
    document.getElementById('dailyProgressBar').style.width = ((adsWatchedToday / settings.daily_limit) * 100) + '%';
    if (isOnCooldown) {
        startAdCooldownTimer(adCooldownEndTime);
    } else if (adsWatchedToday >= settings.daily_limit) {
        mBtn.classList.add('disabled'); mBtn.innerText = 'LIMIT REACHED'; document.getElementById('completedMsg').style.display = 'block';
    } else {
        mBtn.classList.remove('disabled'); document.getElementById('completedMsg').style.display = 'none';
        mBtn.onclick = startAdFlow; mBtn.innerHTML = `${settings.ad_btn_text} <span class="flare"></span>`;
    }

    // Adsgram
    const aBtn = document.getElementById('watchAdsgramBtn');
    const isAdsgramOnCooldown = now < adsgramCooldownEndTime;
    document.getElementById('adsgramCount').innerText = adsgramWatchedToday;
    document.getElementById('adsgramProgressBar').style.width = ((adsgramWatchedToday / settings.adsgram_daily_limit) * 100) + '%';
    if (isAdsgramOnCooldown) {
        startAdsgramCooldownTimer(adsgramCooldownEndTime);
    } else if (adsgramWatchedToday >= settings.adsgram_daily_limit) {
        aBtn.classList.add('disabled'); aBtn.innerText = 'LIMIT REACHED'; document.getElementById('adsgramCompletedMsg').style.display = 'block';
    } else {
        aBtn.classList.remove('disabled'); document.getElementById('adsgramCompletedMsg').style.display = 'none';
        aBtn.onclick = startAdsgramFlow; aBtn.innerHTML = `${settings.adsgram_btn_text} <span class="flare"></span>`;
    }

    // Onclicka - FIXED: Allow RETRY INIT if SDK load fails or is pending
    const oBtn = document.getElementById('watchOnclickaBtn');
    const isOnClickaOnCooldown = now < onclickaCooldownEndTime;
    const isLimitReached = onclickaWatchedToday >= settings.onclicka_daily_limit;
    const isActiveTab = document.getElementById('card-onclicka').classList.contains('active');

    document.getElementById('onclickaCount').innerText = onclickaWatchedToday;
    document.getElementById('onclickaProgressBar').style.width = ((onclickaWatchedToday / settings.onclicka_daily_limit) * 100) + '%';
    document.getElementById('onclickaCompletedMsg').style.display = 'none';

    if (isOnClickaOnCooldown) {
        startOnclickaCooldownTimer(onclickaCooldownEndTime);
    } else if (isLimitReached) {
        oBtn.classList.add('disabled'); 
        oBtn.innerText = 'LIMIT REACHED'; 
        document.getElementById('onclickaCompletedMsg').style.display = 'block';
        oBtn.onclick = 'void(0)';
    } else if (!showOnclicka) { 
        // If SDK hasn't loaded and not on cooldown/limit
        oBtn.classList.remove('disabled'); 
        oBtn.innerText = isActiveTab ? 'RETRY INIT' : 'INITIALIZING...'; // Only show retry if tab is active
        
        oBtn.onclick = function() {
            oBtn.classList.add('disabled');
            oBtn.innerText = 'CONNECTING...';
            loadOnclickaSdk(settings.onclicka_spot_id); // Force re-run SDK loading
        };
        // Keep disabled if not active tab (to prevent hidden attempts)
        if (!isActiveTab) { oBtn.classList.add('disabled'); }

    } else {
        // Ready to watch
        oBtn.classList.remove('disabled'); 
        oBtn.innerHTML = `${settings.onclicka_btn_text} <span class="flare"></span>`;
        oBtn.onclick = startOnclickaFlow;
    }
}

function updateDailyRewardUI() {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    const btn = document.getElementById('dailyClaimBtn'); const today = new Date().toDateString(); if (!btn) return; 
    if (lastDailyClaimDate === today) { btn.classList.add('disabled'); btn.innerText = 'LOGGED'; btn.onclick = 'void(0)'; } 
    else { btn.classList.remove('disabled'); btn.innerText = 'CHECK-IN'; btn.onclick = claimDailyReward; btn.disabled = false; }
}
function claimDailyReward() {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    const today = new Date().toDateString();
    if (lastDailyClaimDate === today) { showErrorModal('ALREADY LOGGED', 'Daily protocol completed.', 'exclamation-triangle'); updateDailyRewardUI(); return; }
    document.getElementById('dailyClaimBtn').disabled = true; window.dailyClaimButtonRef = document.getElementById('dailyClaimBtn'); 
    showRewardModal('daily', settings.daily_reward_amount, null); 
}

// --- TASKS RENDER ---
function renderTasks() {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    const activeContainer = document.getElementById('taskListContainer'); 
    const missionsTitle = document.getElementById('missionsSectionTitle'); 
    const completedContainer = document.getElementById('completedListContainer'); 
    const completedTitle = document.getElementById('completedMissionsTitle');
    
    db.collection('tasks').where('active', '==', true).onSnapshot(snapshot => {
        let tasks = []; snapshot.forEach(doc => tasks.push({id: doc.id, ...doc.data()})); tasks.sort((a,b) => b.created_at - a.created_at);
        let activeHtml = '', completedHtml = '';
        tasks.forEach(task => {
            const isCompleted = completedTasks.includes(task.id);
            let iconClass = task.type === 'telegram' ? 'fab fa-telegram-plane' : (task.type === 'youtube' ? 'fab fa-youtube' : 'fas fa-globe');
            
            // NEW: waitTime
            const taskWaitTime = task.waitTime || 5; 
            
            let btnClass = isCompleted ? 'cyber-btn-small disabled' : 'cyber-btn-small', 
                btnText = isCompleted ? 'LOGGED' : 'START', 
                // UPDATED: startTask এর নতুন প্যারামিটার (showTimer) সরানো হয়েছে
                btnAction = isCompleted ? 'void(0)' : `startTask('${task.id}', '${task.link}', ${task.reward}, ${taskWaitTime})`;
            
            const cardHtml = `
            <div class="mission-capsule">
                <div class="capsule-left">
                    <div class="capsule-icon"><i class="${iconClass}"></i></div>
                    <div class="capsule-info">
                        <h4>${task.title}</h4>
                        <p>Bounty: ${task.reward} Coins</p>
                    </div>
                </div>
                <button id="btn-${task.id}" class="${btnClass}" onclick="${btnAction}">${btnText}</button>
            </div>`;
            if (isCompleted) completedHtml += cardHtml; else activeHtml += cardHtml;
        });

        if (activeHtml === '') {
            activeContainer.innerHTML = ''; 
            missionsTitle.style.display = 'none';
        } else {
            activeContainer.innerHTML = activeHtml;
            missionsTitle.style.display = 'flex';
        }
        completedContainer.innerHTML = completedHtml; 
        completedTitle.style.display = completedHtml ? 'flex' : 'none';
    });
}

// --- script.js এর startTask ফাংশন আপডেট করুন ---
// UPDATED: Removed showTimer parameter, simplified/fixed logic
function startTask(id, link, reward, waitTime = 5) {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    
    // NEW: অন্য কোনো মিশন চলছে কিনা তা পরীক্ষা করা - এখন activeTaskTimeout চেক করবে
    if (activeTaskTimeout) {
        return showErrorModal('FIELD MISSION', 'অন্য একটি মিশন প্রক্রিয়াকরণের মধ্যে রয়েছে। সেটি আগে সম্পূর্ণ করুন।', 'clock');
    }
    
    // টাস্ক লিংক ওপেন করা
    window.open(link, '_blank'); 
    
    const btn = document.getElementById(`btn-${id}`);
    
    // স্পিনার দেখানো
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
    btn.disabled = true; 

    // ওয়েটিং টাইমের পর CLAIM বাটন দেখানোর জন্য Timeout সেট করা
    // waitTime = 0 হলে, কমপক্ষে 5 সেকেন্ড অপেক্ষা করবে
    const actualWaitTime = waitTime > 0 ? waitTime : 5; 
    const totalWaitTimeMs = actualWaitTime * 1000 + 1500; // 1.5s delay + actualWaitTime

    // Mission ID সেট করা, যাতে tab switch করলে stopMissionTimer এটি ব্যবহার করতে পারে
    activeMissionId = id; 
    
    // NEW SIMPLIFIED LOGIC: Single timeout for the full duration
    activeTaskTimeout = setTimeout(() => { 
        
        // Final cleanup for successful wait (before showing CLAIM)
        activeTaskTimeout = null; 
        activeMissionId = null; 
        
        // যদি ইতিমধ্যে টাস্ক কমপ্লিট হয়ে থাকে
        if (completedTasks.includes(id)) { 
            btn.innerHTML = 'LOGGED'; 
            btn.className = 'cyber-btn-small disabled'; 
            return; 
        } 
        
        // CLAIM বাটন দেখানো
        btn.innerHTML = 'CLAIM'; 
        btn.disabled = false; 
        
        btn.classList.add('btn-claim');
        
        // FIX 1: Only call the modal, pass the button element (btn)
        btn.onclick = function() { 
            showRewardModal('mission', reward, id, null, btn); // Pass the button element
        }; 
        
    }, totalWaitTimeMs); // Total wait time
}

// টাইমার বন্ধ করার ফাংশন (মাঝপথে বেরিয়ে এলে এরর দেখানো সহ)
// UPDATED: Now clears only activeTaskTimeout and shows generic error
function stopMissionTimer(showError = false) {
     if (activeTaskTimeout) { // Check activeTaskTimeout
        
        // CLAIM বাটন পরিবর্তনের জন্য সেট করা Timeout বন্ধ করা
        clearTimeout(activeTaskTimeout);
        activeTaskTimeout = null;
        
        // যদি এরর দেখাতে হয়
        if (showError) { 
            const errorDesc = `আপনি টাইমার শেষ হওয়ার আগেই বেরিয়ে এসেছেন। অনুগ্রহ করে আবার শুরু করুন।`;
            showErrorModal('FIELD MISSION', errorDesc, 'exclamation-triangle');
            
            // বাটনকে 'START' এ রিসেট করা
            const btn = document.getElementById(`btn-${activeMissionId}`);
            if(btn) {
                btn.innerHTML = 'START';
                btn.classList.remove('disabled', 'btn-claim');
                btn.disabled = false; 
                // The original onclick will be restored when `renderTasks` runs next
            }
        }
        
        // গ্লোবাল স্টেট রিসেট করা
        activeMissionId = null;
    }
}

// --- ADS LOGIC ---
function startAdFlow() { 
    const now = Date.now(); 
    // UPDATED: Use dynamic cooldown
    if (now < adCooldownEndTime) { updateUI(); showErrorModal('WAIT', `Cooling down. Try again in ${Math.ceil((adCooldownEndTime - now) / 1000)} seconds.`, 'clock'); return; }
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    if (adsWatchedToday >= settings.daily_limit) return;
    const adFunc = window[adFunctionName]; if (!adFunc || typeof adFunc !== 'function') { showErrorModal('ERROR', 'System not ready.', 'exclamation-circle'); return; }
    document.getElementById('adOverlay').style.display = 'flex'; 
    document.getElementById('watchAdBtn').classList.add('disabled'); 
    document.getElementById('watchAdBtn').innerHTML = 'CONNECTING...'; 

    adFunc().then(() => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        openAdModal('monetag'); 
    }).catch((e) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        document.getElementById('watchAdBtn').classList.remove('disabled'); 
        document.getElementById('watchAdBtn').innerHTML = `${settings.ad_btn_text} <span class="flare"></span>`; 
        showErrorModal('FAILED', 'Connection lost.', 'times-circle'); 
    });
}

function startAdsgramFlow() { 
    const now = Date.now(); 
    // UPDATED: Use dynamic cooldown
    if (now < adsgramCooldownEndTime) { updateUI(); showErrorModal('WAIT', `Cooling down. Try again in ${Math.ceil((adsgramCooldownEndTime - now) / 1000)} seconds.`, 'clock'); return; }
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    if (adsgramWatchedToday >= settings.adsgram_daily_limit) return;
    const blockId = settings.adsgram_block_id || "int-18699"; if (!window.Adsgram) { showErrorModal('ERROR', 'Module missing.', 'exclamation-circle'); return; }
    const AdController = window.Adsgram.init({ blockId: blockId });
    document.getElementById('adOverlay').style.display = 'flex'; 
    document.getElementById('watchAdsgramBtn').classList.add('disabled'); 
    document.getElementById('watchAdsgramBtn').innerHTML = 'CONNECTING...'; 

    AdController.show().then((result) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        openAdModal('adsgram'); 
    }).catch((result) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        document.getElementById('watchAdsgramBtn').classList.remove('disabled'); 
        document.getElementById('watchAdsgramBtn').innerHTML = `${settings.adsgram_btn_text} <span class="flare"></span>`; 
        showErrorModal('FAILED', 'Link terminated.', 'times-circle'); 
    });
}

function startOnclickaFlow() {
    const now = Date.now(); 
    // UPDATED: Use dynamic cooldown
    if (now < onclickaCooldownEndTime) { updateUI(); showErrorModal('WAIT', `Cooling down. Try again in ${Math.ceil((onclickaCooldownEndTime - now) / 1000)} seconds.`, 'clock'); return; }
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    if (onclickaWatchedToday >= settings.onclicka_daily_limit) return;
    
    if (!showOnclicka || typeof showOnclicka !== 'function') {
        showErrorModal('ERROR', 'Node not found. Retry.', 'exclamation-circle'); 
        loadOnclickaSdk(settings.onclicka_spot_id); 
        return;
    }

    document.getElementById('adOverlay').style.display = 'flex'; 
    document.getElementById('watchOnclickaBtn').classList.add('disabled'); 
    document.getElementById('watchOnclickaBtn').innerHTML = 'CONNECTING...'; 

    showOnclicka().then(() => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        openAdModal('onclicka'); 
    }).catch((e) => { 
        document.getElementById('adOverlay').style.display = 'none'; 
        document.getElementById('watchOnclickaBtn').classList.remove('disabled'); 
        document.getElementById('watchOnclickaBtn').innerHTML = `${settings.onclicka_btn_text} <span class="flare"></span>`; 
        showErrorModal('FAILED', 'Node rejected.', 'times-circle'); 
    });
}

function openAdModal(provider) {
    const btnId = (provider === 'adsgram') ? 'watchAdsgramBtn' : (provider === 'onclicka') ? 'watchOnclickaBtn' : 'watchAdBtn';
    const btn = document.getElementById(btnId);
    
    btn.classList.add('disabled'); 
    btn.innerHTML = 'WAITING...'; 

    const reward = (provider === 'adsgram') ? settings.adsgram_reward : (provider === 'onclicka') ? settings.onclicka_reward : settings.reward_per_ad;
    showRewardModal('ad', reward, null, provider); 
}

function executeAdRewardTransaction(amount, provider) {
    const now = new Date(); 
    const todayDateKey = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
    const ref = db.collection('users').doc(uid).collection('daily_ads_views').doc(todayDateKey);

    db.runTransaction(async t => { 
        const dailyDoc = await t.get(ref);
        const userDoc = await t.get(db.collection('users').doc(uid));
        if (!userDoc.exists) throw "User not found.";
        
        const newDailyCount = (dailyDoc.exists ? dailyDoc.data().count : 0) + 1;
        const dailyData = {
            count: newDailyCount, last_reward: amount, last_provider: provider, updated_at: Date.now(), 
            created_at: dailyDoc.exists ? dailyDoc.data().created_at : Date.now()
        };
        t.set(ref, dailyData, {merge: true}); 

        const currentTotalAds = (userDoc.data().total_ads_watched || 0) + 1;
        if (userDoc.data().referred_by) {
            const referrerUid = userDoc.data().referred_by;
            t.update(db.collection('users').doc(referrerUid).collection('referred_users').doc(uid), { referred_total_ads_watched: currentTotalAds });
        }
        
        let updateData = {
            balance: firebase.firestore.FieldValue.increment(amount), 
            total_ads_watched: firebase.firestore.FieldValue.increment(1), 
            last_activity: Date.now()
        };
        
        if (provider === 'adsgram') {
            updateData.adsgram_ads_watched = firebase.firestore.FieldValue.increment(1);
            // UPDATED: Use dynamic cooldown
            updateData.adsgram_cooldown_end_time = Date.now() + settings.adsgram_cooldown_duration;
        } else if (provider === 'onclicka') { 
            updateData.onclicka_ads_watched = firebase.firestore.FieldValue.increment(1);
            // UPDATED: Use dynamic cooldown
            updateData.onclicka_cooldown_end_time = Date.now() + settings.onclicka_cooldown_duration;
        } else { 
            updateData.ads_watched = firebase.firestore.FieldValue.increment(1);
            // UPDATED: Use dynamic cooldown
            updateData.ad_cooldown_end_time = Date.now() + settings.monetag_cooldown_duration;
        }

        t.update(db.collection('users').doc(uid), updateData);
    }).then(() => {
        // UPDATED: Use dynamic cooldown
        if (provider === 'adsgram') adsgramCooldownEndTime = Date.now() + settings.adsgram_cooldown_duration;
        // UPDATED: Use dynamic cooldown
        else if (provider === 'onclicka') onclickaCooldownEndTime = Date.now() + settings.onclicka_cooldown_duration; 
        // UPDATED: Use dynamic cooldown
        else adCooldownEndTime = Date.now() + settings.monetag_cooldown_duration;
        updateUI();
    }).catch(err => console.error("Ad log failed: ", err));
}



function showErrorModal(title, desc, iconName) {
    const modal = document.getElementById('rewardModal');
    
    // আইকন: লাল কালার + বাউন্স এনিমেশন
    document.getElementById('modalIconContainer').innerHTML = `<div class="modal-main-icon text-red"><i class="fas fa-${iconName}"></i></div>`;
    
    document.getElementById('popupAmount').style.display = 'none'; 
    
    // টাইটেল: লাল কালার
    const titleEl = modal.querySelector('.reward-title');
    titleEl.innerText = title;
    titleEl.className = 'reward-title text-red';

    modal.querySelector('.reward-desc').innerHTML = desc; 
    modal.style.display = 'flex';
    
    const btn = document.getElementById('modalClaimBtn');
    btn.innerText = settings.error_modal_btn_text; 
    btn.onclick = () => modal.style.display = 'none';
}

// --- নতুন সফলতার মডাল ফাংশন যোগ করা হয়েছে ---
function showCustomSuccessModal(title, desc, iconName) {
    const modal = document.getElementById('statusModal'); 
    
    // আইকন: সবুজ কালার + বাউন্স এনিমেশন
    document.getElementById('statusIconContainer').innerHTML = `<div class="modal-main-icon" style="color:#2ecc71; text-shadow: 0 0 15px rgba(46, 204, 113, 0.6);"><i class="fas fa-${iconName}"></i></div>`;
    
    // টাইটেল: সবুজ কালার
    const titleEl = document.getElementById('statusTitle');
    titleEl.innerText = title; 
    titleEl.style.color = '#2ecc71'; // সফলতার রং
    titleEl.className = 'reward-title text-cyan'; // CSS স্টাইল ব্যবহারের জন্য

    // ডেসক্রিপশন
    document.getElementById('statusDesc').innerText = desc;
    
    const btn = document.getElementById('statusBtn'); 
    btn.innerText = settings.withdraw_success_btn_text; // সেটিংসে সংজ্ঞায়িত "DONE" বাটন টেক্সট
    btn.className = 'cyber-btn-small btn-claim'; // সবুজ বাটন স্টাইল
    
    // বাটন ক্লিক করলে মডাল বন্ধ হবে
    btn.onclick = function() { 
        modal.style.display = 'none'; 
    }; 
    
    modal.style.display = 'flex';
}
// ----------------------------------------------------

// UPDATED: Added taskButtonEl parameter
function showRewardModal(type, amount, id, provider = null, taskButtonEl = null) {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED

    let title = 'SUCCESS';
    let desc = 'Transaction Verified.';
    
    // টাইপ অনুযায়ী টাইটেল সেট করা (কিন্তু আইকন সব সময় কয়েন থাকবে)
    if (type === 'ad') { 
        title = settings.ad_popup_title; 
        desc = settings.ad_popup_desc; 
    }
    else if (type === 'daily') { 
        title = settings.daily_popup_title; 
        desc = settings.daily_popup_desc; 
    }
    else if (type === 'mission') { 
        title = settings.mission_popup_title; 
        desc = settings.mission_popup_desc; 
    }
    else if (type === 'referral') { 
        title = 'BONUS CLAIMED'; 
        desc = 'Referral bounty processing.'; 
    } 

    const modal = document.getElementById('rewardModal');

    // 1. আইকন সেট করা (সর্বদা কয়েন আইকন + গোল্ড কালার + বাউন্স এনিমেশন)
    const iconContainer = document.getElementById('modalIconContainer');
    iconContainer.innerHTML = `<div class="modal-main-icon text-gold"><i class="fas fa-coins"></i></div>`;

    // 2. টাইটেল সেট করা (Cyan কালার)
    const titleEl = modal.querySelector('.reward-title');
    titleEl.innerText = title;
    titleEl.className = 'reward-title text-cyan'; // Cyan কালার

    // 3. ডেসক্রিপশন
    modal.querySelector('.reward-desc').innerText = desc; 

    // 4. অ্যামাউন্ট সেট করা (Gold কালার)
    const amountEl = document.getElementById('popupAmount');
    amountEl.innerText = '+' + amount;
    amountEl.style.display = 'block';
    amountEl.className = 'reward-amount-text text-gold'; // Gold কালার

    modal.style.display = 'flex';

    // বাটন লজিক
    const btn = document.getElementById('modalClaimBtn');
    btn.onclick = null; 
    btn.innerText = settings.modal_claim_btn_text; 
    
    // FIX 1: Coins are added, and button state is updated ONLY when this modal button is clicked.
    btn.onclick = function(e) {
        modal.style.display = 'none';
        
        // Calculate the new balance for the animation before the transaction
        const newBalanceVisual = currentBalance + amount; 

        spawnFlyingCoins(e, () => {
             // 1. Start the visual balance animation after coins land
             animateBalance(currentBalance, newBalanceVisual);
             
             // 2. Execute the database transaction ONLY when coins land
             if (type === 'ad') { executeAdRewardTransaction(amount, provider); }
             else if (type === 'mission') { 
                 // Coin/Data transaction (Mission)
                 userRef.update({ 
                     balance: firebase.firestore.FieldValue.increment(amount), 
                     completed_tasks: firebase.firestore.FieldValue.arrayUnion(id), 
                     last_activity: Date.now() 
                 }).then(() => {
                     // FIX 1: Update the task card button state here
                     if (taskButtonEl) {
                         taskButtonEl.innerHTML = 'LOGGED'; 
                         taskButtonEl.className = 'cyber-btn-small disabled';
                         taskButtonEl.disabled = true; 
                     }
                 }); 
             }
             else if (type === 'daily') {
                 const today = new Date().toDateString();
                 userRef.update({ balance: firebase.firestore.FieldValue.increment(amount), last_daily_claim_date: today, last_activity: Date.now() }).then(() => {
                     if(window.dailyClaimButtonRef) { 
                         window.dailyClaimButtonRef.innerText = 'LOGGED'; 
                         window.dailyClaimButtonRef.className = 'cyber-btn-small disabled'; 
                         window.dailyClaimButtonRef.disabled = true; 
                         lastDailyClaimDate = today; 
                         delete window.dailyClaimButtonRef; 
                     }
                 });
             } 
             else if (type === 'referral') { processReferralClaimTransaction(window.referredIdToClaim, window.rewardAmountToClaim); }
        });
    };
}

function formatDate(timestamp) {
    if (!timestamp) return 'N/A';
    const date = (typeof timestamp === 'number') ? new Date(timestamp) : timestamp.toDate();
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

async function processReferralClaimTransaction(referredUid, amount) {
     const btn = document.getElementById(`ref-btn-${referredUid}`);
    const refUserRef = db.collection('users').doc(uid).collection('referred_users').doc(referredUid);
    try {
        await db.runTransaction(async t => {
            const userDoc = await t.get(userRef); const refDoc = await t.get(refUserRef);
            if (!userDoc.exists || !refDoc.exists) throw "User or Referral record not found.";
            if (refDoc.data().is_claimed) throw "Bonus already claimed.";
            if ((refDoc.data().referred_total_ads_watched || 0) < settings.ref_ads_watch_requirement) throw "Req not met.";
            t.update(userRef, { balance: firebase.firestore.FieldValue.increment(amount), referral_earnings: firebase.firestore.FieldValue.increment(amount), last_activity: Date.now() });
            t.update(refUserRef, { is_claimed: true, claimed_at: Date.now() });
            return amount; 
        });
    } catch (error) {
        console.error("Referral Claim Failed: ", error);
        const errMsg = (typeof error === 'string') ? error : "System Error.";
        if (btn && errMsg !== "Bonus already claimed.") { btn.innerHTML = 'CLAIM'; btn.classList.remove('disabled'); btn.disabled = false; }
        showErrorModal('FAILED', errMsg, 'exclamation-triangle');
    }
    window.referredIdToClaim = null; window.rewardAmountToClaim = null; 
}

async function claimReferralBonus(referredUid, amount) {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    const btn = document.getElementById(`ref-btn-${referredUid}`); btn.innerHTML = '...'; btn.disabled = true;
    const refDoc = await db.collection('users').doc(uid).collection('referred_users').doc(referredUid).get();
    if (!refDoc.exists || refDoc.data().is_claimed || (refDoc.data().referred_total_ads_watched || 0) < settings.ref_ads_watch_requirement) {
         btn.innerHTML = 'PENDING'; btn.classList.add('disabled'); btn.disabled = true;
         showErrorModal('ACCESS DENIED', 'Referral must view more ads.', 'hand-point-up'); return; 
    }
    window.referredIdToClaim = referredUid; window.rewardAmountToClaim = amount; showRewardModal('referral', amount, referredUid); 
}

// --- REFERRALS RENDER ---
function renderReferrals(page = 1) {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    db.collection('users').doc(uid).collection('referred_users').onSnapshot(async snapshot => {
        const referrals = []; const reqs = [];
        snapshot.forEach(doc => {
            const d = doc.data();
            reqs.push(db.collection('users').doc(d.referred_uid).get().then(refUserDoc => {
                const userName = d.referred_username || (refUserDoc.exists ? (refUserDoc.data().full_name || 'Agent') : 'Agent'); 
                const totalAds = refUserDoc.exists ? (refUserDoc.data().total_ads_watched || 0) : (d.referred_total_ads_watched || 0);
                referrals.push({ ...d, id: doc.id, referred_username: userName, referred_total_ads_watched: totalAds });
            }).catch(() => { referrals.push({ ...d, id: doc.id, referred_total_ads_watched: d.referred_total_ads_watched || 0 }); }));
        });
        await Promise.all(reqs);
        activeReferralsData = referrals.filter(r => !r.is_claimed); completedReferralsData = referrals.filter(r => r.is_claimed);
        activeReferralsData.sort((a, b) => (b.referred_total_ads_watched || 0) - (a.referred_total_ads_watched || 0));
        completedReferralsData.sort((a, b) => (b.claimed_at || 0) - (a.claimed_at || 0));
        activeRefPage = page; completedRefPage = 1; 
        updateReferralList(activeReferralsData, activeRefPage, 'active'); updateReferralList(completedReferralsData, completedRefPage, 'completed');
    });
}

function updateReferralList(data, page, type) {
    const container = document.getElementById(`${type}ReferralListContainer`); const titleEl = document.getElementById(`${type}ReferralsTitle`); const paginationEl = document.getElementById(`${type}ReferralPagination`);
    const start = (page - 1) * pageSize; const end = start + pageSize; const paginatedData = data.slice(start, end); const totalPages = Math.ceil(data.length / pageSize); const refReq = settings.ref_ads_watch_requirement || 100;
    titleEl.style.display = data.length > 0 ? 'flex' : 'none';
    if (data.length === 0) { container.innerHTML = ''; paginationEl.style.display = 'none'; return; }
    
    let html = '';
    paginatedData.forEach(r => {
        const adsWatched = r.referred_total_ads_watched || 0; const cappedAdsWatched = Math.min(adsWatched, refReq); const isReadyToClaim = adsWatched >= refReq; const progressText = `${cappedAdsWatched}/${refReq}`; const progressColor = isReadyToClaim ? '#00f0ff' : '#bc13fe';
        let btnClass = 'cyber-btn-small disabled', btnText = 'PENDING', btnAction = 'void(0)', btnDisabled = true;
        
        if (r.is_claimed) { btnText = 'CLAIMED'; btnClass = 'cyber-btn-small disabled'; btnDisabled = true; } 
        else if (isReadyToClaim) { btnText = 'CLAIM'; btnClass = 'cyber-btn-small'; btnAction = `claimReferralBonus('${r.id}', ${settings.ref_bonus})`; btnDisabled = false; }
        
        html += `
        <div class="mission-capsule">
            <div class="capsule-left">
                <div class="capsule-icon"><i class="fas fa-user-secret"></i></div>
                <div class="capsule-info">
                    <h4>${r.referred_username}</h4>
                    <p style="color:${progressColor}">Progress: ${progressText} Ads</p>
                </div>
            </div>
            <button id="ref-btn-${r.id}" class="${btnClass}" onclick="${btnAction}" ${btnDisabled ? 'disabled' : ''}>${btnText}</button>
        </div>`;
    });
    container.innerHTML = html;
    paginationEl.innerHTML = '';
    if (totalPages > 1) {
        const prevBtn = `<button class="page-btn" onclick="changeRefPage('${type}', ${page - 1})" ${page === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
        const nextBtn = `<button class="page-btn" onclick="changeRefPage('${type}', ${page + 1})" ${page === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
        let pageNumbers = ''; for (let i = 1; i <= totalPages; i++) { pageNumbers += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="changeRefPage('${type}', ${i})">${i}</button>`; }
        paginationEl.innerHTML = prevBtn + pageNumbers + nextBtn; paginationEl.style.display = 'flex';
    } else { paginationEl.style.display = 'none'; }
}
function changeRefPage(type, newPage) { if (type === 'active') { activeRefPage = newPage; updateReferralList(activeReferralsData, activeRefPage, 'active'); } else if (type === 'completed') { completedRefPage = newPage; updateReferralList(completedReferralsData, completedRefPage, 'completed'); } }


// --- NEW: Custom Dropdown Modal Logic ---
function openNetworkSelectionModal() {
    const modal = document.getElementById('networkSelectionModal');
    // Render the options inside the modal container
    populateWithdrawMethods(settings.pay_methods);
    
    // Display the modal
    modal.style.display = 'flex';
    
    // Set icon rotation
    const triggerIcon = document.getElementById('triggerIcon');
    triggerIcon.classList.add('fa-rotate-180'); 
}

function closeNetworkSelectionModal() {
    const modal = document.getElementById('networkSelectionModal');
    modal.style.display = 'none';
    
    // Reset icon rotation
    const triggerIcon = document.getElementById('triggerIcon');
    triggerIcon.classList.remove('fa-rotate-180');
}

function selectNetwork(el, name, value, placeholder) {
    const container = document.getElementById('networkOptionsContainer');
    const selectedTextEl = document.getElementById('selectedNetworkText');
    const hiddenInput = document.getElementById('withdrawMethodValue');

    // Deselect all
    container.querySelectorAll('.network-option-capsule').forEach(capsule => {
        capsule.classList.remove('selected');
    });

    // Select new element
    el.classList.add('selected');
    
    // Update state
    selectedWithdrawalMethod = { name: name, placeholder: placeholder };
    selectedMethodValue = value;

    // Update UI elements
    selectedTextEl.innerText = name;
    hiddenInput.value = value;
    
    // Update account input placeholder and visibility
    toggleAccountInput(placeholder);

    // Close modal
    closeNetworkSelectionModal(); 
}

// --- UPDATED: toggleAccountInput ফাংশন (Custom Dropdown) ---
// এখন প্যারামিটার হিসেবে নির্বাচিত মেথডের প্লেসহোল্ডার নেবে
function toggleAccountInput(placeholderText) { 
    const accInputEl = document.getElementById('accountNumber');
    
    // যদি placeholderText ফাঁকা বা null হয়, তবে নেটওয়ার্ক নির্বাচন হয়নি
    if (placeholderText) {
        accInputEl.placeholder = placeholderText;
        accInputEl.style.display = 'block';
    } else {
        // Reset or hide if no valid method is selected
        accInputEl.style.display = 'none';
        accInputEl.placeholder = 'Wallet Address / Number'; 
    }
}

function requestWithdraw() {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    // UPDATED: Get value from the hidden input
    const method = document.getElementById('withdrawMethodValue').value; 
    const accNum = document.getElementById('accountNumber').value.trim();
    const amount = parseInt(document.getElementById('withdrawAmount').value), minWithdraw = settings.min_withdraw; 
    if (totalAdsWatched < settings.min_ads_view_for_withdraw) return showErrorModal(settings.min_ads_err_title, settings.min_ads_err_desc.replace('{{min_ads_view}}', settings.min_ads_view_for_withdraw), 'video');
    if (referralCount < settings.min_referrals_for_withdraw) return showErrorModal(settings.min_refs_err_title, settings.min_refs_err_desc.replace('{{min_referrals}}', settings.min_referrals_for_withdraw), 'user-plus');
    if (isNaN(amount) || amount <= 0) return showErrorModal(settings.min_amt_err_title, settings.min_amt_err_desc.replace('{{min_withdraw}}', minWithdraw), 'ban');
    if (amount < minWithdraw) return showErrorModal(settings.min_amt_err_title, settings.min_amt_err_desc.replace('{{min_withdraw}}', minWithdraw), 'hand-point-up');
    if (amount > currentBalance) return showErrorModal(settings.bal_err_title, settings.bal_err_desc, 'wallet');
    // Use the hidden input value
    if (!method) return showErrorModal(settings.method_err_title, settings.method_err_desc, 'credit-card');
    if (!accNum) return showErrorModal(settings.acc_num_err_title, settings.acc_num_err_desc, 'user-circle');
    
    // Manual balance update removed, rely on Firestore listener
    
    // ফায়ারবেস ট্রানজ্যাকশন শুরু
    userRef.update({ balance: firebase.firestore.FieldValue.increment(-amount), last_activity: Date.now() }).then(() => {
        
        // উইথড্রয়াল রেকর্ড তৈরি
        db.collection('withdrawals').add({ user_id: uid, username: username, method: method, account_number: accNum, amount: amount, status: 'pending', date: Date.now() })
        .then(() => { 
            // --- সফলতার পপআপ দেখানোর জন্য আপডেট করা হয়েছে ---
            showCustomSuccessModal(settings.withdraw_success_title, settings.withdraw_success_desc, 'check-circle'); 
            // ----------------------------------------------------
            
            document.getElementById('withdrawAmount').value = ''; 
            document.getElementById('accountNumber').value = ''; 
            
            // Clear custom selection state and UI
            document.getElementById('withdrawMethodValue').value = ''; 
            document.getElementById('selectedNetworkText').innerText = 'Select Withdraw Method'; 
            selectedMethodValue = '';
            selectedWithdrawalMethod = null;
            toggleAccountInput('');
        });
    }).catch(err => { 
        showErrorModal("ERROR", "Transaction failed.", 'exclamation-triangle'); 
        // Note: Balance is automatically corrected by Firestore listener, no manual update needed here.
    });
}

function hideHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }
function showHistoryModal(type) {
     if (!uid) return; const modal = document.getElementById('historyModal'); 
     document.getElementById('historyListContainer').innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Fetching Data...</p></div>`;
    if (type === 'withdrawal') { fetchWithdrawalHistory(); } 
    modal.style.display = 'flex'; updateUserActivity(); 
}
function showAdsHistoryModal() {
    if (!uid) return; const modal = document.getElementById('historyModal'); document.getElementById('historyListContainer').innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Fetching Logs...</p></div>`; 
    modal.style.display = 'flex'; fetchAdsHistory(); updateUserActivity(); 
}

function fetchWithdrawalHistory() {
    if (!uid) return; 
    
    db.collection('withdrawals').where('user_id', '==', uid).orderBy('date', 'desc').onSnapshot(snapshot => {
        let html = ''; 
        
        if (snapshot.empty) {
            html = `<div style="text-align:center; padding: 30px; color: #8b9bb4;">
                        <i class="fas fa-box-open fa-2x"></i>
                        <p>No records found.</p>
                    </div>`;
        } else {
            snapshot.forEach(doc => { 
                const item = doc.data(); 
                const date = item.date ? new Date(item.date).toLocaleDateString() : 'N/A'; 
                const accNum = item.account_number || '';

                // --- কালার লজিক ---
                let styleOverride = ''; 
                
                const statusText = item.status ? item.status.toLowerCase() : 'pending';

                if (statusText === 'rejected' || statusText === 'declined' || statusText === 'cancel') {
                    styleOverride = 'background: rgba(255, 77, 77, 0.15); color: #ff4d4d;';
                } else if (statusText === 'pending') {
                    styleOverride = 'background: rgba(255, 215, 0, 0.1); color: #ffd700;';
                }
                
                const displayStatus = item.status ? item.status.toUpperCase() : 'PENDING';

                html += `
                <div class="mission-capsule">
                    <div class="capsule-left" style="align-items:flex-start;">
                        <div class="capsule-info">
                            <h4 style="color:#00f0ff; margin-bottom: 3px;">${item.amount} Coins</h4>
                            <p style="margin: 0; color: #e0e0e0; font-size: 0.8rem;">
                                ${item.method} | <span style="color: #bc13fe;">${accNum}</span>
                            </p>
                            <p style="margin: 2px 0 0 0; font-size: 0.7rem; color: #6c7a89;">
                                ${date}
                            </p>
                        </div>
                    </div>
                    
                    <div class="ref-count-pill" style="align-self: center; min-width: 70px; ${styleOverride}">
                        ${displayStatus}
                    </div>
                </div>`; 
            });
        }
        document.getElementById('historyListContainer').innerHTML = html;
    });
}

function fetchAdsHistory() {
    if (!uid) return;
    
    db.collection('users').doc(uid).collection('daily_ads_views')
    .orderBy('updated_at', 'desc')
    .onSnapshot(snapshot => {
        let html = '';
        
        html += `<div class="glass-panel" style="margin-bottom:10px; padding:10px; text-align: center;">
                    <h4 style="margin:0">LIFETIME ADS Viewed: <span style="color:#00f0ff">${totalAdsWatched}</span></h4>
                 </div>`;
        
        if (snapshot.empty) {
            html += `<div style="text-align:center; padding: 30px; color: #8b9bb4;">
                        <i class="fas fa-box-open fa-2x"></i>
                        <p>No logs found.</p>
                     </div>`;
        } else {
            snapshot.forEach(doc => { 
                const item = doc.data(); 
                
                const parts = doc.id.split('-'); 
                const displayDate = new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric'
                }); 
                
                let providerName = 'Zone 1'; // Monetag
                if(item.last_provider === 'adsgram') providerName = 'Zone 2';
                else if(item.last_provider === 'onclicka') providerName = 'Zone 3';

                html += `
                <div class="top-ref-item" style="justify-content:space-between; align-items: center; padding: 12px;">
                    <div class="ref-info" style="display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                        <h4 style="margin: 0; font-size: 0.95rem; color: #fff; line-height: 1.2;">
                            Daily Ads viewed
                        </h4>
                        <p style="margin: 4px 0 0 0; padding: 0; font-size: 0.8rem; color: #8b9bb4; line-height: 1.2;">
                            Last Ad Zone: <span style="color: #00f0ff; font-weight: bold;">${providerName}</span>
                        </p>
                        <p style="margin: 4px 0 0 0; padding: 0; font-size: 0.75rem; color: #6c7a89; line-height: 1.2;">
                            ${displayDate}
                        </p>
                    </div>
                    <div class="ref-count-pill" style="background: rgba(0, 240, 255, 0.15); color: #00f0ff;">
                        ${item.count}
                    </div>
                </div>`; 
            });
        }
        document.getElementById('historyListContainer').innerHTML = html;
    });
}

// --- LEADERBOARD & TOURNAMENT ---
function handleTournamentButtonClick() {
    if (!isTournamentActive) {
        showErrorModal('INACTIVE', 'Tournament offline.', 'trophy');
    } else if (!hasJoinedTournament) {
        showJoinTournamentModal();
    } else {
        showTournamentListModal();
    }
}

function showTournamentListModal() {
    if (!isTournamentActive) return;

    document.getElementById('tournamentListModal').style.display = 'flex';
    
    const joinBtn = document.getElementById('listModalJoinBtn');
    joinBtn.style.display = hasJoinedTournament ? 'none' : 'block';
    
    document.getElementById('currentUserTournamentSummary').style.display = 'none';
    document.getElementById('currentUserTournamentSummary').innerHTML = '';

    startTournamentCountdown(tournamentEndTime, 'tournListModalCountdown');
    fetchTournamentLeaderboard(document.getElementById('tournamentLeaderboardList'), true);
}

function hideTournamentListModal() {
    document.getElementById('tournamentListModal').style.display = 'none';
}

function showJoinTournamentModal(fromList = false) {
    if (hasJoinedTournament) { 
        if(fromList) hideTournamentListModal();
        return; 
    }
    document.getElementById('joinTournamentModal').style.display = 'flex';
    if(fromList) hideTournamentListModal(); 
}

function hideJoinTournamentModal() {
    document.getElementById('joinTournamentModal').style.display = 'none';
}

function renderLeaderboard() {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    
    // NEW: Check visibility before rendering <-- ADDED
    if(settings.hide_rank_section) {
        // Ensure the section is hidden even if renderLeaderboard is accidentally called
        checkRankSectionVisibility();
        return; 
    }
    
    const container = document.getElementById('topReferralListContainer');
    const titleEl = document.getElementById('leaderboardTitle');
    const tourneyUI = document.getElementById('tournament-ui-container');
    const now = Date.now();

    if (isTournamentActive && now < tournamentEndTime) {
        tourneyUI.style.display = 'block';
        document.getElementById('referralTournamentBtn').innerHTML = `<i class="fas fa-trophy"></i> EVENT`;
        // মেইন টাইমার চালু
        startTournamentCountdown(tournamentEndTime, 'tournamentTimerDisplay', 'main');
    } else {
        tourneyUI.style.display = 'none';
        if (typeof mainTournamentInterval !== 'undefined' && mainTournamentInterval) clearInterval(mainTournamentInterval);
    }
    
    titleEl.innerHTML = 'ELITE AGENTS (Lifetime) <div class="line"></div>';
    
    container.innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Syncing...</p></div>`;
    
    db.collection('users').orderBy('referral_count', 'desc').limit(100).onSnapshot(snapshot => {
         let html = '';
         const filteredUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(data => (data.referral_count || 0) > 0); 

        if (filteredUsers.length === 0) {
            html = `<div style="text-align:center; padding: 40px; color: #8b9bb4;"><i class="fas fa-user-slash fa-2x"></i><p>No agents found.</p></div>`;
        } else {
             filteredUsers.forEach((data, index) => {
                  const rank = index + 1;
                  const fullName = data.full_name || data.username || 'Unknown Agent'; 
                  const referralCount = data.referral_count || 0;
                  
                  let rankBadgeHtml = ''; let badgeClass = '';
                  
                  if (rank === 1) { 
                      rankBadgeHtml = `1`; 
                      badgeClass = 'rank-1'; 
                  } 
                  else if (rank === 2) { 
                      rankBadgeHtml = `2`; 
                      badgeClass = 'rank-2'; 
                  } 
                  else if (rank === 3) { 
                      rankBadgeHtml = `3`; 
                      badgeClass = 'rank-3'; 
                  }
                  else { 
                      rankBadgeHtml = rank; 
                  }
                  
                  html += `
                    <div class="top-ref-item">
                        <div class="ref-rank-badge ${badgeClass}">${rankBadgeHtml}</div>
                        <div class="ref-info"><h4>${fullName}</h4></div>
                        <div class="ref-count-pill">${referralCount} Refs</div>
                    </div>`;
             });
        }
        container.innerHTML = html;
    });
}

function fetchTournamentLeaderboard(container, isModal = false) {
    if (!isTournamentActive) return;

    container.innerHTML = `<div class="loading-holo"><div class="scanner"></div><p>Loading Event Data...</p></div>`;
    
    const currentUserSummaryEl = document.getElementById('currentUserTournamentSummary');
    if(isModal && currentUserSummaryEl) {
        currentUserSummaryEl.style.display = 'none';
        currentUserSummaryEl.innerHTML = '';
    }

    db.collection('users')
        .where('has_joined_tournament', '==', true)
        .orderBy('tournament_referral_count', 'desc')
        .limit(100)
        .onSnapshot(snapshot => {
            let html = '';
            let currentUserData = null;
            const participatingUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(data => (data.tournament_referral_count || 0) >= 0); 

            participatingUsers.forEach((data, index) => {
                if (data.id === uid) {
                    currentUserData = {...data, rank: index + 1};
                }
            });

            if (isModal && hasJoinedTournament && currentUserData) {
                const rankText = currentUserData.rank;
                const refCount = currentUserData.tournament_referral_count || 0;
                
                currentUserSummaryEl.innerHTML = `
                    <div class="glass-panel" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-color:#00f0ff;">
                        <div style="display:flex; align-items:center;">
                            <span class="ref-rank-badge" style="background: rgba(0,240,255,0.2); color: #00f0ff; margin-right: 10px;">${rankText}</span>
                            <span style="color: #fff; font-weight: bold;">${userFullName}</span>
                        </div>
                        <div class="ref-count-pill" style="background:#00f0ff; color:#000;">${refCount} Refs</div>
                    </div>
                `;
                currentUserSummaryEl.style.display = 'block';
            }

            if (participatingUsers.length === 0) {
                html = `<div style="text-align:center; padding: 40px; color: #8b9bb4;"><i class="fas fa-users-slash fa-2x"></i><p>No participants yet.</p></div>`;
            } else {
                 participatingUsers.forEach((data, index) => {
                      const rank = index + 1;
                      const fullName = data.full_name || data.username || 'Unknown Agent'; 
                      const referralCount = data.tournament_referral_count || 0;
                      
                      let rankBadgeHtml = ''; let badgeClass = '';

                      if (rank === 1) { 
                          rankBadgeHtml = `<i class="fas fa-crown"></i>`; 
                          badgeClass = 'rank-1'; 
                      } 
                      else if (rank === 2) { 
                          rankBadgeHtml = `<i class="fas fa-star"></i>`; 
                          badgeClass = 'rank-2'; 
                      } 
                      else if (rank === 3) { 
                          rankBadgeHtml = `<i class="fas fa-medal"></i>`; 
                          badgeClass = 'rank-3'; 
                      }
                      else {
                          rankBadgeHtml = rank;
                      }
                      
                      const isCurrentUser = data.id === uid;
                      const itemStyle = isCurrentUser && !isModal ? 'border-color: #00f0ff; background: rgba(0,240,255,0.05);' : '';
                      
                      html += `
                        <div class="top-ref-item" style="${itemStyle}">
                            <div class="ref-rank-badge ${badgeClass}">${rankBadgeHtml}</div>
                            <div class="ref-info"><h4>${fullName}</h4></div>
                            <div class="ref-count-pill">${referralCount} Refs</div>
                        </div>`;
                 });
            }
            container.innerHTML = html;
        });
}

function startTournamentCountdown(endTime, displayId) {
    if (tournamentCountdownInterval) clearInterval(tournamentCountdownInterval); 
    const displayEl = document.getElementById(displayId);
    if(!displayEl) return;

    updateCountdownDisplay(endTime, displayEl);

    tournamentCountdownInterval = setInterval(() => {
        updateCountdownDisplay(endTime, displayEl);
    }, 1000); 
}

function updateCountdownDisplay(endTime, displayEl) {
    const now = Date.now();
    const remaining = endTime - now; 
    
    if (remaining <= 0) {
        clearInterval(tournamentCountdownInterval);
        isTournamentActive = false;
        document.getElementById('tournament-ui-container').style.display = 'none';
        checkAndShowPrizeModal();
        renderLeaderboard(); 
        return;
    }

    const totalSeconds = Math.floor(remaining / 1000);
    const days = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60; 

    const display = `${days}D ${String(hours).padStart(2, '0')}H ${String(minutes).padStart(2, '0')}M ${String(seconds).padStart(2, '0')}S`;
    displayEl.innerHTML = display;
}

function joinTournament() {
    if(hasJoinedTournament) return;
    document.getElementById('joinTournamentBtn').disabled = true;
    document.getElementById('joinTournamentBtn').innerHTML = 'JOINING...';

    userRef.update({
        has_joined_tournament: true,
        tournament_referral_count: 0 
    }).then(() => {
        hasJoinedTournament = true;
        hideJoinTournamentModal();
        renderLeaderboard();
    }).catch(err => {
        document.getElementById('joinTournamentBtn').disabled = false;
        document.getElementById('joinTournamentBtn').innerHTML = 'ACCEPT CHALLENGE';
    });
}

function showRulesModal() {
    document.getElementById('tournamentRulesContent').innerHTML = settings.tournament_rules || 'No data.';
    document.getElementById('rulesModal').style.display = 'flex';
}
function hideRulesModal() {
    document.getElementById('rulesModal').style.display = 'none';
}

// --- PRIZE LOGIC ---
function getPrizeAmount(rank, prizeTiers) {
    if (rank === 1) return prizeTiers['1'] || 0;
    if (rank === 2) return prizeTiers['2'] || 0;
    if (rank === 3) return prizeTiers['3'] || 0;
    if (rank >= 4 && rank <= 10) return prizeTiers['4-10'] || 0;
    if (rank >= 11 && rank <= 20) return prizeTiers['11-20'] || 0;
    if (rank >= 21 && rank <= 50) return prizeTiers['21-50'] || 0;
    if (rank >= 51 && rank <= 100) return prizeTiers['51-100'] || 0;
    if (rank >= 101 && rank <= 500) return prizeTiers['101-500'] || 0;
    if (rank >= 501 && rank <= 1000) return prizeTiers['501-1000'] || 0;
    if (rank > 1000) return prizeTiers['1000+'] || 0;
    return 0;
}

function getRankRange(rank) {
    if (rank === 1) return '1';
    if (rank === 2) return '2';
    if (rank === 3) return '3';
    if (rank >= 4 && rank <= 10) return '4-10';
    if (rank >= 11 && rank <= 20) return '11-20';
    if (rank >= 21 && rank <= 50) return '21-50';
    if (rank >= 51 && rank <= 100) return '51-100';
    if (rank >= 101 && rank <= 500) return '101-500';
    if (rank >= 501 && rank <= 1000) return '501-1000';
    if (rank > 1000) return '1000+';
    return 'Unranked';
}

function checkAndShowPrizeModal() {
    if (window.userTournamentRank === null || window.hasClaimedPrize || isTournamentActive) return; 
    
    const rank = window.userTournamentRank;
    const prizeAmount = getPrizeAmount(rank, settings.tournament_prizes);
    
    if (prizeAmount <= 0) {
        userRef.update({ 'tournament_data.claimed_prize': true });
        return;
    }

    const rankRange = getRankRange(rank);
    
    document.getElementById('prizeModalTitle').innerText = settings.prize_popup_title;
    let desc = settings.prize_popup_desc.replace('{{rank_range}}', rankRange);
    desc = desc.replace('{{prize_amount}}', prizeAmount);
    document.getElementById('prizeModalDesc').innerText = desc;
    document.getElementById('prizePopupAmount').innerText = `+${prizeAmount}`;
    document.getElementById('prizeCollectBtn').innerText = settings.prize_popup_btn_text;

    document.getElementById('prizeCollectBtn').onclick = () => claimTournamentPrize(prizeAmount);
    document.getElementById('prizeCollectModal').style.display = 'flex';
}

function claimTournamentPrize(amount) {
    const btn = document.getElementById('prizeCollectBtn');
    btn.disabled = true;
    btn.innerHTML = 'CLAIMING...';
    
    // Fake event for animation position (center of button)
    const rect = btn.getBoundingClientRect();
    const fakeEvent = { clientX: rect.left + rect.width/2, clientY: rect.top + rect.height/2 };

    document.getElementById('prizeCollectModal').style.display = 'none';

    spawnFlyingCoins(fakeEvent, () => {
        let newBalance = currentBalance + amount; 
        animateBalance(currentBalance, newBalance);
        window.hasClaimedPrize = true;
    });
    
    userRef.update({
        balance: firebase.firestore.FieldValue.increment(amount),
        'tournament_data.claimed_prize': true,
        last_activity: Date.now()
    }).catch(err => {
        // Handle error silently or log
        console.error("Prize claim DB error:", err);
    });
}

function switchTab(id, el) {
    // if (!isBotVerified && isEntryViaReferral) return; // REMOVED
    
    // NEW: Mission ট্যাব থেকে বের হওয়ার সময় টাইমার চলছে কিনা তা পরীক্ষা করা
    const isLeavingTasks = document.getElementById('tasks-section').classList.contains('active-section') && id !== 'tasks';
    
    // UPDATED: Check for activeTaskTimeout
    if (isLeavingTasks && activeTaskTimeout) {
        // যদি টাইমার চলছে, তবে বন্ধ করো এবং এরর দেখাও
        stopMissionTimer(true); 
    }

    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section')); 
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); 
    
    document.getElementById(id+'-section').classList.add('active-section'); 
    el.classList.add('active');
    
    window.scrollTo(0,0); 
    updateUserActivity(); 

    if (id === 'invite') { 
        activeRefPage = 1; completedRefPage = 1; renderReferrals(activeRefPage); 
    } else if (id === 'topref') { 
        renderLeaderboard(); 
    } else if (id === 'tasks') {
        renderTasks();
    }
    
    // Ensure network selection modal is closed on tab switch
    if(document.getElementById('networkSelectionModal').style.display === 'flex') closeNetworkSelectionModal();
}

// =========================================
// RANK SECTION VISIBILITY TOGGLE (NEW) <-- ADDED FUNCTION
// =========================================
function checkRankSectionVisibility() {
    const rankSection = document.getElementById('topref-section');
    // Nav আইটেমটিকে তার onclick attribute ব্যবহার করে খুঁজে বের করা
    const rankNavItem = document.querySelector('.cyber-nav .nav-item[onclick*="\'topref\'"]');
    
    if (settings.hide_rank_section) {
        // Hide the section and the navigation item
        if (rankSection) rankSection.style.display = 'none';
        if (rankNavItem) rankNavItem.style.display = 'none';
        
        // If the Rank section is currently active, switch to Home
        if (rankSection && rankSection.classList.contains('active-section')) {
            // Find the home nav item and simulate a switch
            const homeNavItem = document.querySelector('.cyber-nav .nav-item[onclick*="\'home\'"]');
            if (homeNavItem) switchTab('home', homeNavItem);
        }
    } else {
        // Show the section and the navigation item (relying on default CSS for actual state)
        if (rankSection) rankSection.style.display = ''; 
        if (rankNavItem) rankNavItem.style.display = ''; 
    }
}
// =========================================


function copyLink(btn) { 
    navigator.clipboard.writeText(document.getElementById('refLink').innerText).then(() => { 
        let old = btn.innerHTML; 
        btn.innerHTML = 'COPIED!'; 
        btn.style.borderColor = '#2ecc71'; 
        btn.style.color = '#2ecc71';
        setTimeout(() => { 
            btn.innerHTML = old; 
            btn.style.borderColor = ''; 
            btn.style.color = '';
        }, 1000); 
    }); 
}

// 2. ANIMATE BALANCE FUNCTION (Updated with Counting Bounce Sparkle)
function animateBalance(start, end) { 
    const balanceEl = document.getElementById('balance');
    let current = start;
    let step = Math.ceil((end - start) / 15); // Increased steps slightly for smoother count
    if(step === 0) step = 1;

    // START ANIMATION: Add class
    balanceEl.classList.add('counting-sparkle');

    const timer = setInterval(() => { 
        current += step; 
        if ((step > 0 && current >= end) || (step < 0 && current <= end)) { 
            current = end; 
            clearInterval(timer); 
            
            // STOP ANIMATION: Remove class when done
            balanceEl.classList.remove('counting-sparkle');
        } 
        balanceEl.innerText = current; 
        
        // UPDATE USD DURING ANIMATION
        updateUsdDisplay(current);

    }, 40); // Speed of counting
}

// =========================================
// SMART BALANCE FONT SCALER
// =========================================

function adjustBalanceFontSize() {
    const balanceEl = document.getElementById('balance');
    if (!balanceEl) return;

    const textLength = balanceEl.innerText.length;

    if (textLength <= 4) {
        balanceEl.style.fontSize = '2rem';      
    } else if (textLength <= 6) {
        balanceEl.style.fontSize = '1.4rem';    
    } else if (textLength <= 8) {
        balanceEl.style.fontSize = '1.1rem';    
    } else if (textLength <= 10) {
        balanceEl.style.fontSize = '.9rem';    
    } else if (textLength <= 12) {
        balanceEl.style.fontSize = '.7rem';    
    } else if (textLength <= 14) {
        balanceEl.style.fontSize = '.6rem'; 
    } else if (textLength <= 16) {
        balanceEl.style.fontSize = '.5rem'; 
    } else {
        balanceEl.style.fontSize = '0.3rem';    
    }
}

const balanceObserver = new MutationObserver(adjustBalanceFontSize);
const balanceNode = document.getElementById('balance');

if (balanceNode) {
    adjustBalanceFontSize(); 
    balanceObserver.observe(balanceNode, { childList: true, characterData: true, subtree: true });
}


// --- script.js এর একদম নিচে যোগ করুন ---

function adjustRefStatSize(elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;

    const textLength = el.innerText.length;

    // সংখ্যার দৈর্ঘ্য অনুযায়ী ফন্ট সাইজ ছোট করা
    if (textLength <= 5) {
        el.style.fontSize = '1.2rem';      // সাধারণ সাইজ
    } else if (textLength <= 7) {
        el.style.fontSize = '1rem';        // একটু ছোট
    } else if (textLength <= 9) {
        el.style.fontSize = '0.8rem';      // আরও ছোট
    } else if (textLength <= 12) {
        el.style.fontSize = '0.7rem';      // বেশ ছোট
    } else {
        el.style.fontSize = '0.6rem';      // অনেক বড় সংখ্যার জন্য একদম ছোট
    }
}

// =========================================
// ADVANCED PATH FINDING FLYING COINS (1-2-3 CYCLE)
// =========================================

/**
 * Spawns coins with smoke trails in a 3-step cycle pattern
 */
function spawnFlyingCoins(e, callback) {
    // 1. Get Start Position
    const startX = e.clientX || (e.touches && e.touches[0].clientX) || window.innerWidth / 2;
    const startY = e.clientY || (e.touches && e.touches[0].clientY) || window.innerHeight / 2;

    // 2. Get Target Position
    const targetEl = document.getElementById('mainCoinIcon'); 
    if (!targetEl) { if(callback) callback(); return; }
    
    const targetRect = targetEl.getBoundingClientRect();
    const targetX = targetRect.left + (targetRect.width / 4);
    const targetY = targetRect.top + (targetRect.height / 4);

    // 3. Determine Cycle Pattern (0 = Zigzag, 1 = Right Curve, 2 = Left Curve)
    const pattern = coinClickCycle % 3;
    coinClickCycle++; // Increment for next time

    const particleCount = 12; 
    let completedParticles = 0;

    for (let i = 0; i < particleCount; i++) {
        const coin = document.createElement('div');
        coin.classList.add('flying-coin');
        document.body.appendChild(coin);

        // Initial Spread
        const randomOffsetX = (Math.random() - 0.5) * 30;
        const randomOffsetY = (Math.random() - 0.5) * 30;
        
        const sX = startX + randomOffsetX;
        const sY = startY + randomOffsetY;
        
        coin.style.left = `${sX}px`;
        coin.style.top = `${sY}px`;

        let keyframes = [];
        const duration = 1000 + Math.random() * 300; // ~1 second
        
        // --- PATH LOGIC ---
        if (pattern === 0) { 
            // 1. ZIGZAG (আঁকাবাঁকা)
            keyframes = [
                { transform: `translate(0, 0) scale(0.5)`, opacity: 1 },
                { transform: `translate(${(targetX - sX)*0.25 + 40}px, ${(targetY - sY)*0.25}px) scale(0.8)`, opacity: 1, offset: 0.25 },
                { transform: `translate(${(targetX - sX)*0.5 - 40}px, ${(targetY - sY)*0.5}px) scale(1)`, opacity: 1, offset: 0.5 },
                { transform: `translate(${(targetX - sX)*0.75 + 40}px, ${(targetY - sY)*0.75}px) scale(1.1)`, opacity: 1, offset: 0.75 },
                { transform: `translate(${targetX - sX}px, ${targetY - sY}px) scale(0.4)`, opacity: 0 }
            ];
        } 
        else if (pattern === 1) { 
            // 2. RIGHT CURVE
            keyframes = [
                { transform: `translate(0, 0) scale(0.5)`, opacity: 1 },
                { transform: `translate(${(targetX - sX)/2 + 150}px, ${(targetY - sY)/2}px) scale(1.2)`, opacity: 1, offset: 0.5 },
                { transform: `translate(${targetX - sX}px, ${targetY - sY}px) scale(0.4)`, opacity: 0 }
            ];
        } 
        else { 
            // 3. LEFT CURVE
            keyframes = [
                { transform: `translate(0, 0) scale(0.5)`, opacity: 1 },
                { transform: `translate(${(targetX - sX)/2 - 150}px, ${(targetY - sY)/2}px) scale(1.2)`, opacity: 1, offset: 0.5 },
                { transform: `translate(${targetX - sX}px, ${targetY - sY}px) scale(0.4)`, opacity: 0 }
            ];
        }

        // Run Animation
        const anim = coin.animate(keyframes, {
            duration: duration,
            easing: 'ease-in-out',
            fill: 'forwards'
        });

        // --- SMOKE TRAIL ---
        const trailInterval = setInterval(() => {
            const rect = coin.getBoundingClientRect();
            createSmoke(rect.left + 4, rect.top + 4); 
            if (anim.playState === 'finished') clearInterval(trailInterval);
        }, 50);

        anim.onfinish = () => {
            clearInterval(trailInterval);
            coin.remove();
            completedParticles++;
            
            // Trigger IMPACT slightly before all finish
            if (completedParticles === Math.floor(particleCount - 2)) { 
                triggerBalanceImpact(); 
            }
            
            if (completedParticles === particleCount) {
                if (callback) callback();
            }
        };
    }
}

// Helper to create fading smoke
function createSmoke(x, y) {
    const smoke = document.createElement('div');
    smoke.classList.add('neon-smoke');
    document.body.appendChild(smoke);
    
    smoke.style.left = `${x}px`;
    smoke.style.top = `${y}px`;
    
    setTimeout(() => { smoke.remove(); }, 600);
}

// Balance Hit Effect (Sparkle Ring)
function triggerBalanceImpact() {
    const ripple = document.createElement('div');
    ripple.classList.add('balance-sparkle');
    document.querySelector('.balance-orbit-container').appendChild(ripple);
    setTimeout(() => ripple.remove(), 500);
}


/* --- END OF FILE script.js --- */
        
    </script>
    
</body>
</html>
